<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>WireGuard on star徐的博客</title><link>http://cloud-ip.cc/tags/wireguard/</link><description>Recent content in WireGuard on star徐的博客</description><generator>Hugo -- 0.152.2</generator><language>zh-cn</language><lastBuildDate>Thu, 13 Nov 2025 18:00:00 +0800</lastBuildDate><atom:link href="http://cloud-ip.cc/tags/wireguard/index.xml" rel="self" type="application/rss+xml"/><item><title>智能分流网关分流部署方案(ipset、wireguard、dnsmasq)</title><link>http://cloud-ip.cc/posts/%E6%99%BA%E8%83%BD%E5%88%86%E6%B5%81%E7%BD%91%E5%85%B3%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88-%E7%99%BD%E5%90%8D%E5%8D%95%E7%9B%B4%E8%BF%9E%E9%BB%98%E8%AE%A4%E4%BB%A3%E7%90%86/</link><pubDate>Thu, 13 Nov 2025 18:00:00 +0800</pubDate><guid>http://cloud-ip.cc/posts/%E6%99%BA%E8%83%BD%E5%88%86%E6%B5%81%E7%BD%91%E5%85%B3%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88-%E7%99%BD%E5%90%8D%E5%8D%95%E7%9B%B4%E8%BF%9E%E9%BB%98%E8%AE%A4%E4%BB%A3%E7%90%86/</guid><description>&lt;h2 id="方案概览"&gt;方案概览&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;核心技术&lt;/strong&gt;: WireGuard, Dnsmasq, Iptables, IPset, 策略路由&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;核心策略&lt;/strong&gt;: &lt;strong&gt;白名单直连，默认代理&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;流量路径&lt;/strong&gt;:
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;DNS查询&lt;/strong&gt;:
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;国内域名&lt;/strong&gt; (匹配&lt;code&gt;dnsmasq-china-list&lt;/code&gt;): 通过国内DNS (&lt;code&gt;119.29.29.29&lt;/code&gt;等) 直接解析，并将结果IP自动加入&lt;code&gt;directlist&lt;/code&gt; IP白名单集合。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;被墙域名 &amp;amp; 未知域名&lt;/strong&gt;: 统一通过WireGuard隧道向上游DNS (&lt;code&gt;8.8.8.8&lt;/code&gt;) 查询。被墙域名的结果IP会自动加入&lt;code&gt;gfwlist&lt;/code&gt; IP集合。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;数据传输&lt;/strong&gt;:
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;国内IP&lt;/strong&gt; (匹配&lt;code&gt;directlist&lt;/code&gt; IP白名单): 直接连接（走本地出口）。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;所有其他IP&lt;/strong&gt; (包括被墙IP和未知IP): 由于未匹配到白名单，默认被Iptables打上标记，强制通过策略路由进入WireGuard隧道。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;核心特性&lt;/strong&gt;:
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;DNS查询保护&lt;/strong&gt;: 对国外及未知域名的DNS查询本身也被强制通过隧道，防止ISP窥探。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;默认代理&lt;/strong&gt;: 任何未明确指定为“直连”的流量，都将默认通过隧道，提供更强的隐私保护。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Kill Switch&lt;/strong&gt;: VPN隧道意外断开时，自动阻止所有需要走隧道的流量，防止真实IP泄露。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;全自动化&lt;/strong&gt;: 定时脚本自动更新国内外域名与IP列表，无需人工干预。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id="第一部分vps-服务器端-配置"&gt;第一部分：VPS (服务器端) 配置&lt;/h2&gt;
&lt;p&gt;VPS作为流量的最终出口，负责将隧道数据转发至公共互联网。&lt;/p&gt;
&lt;h3 id="1-系统准备与软件安装"&gt;1. 系统准备与软件安装&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 更新系统软件包列表并升级已安装的软件&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo apt update &lt;span style="color:#f92672"&gt;&amp;amp;&amp;amp;&lt;/span&gt; sudo apt upgrade -y
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 安装WireGuard&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo apt install wireguard -y
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="2-启用ip转发"&gt;2. 启用IP转发&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 编辑sysctl配置文件&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo nano /etc/sysctl.conf
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;确保文件中包含以下行（去掉前面的&lt;code&gt;#&lt;/code&gt;号）：&lt;/p&gt;</description></item><item><title>基于WireGuard的国内到国外VPS组网架构</title><link>http://cloud-ip.cc/posts/%E5%9F%BA%E4%BA%8Ewireguard%E7%9A%84%E5%9B%BD%E5%86%85%E5%88%B0%E5%9B%BD%E5%A4%96vps%E7%BB%84%E7%BD%91%E6%9E%B6%E6%9E%84/</link><pubDate>Thu, 13 Nov 2025 18:05:00 +0810</pubDate><guid>http://cloud-ip.cc/posts/%E5%9F%BA%E4%BA%8Ewireguard%E7%9A%84%E5%9B%BD%E5%86%85%E5%88%B0%E5%9B%BD%E5%A4%96vps%E7%BB%84%E7%BD%91%E6%9E%B6%E6%9E%84/</guid><description>&lt;h2 id="概述与技术栈建议"&gt;概述与技术栈建议&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;需求实现&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;DNS分流 (黑名单模式)&lt;/strong&gt;：被墙域名通过&lt;code&gt;8.8.8.8&lt;/code&gt;走WireGuard隧道解析；国内及所有未匹配的域名，默认通过&lt;code&gt;114.114.114.114&lt;/code&gt;直连解析。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;流量分流 (黑名单模式)&lt;/strong&gt;：目标IP在大陆IP列表中的流量直连；目标IP在被墙IP列表中的流量走隧道；所有未匹配的流量默认直连。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;安全增强&lt;/strong&gt;：集成Kill Switch，当隧道意外断开时，自动阻止所有应走隧道的流量，防止真实IP泄露。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;自动化与持久化&lt;/strong&gt;：所有路由和防火墙规则与WireGuard接口生命周期绑定，实现开机自启、自动配置与清理，无需手动干预。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;技术栈&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;WireGuard：VPN隧道（UDP，端口51820）。&lt;/li&gt;
&lt;li&gt;Dnsmasq：本地DNS服务器，分流解析。&lt;/li&gt;
&lt;li&gt;ipset + iptables + ip rule/route：政策路由分流。&lt;/li&gt;
&lt;li&gt;gfwlist2dnsmasq.sh：生成被墙域名黑名单。&lt;/li&gt;
&lt;li&gt;cron + bash：自动化更新。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;注意事项&lt;/strong&gt;：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;先在测试环境试运行，避免影响生产。&lt;/li&gt;
&lt;li&gt;VPS防火墙需允许WireGuard端口：&lt;code&gt;ufw allow 51820/udp&lt;/code&gt;。&lt;/li&gt;
&lt;li&gt;VPS启用IP转发：&lt;code&gt;echo 'net.ipv4.ip_forward=1' &amp;gt;&amp;gt; /etc/sysctl.conf; sysctl -p&lt;/code&gt;。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="步骤1-安装必要工具"&gt;步骤1: 安装必要工具&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;VPS (服务器端)&lt;/strong&gt;：&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# 2. 更新Dnsmasq域名列表&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; wget -O /etc/dnsmasq.d/accelerated-domains.china.conf https://github.com/felixonmars/dnsmasq-china-list/raw/master/accelerated-domains.china.conf
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; wget -O /etc/dnsmasq.d/bogus-nxdomain.china.conf https://github.com/felixonmars/dnsmasq-china-list/raw/master/bogus-nxdomain.china.conf
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# 清空gfwlist ipset，让脚本重新填充&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ipset flush gfwlist
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; /usr/local/bin/gfwlist2dnsmasq.sh -s 8.8.8.8 -i gfwlist -o /etc/dnsmasq.d/gfwlist.conf
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# 3. 更新ipset IP列表&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# 使用临时文件避免网络问题导致列表被清空&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; TMP_FILE&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;$(&lt;/span&gt;mktemp&lt;span style="color:#66d9ef"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; wget -O &lt;span style="color:#e6db74"&gt;&amp;#34;&lt;/span&gt;$TMP_FILE&lt;span style="color:#e6db74"&gt;&amp;#34;&lt;/span&gt; https://github.com/gaoyifan/china-operator-ip/raw/ip-lists/china.txt
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ipset flush china_ip
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;while&lt;/span&gt; read line; &lt;span style="color:#66d9ef"&gt;do&lt;/span&gt; ipset add china_ip $line; &lt;span style="color:#66d9ef"&gt;done&lt;/span&gt; &amp;lt; &lt;span style="color:#e6db74"&gt;&amp;#34;&lt;/span&gt;$TMP_FILE&lt;span style="color:#e6db74"&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; rm &lt;span style="color:#e6db74"&gt;&amp;#34;&lt;/span&gt;$TMP_FILE&lt;span style="color:#e6db74"&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ipset add china_ip 114.114.114.114
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# 4. 重启Dnsmasq服务以应用新域名列表&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; systemctl restart dnsmasq
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; echo &lt;span style="color:#e6db74"&gt;&amp;#34;Lists updated successfully.&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;VPS (/etc/wireguard/wg0.conf)&lt;/strong&gt; - (此部分无变化):&lt;/p&gt;</description></item></channel></rss>