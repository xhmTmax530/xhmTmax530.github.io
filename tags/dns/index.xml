<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>DNS on star徐的博客</title><link>http://cloud-ip.cc/tags/dns/</link><description>Recent content in DNS on star徐的博客</description><generator>Hugo -- 0.152.2</generator><language>zh-cn</language><lastBuildDate>Thu, 13 Nov 2025 18:00:00 +0800</lastBuildDate><atom:link href="http://cloud-ip.cc/tags/dns/index.xml" rel="self" type="application/rss+xml"/><item><title>智能分流网关分流部署方案(ipset、wireguard、dnsmasq)</title><link>http://cloud-ip.cc/posts/%E6%99%BA%E8%83%BD%E5%88%86%E6%B5%81%E7%BD%91%E5%85%B3%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88-%E7%99%BD%E5%90%8D%E5%8D%95%E7%9B%B4%E8%BF%9E%E9%BB%98%E8%AE%A4%E4%BB%A3%E7%90%86/</link><pubDate>Thu, 13 Nov 2025 18:00:00 +0800</pubDate><guid>http://cloud-ip.cc/posts/%E6%99%BA%E8%83%BD%E5%88%86%E6%B5%81%E7%BD%91%E5%85%B3%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88-%E7%99%BD%E5%90%8D%E5%8D%95%E7%9B%B4%E8%BF%9E%E9%BB%98%E8%AE%A4%E4%BB%A3%E7%90%86/</guid><description>&lt;h2 id="方案概览"&gt;方案概览&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;核心技术&lt;/strong&gt;: WireGuard, Dnsmasq, Iptables, IPset, 策略路由&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;核心策略&lt;/strong&gt;: &lt;strong&gt;白名单直连，默认代理&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;流量路径&lt;/strong&gt;:
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;DNS查询&lt;/strong&gt;:
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;国内域名&lt;/strong&gt; (匹配&lt;code&gt;dnsmasq-china-list&lt;/code&gt;): 通过国内DNS (&lt;code&gt;119.29.29.29&lt;/code&gt;等) 直接解析，并将结果IP自动加入&lt;code&gt;directlist&lt;/code&gt; IP白名单集合。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;被墙域名 &amp;amp; 未知域名&lt;/strong&gt;: 统一通过WireGuard隧道向上游DNS (&lt;code&gt;8.8.8.8&lt;/code&gt;) 查询。被墙域名的结果IP会自动加入&lt;code&gt;gfwlist&lt;/code&gt; IP集合。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;数据传输&lt;/strong&gt;:
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;国内IP&lt;/strong&gt; (匹配&lt;code&gt;directlist&lt;/code&gt; IP白名单): 直接连接（走本地出口）。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;所有其他IP&lt;/strong&gt; (包括被墙IP和未知IP): 由于未匹配到白名单，默认被Iptables打上标记，强制通过策略路由进入WireGuard隧道。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;核心特性&lt;/strong&gt;:
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;DNS查询保护&lt;/strong&gt;: 对国外及未知域名的DNS查询本身也被强制通过隧道，防止ISP窥探。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;默认代理&lt;/strong&gt;: 任何未明确指定为“直连”的流量，都将默认通过隧道，提供更强的隐私保护。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Kill Switch&lt;/strong&gt;: VPN隧道意外断开时，自动阻止所有需要走隧道的流量，防止真实IP泄露。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;全自动化&lt;/strong&gt;: 定时脚本自动更新国内外域名与IP列表，无需人工干预。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id="第一部分vps-服务器端-配置"&gt;第一部分：VPS (服务器端) 配置&lt;/h2&gt;
&lt;p&gt;VPS作为流量的最终出口，负责将隧道数据转发至公共互联网。&lt;/p&gt;
&lt;h3 id="1-系统准备与软件安装"&gt;1. 系统准备与软件安装&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 更新系统软件包列表并升级已安装的软件&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo apt update &lt;span style="color:#f92672"&gt;&amp;amp;&amp;amp;&lt;/span&gt; sudo apt upgrade -y
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 安装WireGuard&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo apt install wireguard -y
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="2-启用ip转发"&gt;2. 启用IP转发&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# 编辑sysctl配置文件&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo nano /etc/sysctl.conf
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;确保文件中包含以下行（去掉前面的&lt;code&gt;#&lt;/code&gt;号）：&lt;/p&gt;</description></item></channel></rss>