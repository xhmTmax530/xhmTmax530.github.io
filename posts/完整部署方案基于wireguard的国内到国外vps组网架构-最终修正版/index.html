<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=16893&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>star徐的博客</title>
<meta name="keywords" content="">
<meta name="description" content="概述与技术栈建议


需求实现：

DNS分流 (黑名单模式)：被墙域名通过8.8.8.8走WireGuard隧道解析；国内及所有未匹配的域名，默认通过114.114.114.114直连解析。
流量分流 (黑名单模式)：目标IP在大陆IP列表中的流量直连；目标IP在被墙IP列表中的流量走隧道；所有未匹配的流量默认直连。
安全增强：集成Kill Switch，当隧道意外断开时，自动阻止所有应走隧道的流量，防止真实IP泄露。
自动化与持久化：所有路由和防火墙规则与WireGuard接口生命周期绑定，实现开机自启、自动配置与清理，无需手动干预。



技术栈：

WireGuard：VPN隧道（UDP，端口51820）。
Dnsmasq：本地DNS服务器，分流解析。
ipset &#43; iptables &#43; ip rule/route：政策路由分流。
gfwlist2dnsmasq.sh：生成被墙域名黑名单。
cron &#43; bash：自动化更新。



注意事项：

先在测试环境试运行，避免影响生产。
VPS防火墙需允许WireGuard端口：ufw allow 51820/udp。
VPS启用IP转发：echo &#39;net.ipv4.ip_forward=1&#39; &gt;&gt; /etc/sysctl.conf; sysctl -p。



步骤1: 安装必要工具

VPS (服务器端)：
sudo apt update  # 更新软件包列表
sudo apt install wireguard -y # 仅需安装WireGuard

国内客户端：
sudo apt update  # 更新软件包列表
# iptables-persistent不再需要，因为规则由WireGuard动态管理
sudo apt install wireguard dnsmasq ipset cron -y

下载gfwlist2dnsmasq.sh（客户端）：
wget https://github.com/cokebar/gfwlist2dnsmasq/raw/master/gfwlist2dnsmasq.sh -O /usr/local/bin/gfwlist2dnsmasq.sh
chmod &#43;x /usr/local/bin/gfwlist2dnsmasq.sh


步骤2: 配置WireGuard隧道


生成密钥（在VPS和客户端上分别执行）：">
<meta name="author" content="您的姓名">
<link rel="canonical" href="//localhost:16893/posts/%E5%AE%8C%E6%95%B4%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88%E5%9F%BA%E4%BA%8Ewireguard%E7%9A%84%E5%9B%BD%E5%86%85%E5%88%B0%E5%9B%BD%E5%A4%96vps%E7%BB%84%E7%BD%91%E6%9E%B6%E6%9E%84-%E6%9C%80%E7%BB%88%E4%BF%AE%E6%AD%A3%E7%89%88/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fd5566c526ae48aadabd950798a2dc3568536401560eae5caac3765a42a9e7b5.css" integrity="sha256-/VVmxSauSKravZUHmKLcNWhTZAFWDq5cqsN2WkKp57U=" rel="preload stylesheet" as="style">
<link rel="icon" href="//localhost:16893/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="//localhost:16893/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="//localhost:16893/favicon-32x32.png">
<link rel="apple-touch-icon" href="//localhost:16893/apple-touch-icon.png">
<link rel="mask-icon" href="//localhost:16893/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="//localhost:16893/posts/%E5%AE%8C%E6%95%B4%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88%E5%9F%BA%E4%BA%8Ewireguard%E7%9A%84%E5%9B%BD%E5%86%85%E5%88%B0%E5%9B%BD%E5%A4%96vps%E7%BB%84%E7%BD%91%E6%9E%B6%E6%9E%84-%E6%9C%80%E7%BB%88%E4%BF%AE%E6%AD%A3%E7%89%88/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="//localhost:16893/" accesskey="h" title="star徐的博客 (Alt + H)">star徐的博客</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="//localhost:16893/" title="首页">
                    <span>首页</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="//localhost:16893/">Home</a>&nbsp;»&nbsp;<a href="//localhost:16893/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      
    </h1>
    <div class="post-meta"><span>您的姓名</span>

</div>
  </header> 
  <div class="post-content"><h2 id="概述与技术栈建议">概述与技术栈建议<a hidden class="anchor" aria-hidden="true" href="#概述与技术栈建议">#</a></h2>
<ul>
<li>
<p><strong>需求实现</strong>：</p>
<ul>
<li><strong>DNS分流 (黑名单模式)</strong>：被墙域名通过<code>8.8.8.8</code>走WireGuard隧道解析；国内及所有未匹配的域名，默认通过<code>114.114.114.114</code>直连解析。</li>
<li><strong>流量分流 (黑名单模式)</strong>：目标IP在大陆IP列表中的流量直连；目标IP在被墙IP列表中的流量走隧道；所有未匹配的流量默认直连。</li>
<li><strong>安全增强</strong>：集成Kill Switch，当隧道意外断开时，自动阻止所有应走隧道的流量，防止真实IP泄露。</li>
<li><strong>自动化与持久化</strong>：所有路由和防火墙规则与WireGuard接口生命周期绑定，实现开机自启、自动配置与清理，无需手动干预。</li>
</ul>
</li>
<li>
<p><strong>技术栈</strong>：</p>
<ul>
<li>WireGuard：VPN隧道（UDP，端口51820）。</li>
<li>Dnsmasq：本地DNS服务器，分流解析。</li>
<li>ipset + iptables + ip rule/route：政策路由分流。</li>
<li>gfwlist2dnsmasq.sh：生成被墙域名黑名单。</li>
<li>cron + bash：自动化更新。</li>
</ul>
</li>
<li>
<p><strong>注意事项</strong>：</p>
<ul>
<li>先在测试环境试运行，避免影响生产。</li>
<li>VPS防火墙需允许WireGuard端口：<code>ufw allow 51820/udp</code>。</li>
<li>VPS启用IP转发：<code>echo 'net.ipv4.ip_forward=1' &gt;&gt; /etc/sysctl.conf; sysctl -p</code>。</li>
</ul>
</li>
</ul>
<h2 id="步骤1-安装必要工具">步骤1: 安装必要工具<a hidden class="anchor" aria-hidden="true" href="#步骤1-安装必要工具">#</a></h2>
<ul>
<li><strong>VPS (服务器端)</strong>：
<pre tabindex="0"><code>sudo apt update  # 更新软件包列表
sudo apt install wireguard -y # 仅需安装WireGuard
</code></pre></li>
<li><strong>国内客户端</strong>：
<pre tabindex="0"><code>sudo apt update  # 更新软件包列表
# iptables-persistent不再需要，因为规则由WireGuard动态管理
sudo apt install wireguard dnsmasq ipset cron -y
</code></pre></li>
<li><strong>下载gfwlist2dnsmasq.sh</strong>（客户端）：
<pre tabindex="0"><code>wget https://github.com/cokebar/gfwlist2dnsmasq/raw/master/gfwlist2dnsmasq.sh -O /usr/local/bin/gfwlist2dnsmasq.sh
chmod +x /usr/local/bin/gfwlist2dnsmasq.sh
</code></pre></li>
</ul>
<h2 id="步骤2-配置wireguard隧道">步骤2: 配置WireGuard隧道<a hidden class="anchor" aria-hidden="true" href="#步骤2-配置wireguard隧道">#</a></h2>
<ul>
<li>
<p><strong>生成密钥</strong>（在VPS和客户端上分别执行）：</p>
<pre tabindex="0"><code>wg genkey | tee private.key | wg pubkey &gt; public.key
</code></pre></li>
<li>
<p><strong>VPS (/etc/wireguard/wg0.conf)</strong> - (此部分无变化):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[Interface]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Address</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">10.0.0.1/24</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PrivateKey</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;VPS私钥&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ListenPort</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">51820</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PostUp</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">iptables -A FORWARD -i %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PostDown</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">iptables -D FORWARD -i %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SaveConfig</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[Peer]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PublicKey</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;客户端公钥&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AllowedIPs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">10.0.0.2/32</span>
</span></span></code></pre></div><ul>
<li>启动：<code>wg-quick up wg0; systemctl enable wg-quick@wg0</code></li>
</ul>
</li>
<li>
<p><strong>客户端 (/etc/wireguard/wg0.conf)</strong> - <strong>【核心修改】</strong>
<strong>将原配置替换为以下完整内容。</strong> 它集成了策略路由、防火墙规则和Kill Switch，实现了完全自动化。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[Interface]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Address</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">10.0.0.2/24</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PrivateKey</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;客户端私钥&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">DNS</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">127.0.0.1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MTU</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">1420</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 关键：告诉wg-quick不要自动修改主路由表，让我们的策略路由完全接管</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Table</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">off</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># === 启动时自动执行 ===</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1. 创建策略路由: 所有被标记(fwmark 0x1)的流量，查询路由表100</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PostUp</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">ip rule add fwmark 0x1 table 100</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. 在路由表100中，设置默认网关为VPS的隧道IP (10.0.0.1)，通过wg0接口(%i)出去</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PostUp</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">ip route add default via 10.0.0.1 dev %i table 100</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. 创建一个新的iptables链，用于集中管理标记规则</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PostUp</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">iptables -t mangle -N WIREGUARD_MARK</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4. 将进入和本机产生的数据包都送到这个新链进行处理</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PostUp</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">iptables -t mangle -A PREROUTING -j WIREGUARD_MARK</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PostUp</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">iptables -t mangle -A OUTPUT -j WIREGUARD_MARK</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 5. 在链中定义规则: 如果目标IP是国内IP(在china_ip集合中)，则直接返回，不再继续匹配</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PostUp</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">iptables -t mangle -A WIREGUARD_MARK -m set --match-set china_ip dst -j RETURN</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 6. 如果目标IP是被墙IP(在gfwlist集合中)，则打上标记0x1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PostUp</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">iptables -t mangle -A WIREGUARD_MARK -m set --match-set gfwlist dst -j MARK --set-mark 0x1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 7. 如果是本机发往国外DNS(8.8.8.8)的查询请求，也打上标记0x1，确保DNS查询本身也走隧道</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PostUp</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">iptables -t mangle -A WIREGUARD_MARK -p udp -d 8.8.8.8 --dport 53 -j MARK --set-mark 0x1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 8. 添加Kill Switch: 在OUTPUT链顶部插入规则，如果数据包有标记0x1但出口不是wg0(%i)，则直接丢弃</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PostUp</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">iptables -I OUTPUT 1 -m mark --mark 0x1 ! -o %i -j DROP</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># === 关闭时自动清理 (顺序与PostUp相反) ===</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PreDown</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">iptables -D OUTPUT -m mark --mark 0x1 ! -o %i -j DROP</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PreDown</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">iptables -t mangle -D PREROUTING -j WIREGUARD_MARK</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PreDown</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">iptables -t mangle -D OUTPUT -j WIREGUARD_MARK</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PreDown</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">iptables -t mangle -F WIREGUARD_MARK</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PreDown</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">iptables -t mangle -X WIREGUARD_MARK</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PreDown</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">ip route del default via 10.0.0.1 dev %i table 100</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PreDown</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">ip rule del fwmark 0x1 table 100</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[Peer]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PublicKey</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;VPS公钥&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AllowedIPs</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">0.0.0.0/0, ::/0 # 允许所有IP通过隧道，但具体走向由策略路由决定</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Endpoint</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;VPS公IP&gt;:51820</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PersistentKeepalive</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">25</span>
</span></span></code></pre></div><ul>
<li>启动：<code>wg-quick up wg0; systemctl enable wg-quick@wg0</code></li>
</ul>
</li>
</ul>
<h2 id="步骤3-配置dnsmasqdns分流--逻辑修正">步骤3: 配置Dnsmasq（DNS分流）- 【逻辑修正】<a hidden class="anchor" aria-hidden="true" href="#步骤3-配置dnsmasqdns分流--逻辑修正">#</a></h2>
<ul>
<li><strong>主配置 (/etc/dnsmasq.conf)</strong> - (无变化):
<pre tabindex="0"><code>no-resolv
strict-order
listen-address=127.0.0.1
port=53
conf-dir=/etc/dnsmasq.d/,*.conf
</code></pre></li>
<li><strong>设置默认国内DNS (<code>/etc/dnsmasq.d/upstream.conf</code>)</strong> - <strong>【关键修改】</strong>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 创建此文件，将114设为所有未匹配查询的默认DNS服务器</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;server=114.114.114.114&#34;</span> | sudo tee /etc/dnsmasq.d/upstream.conf
</span></span></code></pre></div></li>
<li><strong>国内域名白名单</strong> - <strong>【修正指导】</strong>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 只需下载，无需任何手动编辑</span>
</span></span><span style="display:flex;"><span>wget https://github.com/felixonmars/dnsmasq-china-list/raw/master/accelerated-domains.china.conf -O /etc/dnsmasq.d/accelerated-domains.china.conf
</span></span><span style="display:flex;"><span>wget https://github.com/felixonmars/dnsmasq-china-list/raw/master/bogus-nxdomain.china.conf -O /etc/dnsmasq.d/bogus-nxdomain.china.conf
</span></span></code></pre></div></li>
<li><strong>被墙黑名单 (<code>gfwlist.conf</code>)</strong> - (无变化):
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 此脚本会为gfwlist中的域名强制指定8.8.8.8作为DNS服务器</span>
</span></span><span style="display:flex;"><span>/usr/local/bin/gfwlist2dnsmasq.sh -s 8.8.8.8 -i gfwlist -o /etc/dnsmasq.d/gfwlist.conf
</span></span></code></pre></div></li>
<li><strong>系统DNS与重启</strong>:
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;nameserver 127.0.0.1&#34;</span> | sudo tee /etc/resolv.conf
</span></span><span style="display:flex;"><span>sudo systemctl restart dnsmasq
</span></span></code></pre></div></li>
<li><strong>新原理</strong>:
Dnsmasq现在以“黑名单”模式工作。<code>gfwlist.conf</code>中的域名被<strong>特殊规则</strong>强制导向<code>8.8.8.8</code>。而所有其他域名（包括国内和未知域名），由于没有匹配到特殊规则，都会回退使用我们在<code>upstream.conf</code>中设置的<strong>默认DNS</strong> <code>114.114.114.114</code>进行解析。</li>
</ul>
<h2 id="步骤4-配置ipsetip分流">步骤4: 配置ipset（IP分流）<a hidden class="anchor" aria-hidden="true" href="#步骤4-配置ipsetip分流">#</a></h2>
<p>此步骤的命令本身是正确的，它们用于在系统启动时或手动执行时创建 <code>ipset</code> 集合。</p>
<ul>
<li>创建：
<pre tabindex="0"><code>sudo ipset create china_ip hash:net
sudo ipset create gfwlist hash:ip
</code></pre></li>
<li>加载china_ip：
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 建议将此长命令放入自动化更新脚本中</span>
</span></span><span style="display:flex;"><span>wget -O - https://github.com/gaoyifan/china-operator-ip/raw/ip-lists/china.txt | sudo xargs -I <span style="color:#f92672">{}</span> ipset add china_ip <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span>sudo ipset add china_ip 114.114.114.114
</span></span></code></pre></div></li>
</ul>
<blockquote>
<p><strong>注意</strong>：<code>gfwlist</code> ipset 会由 <code>gfwlist2dnsmasq.sh</code> 脚本在运行时自动填充。</p>
</blockquote>
<h2 id="步骤5--6-配置iptables与政策路由---已整合">步骤5 &amp; 6: 配置iptables与政策路由 - 【已整合】<a hidden class="anchor" aria-hidden="true" href="#步骤5--6-配置iptables与政策路由---已整合">#</a></h2>
<p><strong>这两个步骤已被完全整合入步骤2的客户端WireGuard配置文件中</strong> (<code>PostUp</code>和<code>PreDown</code>部分)，实现了自动化管理，无需再手动执行或使用 <code>netfilter-persistent</code> 保存。</p>
<h2 id="步骤7-自动化更新">步骤7: 自动化更新<a hidden class="anchor" aria-hidden="true" href="#步骤7-自动化更新">#</a></h2>
<p>此脚本依然非常有用，用于定期更新域名和IP列表。</p>
<ul>
<li>脚本 (/usr/local/bin/update_lists.sh)：
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>set -e <span style="color:#75715e"># 遇到错误立即退出</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1. 更新Dnsmasq域名列表</span>
</span></span><span style="display:flex;"><span>wget -O /etc/dnsmasq.d/accelerated-domains.china.conf https://github.com/felixonmars/dnsmasq-china-list/raw/master/accelerated-domains.china.conf
</span></span><span style="display:flex;"><span>wget -O /etc/dnsmasq.d/bogus-nxdomain.china.conf https://github.com/felixonmars/dnsmasq-china-list/raw/master/bogus-nxdomain.china.conf
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 清空gfwlist ipset，让脚本重新填充</span>
</span></span><span style="display:flex;"><span>ipset flush gfwlist
</span></span><span style="display:flex;"><span>/usr/local/bin/gfwlist2dnsmasq.sh -s 8.8.8.8 -i gfwlist -o /etc/dnsmasq.d/gfwlist.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. 更新ipset IP列表</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用临时文件避免网络问题导致列表被清空</span>
</span></span><span style="display:flex;"><span>TMP_FILE<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>mktemp<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>wget -O <span style="color:#e6db74">&#34;</span>$TMP_FILE<span style="color:#e6db74">&#34;</span> https://github.com/gaoyifan/china-operator-ip/raw/ip-lists/china.txt
</span></span><span style="display:flex;"><span>ipset flush china_ip
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> read line; <span style="color:#66d9ef">do</span> ipset add china_ip $line; <span style="color:#66d9ef">done</span> &lt; <span style="color:#e6db74">&#34;</span>$TMP_FILE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>rm <span style="color:#e6db74">&#34;</span>$TMP_FILE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>ipset add china_ip 114.114.114.114
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. 重启Dnsmasq服务以应用新域名列表</span>
</span></span><span style="display:flex;"><span>systemctl restart dnsmasq
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Lists updated successfully.&#34;</span>
</span></span></code></pre></div></li>
<li>权限与定时任务：
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo chmod +x /usr/local/bin/update_lists.sh
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 编辑定时任务: sudo crontab -e</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加以下行，表示每天凌晨3点运行</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span> <span style="color:#ae81ff">3</span> * * * /usr/local/bin/update_lists.sh
</span></span></code></pre></div></li>
</ul>
<h2 id="步骤8-测试与优化---更新验证逻辑">步骤8: 测试与优化 - 【更新验证逻辑】<a hidden class="anchor" aria-hidden="true" href="#步骤8-测试与优化---更新验证逻辑">#</a></h2>
<ul>
<li><strong>DNS测试</strong>:
<ul>
<li><code>dig baidu.com @127.0.0.1</code>  # 应从<code>114.114.114.114</code>解析（直连）。</li>
<li><code>dig google.com @127.0.0.1</code>  # 应从<code>8.8.8.8</code>解析（走隧道）。</li>
<li><code>dig some-random-site.com @127.0.0.1</code> # 应从<code>114.114.114.114</code>解析（直连）。</li>
</ul>
</li>
<li><strong>流量测试</strong>:
<ul>
<li><code>curl ip.cn</code>  # 应显示<strong>本地</strong>公网IP（直连）。</li>
<li><code>curl ifconfig.me</code> # 应显示<strong>VPS</strong>的公网IP（走隧道）。</li>
<li><code>curl cip.cc</code> # 访问一个未知网站，应显示<strong>本地</strong>公网IP（直连）。</li>
</ul>
</li>
<li><strong>Kill Switch测试</strong>:
<ul>
<li>在客户端运行 <code>sudo wg-quick down wg0</code>。</li>
<li>此时，您应该<strong>无法</strong>访问 <code>google.com</code> (因为应走隧道的流量被阻断)，但<strong>依然可以</strong>访问 <code>baidu.com</code> (因为直连流量不受影响)。</li>
<li>运行 <code>sudo wg-quick up wg0</code> 即可恢复。</li>
</ul>
</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="//localhost:16893/">star徐的博客</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
