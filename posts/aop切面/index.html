<!doctype html><html lang=en dir=auto data-theme=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>AOPåˆ‡é¢(javaæ–°æ‰‹) | starå¾çš„åšå®¢</title><meta name=keywords content="Java,AOPåˆ‡é¢,Webå¼€å‘,åŸºç¡€ç¼–ç¨‹"><meta name=description content='AOPåˆ‡é¢(javaæ–°æ‰‹)
ğŸŒŸ ä¸€ã€ä¸ºä»€ä¹ˆè¦ç”¨ AOPï¼Ÿ
æƒ³è±¡ä¸€ä¸‹ï¼šä½ åœ¨å¼€å‘ä¸€ä¸ªç”µå•†ç½‘ç«™ï¼Œæœ‰å‡ åä¸ªæ¥å£ï¼Œæ¯”å¦‚

ç”¨æˆ·ç™»å½•
ä¸‹å•
æŸ¥çœ‹å•†å“
ä¿®æ”¹åœ°å€
æ”¯ä»˜è®¢å•

è¿™äº›åŠŸèƒ½éƒ½å±äºâ€œä¸šåŠ¡é€»è¾‘â€ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰ã€‚ä½†ä½ å‘ç°ï¼Œæ¯ä¸ªæ¥å£éƒ½éœ€è¦åšä¸¤ä»¶äº‹ï¼š

è®°å½•æ—¥å¿—ï¼ˆè°åœ¨ä»€ä¹ˆæ—¶å€™è°ƒç”¨äº†å“ªä¸ªæ¥å£ï¼Ÿï¼‰
æ£€æŸ¥ç”¨æˆ·æœ‰æ²¡æœ‰æƒé™ï¼ˆæ¯”å¦‚æ™®é€šç”¨æˆ·ä¸èƒ½åˆ åˆ«äººè®¢å•ï¼‰

å¦‚æœä¸ç”¨ AOPï¼Œä½ å¯èƒ½ä¼šåœ¨æ¯ä¸ªæ–¹æ³•é‡Œæ‰‹åŠ¨å†™æ—¥å¿—å’Œæƒé™æ£€æŸ¥ä»£ç ï¼Œåƒè¿™æ ·
é—®é¢˜æ¥äº†ï¼š

ä»£ç é‡å¤ï¼æ¯ä¸ªæ–¹æ³•éƒ½è¦å†™ä¸€æ ·çš„æ—¥å¿—å’Œæƒé™ã€‚
ä¸šåŠ¡é€»è¾‘è¢«â€œæ±¡æŸ“â€äº†ï¼Œçœ‹ä¸æ¸…æ ¸å¿ƒåŠŸèƒ½ã€‚
å¦‚æœå“ªå¤©è¦æ”¹æ—¥å¿—æ ¼å¼ï¼Ÿå¾—æ”¹å‡ åä¸ªåœ°æ–¹ï¼

ğŸ‘‰ AOP å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§â€œæ¨ªç€åˆ‡â€çš„å…¬å…±é—®é¢˜è€Œç”Ÿçš„ï¼
ğŸ‘‰ AOP å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§â€œæ¨ªç€åˆ‡â€çš„å…¬å…±é—®é¢˜è€Œç”Ÿçš„ï¼

âœ… AOP çš„æ ¸å¿ƒæ€æƒ³ï¼š
æŠŠé‚£äº›å’Œä¸šåŠ¡æ— å…³ä½†åˆåˆ°å¤„è¦ç”¨çš„åŠŸèƒ½ï¼ˆæ¯”å¦‚æ—¥å¿—ã€æƒé™ã€äº‹åŠ¡ã€é˜²é‡æäº¤ï¼‰æŠ½å‡ºæ¥ï¼Œå†™åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œè‡ªåŠ¨â€œç»‡å…¥â€åˆ°éœ€è¦çš„åœ°æ–¹ã€‚
ä¸šåŠ¡ä»£ç åªç®¡åšè‡ªå·±çš„äº‹ï¼Œå¹²å‡€æ¸…çˆ½ï¼

ğŸ§© äºŒã€æ€ä¹ˆç†è§£ AOPï¼Ÿç”¨ä¸¤ä¸ªçœŸå®ä¾‹å­
âœ… è‡ªåŠ¨è®°å½•æ¥å£æ—¥å¿—ï¼ˆæœ€å¸¸è§ï¼ï¼‰
åœºæ™¯ï¼š
ä½ æƒ³çŸ¥é“å“ªäº›ç”¨æˆ·è°ƒç”¨äº†å“ªäº›æ¥å£ã€èŠ±äº†å¤šé•¿æ—¶é—´ã€‚
ä¸ç”¨ AOPï¼ˆéº»çƒ¦ï¼‰ï¼š
æ¯ä¸ª Controller æ–¹æ³•é‡Œæ‰‹å†™ logger.info(...)ã€‚
ç”¨ AOPï¼ˆä¼˜é›…ï¼‰ï¼š

å®šä¹‰ä¸€ä¸ªâ€œåˆ‡é¢â€ç±»ï¼ˆä¸“é—¨å¤„ç†æ—¥å¿—ï¼‰ï¼š

@Aspect
@Component
public class LogAspect {

    private static final Logger logger = LoggerFactory.getLogger(LogAspect.class);

    // å®šä¹‰â€œåˆ‡å…¥ç‚¹â€ï¼šæ‰€æœ‰ Controller åŒ…ä¸‹çš„ public æ–¹æ³•
    @Pointcut("execution(public * com.example.controller..*.*(..))")
    public void controllerMethods() {}

    // åœ¨æ–¹æ³•æ‰§è¡Œå‰è®°å½•å¼€å§‹
    @Before("controllerMethods()")
    public void logBefore(JoinPoint joinPoint) {
        String methodName = joinPoint.getSignature().getName();
        Object[] args = joinPoint.getArgs();
        logger.info("è°ƒç”¨æ–¹æ³•: {}, å‚æ•°: {}", methodName, Arrays.toString(args));
    }

    // åœ¨æ–¹æ³•æ‰§è¡Œåè®°å½•è€—æ—¶
    @Around("controllerMethods()")
    public Object logTime(ProceedingJoinPoint joinPoint) throws Throwable {
        long start = System.currentTimeMillis();
        Object result = joinPoint.proceed(); // æ‰§è¡ŒåŸæ–¹æ³•
        long time = System.currentTimeMillis() - start;
        logger.info("æ–¹æ³• {} è€—æ—¶ {}ms", joinPoint.getSignature().getName(), time);
        return result;
    }
}

ä½ çš„ä¸šåŠ¡ä»£ç å®Œå…¨ä¸ç”¨æ”¹ï¼

@RestController
public class OrderController {
    @PostMapping("/order")
    public String createOrder(@RequestBody Order order) {
        // åªå†™ä¸šåŠ¡é€»è¾‘ï¼æ—¥å¿—è‡ªåŠ¨åŠ ä¸Šäº†
        orderService.save(order);
        return "success";
    }
}
âœ… æ•ˆæœï¼šåªè¦è°ƒç”¨ /orderï¼ŒAOP è‡ªåŠ¨å¸®ä½ æ‰“æ—¥å¿—ã€ç®—æ—¶é—´ï¼Œä¸šåŠ¡ä»£ç é›¶ä¾µå…¥ï¼'><meta name=author content="æ‚¨çš„å§“å"><link rel=canonical href=http://ljj1992.fun/posts/aop%E5%88%87%E9%9D%A2/><link crossorigin=anonymous href=/assets/css/stylesheet.343cc480b9ffc8f04ccbe5e968ad674880cab773ec19905e93033065c1e7a804.css integrity="sha256-NDzEgLn/yPBMy+XpaK1nSIDKt3PsGZBekwMwZcHnqAQ=" rel="preload stylesheet" as=style><link rel=icon href=http://ljj1992.fun/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://ljj1992.fun/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://ljj1992.fun/favicon-32x32.png><link rel=apple-touch-icon href=http://ljj1992.fun/apple-touch-icon.png><link rel=mask-icon href=http://ljj1992.fun/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://ljj1992.fun/posts/aop%E5%88%87%E9%9D%A2/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51);color-scheme:dark}.list{background:var(--theme)}.toc{background:var(--entry)}}@media(prefers-color-scheme:light){.list::-webkit-scrollbar-thumb{border-color:var(--code-bg)}}</style></noscript><script>localStorage.getItem("pref-theme")==="dark"?document.querySelector("html").dataset.theme="dark":localStorage.getItem("pref-theme")==="light"?document.querySelector("html").dataset.theme="light":window.matchMedia("(prefers-color-scheme: dark)").matches?document.querySelector("html").dataset.theme="dark":document.querySelector("html").dataset.theme="light"</script><meta property="og:url" content="http://ljj1992.fun/posts/aop%E5%88%87%E9%9D%A2/"><meta property="og:site_name" content="starå¾çš„åšå®¢"><meta property="og:title" content="AOPåˆ‡é¢(javaæ–°æ‰‹)"><meta property="og:description" content='AOPåˆ‡é¢(javaæ–°æ‰‹) ğŸŒŸ ä¸€ã€ä¸ºä»€ä¹ˆè¦ç”¨ AOPï¼Ÿ æƒ³è±¡ä¸€ä¸‹ï¼šä½ åœ¨å¼€å‘ä¸€ä¸ªç”µå•†ç½‘ç«™ï¼Œæœ‰å‡ åä¸ªæ¥å£ï¼Œæ¯”å¦‚
ç”¨æˆ·ç™»å½• ä¸‹å• æŸ¥çœ‹å•†å“ ä¿®æ”¹åœ°å€ æ”¯ä»˜è®¢å• è¿™äº›åŠŸèƒ½éƒ½å±äºâ€œä¸šåŠ¡é€»è¾‘â€ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰ã€‚ä½†ä½ å‘ç°ï¼Œæ¯ä¸ªæ¥å£éƒ½éœ€è¦åšä¸¤ä»¶äº‹ï¼š
è®°å½•æ—¥å¿—ï¼ˆè°åœ¨ä»€ä¹ˆæ—¶å€™è°ƒç”¨äº†å“ªä¸ªæ¥å£ï¼Ÿï¼‰ æ£€æŸ¥ç”¨æˆ·æœ‰æ²¡æœ‰æƒé™ï¼ˆæ¯”å¦‚æ™®é€šç”¨æˆ·ä¸èƒ½åˆ åˆ«äººè®¢å•ï¼‰ å¦‚æœä¸ç”¨ AOPï¼Œä½ å¯èƒ½ä¼šåœ¨æ¯ä¸ªæ–¹æ³•é‡Œæ‰‹åŠ¨å†™æ—¥å¿—å’Œæƒé™æ£€æŸ¥ä»£ç ï¼Œåƒè¿™æ ·
é—®é¢˜æ¥äº†ï¼š
ä»£ç é‡å¤ï¼æ¯ä¸ªæ–¹æ³•éƒ½è¦å†™ä¸€æ ·çš„æ—¥å¿—å’Œæƒé™ã€‚ ä¸šåŠ¡é€»è¾‘è¢«â€œæ±¡æŸ“â€äº†ï¼Œçœ‹ä¸æ¸…æ ¸å¿ƒåŠŸèƒ½ã€‚ å¦‚æœå“ªå¤©è¦æ”¹æ—¥å¿—æ ¼å¼ï¼Ÿå¾—æ”¹å‡ åä¸ªåœ°æ–¹ï¼ ğŸ‘‰ AOP å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§â€œæ¨ªç€åˆ‡â€çš„å…¬å…±é—®é¢˜è€Œç”Ÿçš„ï¼
ğŸ‘‰ AOP å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§â€œæ¨ªç€åˆ‡â€çš„å…¬å…±é—®é¢˜è€Œç”Ÿçš„ï¼
âœ… AOP çš„æ ¸å¿ƒæ€æƒ³ï¼š æŠŠé‚£äº›å’Œä¸šåŠ¡æ— å…³ä½†åˆåˆ°å¤„è¦ç”¨çš„åŠŸèƒ½ï¼ˆæ¯”å¦‚æ—¥å¿—ã€æƒé™ã€äº‹åŠ¡ã€é˜²é‡æäº¤ï¼‰æŠ½å‡ºæ¥ï¼Œå†™åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œè‡ªåŠ¨â€œç»‡å…¥â€åˆ°éœ€è¦çš„åœ°æ–¹ã€‚ ä¸šåŠ¡ä»£ç åªç®¡åšè‡ªå·±çš„äº‹ï¼Œå¹²å‡€æ¸…çˆ½ï¼
ğŸ§© äºŒã€æ€ä¹ˆç†è§£ AOPï¼Ÿç”¨ä¸¤ä¸ªçœŸå®ä¾‹å­ âœ… è‡ªåŠ¨è®°å½•æ¥å£æ—¥å¿—ï¼ˆæœ€å¸¸è§ï¼ï¼‰ åœºæ™¯ï¼š ä½ æƒ³çŸ¥é“å“ªäº›ç”¨æˆ·è°ƒç”¨äº†å“ªäº›æ¥å£ã€èŠ±äº†å¤šé•¿æ—¶é—´ã€‚
ä¸ç”¨ AOPï¼ˆéº»çƒ¦ï¼‰ï¼š æ¯ä¸ª Controller æ–¹æ³•é‡Œæ‰‹å†™ logger.info(...)ã€‚
ç”¨ AOPï¼ˆä¼˜é›…ï¼‰ï¼š å®šä¹‰ä¸€ä¸ªâ€œåˆ‡é¢â€ç±»ï¼ˆä¸“é—¨å¤„ç†æ—¥å¿—ï¼‰ï¼š @Aspect @Component public class LogAspect { private static final Logger logger = LoggerFactory.getLogger(LogAspect.class); // å®šä¹‰â€œåˆ‡å…¥ç‚¹â€ï¼šæ‰€æœ‰ Controller åŒ…ä¸‹çš„ public æ–¹æ³• @Pointcut("execution(public * com.example.controller..*.*(..))") public void controllerMethods() {} // åœ¨æ–¹æ³•æ‰§è¡Œå‰è®°å½•å¼€å§‹ @Before("controllerMethods()") public void logBefore(JoinPoint joinPoint) { String methodName = joinPoint.getSignature().getName(); Object[] args = joinPoint.getArgs(); logger.info("è°ƒç”¨æ–¹æ³•: {}, å‚æ•°: {}", methodName, Arrays.toString(args)); } // åœ¨æ–¹æ³•æ‰§è¡Œåè®°å½•è€—æ—¶ @Around("controllerMethods()") public Object logTime(ProceedingJoinPoint joinPoint) throws Throwable { long start = System.currentTimeMillis(); Object result = joinPoint.proceed(); // æ‰§è¡ŒåŸæ–¹æ³• long time = System.currentTimeMillis() - start; logger.info("æ–¹æ³• {} è€—æ—¶ {}ms", joinPoint.getSignature().getName(), time); return result; } } ä½ çš„ä¸šåŠ¡ä»£ç å®Œå…¨ä¸ç”¨æ”¹ï¼ @RestController public class OrderController { @PostMapping("/order") public String createOrder(@RequestBody Order order) { // åªå†™ä¸šåŠ¡é€»è¾‘ï¼æ—¥å¿—è‡ªåŠ¨åŠ ä¸Šäº† orderService.save(order); return "success"; } } âœ… æ•ˆæœï¼šåªè¦è°ƒç”¨ /orderï¼ŒAOP è‡ªåŠ¨å¸®ä½ æ‰“æ—¥å¿—ã€ç®—æ—¶é—´ï¼Œä¸šåŠ¡ä»£ç é›¶ä¾µå…¥ï¼'><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-11-23T18:30:00+08:00"><meta property="article:modified_time" content="2025-11-23T18:30:00+08:00"><meta property="article:tag" content="Java"><meta property="article:tag" content="AOPåˆ‡é¢"><meta property="article:tag" content="Webå¼€å‘"><meta property="article:tag" content="åŸºç¡€ç¼–ç¨‹"><meta name=twitter:card content="summary"><meta name=twitter:title content="AOPåˆ‡é¢(javaæ–°æ‰‹)"><meta name=twitter:description content='AOPåˆ‡é¢(javaæ–°æ‰‹)
ğŸŒŸ ä¸€ã€ä¸ºä»€ä¹ˆè¦ç”¨ AOPï¼Ÿ
æƒ³è±¡ä¸€ä¸‹ï¼šä½ åœ¨å¼€å‘ä¸€ä¸ªç”µå•†ç½‘ç«™ï¼Œæœ‰å‡ åä¸ªæ¥å£ï¼Œæ¯”å¦‚

ç”¨æˆ·ç™»å½•
ä¸‹å•
æŸ¥çœ‹å•†å“
ä¿®æ”¹åœ°å€
æ”¯ä»˜è®¢å•

è¿™äº›åŠŸèƒ½éƒ½å±äºâ€œä¸šåŠ¡é€»è¾‘â€ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰ã€‚ä½†ä½ å‘ç°ï¼Œæ¯ä¸ªæ¥å£éƒ½éœ€è¦åšä¸¤ä»¶äº‹ï¼š

è®°å½•æ—¥å¿—ï¼ˆè°åœ¨ä»€ä¹ˆæ—¶å€™è°ƒç”¨äº†å“ªä¸ªæ¥å£ï¼Ÿï¼‰
æ£€æŸ¥ç”¨æˆ·æœ‰æ²¡æœ‰æƒé™ï¼ˆæ¯”å¦‚æ™®é€šç”¨æˆ·ä¸èƒ½åˆ åˆ«äººè®¢å•ï¼‰

å¦‚æœä¸ç”¨ AOPï¼Œä½ å¯èƒ½ä¼šåœ¨æ¯ä¸ªæ–¹æ³•é‡Œæ‰‹åŠ¨å†™æ—¥å¿—å’Œæƒé™æ£€æŸ¥ä»£ç ï¼Œåƒè¿™æ ·
é—®é¢˜æ¥äº†ï¼š

ä»£ç é‡å¤ï¼æ¯ä¸ªæ–¹æ³•éƒ½è¦å†™ä¸€æ ·çš„æ—¥å¿—å’Œæƒé™ã€‚
ä¸šåŠ¡é€»è¾‘è¢«â€œæ±¡æŸ“â€äº†ï¼Œçœ‹ä¸æ¸…æ ¸å¿ƒåŠŸèƒ½ã€‚
å¦‚æœå“ªå¤©è¦æ”¹æ—¥å¿—æ ¼å¼ï¼Ÿå¾—æ”¹å‡ åä¸ªåœ°æ–¹ï¼

ğŸ‘‰ AOP å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§â€œæ¨ªç€åˆ‡â€çš„å…¬å…±é—®é¢˜è€Œç”Ÿçš„ï¼
ğŸ‘‰ AOP å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§â€œæ¨ªç€åˆ‡â€çš„å…¬å…±é—®é¢˜è€Œç”Ÿçš„ï¼

âœ… AOP çš„æ ¸å¿ƒæ€æƒ³ï¼š
æŠŠé‚£äº›å’Œä¸šåŠ¡æ— å…³ä½†åˆåˆ°å¤„è¦ç”¨çš„åŠŸèƒ½ï¼ˆæ¯”å¦‚æ—¥å¿—ã€æƒé™ã€äº‹åŠ¡ã€é˜²é‡æäº¤ï¼‰æŠ½å‡ºæ¥ï¼Œå†™åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œè‡ªåŠ¨â€œç»‡å…¥â€åˆ°éœ€è¦çš„åœ°æ–¹ã€‚
ä¸šåŠ¡ä»£ç åªç®¡åšè‡ªå·±çš„äº‹ï¼Œå¹²å‡€æ¸…çˆ½ï¼

ğŸ§© äºŒã€æ€ä¹ˆç†è§£ AOPï¼Ÿç”¨ä¸¤ä¸ªçœŸå®ä¾‹å­
âœ… è‡ªåŠ¨è®°å½•æ¥å£æ—¥å¿—ï¼ˆæœ€å¸¸è§ï¼ï¼‰
åœºæ™¯ï¼š
ä½ æƒ³çŸ¥é“å“ªäº›ç”¨æˆ·è°ƒç”¨äº†å“ªäº›æ¥å£ã€èŠ±äº†å¤šé•¿æ—¶é—´ã€‚
ä¸ç”¨ AOPï¼ˆéº»çƒ¦ï¼‰ï¼š
æ¯ä¸ª Controller æ–¹æ³•é‡Œæ‰‹å†™ logger.info(...)ã€‚
ç”¨ AOPï¼ˆä¼˜é›…ï¼‰ï¼š

å®šä¹‰ä¸€ä¸ªâ€œåˆ‡é¢â€ç±»ï¼ˆä¸“é—¨å¤„ç†æ—¥å¿—ï¼‰ï¼š

@Aspect
@Component
public class LogAspect {

    private static final Logger logger = LoggerFactory.getLogger(LogAspect.class);

    // å®šä¹‰â€œåˆ‡å…¥ç‚¹â€ï¼šæ‰€æœ‰ Controller åŒ…ä¸‹çš„ public æ–¹æ³•
    @Pointcut("execution(public * com.example.controller..*.*(..))")
    public void controllerMethods() {}

    // åœ¨æ–¹æ³•æ‰§è¡Œå‰è®°å½•å¼€å§‹
    @Before("controllerMethods()")
    public void logBefore(JoinPoint joinPoint) {
        String methodName = joinPoint.getSignature().getName();
        Object[] args = joinPoint.getArgs();
        logger.info("è°ƒç”¨æ–¹æ³•: {}, å‚æ•°: {}", methodName, Arrays.toString(args));
    }

    // åœ¨æ–¹æ³•æ‰§è¡Œåè®°å½•è€—æ—¶
    @Around("controllerMethods()")
    public Object logTime(ProceedingJoinPoint joinPoint) throws Throwable {
        long start = System.currentTimeMillis();
        Object result = joinPoint.proceed(); // æ‰§è¡ŒåŸæ–¹æ³•
        long time = System.currentTimeMillis() - start;
        logger.info("æ–¹æ³• {} è€—æ—¶ {}ms", joinPoint.getSignature().getName(), time);
        return result;
    }
}

ä½ çš„ä¸šåŠ¡ä»£ç å®Œå…¨ä¸ç”¨æ”¹ï¼

@RestController
public class OrderController {
    @PostMapping("/order")
    public String createOrder(@RequestBody Order order) {
        // åªå†™ä¸šåŠ¡é€»è¾‘ï¼æ—¥å¿—è‡ªåŠ¨åŠ ä¸Šäº†
        orderService.save(order);
        return "success";
    }
}
âœ… æ•ˆæœï¼šåªè¦è°ƒç”¨ /orderï¼ŒAOP è‡ªåŠ¨å¸®ä½ æ‰“æ—¥å¿—ã€ç®—æ—¶é—´ï¼Œä¸šåŠ¡ä»£ç é›¶ä¾µå…¥ï¼'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://ljj1992.fun/posts/"},{"@type":"ListItem","position":2,"name":"AOPåˆ‡é¢(javaæ–°æ‰‹)","item":"http://ljj1992.fun/posts/aop%E5%88%87%E9%9D%A2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"AOPåˆ‡é¢(javaæ–°æ‰‹)","name":"AOPåˆ‡é¢(javaæ–°æ‰‹)","description":"AOPåˆ‡é¢(javaæ–°æ‰‹) ğŸŒŸ ä¸€ã€ä¸ºä»€ä¹ˆè¦ç”¨ AOPï¼Ÿ æƒ³è±¡ä¸€ä¸‹ï¼šä½ åœ¨å¼€å‘ä¸€ä¸ªç”µå•†ç½‘ç«™ï¼Œæœ‰å‡ åä¸ªæ¥å£ï¼Œæ¯”å¦‚\nç”¨æˆ·ç™»å½• ä¸‹å• æŸ¥çœ‹å•†å“ ä¿®æ”¹åœ°å€ æ”¯ä»˜è®¢å• è¿™äº›åŠŸèƒ½éƒ½å±äºâ€œä¸šåŠ¡é€»è¾‘â€ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰ã€‚ä½†ä½ å‘ç°ï¼Œæ¯ä¸ªæ¥å£éƒ½éœ€è¦åšä¸¤ä»¶äº‹ï¼š\nè®°å½•æ—¥å¿—ï¼ˆè°åœ¨ä»€ä¹ˆæ—¶å€™è°ƒç”¨äº†å“ªä¸ªæ¥å£ï¼Ÿï¼‰ æ£€æŸ¥ç”¨æˆ·æœ‰æ²¡æœ‰æƒé™ï¼ˆæ¯”å¦‚æ™®é€šç”¨æˆ·ä¸èƒ½åˆ åˆ«äººè®¢å•ï¼‰ å¦‚æœä¸ç”¨ AOPï¼Œä½ å¯èƒ½ä¼šåœ¨æ¯ä¸ªæ–¹æ³•é‡Œæ‰‹åŠ¨å†™æ—¥å¿—å’Œæƒé™æ£€æŸ¥ä»£ç ï¼Œåƒè¿™æ ·\né—®é¢˜æ¥äº†ï¼š\nä»£ç é‡å¤ï¼æ¯ä¸ªæ–¹æ³•éƒ½è¦å†™ä¸€æ ·çš„æ—¥å¿—å’Œæƒé™ã€‚ ä¸šåŠ¡é€»è¾‘è¢«â€œæ±¡æŸ“â€äº†ï¼Œçœ‹ä¸æ¸…æ ¸å¿ƒåŠŸèƒ½ã€‚ å¦‚æœå“ªå¤©è¦æ”¹æ—¥å¿—æ ¼å¼ï¼Ÿå¾—æ”¹å‡ åä¸ªåœ°æ–¹ï¼ ğŸ‘‰ AOP å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§â€œæ¨ªç€åˆ‡â€çš„å…¬å…±é—®é¢˜è€Œç”Ÿçš„ï¼\nğŸ‘‰ AOP å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§â€œæ¨ªç€åˆ‡â€çš„å…¬å…±é—®é¢˜è€Œç”Ÿçš„ï¼\nâœ… AOP çš„æ ¸å¿ƒæ€æƒ³ï¼š æŠŠé‚£äº›å’Œä¸šåŠ¡æ— å…³ä½†åˆåˆ°å¤„è¦ç”¨çš„åŠŸèƒ½ï¼ˆæ¯”å¦‚æ—¥å¿—ã€æƒé™ã€äº‹åŠ¡ã€é˜²é‡æäº¤ï¼‰æŠ½å‡ºæ¥ï¼Œå†™åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œè‡ªåŠ¨â€œç»‡å…¥â€åˆ°éœ€è¦çš„åœ°æ–¹ã€‚ ä¸šåŠ¡ä»£ç åªç®¡åšè‡ªå·±çš„äº‹ï¼Œå¹²å‡€æ¸…çˆ½ï¼\nğŸ§© äºŒã€æ€ä¹ˆç†è§£ AOPï¼Ÿç”¨ä¸¤ä¸ªçœŸå®ä¾‹å­ âœ… è‡ªåŠ¨è®°å½•æ¥å£æ—¥å¿—ï¼ˆæœ€å¸¸è§ï¼ï¼‰ åœºæ™¯ï¼š ä½ æƒ³çŸ¥é“å“ªäº›ç”¨æˆ·è°ƒç”¨äº†å“ªäº›æ¥å£ã€èŠ±äº†å¤šé•¿æ—¶é—´ã€‚\nä¸ç”¨ AOPï¼ˆéº»çƒ¦ï¼‰ï¼š æ¯ä¸ª Controller æ–¹æ³•é‡Œæ‰‹å†™ logger.info(...)ã€‚\nç”¨ AOPï¼ˆä¼˜é›…ï¼‰ï¼š å®šä¹‰ä¸€ä¸ªâ€œåˆ‡é¢â€ç±»ï¼ˆä¸“é—¨å¤„ç†æ—¥å¿—ï¼‰ï¼š @Aspect @Component public class LogAspect { private static final Logger logger = LoggerFactory.getLogger(LogAspect.class); // å®šä¹‰â€œåˆ‡å…¥ç‚¹â€ï¼šæ‰€æœ‰ Controller åŒ…ä¸‹çš„ public æ–¹æ³• @Pointcut(\u0026#34;execution(public * com.example.controller..*.*(..))\u0026#34;) public void controllerMethods() {} // åœ¨æ–¹æ³•æ‰§è¡Œå‰è®°å½•å¼€å§‹ @Before(\u0026#34;controllerMethods()\u0026#34;) public void logBefore(JoinPoint joinPoint) { String methodName = joinPoint.getSignature().getName(); Object[] args = joinPoint.getArgs(); logger.info(\u0026#34;è°ƒç”¨æ–¹æ³•: {}, å‚æ•°: {}\u0026#34;, methodName, Arrays.toString(args)); } // åœ¨æ–¹æ³•æ‰§è¡Œåè®°å½•è€—æ—¶ @Around(\u0026#34;controllerMethods()\u0026#34;) public Object logTime(ProceedingJoinPoint joinPoint) throws Throwable { long start = System.currentTimeMillis(); Object result = joinPoint.proceed(); // æ‰§è¡ŒåŸæ–¹æ³• long time = System.currentTimeMillis() - start; logger.info(\u0026#34;æ–¹æ³• {} è€—æ—¶ {}ms\u0026#34;, joinPoint.getSignature().getName(), time); return result; } } ä½ çš„ä¸šåŠ¡ä»£ç å®Œå…¨ä¸ç”¨æ”¹ï¼ @RestController public class OrderController { @PostMapping(\u0026#34;/order\u0026#34;) public String createOrder(@RequestBody Order order) { // åªå†™ä¸šåŠ¡é€»è¾‘ï¼æ—¥å¿—è‡ªåŠ¨åŠ ä¸Šäº† orderService.save(order); return \u0026#34;success\u0026#34;; } } âœ… æ•ˆæœï¼šåªè¦è°ƒç”¨ /orderï¼ŒAOP è‡ªåŠ¨å¸®ä½ æ‰“æ—¥å¿—ã€ç®—æ—¶é—´ï¼Œä¸šåŠ¡ä»£ç é›¶ä¾µå…¥ï¼\n","keywords":["Java","AOPåˆ‡é¢","Webå¼€å‘","åŸºç¡€ç¼–ç¨‹"],"articleBody":"AOPåˆ‡é¢(javaæ–°æ‰‹) ğŸŒŸ ä¸€ã€ä¸ºä»€ä¹ˆè¦ç”¨ AOPï¼Ÿ æƒ³è±¡ä¸€ä¸‹ï¼šä½ åœ¨å¼€å‘ä¸€ä¸ªç”µå•†ç½‘ç«™ï¼Œæœ‰å‡ åä¸ªæ¥å£ï¼Œæ¯”å¦‚\nç”¨æˆ·ç™»å½• ä¸‹å• æŸ¥çœ‹å•†å“ ä¿®æ”¹åœ°å€ æ”¯ä»˜è®¢å• è¿™äº›åŠŸèƒ½éƒ½å±äºâ€œä¸šåŠ¡é€»è¾‘â€ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰ã€‚ä½†ä½ å‘ç°ï¼Œæ¯ä¸ªæ¥å£éƒ½éœ€è¦åšä¸¤ä»¶äº‹ï¼š\nè®°å½•æ—¥å¿—ï¼ˆè°åœ¨ä»€ä¹ˆæ—¶å€™è°ƒç”¨äº†å“ªä¸ªæ¥å£ï¼Ÿï¼‰ æ£€æŸ¥ç”¨æˆ·æœ‰æ²¡æœ‰æƒé™ï¼ˆæ¯”å¦‚æ™®é€šç”¨æˆ·ä¸èƒ½åˆ åˆ«äººè®¢å•ï¼‰ å¦‚æœä¸ç”¨ AOPï¼Œä½ å¯èƒ½ä¼šåœ¨æ¯ä¸ªæ–¹æ³•é‡Œæ‰‹åŠ¨å†™æ—¥å¿—å’Œæƒé™æ£€æŸ¥ä»£ç ï¼Œåƒè¿™æ ·\né—®é¢˜æ¥äº†ï¼š\nä»£ç é‡å¤ï¼æ¯ä¸ªæ–¹æ³•éƒ½è¦å†™ä¸€æ ·çš„æ—¥å¿—å’Œæƒé™ã€‚ ä¸šåŠ¡é€»è¾‘è¢«â€œæ±¡æŸ“â€äº†ï¼Œçœ‹ä¸æ¸…æ ¸å¿ƒåŠŸèƒ½ã€‚ å¦‚æœå“ªå¤©è¦æ”¹æ—¥å¿—æ ¼å¼ï¼Ÿå¾—æ”¹å‡ åä¸ªåœ°æ–¹ï¼ ğŸ‘‰ AOP å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§â€œæ¨ªç€åˆ‡â€çš„å…¬å…±é—®é¢˜è€Œç”Ÿçš„ï¼\nğŸ‘‰ AOP å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§â€œæ¨ªç€åˆ‡â€çš„å…¬å…±é—®é¢˜è€Œç”Ÿçš„ï¼\nâœ… AOP çš„æ ¸å¿ƒæ€æƒ³ï¼š æŠŠé‚£äº›å’Œä¸šåŠ¡æ— å…³ä½†åˆåˆ°å¤„è¦ç”¨çš„åŠŸèƒ½ï¼ˆæ¯”å¦‚æ—¥å¿—ã€æƒé™ã€äº‹åŠ¡ã€é˜²é‡æäº¤ï¼‰æŠ½å‡ºæ¥ï¼Œå†™åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œè‡ªåŠ¨â€œç»‡å…¥â€åˆ°éœ€è¦çš„åœ°æ–¹ã€‚ ä¸šåŠ¡ä»£ç åªç®¡åšè‡ªå·±çš„äº‹ï¼Œå¹²å‡€æ¸…çˆ½ï¼\nğŸ§© äºŒã€æ€ä¹ˆç†è§£ AOPï¼Ÿç”¨ä¸¤ä¸ªçœŸå®ä¾‹å­ âœ… è‡ªåŠ¨è®°å½•æ¥å£æ—¥å¿—ï¼ˆæœ€å¸¸è§ï¼ï¼‰ åœºæ™¯ï¼š ä½ æƒ³çŸ¥é“å“ªäº›ç”¨æˆ·è°ƒç”¨äº†å“ªäº›æ¥å£ã€èŠ±äº†å¤šé•¿æ—¶é—´ã€‚\nä¸ç”¨ AOPï¼ˆéº»çƒ¦ï¼‰ï¼š æ¯ä¸ª Controller æ–¹æ³•é‡Œæ‰‹å†™ logger.info(...)ã€‚\nç”¨ AOPï¼ˆä¼˜é›…ï¼‰ï¼š å®šä¹‰ä¸€ä¸ªâ€œåˆ‡é¢â€ç±»ï¼ˆä¸“é—¨å¤„ç†æ—¥å¿—ï¼‰ï¼š @Aspect @Component public class LogAspect { private static final Logger logger = LoggerFactory.getLogger(LogAspect.class); // å®šä¹‰â€œåˆ‡å…¥ç‚¹â€ï¼šæ‰€æœ‰ Controller åŒ…ä¸‹çš„ public æ–¹æ³• @Pointcut(\"execution(public * com.example.controller..*.*(..))\") public void controllerMethods() {} // åœ¨æ–¹æ³•æ‰§è¡Œå‰è®°å½•å¼€å§‹ @Before(\"controllerMethods()\") public void logBefore(JoinPoint joinPoint) { String methodName = joinPoint.getSignature().getName(); Object[] args = joinPoint.getArgs(); logger.info(\"è°ƒç”¨æ–¹æ³•: {}, å‚æ•°: {}\", methodName, Arrays.toString(args)); } // åœ¨æ–¹æ³•æ‰§è¡Œåè®°å½•è€—æ—¶ @Around(\"controllerMethods()\") public Object logTime(ProceedingJoinPoint joinPoint) throws Throwable { long start = System.currentTimeMillis(); Object result = joinPoint.proceed(); // æ‰§è¡ŒåŸæ–¹æ³• long time = System.currentTimeMillis() - start; logger.info(\"æ–¹æ³• {} è€—æ—¶ {}ms\", joinPoint.getSignature().getName(), time); return result; } } ä½ çš„ä¸šåŠ¡ä»£ç å®Œå…¨ä¸ç”¨æ”¹ï¼ @RestController public class OrderController { @PostMapping(\"/order\") public String createOrder(@RequestBody Order order) { // åªå†™ä¸šåŠ¡é€»è¾‘ï¼æ—¥å¿—è‡ªåŠ¨åŠ ä¸Šäº† orderService.save(order); return \"success\"; } } âœ… æ•ˆæœï¼šåªè¦è°ƒç”¨ /orderï¼ŒAOP è‡ªåŠ¨å¸®ä½ æ‰“æ—¥å¿—ã€ç®—æ—¶é—´ï¼Œä¸šåŠ¡ä»£ç é›¶ä¾µå…¥ï¼\nçœ‹æ‡‚ AOP æ˜¯æ€ä¹ˆè¿è¡Œçš„ ğŸŒŸ å…ˆè¯´æ¸…æ¥šï¼šAOP åˆ°åº•æ˜¯æ€ä¹ˆâ€œæ’è¿›å»â€çš„ï¼Ÿ\nğŸ”‘ æ ¸å¿ƒåŸç†ä¸€å¥è¯ï¼š Spring åœ¨å¯åŠ¨æ—¶ï¼Œä¼šå·å·æŠŠä½ çš„ä¸šåŠ¡ç±»ï¼ˆæ¯”å¦‚ OrderControllerï¼‰æ›¿æ¢æˆä¸€ä¸ªâ€œä»£ç†å¯¹è±¡â€ã€‚ å½“ä½ è°ƒç”¨ createOrder() æ—¶ï¼Œå…¶å®å…ˆæ‰§è¡Œçš„æ˜¯ AOP é‡Œçš„ä»£ç ï¼Œç„¶åå†å»è°ƒçœŸæ­£çš„ä¸šåŠ¡æ–¹æ³•ã€‚\nè¿™å°±åƒä½ ç‚¹å¤–å–ï¼š\nä½ ä»¥ä¸ºç›´æ¥è”ç³»å¨å¸ˆï¼ˆä¸šåŠ¡æ–¹æ³•ï¼‰ å…¶å®ä¸­é—´æœ‰ä¸ªâ€œæ™ºèƒ½å‰å°â€ï¼ˆä»£ç†å¯¹è±¡ï¼‰ï¼šå…ˆæ£€æŸ¥ä½ æ˜¯ä¸æ˜¯ä¼šå‘˜ï¼ˆæƒé™ï¼‰ã€è®°å½•ä½ ç‚¹äº†ä»€ä¹ˆï¼ˆæ—¥å¿—ï¼‰ï¼Œå†é€šçŸ¥å¨æˆ¿åšèœ ç°åœ¨æˆ‘ä»¬æ¥é€è¡Œè§£è¯»ä¸¤ä¸ªä¾‹å­ã€‚\nâœ… è‡ªåŠ¨è®°å½•æ¥å£æ—¥å¿—ï¼ˆé€è¡Œè¯¦è§£ï¼‰ ç¬¬ä¸€æ­¥ï¼šå®šä¹‰åˆ‡é¢ç±»ï¼ˆLogAspect.javaï¼‰\n@Aspect @Component public class LogAspect { @Aspectï¼šå‘Šè¯‰ Springï¼šâ€œæˆ‘æ˜¯ä¸€ä¸ªåˆ‡é¢ç±»ï¼Œé‡Œé¢è£…çš„æ˜¯æ¨ªåˆ‡é€»è¾‘ï¼ˆæ¯”å¦‚æ—¥å¿—ï¼‰â€ @Componentï¼šè®© Spring èƒ½æ‰«æåˆ°è¿™ä¸ªç±»ï¼Œå¹¶æŠŠå®ƒæ”¾è¿›å®¹å™¨é‡Œï¼ˆå¦åˆ™ä¸ä¼šç”Ÿæ•ˆï¼‰ ğŸ’¡ å°±åƒä½ å‘Šè¯‰å…¬å¸ï¼šâ€œæˆ‘æ˜¯ä¸“é—¨è´Ÿè´£æ‰“å¡è€ƒå‹¤çš„äººâ€ï¼Œå…¬å¸æ‰ä¼šè®©ä½ ä¸Šå²—ã€‚\n@Pointcut(\"execution(public * com.example.controller..*.*(..))\") public void controllerMethods() {} @Pointcutï¼šå®šä¹‰â€œåœ¨å“ªäº›åœ°æ–¹æ’å…¥é€»è¾‘â€\nè¡¨è¾¾å¼å«ä¹‰ï¼ˆå¤§ç™½è¯ï¼‰ï¼š\nexecution(...)ï¼šåŒ¹é…æ–¹æ³•æ‰§è¡Œ\npublic *ï¼šä»»æ„è¿”å›å€¼çš„ public æ–¹æ³•\ncom.example.controller..*.*(..) com.example.controllerï¼šåŒ…å ..ï¼šåŒ…æ‹¬æ‰€æœ‰å­åŒ…ï¼ˆæ¯”å¦‚ controller.user, controller.orderï¼‰ *.*(..)ï¼šä»»æ„ç±»çš„ä»»æ„æ–¹æ³•ï¼Œä»»æ„å‚æ•° âœ… è¿™å¥è¯çš„æ„æ€æ˜¯ï¼šæ‰€æœ‰ Controller åŒ…ä¸‹çš„ public æ–¹æ³•ï¼Œéƒ½æ˜¯æˆ‘çš„ç›®æ ‡ï¼\nğŸ’¡ è¿™ä¸ªæ–¹æ³•æœ¬èº«æ˜¯ç©ºçš„ï¼Œåªæ˜¯ä¸ªâ€œæ ‡è®°â€ï¼Œæ–¹ä¾¿åé¢å¼•ç”¨ï¼Œå°±åƒç»™ä¸€å †é—¨è´´ä¸Šâ€œçº¢è‰²æ ‡ç­¾â€ï¼Œåé¢è¯´â€œæ‰€æœ‰çº¢æ ‡ç­¾çš„é—¨éƒ½è¦æ£€æŸ¥â€ã€‚\n@Before(\"controllerMethods()\") public void logBefore(JoinPoint joinPoint) { String methodName = joinPoint.getSignature().getName(); Object[] args = joinPoint.getArgs(); logger.info(\"è°ƒç”¨æ–¹æ³•: {}, å‚æ•°: {}\", methodName, Arrays.toString(args)); } @Before(\"controllerMethods()\")ï¼šåœ¨â€œçº¢æ ‡ç­¾çš„é—¨â€è¢«æ‰“å¼€ä¹‹å‰ï¼Œæ‰§è¡Œè¿™ä¸ªæ–¹æ³•\nJoinPoint joinPointï¼šä»£è¡¨â€œå½“å‰æ­£åœ¨è¢«è°ƒç”¨çš„é‚£ä¸ªæ–¹æ³•â€çš„ä¸Šä¸‹æ–‡ä¿¡æ¯\njoinPoint.getSignature().getName() â†’ è·å–æ–¹æ³•åï¼Œæ¯”å¦‚ \"createOrder\"\njoinPoint.getArgs() â†’ è·å–ä¼ å…¥çš„å‚æ•°ï¼Œæ¯”å¦‚ [Order{id=1, userId=123}]\nâœ… æ•ˆæœï¼šç”¨æˆ·ä¸€è°ƒæ¥å£ï¼Œç«‹åˆ»æ‰“å°ï¼š è°ƒç”¨æ–¹æ³•: createOrder, å‚æ•°: [Order{id=1, userId=123}]\nğŸ’¡ å°±åƒé—¨å«åœ¨ä½ è¿›é—¨æ—¶é—®ï¼šâ€œä½ æ˜¯è°ï¼Ÿæ¥å¹²å˜›ï¼Ÿâ€ç„¶åè®°åœ¨æœ¬å­ä¸Šã€‚\n@Around(\"controllerMethods()\") public Object logTime(ProceedingJoinPoint joinPoint) throws Throwable { long start = System.currentTimeMillis(); Object result = joinPoint.proceed(); // â­ å…³é”®ï¼æ‰§è¡ŒçœŸæ­£çš„ä¸šåŠ¡æ–¹æ³• long time = System.currentTimeMillis() - start; logger.info(\"æ–¹æ³• {} è€—æ—¶ {}ms\", joinPoint.getSignature().getName(), time); return result; } @Aroundï¼šç¯ç»•é€šçŸ¥â€”â€”æœ€å¼ºå¤§çš„é€šçŸ¥ç±»å‹ï¼Œå¯ä»¥åœ¨æ–¹æ³•å‰åéƒ½å¹²æ´»\nProceedingJoinPointï¼šæ˜¯ JoinPoint çš„å‡çº§ç‰ˆï¼Œå¤šäº† .proceed() æ–¹æ³•\njoinPoint.proceed()ï¼šçœŸæ­£å»è°ƒç”¨åŸå§‹çš„ä¸šåŠ¡æ–¹æ³•ï¼ˆæ¯”å¦‚ orderService.save(order)ï¼‰\nâ€‹ è¿™è¡Œä»£ç ä¹‹å‰ï¼šç›¸å½“äºâ€œå‰ç½®é€šçŸ¥â€\nâ€‹ è¿™è¡Œä»£ç ä¹‹åï¼šç›¸å½“äºâ€œåç½®é€šçŸ¥â€\nâœ… æ‰§è¡Œæµç¨‹ï¼š\nè®°å½•å¼€å§‹æ—¶é—´ æ‰§è¡ŒçœŸæ­£çš„ createOrder() è®¡ç®—è€—æ—¶ æ‰“å°æ—¥å¿— æŠŠä¸šåŠ¡æ–¹æ³•çš„è¿”å›å€¼åŸæ ·è¿”å›ï¼ˆä¸èƒ½ä¸¢ï¼ï¼‰ ğŸ’¡ å°±åƒå¿«é€’å‘˜é€åŒ…è£¹ï¼š\nå…ˆæ‰«ç ç™»è®°ï¼ˆè®°å½•å¼€å§‹ï¼‰ ç„¶åçœŸçš„å»é€è´§ï¼ˆproceedï¼‰ é€åˆ°åå›ä¼ ç­¾æ”¶å•ï¼ˆreturn resultï¼‰ åŒæ—¶è®°å½•ç”¨äº†å¤šä¹… éªŒè¯æµ‹è¯•ç»“æœ ğŸ§ª åœºæ™¯å›é¡¾ ä½ æœ‰è¿™æ ·ä¸€ä¸ª Controllerï¼š\n@RestController public class OrderController { private final Logger logger = LoggerFactory.getLogger(OrderController.class); @PostMapping(\"/order\") public String createOrder(@RequestBody Order order) { // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†ï¼šæ¯”å¦‚ä¿å­˜è®¢å• logger.info(\"ã€ä¸šåŠ¡å±‚ã€‘æ­£åœ¨ä¿å­˜è®¢å•: {}\", order); return \"è®¢å•åˆ›å»ºæˆåŠŸï¼\"; } } åŒæ—¶ï¼Œä½ æœ‰ä¸€ä¸ª AOP åˆ‡é¢ç±»ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š\n@Aspect @Component public class LogAspect { private static final Logger logger = LoggerFactory.getLogger(LogAspect.class); @Pointcut(\"execution(public * com.example.controller..*.*(..))\") public void controllerMethods() {} @Before(\"controllerMethods()\") public void logBefore(JoinPoint joinPoint) { String methodName = joinPoint.getSignature().getName(); Object[] args = joinPoint.getArgs(); logger.info(\"\u003e\u003e\u003e [AOPå‰ç½®] è°ƒç”¨æ–¹æ³•: {}, å‚æ•°: {}\", methodName, Arrays.toString(args)); } @Around(\"controllerMethods()\") public Object logTime(ProceedingJoinPoint joinPoint) throws Throwable { long start = System.currentTimeMillis(); logger.info(\"\u003e\u003e\u003e [AOPç¯ç»•å¼€å§‹] å‡†å¤‡æ‰§è¡Œæ–¹æ³•: {}\", joinPoint.getSignature().getName()); // â­ å…³é”®ï¼šçœŸæ­£æ‰§è¡Œ createOrder() Object result = joinPoint.proceed(); long time = System.currentTimeMillis() - start; logger.info(\"\u003e\u003e\u003e [AOPç¯ç»•ç»“æŸ] æ–¹æ³• {} æ‰§è¡Œå®Œæ¯•ï¼Œè€—æ—¶: {} ms\", joinPoint.getSignature().getName(), time); return result; } } ğŸ’¡ æ³¨æ„ï¼š@Before å’Œ @Around åŒæ—¶å­˜åœ¨æ—¶ï¼Œ@Around ä¼šåŒ…è£¹ @Beforeï¼ˆå› ä¸º @Around æ˜¯æœ€å¤–å±‚çš„ä»£ç†é€»è¾‘ï¼‰ã€‚\nğŸ–¥ï¸ å‡è®¾ä½ å‘é€ä¸€ä¸ªè¯·æ±‚ï¼š POST http://localhost:8080/order Content-Type: application/json { \"userId\": 1001, \"productId\": 2002, \"amount\": 99.9 } âœ… ç¨‹åºæ‰§è¡Œé¡ºåº + æ§åˆ¶å°è¾“å‡ºï¼ˆé€è¡Œï¼‰ å½“ Spring Boot æ”¶åˆ°è¿™ä¸ªè¯·æ±‚ï¼Œä¼šå‘ç”Ÿä»¥ä¸‹äº‹æƒ…ï¼š\nç¬¬ä¸€æ­¥ï¼šè¿›å…¥ @Aroundï¼ˆæœ€å¤–å±‚ï¼‰ \u003e\u003e\u003e [AOPç¯ç»•å¼€å§‹] å‡†å¤‡æ‰§è¡Œæ–¹æ³•: createOrder ç¬¬äºŒæ­¥ï¼šæ‰§è¡Œ @Before \u003e\u003e\u003e [AOPå‰ç½®] è°ƒç”¨æ–¹æ³•: createOrder, å‚æ•°: [Order(userId=1001, productId=2002, amount=99.9)] ğŸ” å‚æ•°æ˜¾ç¤ºçš„æ˜¯ Order å¯¹è±¡çš„ toString() ç»“æœã€‚å¦‚æœä½ æ²¡é‡å†™ toString()ï¼Œå¯èƒ½æ˜¾ç¤ºç±»ä¼¼ com.example.Order@1a2b3cã€‚å»ºè®®ç»™ Order åŠ  Lombok çš„ @Data æˆ–æ‰‹åŠ¨é‡å†™ toString()ã€‚\nç¬¬ä¸‰æ­¥ï¼šæ‰§è¡ŒçœŸæ­£çš„ä¸šåŠ¡æ–¹æ³• createOrder() ã€ä¸šåŠ¡å±‚ã€‘æ­£åœ¨ä¿å­˜è®¢å•: Order(userId=1001, productId=2002, amount=99.9) ç¬¬å››æ­¥ï¼šå›åˆ° @Aroundï¼Œè®°å½•è€—æ—¶å¹¶è¿”å› \u003e\u003e\u003e [AOPç¯ç»•ç»“æŸ] æ–¹æ³• createOrder æ‰§è¡Œå®Œæ¯•ï¼Œè€—æ—¶: 15 ms ğŸ’¡ è€—æ—¶æ˜¯æ¨¡æ‹Ÿå€¼ï¼Œå®é™…å¯èƒ½æ˜¯å‡ æ¯«ç§’åˆ°å‡ åæ¯«ç§’ã€‚\nğŸ“‹ æœ€ç»ˆå®Œæ•´æ§åˆ¶å°è¾“å‡ºï¼ˆæŒ‰é¡ºåºï¼‰ \u003e\u003e\u003e [AOPç¯ç»•å¼€å§‹] å‡†å¤‡æ‰§è¡Œæ–¹æ³•: createOrder \u003e\u003e\u003e [AOPå‰ç½®] è°ƒç”¨æ–¹æ³•: createOrder, å‚æ•°: [Order(userId=1001, productId=2002, amount=99.9)] ã€ä¸šåŠ¡å±‚ã€‘æ­£åœ¨ä¿å­˜è®¢å•: Order(userId=1001, productId=2002, amount=99.9) \u003e\u003e\u003e [AOPç¯ç»•ç»“æŸ] æ–¹æ³• createOrder æ‰§è¡Œå®Œæ¯•ï¼Œè€—æ—¶: 15 ms åŒæ—¶ï¼ŒHTTP æ¥å£ä¼šæ­£å¸¸è¿”å›ï¼š\n\"è®¢å•åˆ›å»ºæˆåŠŸï¼\" ğŸ¯ å…³é”®ç»“è®º AOP çš„æ—¥å¿—å…ˆäºä¸šåŠ¡ä»£ç æ‰“å° â†’ è¯´æ˜å®ƒç¡®å®åœ¨â€œå‰é¢â€æ‹¦æˆªäº†ã€‚ ä¸šåŠ¡é€»è¾‘å®Œå…¨ä¸å—å½±å“ â†’ è¯¥ä¿å­˜è®¢å•è¿˜æ˜¯ä¿å­˜ï¼Œè¯¥è¿”å›ç»“æœè¿˜æ˜¯è¿”å›ã€‚ ä½ ä¸ç”¨åœ¨æ¯ä¸ªæ–¹æ³•é‡Œå†™æ—¥å¿— â†’ åªè¦æ–¹æ³•åœ¨ controller åŒ…ä¸‹ï¼Œè‡ªåŠ¨ç”Ÿæ•ˆï¼ æ€§èƒ½ç›‘æ§ä¹Ÿè‡ªåŠ¨å®Œæˆ â†’ è€—æ—¶ç›´æ¥ç®—å‡ºæ¥äº†ï¼Œå¯ç”¨äºæŠ¥è­¦æˆ–ä¼˜åŒ–ã€‚ ğŸ’¡ å°è´´å£«ï¼ˆé¿å…è¸©å‘ï¼‰ å¦‚æœæ²¡çœ‹åˆ° AOP æ—¥å¿—ï¼Ÿæ£€æŸ¥ï¼š åˆ‡é¢ç±»æ˜¯å¦åŠ äº† @Component Spring Boot ä¸»å¯åŠ¨ç±»æ˜¯å¦æ‰«æåˆ°äº†åˆ‡é¢åŒ…ï¼ˆé€šå¸¸é»˜è®¤æ‰«æä¸»ç±»æ‰€åœ¨åŒ…åŠå­åŒ…ï¼‰ æ–¹æ³•æ˜¯ä¸æ˜¯ publicï¼ˆSpring AOP é»˜è®¤åªä»£ç† public æ–¹æ³•ï¼‰ ä¸æƒ³ç”¨ @Before + @Around ä¸¤ä¸ªï¼Ÿå…¶å®åªç”¨ @Around å°±å¤Ÿäº†ï¼Œå®ƒèƒ½å¹²æ‰€æœ‰äº‹ï¼ æˆ‘çš„ç–‘é—®ï¼šä¸ºä»€ä¹ˆ @Around æ¯” @Before å…ˆæ‰§è¡Œï¼Ÿ âœ… ç®€çŸ­ç­”æ¡ˆï¼š ä¸æ˜¯ @Around æ¯” @Before â€œå…ˆæ‰§è¡Œâ€ï¼Œè€Œæ˜¯ @Around åŒ…è£¹äº† @Before å’Œä¸šåŠ¡æ–¹æ³•ã€‚ æ§åˆ¶å°çœ‹èµ·æ¥ @Around çš„â€œå¼€å§‹æ—¥å¿—â€å…ˆæ‰“å°ï¼Œæ˜¯å› ä¸ºå®ƒåœ¨æœ€å¤–å±‚ã€‚\nğŸ§  è¯¦ç»†è§£é‡Šï¼ˆå…³é”®ï¼ï¼‰ Spring AOP çš„åº•å±‚æ˜¯é€šè¿‡ ä»£ç†æ¨¡å¼ å®ç°çš„ã€‚å½“ä¸€ä¸ªæ–¹æ³•åŒæ—¶è¢« @Before å’Œ @Around åˆ‡å…¥æ—¶ï¼ŒSpring åªä¼šç”Ÿæˆä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œè€Œè¿™ä¸ªä»£ç†çš„é€»è¾‘ç»“æ„æ˜¯è¿™æ ·çš„ï¼š\n// ä¼ªä»£ç ï¼šSpring ç”Ÿæˆçš„ä»£ç†é€»è¾‘ public Object createOrderProxy(Order order) { // â€”â€”â€”â€”â€”â€”â€”â€” @Around çš„å¼€å¤´ â€”â€”â€”â€”â€”â€”â€”â€” log(\"\u003e\u003e\u003e [AOPç¯ç»•å¼€å§‹] å‡†å¤‡æ‰§è¡Œæ–¹æ³•: createOrder\"); try { // â€”â€”â€”â€”â€”â€”â€”â€” æ‰§è¡Œæ‰€æœ‰ @Before â€”â€”â€”â€”â€”â€”â€”â€” log(\"\u003e\u003e\u003e [AOPå‰ç½®] è°ƒç”¨æ–¹æ³•: createOrder, å‚æ•°: ...\"); // â€”â€”â€”â€”â€”â€”â€”â€” æ‰§è¡ŒçœŸæ­£çš„ä¸šåŠ¡æ–¹æ³• â€”â€”â€”â€”â€”â€”â€”â€” Object result = realTarget.createOrder(order); // â€”â€”â€”â€”â€”â€”â€”â€” æ‰§è¡Œ @AfterReturningï¼ˆå¦‚æœæœ‰ï¼‰â€”â€”â€”â€” return result; } finally { // â€”â€”â€”â€”â€”â€”â€”â€” @Around çš„ç»“å°¾ â€”â€”â€”â€”â€”â€”â€”â€” log(\"\u003e\u003e\u003e [AOPç¯ç»•ç»“æŸ] æ–¹æ³• createOrder è€—æ—¶: ... ms\"); } } æ‰€ä»¥å®é™…æ‰§è¡Œé¡ºåºæ˜¯ï¼š\n@Around å¼€å§‹éƒ¨åˆ† â†“ @Before â†“ çœŸæ­£çš„ä¸šåŠ¡æ–¹æ³•ï¼ˆcreateOrderï¼‰ â†“ @After / @AfterReturningï¼ˆå¦‚æœæœ‰ï¼‰ â†“ @Around ç»“æŸéƒ¨åˆ† âœ… å› æ­¤ï¼š\n@Around çš„ ç¬¬ä¸€è¡Œä»£ç ï¼ˆè®°å½•å¼€å§‹æ—¶é—´ï¼‰æœ€å…ˆæ‰§è¡Œ â†’ æ‰€ä»¥ä½ çœ‹åˆ°å®ƒå…ˆæ‰“å°ã€‚ ä½† @Before æ˜¯åœ¨ @Around å†…éƒ¨ã€ä¸šåŠ¡æ–¹æ³•ä¹‹å‰æ‰§è¡Œçš„ã€‚ ğŸ”¸ ç±»æ¯”ï¼š ä½ ç‚¹å¤–å–ï¼š\néª‘æ‰‹ï¼ˆ@Aroundï¼‰å…ˆè¯´ï¼šâ€œæˆ‘å‡ºå‘å»å–é¤äº†ï¼â€ï¼ˆæ‰“å°å¼€å§‹ï¼‰ åˆ°åº—åï¼Œåº—å‘˜ï¼ˆ@Beforeï¼‰è¯´ï¼šâ€œå·²æ¥å•ï¼Œæ­£åœ¨æ‰“åŒ…ï¼â€ å¨å¸ˆï¼ˆä¸šåŠ¡æ–¹æ³•ï¼‰å¼€å§‹ç‚’èœ éª‘æ‰‹æ‹¿åˆ°é¤åè¯´ï¼šâ€œé€é¤å®Œæˆï¼Œå…±ç”¨æ—¶25åˆ†é’Ÿï¼â€ï¼ˆæ‰“å°ç»“æŸï¼‰ æ‰€ä»¥ä¸æ˜¯è°â€œä¼˜å…ˆçº§é«˜â€ï¼Œè€Œæ˜¯ @Around æ˜¯ä¸€ä¸ªâ€œå¤§ç›’å­â€ï¼ŒæŠŠ @Before å’Œä¸šåŠ¡ä»£ç éƒ½è£…è¿›å»äº†ã€‚\nâœ… é˜²æ­¢é‡å¤æäº¤ï¼ˆå¹‚ç­‰æ€§æ§åˆ¶ï¼‰ åœºæ™¯ï¼š ç”¨æˆ·ç‹‚ç‚¹â€œæ”¯ä»˜â€æŒ‰é’®ï¼Œå¯èƒ½é€ æˆé‡å¤æ‰£æ¬¾ï¼ä½ éœ€è¦5ç§’å†…åŒä¸€ä¸ªç”¨æˆ·+åŒä¸€ä¸ªå•†å“åªèƒ½ä¸‹å•ä¸€æ¬¡ã€‚\nä½ éœ€è¦å€ŸåŠ© Spring çš„ SpELï¼ˆSpring Expression Languageï¼‰å¼•æ“ æ¥è§£æè¡¨è¾¾å¼\næ­¥éª¤ 1ï¼šåˆ›å»ºä¸€ä¸ªå·¥å…·ç±»ï¼ˆæ¨èï¼‰ import org.springframework.core.LocalVariableTableParameterNameDiscoverer; import org.springframework.expression.ExpressionParser; import org.springframework.expression.spel.standard.SpelExpressionParser; import org.springframework.expression.spel.support.StandardEvaluationContext; public class SpelUtil { private static final ExpressionParser PARSER = new SpelExpressionParser(); private static final LocalVariableTableParameterNameDiscoverer NAME_DISCOVERER = new LocalVariableTableParameterNameDiscoverer(); public static String parse(String spel, Object[] args, Class\u003c?\u003e targetClass) { if (spel == null || spel.isEmpty()) { return \"\"; } // è·å–æ–¹æ³•å‚æ•°åï¼ˆæ¯”å¦‚ order, userIdï¼‰ String[] paramNames = NAME_DISCOVERER.getParameterNames(targetClass.getDeclaredMethods()[0]); // ç®€åŒ–ç‰ˆï¼Œå®é™…éœ€åŒ¹é…æ–¹æ³• // åˆ›å»ºä¸Šä¸‹æ–‡ StandardEvaluationContext context = new StandardEvaluationContext(); for (int i = 0; i \u003c args.length; i++) { context.setVariable(paramNames[i], args[i]); } // è§£æè¡¨è¾¾å¼ return PARSER.parseExpression(spel).getValue(context, String.class); } } ğŸ’¡ ä½†ä¸Šé¢ä»£ç æœ‰ç¼ºé™·ï¼ˆæ–¹æ³•åŒ¹é…ä¸å‡†ç¡®ï¼‰ï¼Œæ›´ç¨³å¦¥çš„åšæ³•æ˜¯ç»“åˆ AOP çš„ MethodSignatureã€‚\næ­¥éª¤ 2ï¼šåœ¨åˆ‡é¢ä¸­æ­£ç¡®ä½¿ç”¨ï¼ˆå®Œæ•´å¯è¿è¡Œç‰ˆï¼‰ @Aspect @Component public class IdempotentAspect { @Autowired private RedisTemplate\u003cString, String\u003e redisTemplate; @Around(\"@annotation(idempotent)\") public Object checkIdempotent(ProceedingJoinPoint joinPoint, Idempotent idempotent) throws Throwable { // 1. è·å–æ–¹æ³•ç­¾å MethodSignature signature = (MethodSignature) joinPoint.getSignature(); Method method = signature.getMethod(); // 2. è·å–å‚æ•°åï¼ˆéœ€è¦ç¼–è¯‘æ—¶ä¿ç•™å‚æ•°åï¼šJava 8+ é»˜è®¤å¼€å¯ï¼Œæˆ–åŠ  -parametersï¼‰ String[] paramNames = signature.getParameterNames(); Object[] args = joinPoint.getArgs(); // 3. æ„å»º SpEL ä¸Šä¸‹æ–‡ StandardEvaluationContext context = new StandardEvaluationContext(); for (int i = 0; i \u003c paramNames.length; i++) { context.setVariable(paramNames[i], args[i]); } // 4. è§£æè¡¨è¾¾å¼ï¼Œå¾—åˆ°çœŸå® key String keyExpression = idempotent.key(); // å¦‚ \"#order.userId + '-' + #order.productId\" String realKey = new SpelExpressionParser() .parseExpression(keyExpression) .getValue(context, String.class); // 5. æ„é€  Redis é” key String lockKey = \"idempotent:\" + realKey; // 6. å°è¯•åŠ é” Boolean isSet = redisTemplate.opsForValue() .setIfAbsent(lockKey, \"1\", idempotent.expire(), TimeUnit.SECONDS); if (Boolean.TRUE.equals(isSet)) { return joinPoint.proceed(); } else { throw new RuntimeException(\"è¯·å‹¿é‡å¤æäº¤ï¼\"); } } } ğŸ§ª ä¸¾ä¸ªå®é™…è¿è¡Œä¾‹å­ ä½ çš„ Controllerï¼š\n@PostMapping(\"/comment\") @Idempotent(key = \"#userId + '-' + #productId\", expire = 10) public String addComment( @RequestParam Long userId, @RequestParam Long productId, @RequestBody String content) { // ä¸šåŠ¡é€»è¾‘ } ç”¨æˆ·è¯·æ±‚ï¼š\nPOST /comment?userId=1001\u0026productId=2002 Body: \"å¾ˆå¥½ï¼\" åˆ‡é¢æ‰§è¡Œæ—¶ï¼š\nkeyExpression = \"#userId + '-' + #productId\" paramNames = [\"userId\", \"productId\", \"content\"] args = [1001L, 2002L, \"å¾ˆå¥½ï¼\"] SpEL è§£æåï¼šrealKey = \"1001-2002\" lockKey = \"idempotent:1001-2002\" âœ… å®Œç¾å®ç°â€œåŒä¸€ç”¨æˆ·å¯¹åŒä¸€å•†å“10ç§’å†…åªèƒ½è¯„è®ºä¸€æ¬¡â€\né€è¡Œè§£é‡Š ğŸ§© æ•´ä½“ç›®æ ‡ æˆ‘ä»¬è¦å®ç°ä¸€ä¸ªåŠŸèƒ½ï¼š\nå½“ç”¨æˆ·è°ƒç”¨ /comment æ¥å£æ—¶ï¼Œå¦‚æœçŸ­æ—¶é—´å†…é‡å¤æäº¤ï¼ˆæ¯”å¦‚è¿ç»­ç‚¹ä¸¤æ¬¡æŒ‰é’®ï¼‰ï¼Œç³»ç»Ÿåªå¤„ç†ä¸€æ¬¡ï¼Œç¬¬äºŒæ¬¡å°±æç¤ºâ€œè¯·å‹¿é‡å¤æäº¤â€ã€‚\nä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ï¼š\nAOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰ï¼šåœ¨æ–¹æ³•æ‰§è¡Œå‰åæ’å…¥é€»è¾‘ã€‚ SpELï¼ˆSpring Expression Languageï¼‰ï¼šåŠ¨æ€ä»æ–¹æ³•å‚æ•°ä¸­æå–æ•°æ®æ‹¼æˆå”¯ä¸€ keyã€‚ Redisï¼šç”¨å®ƒåšåˆ†å¸ƒå¼é”ï¼Œç¡®ä¿åŒä¸€ä¸ªè¯·æ±‚ä¸ä¼šè¢«é‡å¤å¤„ç†ã€‚ ç¬¬ä¸€éƒ¨åˆ†ï¼šSpelUtil.javaï¼ˆå·¥å…·ç±»ï¼‰ import org.springframework.core.LocalVariableTableParameterNameDiscoverer; import org.springframework.expression.ExpressionParser; import org.springframework.expression.spel.standard.SpelExpressionParser; import org.springframework.expression.spel.support.StandardEvaluationContext; âœ… å¤§ç™½è¯ï¼š\nè¿™äº›æ˜¯ Spring æä¾›çš„â€œå·¥å…·åŒ…â€ï¼Œç”¨æ¥ï¼š\nè·å–æ–¹æ³•çš„å‚æ•°åå­—ï¼ˆæ¯”å¦‚ userIdã€productIdï¼‰ è§£æåƒ \"#userId + '-' + #productId\" è¿™æ ·çš„è¡¨è¾¾å¼ åˆ›å»ºä¸€ä¸ªâ€œå˜é‡å®¹å™¨â€ï¼ŒæŠŠå‚æ•°å€¼æ”¾è¿›å»ï¼Œè®©è¡¨è¾¾å¼èƒ½è¯»åˆ° âœ… è¯­æ³•åŸç†ï¼š\nLocalVariableTableParameterNameDiscovererï¼šé€šè¿‡ Java å­—èŠ‚ç è·å–æ–¹æ³•å‚æ•°åï¼ˆéœ€è¦ç¼–è¯‘æ—¶ä¿ç•™å‚æ•°åï¼ŒJava 8+ é»˜è®¤æ”¯æŒï¼‰ã€‚ SpelExpressionParserï¼šSpring çš„è¡¨è¾¾å¼è§£æå™¨ï¼Œèƒ½ç†è§£ #xxx è¿™ç§å†™æ³•ã€‚ StandardEvaluationContextï¼šè¡¨è¾¾å¼è¿è¡Œæ—¶çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œç›¸å½“äºä¸€ä¸ªâ€œå˜é‡è¡¨â€ã€‚ 1ã€public class SpelUtil public class SpelUtil { private static final ExpressionParser PARSER = new SpelExpressionParser(); private static final LocalVariableTableParameterNameDiscoverer NAME_DISCOVERER = new LocalVariableTableParameterNameDiscoverer(); âœ… å¤§ç™½è¯ï¼š\nåˆ›å»ºä¸¤ä¸ªâ€œä¸‡èƒ½å·¥å…·â€ï¼š\nä¸€ä¸ªå« PARSERï¼Œä¸“é—¨è´Ÿè´£â€œè¯»æ‡‚â€åƒ #userId + '-' + #productId è¿™æ ·çš„å­—ç¬¦ä¸²ã€‚ ä¸€ä¸ªå« NAME_DISCOVERERï¼Œä¸“é—¨è´Ÿè´£â€œçŒœå‡ºâ€æ–¹æ³•çš„å‚æ•°å«ä»€ä¹ˆåå­—ï¼ˆæ¯”å¦‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸æ˜¯å« userIdï¼‰ã€‚ å®ƒä»¬éƒ½æ˜¯ static finalï¼Œæ„æ€æ˜¯æ•´ä¸ªç¨‹åºåªç”¨ä¸€ä»½ï¼Œçœèµ„æºã€‚\nğŸ§© ç¬¬ä¸€è¡Œï¼špublic class SpelUtil\nğŸ’¬ å¤§ç™½è¯ï¼š\nè¿™æ˜¯ä¸€ä¸ªå« SpelUtil çš„â€œå·¥å…·ç®±â€ï¼Œä¸“é—¨ç”¨æ¥å¤„ç† Spring è¡¨è¾¾å¼ï¼ˆSpELï¼‰ç›¸å…³çš„äº‹æƒ…ã€‚ æ¯”å¦‚ï¼šæŠŠ \"#userId + '-' + #productId\" è¿™ç§å­—ç¬¦ä¸²å˜æˆçœŸæ­£çš„å€¼ã€‚\nå°±åƒä½ æœ‰ä¸€ä¸ªâ€œè®¡ç®—å™¨å·¥å…·ç±»â€ï¼Œåˆ«äººå¯ä»¥ç›´æ¥æ‹¿æ¥ç®—è¡¨è¾¾å¼ï¼Œä¸ç”¨è‡ªå·±ä»å¤´å†™ã€‚\nğŸ”¬ è¯­æ³•åŸç†ï¼š\npublicï¼šå…¬å¼€ç±»ï¼Œå…¶ä»–åŒ…ä¹Ÿèƒ½ç”¨ã€‚ class SpelUtilï¼šå®šä¹‰ä¸€ä¸ªæ™®é€š Java ç±»ã€‚ å‘½åä¹ æƒ¯ï¼šä»¥ Util ç»“å°¾ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸ªå·¥å…·ç±»ï¼ˆé€šå¸¸åªåŒ…å«é™æ€æ–¹æ³•ï¼Œä¸å®ä¾‹åŒ–ï¼‰ã€‚ ğŸ§© ç¬¬äºŒè¡Œï¼šprivate static final ExpressionParser PARSER = new SpelExpressionParser();\næˆ‘ä»¬æ‹†æˆå‡ ä¸ªå…³é”®è¯æ¥çœ‹ï¼š\nâœ… private\nåªæœ‰è¿™ä¸ªç±»å†…éƒ¨èƒ½è®¿é—®ï¼Œå¤–é¢ä¸èƒ½ç›´æ¥è°ƒç”¨ PARSERã€‚ ç¬¦åˆå°è£…åŸåˆ™ï¼šå·¥å…·çš„â€œé›¶ä»¶â€ä¸æš´éœ²ç»™ç”¨æˆ·ã€‚ âœ… static\nå±äºç±»æœ¬èº«ï¼Œä¸å±äºæŸä¸ªå¯¹è±¡ã€‚ æ•´ä¸ªç¨‹åºè¿è¡ŒæœŸé—´ï¼Œåªåˆ›å»ºä¸€ä»½ PARSERã€‚ è°ƒç”¨æ—¶ä¸ç”¨ new SpelUtil()ï¼Œç›´æ¥é€šè¿‡ç±»åéšå¼ä½¿ç”¨ï¼ˆå› ä¸ºæ˜¯ç§æœ‰çš„ï¼Œå…¶å®å¤–éƒ¨ä¹Ÿçœ‹ä¸åˆ°ï¼‰ã€‚ ğŸŒ° æ¯”å¦‚ï¼šå…¨å…¬å¸å…±ç”¨ä¸€å°æ‰“å°æœºï¼Œä¸æ˜¯æ¯äººä¹°ä¸€å°ã€‚\nâœ… final\nè¿™ä¸ªå˜é‡ä¸€æ—¦èµ‹å€¼ï¼Œå°±ä¸èƒ½å†æ”¹äº†ã€‚ é˜²æ­¢ä¸å°å¿ƒè¢«è¦†ç›–ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨ï¼ˆå› ä¸ºå®ƒæ˜¯æ— çŠ¶æ€çš„ï¼Œå¯ä»¥å®‰å…¨å…±äº«ï¼‰ã€‚ âœ… ExpressionParser PARSER\nExpressionParser æ˜¯ Spring æä¾›çš„æ¥å£ï¼Œä»£è¡¨â€œè¡¨è¾¾å¼è§£æå™¨â€ã€‚ PARSER æ˜¯å˜é‡åï¼Œå…¨å¤§å†™æ˜¯å¸¸é‡å‘½åä¹ æƒ¯ï¼ˆè™½ç„¶ Java æ²¡å¼ºåˆ¶ï¼Œä½†å¤§å®¶éƒ½è¿™ä¹ˆå†™ï¼‰ã€‚ âœ… new SpelExpressionParser()\nåˆ›å»ºä¸€ä¸ªå…·ä½“çš„è§£æå™¨å®ä¾‹ã€‚ SpelExpressionParser æ˜¯ Spring å®ç° ExpressionParser æ¥å£çš„ç±»ï¼Œä¸“é—¨è§£æ SpELï¼ˆSpring Expression Languageï¼‰ è¡¨è¾¾å¼ã€‚ ğŸ¯ å®ƒèƒ½ç†è§£ï¼š\n#name\n#order.price \u003e 100\n'Hello ' + #user.name\nT(java.lang.Math).random()ï¼ˆè°ƒç”¨é™æ€æ–¹æ³•ï¼‰\nï¼‰\nğŸ’¬ æ•´ä½“å¤§ç™½è¯æ€»ç»“è¿™è¡Œï¼š\nâ€œæˆ‘å‡†å¤‡äº†ä¸€ä¸ªä¸‡èƒ½çš„â€˜è¡¨è¾¾å¼ç¿»è¯‘å®˜â€™ï¼Œå« PARSERï¼Œå®ƒä¸€è¾ˆå­å°±å¹²ä¸€ä»¶äº‹ï¼šæŠŠåƒ #userId + '-' + #productId è¿™æ ·çš„å­—ç¬¦ä¸²ï¼Œç¿»è¯‘æˆçœŸæ­£çš„å€¼ã€‚â€\nè€Œä¸”è¿™ä¸ªç¿»è¯‘å®˜æ˜¯ï¼š\nå…¨å±€å”¯ä¸€çš„ï¼ˆstaticï¼‰ ä¸ä¼šè¢«æ¢æ‰ï¼ˆfinalï¼‰ åˆ«äººçœ‹ä¸è§ï¼ˆprivateï¼‰ï¼Œåªèƒ½é€šè¿‡æˆ‘æä¾›çš„æ–¹æ³•é—´æ¥ä½¿ç”¨ ğŸ§© ç¬¬ä¸‰è¡Œï¼šprivate static final LocalVariableTableParameterNameDiscoverer NAME_DISCOVERER = ...\nåŒæ ·æ‹†è§£ï¼š\nâœ… LocalVariableTableParameterNameDiscoverer\nè¿™æ˜¯ Spring æä¾›çš„ä¸€ä¸ªå‚æ•°åå‘ç°å™¨ã€‚\nğŸ’¬ å¤§ç™½è¯ï¼š\nâ€œæˆ‘æƒ³çŸ¥é“æŸä¸ªæ–¹æ³•çš„å‚æ•°åˆ°åº•å«ä»€ä¹ˆåå­—ï¼Œæ¯”å¦‚æ˜¯å« userId è¿˜æ˜¯ uidï¼Ÿ ä½† Java ç¼–è¯‘åï¼Œé»˜è®¤ä¼šæŠŠå‚æ•°åå˜æˆ arg0, arg1â€¦â€¦ è¿™ä¸ªå·¥å…·èƒ½ä»å­—èŠ‚ç é‡Œâ€˜æŒ–å‡ºâ€™åŸå§‹çš„å‚æ•°åï¼â€\nğŸ”¬ æŠ€æœ¯ç»†èŠ‚ï¼š\nå®ƒé€šè¿‡è¯»å– .class æ–‡ä»¶ä¸­çš„ LocalVariableTableï¼ˆæœ¬åœ°å˜é‡è¡¨ï¼‰æ¥è·å–çœŸå®å‚æ•°åã€‚ å‰æï¼šç¼–è¯‘æ—¶å¿…é¡»ä¿ç•™è°ƒè¯•ä¿¡æ¯ï¼ˆJava 8+ é»˜è®¤å¼€å¯ï¼Œæˆ–æ˜¾å¼åŠ  -g æˆ– -parametersï¼‰ã€‚ å¦‚æœæ²¡ä¿ç•™ï¼Œå®ƒä¼šè¿”å› nullï¼ âš ï¸ æ‰€ä»¥è¿™ä¸ªå·¥å…·ä¸å¯é â€”â€”è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä½ åœ¨ AOP ä¸­åº”è¯¥ç”¨ MethodSignature.getParameterNames()ï¼Œè€Œä¸æ˜¯å®ƒï¼\nâœ… NAME_DISCOVERER\nå˜é‡åï¼Œæ„æ€æ˜¯â€œå‚æ•°åå‘ç°è€…â€ã€‚ åŒæ ·æ˜¯ private static finalï¼šå…¨å±€å”¯ä¸€ã€ä¸å¯å˜ã€å†…éƒ¨ä½¿ç”¨ã€‚ ğŸ’¬ æ•´ä½“å¤§ç™½è¯æ€»ç»“è¿™è¡Œï¼š\nâ€œæˆ‘è¿˜å‡†å¤‡äº†ä¸€ä¸ªâ€˜è€ƒå¤å­¦å®¶â€™ï¼Œå« NAME_DISCOVERERï¼Œå®ƒçš„ä»»åŠ¡æ˜¯ä»ç¼–è¯‘åçš„ä»£ç é‡Œï¼ŒæŠŠæ–¹æ³•å‚æ•°çš„åŸå§‹åå­—â€˜æŒ–â€™å‡ºæ¥ï¼Œæ¯”å¦‚ userIdã€productIdã€‚â€\nä½†è¦æ³¨æ„ï¼š\nè¿™ä¸ªâ€œè€ƒå¤å­¦å®¶â€æœ‰æ—¶å€™ä¼šç©ºæ‰‹è€Œå½’ï¼ˆå¦‚æœç¼–è¯‘æ—¶æ²¡ç•™çº¿ç´¢ï¼‰ï¼\n2ã€public static String parse() public static String parse(String spel, Object[] args, Class\u003c?\u003e targetClass) { if (spel == null || spel.isEmpty()) { return \"\"; } âœ… å¤§ç™½è¯ï¼š\nè¿™æ˜¯ä¸€ä¸ªå·¥å…·æ–¹æ³•ï¼Œè¾“å…¥ï¼š\nä¸€æ®µè¡¨è¾¾å¼ï¼ˆæ¯”å¦‚ \"#userId + '-' + #productId\"ï¼‰ æ–¹æ³•çš„å®é™…å‚æ•°å€¼ï¼ˆæ¯”å¦‚ [1001, 2002]ï¼‰ æ–¹æ³•æ‰€åœ¨çš„ç±»ï¼ˆæ¯”å¦‚ CommentController.classï¼‰ å¦‚æœè¡¨è¾¾å¼æ˜¯ç©ºçš„ï¼Œå°±ç›´æ¥è¿”å›ç©ºå­—ç¬¦ä¸²ã€‚\n3ã€NAME_DISCOVERER.getParameterNames // è·å–æ–¹æ³•å‚æ•°åï¼ˆæ¯”å¦‚ order, userIdï¼‰ String[] paramNames = NAME_DISCOVERER.getParameterNames(targetClass.getDeclaredMethods()[0]); // ç®€åŒ–ç‰ˆï¼Œå®é™…éœ€åŒ¹é…æ–¹æ³• âœ… å¤§ç™½è¯ï¼ˆâš ï¸æ³¨æ„è¿™é‡Œæœ‰é—®é¢˜ï¼‰ï¼š\nè¿™è¡Œä»£ç æƒ³æ‹¿åˆ°æ–¹æ³•çš„å‚æ•°åå­—ï¼Œæ¯”å¦‚ userId, productIdã€‚\nä½†å®ƒæœ‰ä¸ª ä¸¥é‡é—®é¢˜ï¼štargetClass.getDeclaredMethods()[0] æ˜¯éšä¾¿æ‹¿ç±»é‡Œçš„ç¬¬ä¸€ä¸ªæ–¹æ³•ï¼ å¦‚æœè¿™ä¸ªç±»æœ‰å¤šä¸ªæ–¹æ³•ï¼Œå¾ˆå¯èƒ½æ‹¿é”™ï¼\nğŸš¨ æ‰€ä»¥è¿™ä¸ª SpelUtil å…¶å®æ˜¯ä¸ªâ€œç®€åŒ–ç‰ˆç¤ºä¾‹â€ï¼Œä¸èƒ½ç›´æ¥ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒã€‚åé¢æˆ‘ä»¬ä¼šçœ‹åˆ°æ­£ç¡®çš„åšæ³•åœ¨ IdempotentAspect é‡Œã€‚\nâœ… è¯­æ³•åŸç†ï¼š\ngetDeclaredMethods() è¿”å›ç±»ä¸­æ‰€æœ‰æ–¹æ³•ï¼ˆåŒ…æ‹¬ privateï¼‰ã€‚ [0] è¡¨ç¤ºå–ç¬¬ä¸€ä¸ªï¼Œä½†ä¸ä¸€å®šæ˜¯ä½ è¦çš„é‚£ä¸ªæ–¹æ³•ã€‚ 4ã€StandardEvaluationContext context // åˆ›å»ºä¸Šä¸‹æ–‡ StandardEvaluationContext context = new StandardEvaluationContext(); for (int i = 0; i \u003c args.length; i++) { context.setVariable(paramNames[i], args[i]); } ğŸ§© ç¬¬ä¸€è¡Œï¼šStandardEvaluationContext context = new StandardEvaluationContext();\nğŸ’¬ å¤§ç™½è¯ï¼š\nâ€œæˆ‘è¦å¼€å§‹ç®—ä¸€ä¸ªè¡¨è¾¾å¼äº†ï¼Œå…ˆå‡†å¤‡ä¸€ä¸ªâ€˜å°æœ¬å­â€™ï¼Œç”¨æ¥è®°å˜é‡ã€‚â€\nå°±åƒä½ åšæ•°å­¦é¢˜å‰ï¼Œè€å¸ˆè¯´ï¼šâ€œå·²çŸ¥ï¼šx = 5ï¼Œy = 3â€ï¼Œè¿™ä¸ªâ€œå·²çŸ¥æ¡ä»¶â€çš„åœ°æ–¹ï¼Œå°±æ˜¯ ä¸Šä¸‹æ–‡ï¼ˆcontextï¼‰ã€‚\nåœ¨è¿™é‡Œï¼Œè¿™ä¸ªâ€œå°æœ¬å­â€å« contextï¼Œå®ƒæ˜¯ Spring ä¸“é—¨ç”¨æ¥è®© SpEL è¡¨è¾¾å¼ èƒ½è¯»åˆ°å˜é‡çš„åœ°æ–¹ã€‚\nğŸ¯ ä¸¾ä¸ªç”Ÿæ´»ä¾‹å­ï¼š\nä½ æƒ³ç®—ï¼š#userId + '-' + #productId ä½† Spring ä¸çŸ¥é“ #userId æ˜¯å¤šå°‘å•Šï¼ æ‰€ä»¥ä½ è¦å…ˆå‘Šè¯‰å®ƒï¼šâ€œå¬ç€ï¼Œæˆ‘ç°åœ¨å‘Šè¯‰ä½ ï¼šuserId=1001ï¼ŒproductId=2002â€ è¿™ä¸ªâ€œå‘Šè¯‰â€çš„è¿‡ç¨‹ï¼Œå°±éœ€è¦ä¸€ä¸ªâ€œè®°äº‹æœ¬â€â€”â€”å°±æ˜¯è¿™ä¸ª contextã€‚\nğŸ”¬ è¯­æ³•åŸç†ï¼š\nStandardEvaluationContext æ˜¯ Spring æä¾›çš„ä¸€ä¸ªç±»ï¼Œè¡¨ç¤º SpEL è¡¨è¾¾å¼çš„è¿è¡Œç¯å¢ƒã€‚ å®ƒå¯ä»¥å­˜å‚¨ï¼š å˜é‡ï¼ˆvariablesï¼‰ å‡½æ•°ï¼ˆfunctionsï¼‰ ç±»å‹æŸ¥æ‰¾å™¨ï¼ˆtype locatorsï¼‰ç­‰ åœ¨æ±‚å€¼æ—¶ï¼Œè¡¨è¾¾å¼ä¼šä»è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­æŸ¥æ‰¾ #xxx è¿™æ ·çš„å˜é‡ã€‚ âœ… ç®€å•è¯´ï¼šæ²¡æœ‰å®ƒï¼Œ#userId å°±æ˜¯â€œæ— åä¹‹è¾ˆâ€ï¼Œæœ‰äº†å®ƒï¼Œ#userId æ‰æœ‰å€¼ã€‚\nğŸ§© ç¬¬äºŒéƒ¨åˆ†ï¼šfor å¾ªç¯\nfor (int i = 0; i \u003c args.length; i++) { context.setVariable(paramNames[i], args[i]); } æˆ‘ä»¬æ‹†å¼€æ¥çœ‹ã€‚\nğŸ’¬ å¤§ç™½è¯ï¼š\nâ€œæˆ‘ç°åœ¨æœ‰ä¸€å †å‚æ•°ï¼š\nå‚æ•°åå­—æ˜¯ï¼š[\"userId\", \"productId\", \"content\"] å®é™…å€¼æ˜¯ï¼š[1001, 2002, \"å¥½è¯„ï¼\"] æˆ‘è¦æŠŠå®ƒä»¬ä¸€ä¸ªä¸ªæ”¾è¿›â€˜å°æœ¬å­â€™é‡Œï¼Œå˜æˆï¼š\nuserId = 1001 productId = 2002 content = \"å¥½è¯„ï¼\" è¿™æ ·åé¢ç®—è¡¨è¾¾å¼çš„æ—¶å€™ï¼Œå°±èƒ½ç”¨ #userId æ‹¿åˆ° 1001 äº†ã€‚â€\nğŸ”¬ è¯­æ³•åŸç†ï¼š\nparamNames[i]ï¼šå‚æ•°å\næ¥è‡ª signature.getParameterNames()\næ¯”å¦‚æ–¹æ³•æ˜¯ï¼š\npublic String addComment(Long userId, Long productId, String content) é‚£ä¹ˆ paramNames = [\"userId\", \"productId\", \"content\"]\nâš ï¸ æ³¨æ„ï¼šå¿…é¡»ç¼–è¯‘æ—¶åŠ  -parameters å‚æ•°ï¼Œå¦åˆ™å¯èƒ½å¾—åˆ° arg0, arg1, arg2\nargs[i]ï¼šå‚æ•°å€¼\næ¥è‡ª joinPoint.getArgs()\næ˜¯å®é™…ä¼ è¿›æ¥çš„æ•°æ®ï¼Œæ¯”å¦‚ï¼š\n[1001L, 2002L, \"æœåŠ¡å¾ˆå¥½ï¼\"] context.setVariable(name, value)\næŠŠä¸€ä¸ªå˜é‡æ³¨å†Œåˆ° SpEL ä¸Šä¸‹æ–‡ä¸­ ä¹‹ååœ¨è¡¨è¾¾å¼ä¸­å°±å¯ä»¥ç”¨ #name æ¥å¼•ç”¨å®ƒ âœ… ä¸¾ä¾‹ï¼š\nä»£ç  æ•ˆæœ context.setVariable(\"userId\", 1001) ä¹‹å #userId å°±ç­‰äº 1001 context.setVariable(\"content\", \"å¥½è¯„\") ä¹‹å #content å°±ç­‰äº \"å¥½è¯„\" ğŸ¯ ä¸¾ä¸ªå®Œæ•´ä¾‹å­\nå‡è®¾ä½ è°ƒç”¨äº†è¿™ä¸ªæ¥å£ï¼š\n5ã€return PARSER.parseExpression(spel) âœ… ä»£ç è¡Œï¼š\nreturn PARSER.parseExpression(spel).getValue(context, String.class); è¿™è¡Œä»£ç æ˜¯æ•´ä¸ª SpelUtil.parse() æ–¹æ³•çš„â€œæœ€åä¸€å‡»â€â€”â€”çœŸæ­£å»æ‰§è¡Œ SpEL è¡¨è¾¾å¼ï¼Œå¾—åˆ°ç»“æœã€‚\nğŸ§  å¤§ç™½è¯è§£é‡Šï¼ˆåƒèŠå¤©ä¸€æ ·ï¼‰\næƒ³è±¡ä½ å†™äº†ä¸€ä¸ªâ€œæ•°å­¦é¢˜â€ä¸€æ ·çš„å­—ç¬¦ä¸²ï¼š\n\"#userId + '-' + #productId\" è¿™å…¶å®ä¸æ˜¯ä¸€ä¸ªæ™®é€šå­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä¸€ä¸ªâ€œå¾…è®¡ç®—çš„å…¬å¼â€ã€‚ ç°åœ¨ä½ è¦è®© Spring å¸®ä½ â€œç®—å‡ºç­”æ¡ˆâ€ã€‚\nè¿™ä¸ªè¿‡ç¨‹åˆ†ä¸‰æ­¥ï¼š\næŠŠå…¬å¼è¯»ä¸€é â†’ parseExpression(spel) Spring è¯´ï¼šâ€œå“¦ï¼Œè¿™æ˜¯ä¸ªæ‹¼æ¥å­—ç¬¦ä¸²çš„è¡¨è¾¾å¼ï¼Œè¦ç”¨åˆ° #userId å’Œ #productIdã€‚â€\nçœ‹çœ‹å˜é‡æœ‰æ²¡æœ‰ â†’ éœ€è¦ä¸€ä¸ªâ€œä¸Šä¸‹æ–‡â€ï¼ˆcontextï¼‰â€\nçœ‹çœ‹å˜é‡æœ‰æ²¡æœ‰ â†’ éœ€è¦ä¸€ä¸ªâ€œä¸Šä¸‹æ–‡â€ï¼ˆcontextï¼‰ å°±åƒä½ åšæ•°å­¦é¢˜æ—¶ï¼Œè€å¸ˆè¯´ï¼šâ€œå·²çŸ¥ x=1001, y=2002â€ï¼Œè¿™é‡Œçš„ context å°±æ˜¯â€œå·²çŸ¥æ¡ä»¶â€ã€‚ å¼€å§‹è®¡ç®—ç»“æœ â†’ .getValue(context, String.class) Spring æ‹¿ç€ä¸Šä¸‹æ–‡é‡Œçš„å€¼ï¼Œä»£å…¥å…¬å¼ï¼š #userId â†’ 1001 #productId â†’ 2002 æ‹¼èµ·æ¥å°±æ˜¯ \"1001-2002\" æœ€åæŠŠè¿™ä¸ªç»“æœè¿”å›å‡ºå»ã€‚\nğŸ”š æ‰€ä»¥è¿™è¡Œä»£ç çš„æ„æ€å°±æ˜¯ï¼š\nâ€œè¯·æŠŠ spel è¿™ä¸ªè¡¨è¾¾å¼ï¼Œç»“åˆæˆ‘ç»™çš„å‚æ•°å€¼ï¼ˆcontextï¼‰ï¼Œç®—å‡ºä¸€ä¸ªå­—ç¬¦ä¸²ç»“æœã€‚â€\nğŸ”¬ è¯­æ³•åŸç†æ‹†è§£\næˆ‘ä»¬æŠŠå®ƒæ‹†æˆä¸‰éƒ¨åˆ†æ¥çœ‹ï¼š\n1ï¸âƒ£ PARSER\nprivate static final ExpressionParser PARSER = new SpelExpressionParser(); ExpressionParser æ˜¯ Spring æä¾›çš„æ¥å£ï¼Œä¸“é—¨ç”¨æ¥è§£æè¡¨è¾¾å¼ã€‚ SpelExpressionParser æ˜¯å®ƒçš„å®ç°ç±»ã€‚ PARSER æ˜¯ä¸€ä¸ªé™æ€å¯¹è±¡ï¼Œæ•´ä¸ªç¨‹åºåªåˆ›å»ºä¸€æ¬¡ï¼Œæ•ˆç‡é«˜ã€‚ ğŸ‘‰ å®ƒçš„ä½œç”¨ï¼šæŠŠå­—ç¬¦ä¸²å˜æˆå¯æ‰§è¡Œçš„â€œè¡¨è¾¾å¼å¯¹è±¡â€ã€‚\n2ï¸âƒ£ .parseExpression(spel)\nPARSER.parseExpression(spel) æŠŠä¼ è¿›æ¥çš„å­—ç¬¦ä¸²ï¼ˆæ¯”å¦‚ \"#userId + '-' + #productId\"ï¼‰è§£ææˆä¸€ä¸ªå†…éƒ¨ç»“æ„ï¼ˆASTï¼ŒæŠ½è±¡è¯­æ³•æ ‘ï¼‰ã€‚ è¿™ä¸€æ­¥åªæ˜¯â€œç¼–è¯‘â€ï¼Œè¿˜æ²¡æ‰§è¡Œã€‚ å¦‚æœè¡¨è¾¾å¼å†™é”™äº†ï¼Œæ¯”å¦‚ #user.iddï¼ˆæ‹¼é”™å­—æ®µï¼‰ï¼Œè¿™é‡Œä¼šæŠ›å¼‚å¸¸ã€‚ âœ… ä¸¾ä¸ªä¾‹å­ï¼š\nè¾“å…¥ ç»“æœ \"#name\" å–å˜é‡ name çš„å€¼ \"#order.price * 0.9\" å– price çš„ 90% \"T(java.lang.Math).random()\" è°ƒç”¨ Java é™æ€æ–¹æ³• SpEL åŠŸèƒ½å¾ˆå¼ºï¼Œç”šè‡³èƒ½è°ƒæ–¹æ³•ã€è®¿é—®å±æ€§ã€åšåˆ¤æ–­ï¼\n3ï¸âƒ£ .getValue(context, String.class)\n.getValue(context, String.class) è¿™æ‰æ˜¯çœŸæ­£çš„â€œè¿è¡Œâ€ï¼\ncontextï¼šå°±æ˜¯ä¹‹å‰è®¾ç½®å¥½çš„â€œå˜é‡ç¯å¢ƒâ€ï¼Œé‡Œé¢æœ‰ userId=1001, productId=2002 String.classï¼šè¡¨ç¤ºä½ å¸Œæœ›è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„ç»“æœ Spring ä¼šï¼š\næ‰¾åˆ° #userId â†’ ä» context ä¸­å–å‡º 1001 æ‰¾åˆ° #productId â†’ å–å‡º 2002 ä¸­é—´çš„ '-' æ˜¯å­—ç¬¦ä¸²å¸¸é‡ï¼ˆæ³¨æ„å•å¼•å·ï¼‰ æ‹¼æ¥æˆ \"1001-2002\" è½¬æˆ String ç±»å‹è¿”å› ğŸ§ª ä¸¾ä¸ªå®é™…ä¾‹å­\nå‡è®¾ï¼š\nspel = \"#userId + '-' + #productId\" args = [1001, 2002] paramNames = [\"userId\", \"productId\"] é‚£ä¹ˆï¼š\ncontext.setVariable(\"userId\", 1001); context.setVariable(\"productId\", 2002); æ‰§è¡Œï¼š\nPARSER.parseExpression(\"#userId + '-' + #productId\").getValue(context, String.class) ğŸ‘‰ è¿”å›ç»“æœæ˜¯å­—ç¬¦ä¸²ï¼š\"1001-2002\"\nç¬¬äºŒéƒ¨åˆ†ï¼šIdempotentAspect.javaï¼ˆçœŸæ­£çš„æ ¸å¿ƒï¼‰ @Aspect @Component public class IdempotentAspect { âœ… å¤§ç™½è¯ï¼š\nè¿™æ˜¯ä¸€ä¸ªâ€œåˆ‡é¢ç±»â€ï¼ŒSpring ä¼šè‡ªåŠ¨æ‰«æå®ƒï¼ˆå› ä¸ºåŠ äº† @Componentï¼‰ï¼Œå¹¶åœ¨æœ‰ @Idempotent æ³¨è§£çš„æ–¹æ³•ä¸Šâ€œæ’å…¥é¢å¤–é€»è¾‘â€ã€‚\n@Aspectï¼šå‘Šè¯‰ Springï¼šâ€œæˆ‘æ˜¯ä¸€ä¸ªåˆ‡é¢â€ @Componentï¼šå‘Šè¯‰ Springï¼šâ€œæŠŠæˆ‘å½“æ™®é€š Bean ç®¡ç†èµ·æ¥â€ 1ã€@Autowired @Autowired private RedisTemplate\u003cString, String\u003e redisTemplate; âœ… å¤§ç™½è¯ï¼š\næ³¨å…¥ Redis æ“ä½œå·¥å…·ï¼Œç”¨æ¥å­˜â€œé”â€ã€‚æ¯”å¦‚å­˜ä¸€ä¸ª keyï¼šidempotent:1001-2002ï¼Œè¡¨ç¤ºè¿™ä¸ªç»„åˆæ­£åœ¨å¤„ç†ä¸­ã€‚\n2ã€@Around @Around(\"@annotation(idempotent)\") public Object checkIdempotent(ProceedingJoinPoint joinPoint, Idempotent idempotent) throws Throwable { ğŸ§© ç¬¬ä¸€éƒ¨åˆ†ï¼š@Around(\"@annotation(idempotent)\")\nğŸ’¬ å¤§ç™½è¯è§£é‡Šï¼š\nâ€œå½“æŸä¸ªæ–¹æ³•ä¸ŠåŠ äº† @Idempotent æ³¨è§£çš„æ—¶å€™ï¼Œè¯·å…ˆåˆ«æ€¥ç€æ‰§è¡Œå®ƒï¼Œè®©æˆ‘å…ˆæ’ä¸€è„šï¼â€\nè¿™å¥è¯çš„æ„æ€æ˜¯ï¼š\næˆ‘è¦ç›‘å¬æ‰€æœ‰è¢« @Idempotent æ ‡è®°çš„æ–¹æ³•ã€‚ åœ¨è¿™äº›æ–¹æ³•çœŸæ­£æ‰§è¡Œä¹‹å‰ï¼Œå…ˆè¿è¡Œæˆ‘è¿™ä¸ª checkIdempotent æ–¹æ³•ã€‚ æˆ‘å¯ä»¥å†³å®šï¼šæ˜¯æ”¾è¡Œè®©å®ƒæ‰§è¡Œï¼Ÿè¿˜æ˜¯ç›´æ¥æ‹¦ä¸‹æ¥ï¼Ÿ ğŸ¯ å°±åƒä½ åœ¨é—¨å£è£…äº†ä¸ªâ€œé—¨ç¦ç³»ç»Ÿâ€ï¼Œæ¯ä¸ªäººè¿›é—¨å‰éƒ½è¦åˆ·ä¸€ä¸‹å¡ã€‚\nğŸ”¬ è¯­æ³•åŸç†ï¼š\n@Around æ˜¯ AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰ çš„ä¸€ç§é€šçŸ¥ç±»å‹ï¼Œå«â€œç¯ç»•é€šçŸ¥â€ã€‚ å®ƒæ˜¯æœ€å¼ºå¤§çš„ä¸€ç§é€šçŸ¥ï¼Œå¯ä»¥ï¼š åœ¨æ–¹æ³•å‰åšäº‹æƒ… âœ… å†³å®šæ˜¯å¦æ‰§è¡ŒåŸæ–¹æ³• âœ… åœ¨æ–¹æ³•ååšäº‹æƒ… âœ… ä¿®æ”¹è¿”å›å€¼ âœ… æ•è·å¼‚å¸¸ âœ… \"@annotation(idempotent)\" æ˜¯ä¸€ä¸ª åˆ‡ç‚¹è¡¨è¾¾å¼ï¼ˆPointcut Expressionï¼‰ æ„æ€æ˜¯ï¼šâ€œåŒ¹é…æ‰€æœ‰æ ‡æ³¨äº† @Idempotent æ³¨è§£çš„æ–¹æ³•â€ å…¶ä¸­ idempotent æ˜¯å‚æ•°åï¼Œå¯¹åº”åé¢æ–¹æ³•é‡Œçš„ Idempotent idempotent ğŸ“Œ ä¸¾ä¸ªç±»æ¯”ï¼š\nç±»æ¯” å¯¹åº” å­¦æ ¡å¤§é—¨ è¢«æ‹¦æˆªçš„æ–¹æ³•ï¼ˆå¦‚ addCommentï¼‰ å­¦ç”Ÿåˆ·è„¸è¿›é—¨ æ–¹æ³•è¢«è°ƒç”¨ ä¿å®‰æ‹¦äººæ£€æŸ¥ @Around åˆ‡é¢é€»è¾‘ åªæœ‰æˆ´æ ¡å¾½çš„äººæ‰èƒ½è¿› @annotation(idempotent) æ¡ä»¶ ğŸ§© ç¬¬äºŒéƒ¨åˆ†ï¼šæ–¹æ³•ç­¾å\npublic Object checkIdempotent(ProceedingJoinPoint joinPoint, Idempotent idempotent) æˆ‘ä»¬æ‹†å¼€çœ‹æ¯ä¸ªéƒ¨åˆ†ã€‚\n1ï¸âƒ£ public Object\nè¿”å›ç±»å‹æ˜¯ Objectï¼Œå› ä¸ºæˆ‘ä»¬è¦è¿”å›åŸæ–¹æ³•çš„æ‰§è¡Œç»“æœã€‚ åŸæ–¹æ³•å¯èƒ½æ˜¯ Stringã€Mapã€void ç­‰ï¼Œæ‰€ä»¥ç”¨æœ€é€šç”¨çš„ Object æ¥ä½ã€‚ ğŸ¯ å¤§ç™½è¯ï¼š â€œæˆ‘ä¸ç®¡ä½ æ˜¯è¿”å›å­—ç¬¦ä¸²è¿˜æ˜¯æ•°å­—ï¼Œæˆ‘éƒ½åŸæ ·äº¤å›å»ã€‚â€\n2ï¸âƒ£ ProceedingJoinPoint joinPoint\nè¿™æ˜¯ AOP çš„æ ¸å¿ƒå¯¹è±¡ä¹‹ä¸€ã€‚\nğŸ’¬ å¤§ç™½è¯ï¼š\nâ€œä½ æ‹¦ä½çš„é‚£ä¸ªæ­£åœ¨è¢«è°ƒç”¨çš„æ–¹æ³•ï¼Œæˆ‘ç°åœ¨æŠŠå®ƒâ€˜æ‰“åŒ…â€™æˆä¸€ä¸ªå¯¹è±¡ï¼Œå« joinPointï¼Œä½ å¯ä»¥é€šè¿‡å®ƒçŸ¥é“ï¼š\nå®ƒæ˜¯è°ï¼Ÿï¼ˆå“ªä¸ªç±»çš„å“ªä¸ªæ–¹æ³•ï¼‰ å®ƒæœ‰å“ªäº›å‚æ•°ï¼Ÿ å®ƒçš„å‚æ•°å«ä»€ä¹ˆåå­—ï¼Ÿ æˆ‘ç°åœ¨è¦ä¸è¦è®©å®ƒç»§ç»­æ‰§è¡Œï¼Ÿâ€ ğŸ”¬ è¯­æ³•åŸç†ï¼š\nJoinPointï¼šä»£è¡¨â€œè¿æ¥ç‚¹â€ï¼Œå³ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­çš„æŸä¸ªç‚¹ï¼ˆæ¯”å¦‚æ–¹æ³•è°ƒç”¨ï¼‰ã€‚ ProceedingJoinPoint æ˜¯å®ƒçš„å­æ¥å£ï¼Œå¤šäº† .proceed() æ–¹æ³•ï¼Œè¡¨ç¤ºâ€œç»§ç»­æ‰§è¡ŒåŸæ–¹æ³•â€ã€‚ å¸¸è§æ–¹æ³•ï¼š getArgs() â†’ è·å–å‚æ•°å€¼ getSignature() â†’ è·å–æ–¹æ³•ç­¾å proceed() â†’ æ”¾è¡Œï¼Œè®©åŸæ–¹æ³•æ‰§è¡Œ ğŸ¯ å…³é”®ä½œç”¨ï¼šæ§åˆ¶æµç¨‹æ˜¯å¦ç»§ç»­å‘ä¸‹èµ°\n3ï¸âƒ£ Idempotent idempotent\nğŸ’¬ å¤§ç™½è¯ï¼š\nâ€œä½ ä¸æ˜¯åœ¨æ–¹æ³•ä¸Šå†™äº† @Idempotent(key = '...', expire = 10) å—ï¼Ÿ æˆ‘ç°åœ¨æŠŠé‚£ä¸ªæ³¨è§£æœ¬èº«æ‹¿è¿‡æ¥ï¼Œè¯»é‡Œé¢çš„é…ç½®ã€‚â€\næ¯”å¦‚ä½ å¯ä»¥æ‹¿åˆ°ï¼š\nidempotent.key() â†’ \"#userId + '-' + #productId\" idempotent.expire() â†’ 10 è¿™å°±å®ç°äº†â€œé…ç½®é©±åŠ¨â€ï¼šä¸åŒæ–¹æ³•å¯ä»¥ç”¨ä¸åŒçš„ key å’Œè¿‡æœŸæ—¶é—´ã€‚\nğŸ”¬ è¯­æ³•åŸç†ï¼š\nSpring AOP æ”¯æŒè‡ªåŠ¨æ³¨å…¥æ³¨è§£å¯¹è±¡åˆ°é€šçŸ¥æ–¹æ³•ä¸­ã€‚\næ¡ä»¶ï¼šå‚æ•°åå¿…é¡»å’Œ@Around è¡¨è¾¾å¼ä¸­çš„å˜é‡ä¸€è‡´ã€‚\n@Around(\"@annotation(idempotent)\") æ–¹æ³•å‚æ•°ï¼šIdempotent idempotent åå­—è¦å¯¹å¾—ä¸Šï¼ âœ… æ­£ç¡®ï¼š\n@Around(\"@annotation(myAnno)\") public void advice(MyAnnotation myAnno) { ... } âŒ é”™è¯¯ï¼š\n@Around(\"@annotation(myAnno)\") public void advice(MyAnnotation wrongName) { ... } // æ‰¾ä¸åˆ° ğŸ§© ç¬¬ä¸‰éƒ¨åˆ†ï¼šthrows Throwable\nğŸ’¬ å¤§ç™½è¯ï¼š\nâ€œæˆ‘åœ¨æ£€æŸ¥çš„æ—¶å€™å¯èƒ½ä¼šå‡ºé”™ï¼Œæ¯”å¦‚ Redis è¿ä¸ä¸Šã€è¡¨è¾¾å¼å†™é”™äº†â€¦â€¦ å¦‚æœçœŸå‡ºäº†é—®é¢˜ï¼Œæˆ‘å°±æŠŠé”™è¯¯å¾€ä¸ŠæŠ›ï¼Œè®©åˆ«äººå¤„ç†ã€‚â€\nå› ä¸ºæˆ‘ä»¬è¦è°ƒç”¨ joinPoint.proceed()ï¼Œå®ƒæœ¬èº«å°±ä¼šæŠ›å¼‚å¸¸ï¼ˆæ¯”å¦‚ä¸šåŠ¡é€»è¾‘å¼‚å¸¸ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿè¦å£°æ˜ throws Throwableã€‚\nThrowable æ˜¯æ‰€æœ‰é”™è¯¯å’Œå¼‚å¸¸çš„â€œè€ç¥–å®—â€ï¼ŒåŒ…æ‹¬ Exception å’Œ Errorã€‚\nğŸ¯ æ•´ä½“ç†è§£ï¼ˆå†ä¸²ä¸€éï¼‰\n@Around(\"@annotation(idempotent)\") public Object checkIdempotent(ProceedingJoinPoint joinPoint, Idempotent idempotent) throws Throwable { ğŸ” ç›¸å½“äºä½ è¯´ï¼š\nâ€œSpring å•Šï¼Œè¯·ä½ ç›‘å¬æ‰€æœ‰åŠ äº† @Idempotent æ³¨è§£çš„æ–¹æ³•ã€‚ å½“å®ƒä»¬è¢«è°ƒç”¨æ—¶ï¼Œå…ˆåˆ«æ‰§è¡Œï¼ŒæŠŠæˆ‘è¿™ä¸ªæ–¹æ³•å«èµ·æ¥ï¼š æŠŠâ€˜è¢«æ‹¦æˆªçš„æ–¹æ³•â€™åŒ…è£…æˆ joinPointï¼ŒæŠŠæ³¨è§£æœ¬èº«å½“ä½œ idempotent å‚æ•°ä¼ ç»™æˆ‘ã€‚ æˆ‘ä¼šæ ¹æ®æ³¨è§£é‡Œçš„é…ç½®ï¼Œåˆ¤æ–­è¦ä¸è¦æ”¾è¡Œã€‚ å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œæˆ‘å°±è®©å®ƒç»§ç»­æ‰§è¡Œï¼›å¦åˆ™å°±ç›´æ¥æŠ›å¼‚å¸¸æ‹¦ä½ã€‚ å‡ºäº†é—®é¢˜æˆ‘ä¹Ÿæ‹¦ä¸ä½ï¼Œé‚£å°±å¾€ä¸Šæ‰”é”™è¯¯ã€‚â€\nğŸ§ª ä¸¾ä¸ªç”Ÿæ´»åŒ–çš„ä¾‹å­\næƒ³è±¡ä½ åœ¨ç”µå½±é™¢ä¹°ç¥¨ï¼š\n@PostMapping(\"/buyTicket\") @Idempotent(key = \"#userId + '-' + #movieId\", expire = 60) public String buyTicket(@RequestParam Long userId, @RequestParam Long movieId) { // æ‰£é’±ã€å‡ºç¥¨ } å½“ä½ ç‚¹å‡»â€œä¹°ç¥¨â€æŒ‰é’®ä¸¤æ¬¡ï¼š\nç¬¬ä¸€æ¬¡ï¼š AOP æ‹¦æˆª â†’ checkIdempotent æ‰§è¡Œ ç®— keyï¼š\"1001-2002\" Redis æ²¡æœ‰è¿™ä¸ª key â†’ è®¾ç½®æˆåŠŸ â†’ æ”¾è¡Œ â†’ ä¹°ç¥¨æˆåŠŸ âœ… ç¬¬äºŒæ¬¡ï¼ˆ1 ç§’åï¼‰ï¼š AOP åˆæ‹¦æˆª ç®—åŒæ ·çš„ keyï¼š\"1001-2002\" Redis å·²å­˜åœ¨ â†’ ä¸æ”¾è¡Œ â†’ æŠ›å¼‚å¸¸ âŒ â€œè¯·å‹¿é‡å¤æäº¤â€ ğŸ‘‰ å°±åƒå”®ç¥¨å‘˜è¯´ï¼šâ€œä½ åˆšä¹°è¿‡è¿™å¼ ç¥¨äº†ï¼Œä¸èƒ½å†ä¹°ï¼â€\nâœ… æ€»ç»“ä¸€å¥è¯\n@Around(\"@annotation(idempotent)\") public Object checkIdempotent(ProceedingJoinPoint joinPoint, Idempotent idempotent) throws Throwable å°±åƒæ˜¯ä¸€ä¸ªâ€œæ™ºèƒ½é—¨å«â€ï¼š\nè°æ¥éƒ½è¦æŸ¥ï¼šæ‰€æœ‰å¸¦ @Idempotent çš„æ–¹æ³• æ‰‹é‡Œæœ‰åå•ï¼šidempotent æ³¨è§£é‡Œçš„é…ç½®ï¼ˆkeyã€è¿‡æœŸæ—¶é—´ï¼‰ èƒ½æ‹¦ä¹Ÿèƒ½æ”¾ï¼šé€šè¿‡ joinPoint.proceed() æ§åˆ¶æ˜¯å¦æ‰§è¡ŒåŸæ–¹æ³• å‡ºäº‹è¦ä¸ŠæŠ¥ï¼šå¯èƒ½æŠ›å¼‚å¸¸ï¼Œæ‰€ä»¥å£°æ˜ throws Throwable 3ã€MethodSignature signature = â€¦â€¦ // 1. è·å–æ–¹æ³•ç­¾å MethodSignature signature = (MethodSignature) joinPoint.getSignature(); Method method = signature.getMethod(); âœ… å¤§ç™½è¯ï¼š\næ‹¿åˆ°â€œè¢«è°ƒç”¨çš„æ–¹æ³•â€æœ¬èº«ï¼Œæ¯”å¦‚ addComment(...) è¿™ä¸ªæ–¹æ³•å¯¹è±¡ã€‚\ngetSignature()ï¼šæ‹¿åˆ°æ–¹æ³•çš„â€œèº«ä»½è¯â€ï¼ˆç­¾åï¼‰ å¼ºè½¬æˆ MethodSignature æ˜¯ä¸ºäº†èƒ½è¿›ä¸€æ­¥è·å–å‚æ•°å 4ã€signature.getParameterNames() âœ… å¤§ç™½è¯ï¼š\nè¿™æ‰æ˜¯æ­£ç¡®çš„æ–¹å¼è·å–å‚æ•°åï¼\nsignature.getParameterNames()ï¼šç›´æ¥ä»æ–¹æ³•ç­¾åé‡Œæ‹¿å‚æ•°åæ•°ç»„ï¼Œæ¯”å¦‚ [\"userId\", \"productId\", \"content\"] joinPoint.getArgs()ï¼šæ‹¿åˆ°å®é™…ä¼ å…¥çš„å‚æ•°å€¼ï¼Œæ¯”å¦‚ [1001, 2002, \"å¥½è¯„ï¼\"] âœ… å¯¹æ¯”å‰é¢ SpelUtil çš„é”™è¯¯åšæ³•ï¼Œè¿™é‡Œæ‰æ˜¯å¯¹çš„ï¼\n5ã€StandardEvaluationContext context // 3. æ„å»º SpEL ä¸Šä¸‹æ–‡ StandardEvaluationContext context = new StandardEvaluationContext(); for (int i = 0; i \u003c paramNames.length; i++) { context.setVariable(paramNames[i], args[i]); } ğŸ§© ç¬¬ä¸€è¡Œï¼šStandardEvaluationContext context = new StandardEvaluationContext();\nğŸ’¬ å¤§ç™½è¯ï¼š\nâ€œæˆ‘è¦å¼€å§‹ç®—ä¸€ä¸ªè¡¨è¾¾å¼äº†ï¼Œå…ˆå‡†å¤‡ä¸€ä¸ªâ€˜å°æœ¬å­â€™ï¼Œç”¨æ¥è®°å˜é‡ã€‚â€\nå°±åƒä½ åšæ•°å­¦é¢˜å‰ï¼Œè€å¸ˆè¯´ï¼šâ€œå·²çŸ¥ï¼šx = 5ï¼Œy = 3â€ï¼Œè¿™ä¸ªâ€œå·²çŸ¥æ¡ä»¶â€çš„åœ°æ–¹ï¼Œå°±æ˜¯ ä¸Šä¸‹æ–‡ï¼ˆcontextï¼‰ã€‚\nåœ¨è¿™é‡Œï¼Œè¿™ä¸ªâ€œå°æœ¬å­â€å« contextï¼Œå®ƒæ˜¯ Spring ä¸“é—¨ç”¨æ¥è®© SpEL è¡¨è¾¾å¼ èƒ½è¯»åˆ°å˜é‡çš„åœ°æ–¹ã€‚\nğŸ¯ ä¸¾ä¸ªç”Ÿæ´»ä¾‹å­ï¼š\nä½ æƒ³ç®—ï¼š#userId + '-' + #productId\nä½† Spring ä¸çŸ¥é“ #userId æ˜¯å¤šå°‘å•Šï¼\næ‰€ä»¥ä½ è¦å…ˆå‘Šè¯‰å®ƒï¼šâ€œå¬ç€ï¼Œæˆ‘ç°åœ¨å‘Šè¯‰ä½ ï¼šuserId=1001ï¼ŒproductId=2002â€\nè¿™ä¸ªâ€œå‘Šè¯‰â€çš„è¿‡ç¨‹ï¼Œå°±éœ€è¦ä¸€ä¸ªâ€œè®°äº‹æœ¬â€â€”â€”å°±æ˜¯è¿™ä¸ª contextã€‚\nğŸ”¬ è¯­æ³•åŸç†ï¼š\nStandardEvaluationContext æ˜¯ Spring æä¾›çš„ä¸€ä¸ªç±»ï¼Œè¡¨ç¤º SpEL è¡¨è¾¾å¼çš„è¿è¡Œç¯å¢ƒã€‚ å®ƒå¯ä»¥å­˜å‚¨ï¼š å˜é‡ï¼ˆvariablesï¼‰ å‡½æ•°ï¼ˆfunctionsï¼‰ ç±»å‹æŸ¥æ‰¾å™¨ï¼ˆtype locatorsï¼‰ç­‰ åœ¨æ±‚å€¼æ—¶ï¼Œè¡¨è¾¾å¼ä¼šä»è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­æŸ¥æ‰¾ #xxx è¿™æ ·çš„å˜é‡ã€‚ âœ… ç®€å•è¯´ï¼šæ²¡æœ‰å®ƒï¼Œ#userId å°±æ˜¯â€œæ— åä¹‹è¾ˆâ€ï¼Œæœ‰äº†å®ƒï¼Œ#userId æ‰æœ‰å€¼\nğŸ§© ç¬¬äºŒéƒ¨åˆ†ï¼šfor å¾ªç¯\nfor (int i = 0; i \u003c args.length; i++) { context.setVariable(paramNames[i], args[i]); } æˆ‘ä»¬æ‹†å¼€æ¥çœ‹ã€‚\nğŸ’¬ å¤§ç™½è¯ï¼š\nâ€œæˆ‘ç°åœ¨æœ‰ä¸€å †å‚æ•°ï¼š\nå‚æ•°åå­—æ˜¯ï¼š[\"userId\", \"productId\", \"content\"] å®é™…å€¼æ˜¯ï¼š[1001, 2002, \"å¥½è¯„ï¼\"] æˆ‘è¦æŠŠå®ƒä»¬ä¸€ä¸ªä¸ªæ”¾è¿›â€˜å°æœ¬å­â€™é‡Œï¼Œå˜æˆï¼š\nuserId = 1001 productId = 2002 content = \"å¥½è¯„ï¼\" è¿™æ ·åé¢ç®—è¡¨è¾¾å¼çš„æ—¶å€™ï¼Œå°±èƒ½ç”¨ #userId æ‹¿åˆ° 1001 äº†ã€‚â€\nğŸ”¬ è¯­æ³•åŸç†ï¼š\nparamNames[i]ï¼šå‚æ•°å\næ¥è‡ª signature.getParameterNames()\næ¯”å¦‚æ–¹æ³•æ˜¯ï¼š\npublic String addComment(Long userId, Long productId, String content) é‚£ä¹ˆ paramNames = [\"userId\", \"productId\", \"content\"]\nâš ï¸ æ³¨æ„ï¼šå¿…é¡»ç¼–è¯‘æ—¶åŠ  -parameters å‚æ•°ï¼Œå¦åˆ™å¯èƒ½å¾—åˆ° arg0, arg1, arg2\nargs[i]ï¼šå‚æ•°å€¼\næ¥è‡ª joinPoint.getArgs()\næ˜¯å®é™…ä¼ è¿›æ¥çš„æ•°æ®ï¼Œæ¯”å¦‚ï¼š\n[1001L, 2002L, \"æœåŠ¡å¾ˆå¥½ï¼\"] context.setVariable(name, value)\næŠŠä¸€ä¸ªå˜é‡æ³¨å†Œåˆ° SpEL ä¸Šä¸‹æ–‡ä¸­ ä¹‹ååœ¨è¡¨è¾¾å¼ä¸­å°±å¯ä»¥ç”¨ #name æ¥å¼•ç”¨å®ƒ âœ… ä¸¾ä¾‹ï¼š\nä»£ç  æ•ˆæœ context.setVariable(\"userId\", 1001) ä¹‹å #userId å°±ç­‰äº 1001 context.setVariable(\"content\", \"å¥½è¯„\") ä¹‹å #content å°±ç­‰äº \"å¥½è¯„\" ğŸ¯ ä¸¾ä¸ªå®Œæ•´ä¾‹å­\nå‡è®¾ä½ è°ƒç”¨äº†è¿™ä¸ªæ¥å£ï¼š\n@PostMapping(\"/comment\") @Idempotent(key = \"#userId + '-' + #productId\") public String addComment( @RequestParam Long userId, // å®é™…å€¼ï¼š1001 @RequestParam Long productId, // å®é™…å€¼ï¼š2002 @RequestBody String content) { // å®é™…å€¼ï¼š\"æœåŠ¡å¾ˆæ£’\" // ... } é‚£ä¹ˆï¼š\nå˜é‡ å€¼ paramNames [\"userId\", \"productId\", \"content\"] args [1001, 2002, \"æœåŠ¡å¾ˆæ£’\"] å¾ªç¯æ‰§è¡Œåï¼Œcontext é‡Œå°±å­˜äº†ï¼š\nå˜é‡å å€¼ userId 1001 productId 2002 content \"æœåŠ¡å¾ˆæ£’\" ç„¶åä½ å†™è¡¨è¾¾å¼ï¼š\n\"#userId + '-' + #productId\" Spring å°±èƒ½ä» context ä¸­æ‰¾åˆ°ï¼š\n#userId â†’ 1001 #productId â†’ 2002 æ‹¼æˆ \"1001-2002\" ğŸ¯ æˆåŠŸç”Ÿæˆ Redis çš„ keyï¼\n6ã€String keyExpression = idempotent.key() ğŸ§© ç¬¬ä¸€è¡Œï¼šString keyExpression = idempotent.key();\nğŸ’¬ å¤§ç™½è¯ï¼š\nâ€œå…ˆçœ‹çœ‹ç”¨æˆ·åœ¨æ³¨è§£é‡Œå†™äº†ä»€ä¹ˆè¡¨è¾¾å¼ã€‚â€\næ¯”å¦‚ä½ åœ¨ Controller æ–¹æ³•ä¸Šè¿™ä¹ˆå†™ï¼š\n@Idempotent(key = \"#userId + '-' + #productId\", expire = 10) 2public String addComment(Long userId, Long productId, ...) { ... } é‚£ä¹ˆ idempotent.key() å°±ä¼šè¿”å›å­—ç¬¦ä¸²ï¼š\n\"#userId + '-' + #productId\" è¿™ä¸ªå­—ç¬¦ä¸²ä¸æ˜¯æ™®é€šæ–‡æœ¬ï¼Œè€Œæ˜¯ä¸€ä¸ªâ€œæ¨¡æ¿â€æˆ–â€œå…¬å¼â€ï¼Œç­‰ç€æˆ‘ä»¬å»â€œå¡«ç©ºâ€ã€‚\nğŸ¯ å°±åƒä½ å†™äº†ä¸€ä¸ª Excel å…¬å¼ï¼š=A1 \u0026 \"-\" \u0026 B1ï¼Œä½†è¿˜æ²¡ä»£å…¥çœŸå®å•å…ƒæ ¼çš„å€¼ã€‚\nğŸ”¬ è¯­æ³•åŸç†ï¼š\nidempotent æ˜¯æ–¹æ³•ä¸Šçš„ @Idempotent æ³¨è§£å¯¹è±¡ï¼ˆç”± Spring AOP è‡ªåŠ¨æ³¨å…¥ï¼‰ã€‚\nkey() æ˜¯æ³¨è§£ä¸­çš„ä¸€ä¸ªå±æ€§ï¼ˆæ–¹æ³•ï¼‰ï¼Œè¿”å› String ç±»å‹ã€‚\næ³¨è§£å®šä¹‰å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š\n@Target(ElementType.METHOD) @Retention(RetentionPolicy.RUNTIME) public @interface Idempotent { String key(); // â† è¿™å°±æ˜¯ .key() çš„æ¥æº int expire() default 5; } âœ… æ‰€ä»¥è¿™è¡Œä»£ç åªæ˜¯è¯»å–é…ç½®ï¼Œæ²¡æœ‰è®¡ç®—ã€‚\nğŸ§© ç¬¬äºŒè¡Œï¼ˆæ ¸å¿ƒï¼‰ï¼šè§£æå¹¶æ±‚å€¼\nString realKey = new SpelExpressionParser() .parseExpression(keyExpression) .getValue(context, String.class); æˆ‘ä»¬æ‹†æˆä¸‰æ­¥æ¥çœ‹ï¼š\nâœ… ç¬¬ä¸€æ­¥ï¼šnew SpelExpressionParser()\nğŸ’¬ å¤§ç™½è¯ï¼š\nâ€œè¯·å¬å”¤ä¸€ä½â€˜è¡¨è¾¾å¼ç¿»è¯‘å®˜â€™ï¼â€\nè¿™ä½ç¿»è¯‘å®˜ä¸“é—¨è´Ÿè´£è¯»æ‡‚åƒ \"#userId + '-' + #productId\" è¿™æ ·çš„â€œSpring è¡¨è¾¾å¼è¯­è¨€ï¼ˆSpELï¼‰â€ã€‚\nğŸ”¬ è¯­æ³•åŸç†ï¼š\nSpelExpressionParser æ˜¯ Spring æä¾›çš„æ ‡å‡† SpEL è§£æå™¨ã€‚ æ¯æ¬¡ new ä¸€ä¸ªä¹Ÿå¯ä»¥ï¼Œä½†é€šå¸¸å»ºè®®å¤ç”¨ï¼ˆä¸è¿‡è¿™é‡Œåªç”¨ä¸€æ¬¡ï¼Œé—®é¢˜ä¸å¤§ï¼‰ã€‚ å®ƒå®ç°äº† ExpressionParser æ¥å£ã€‚ âœ… ç¬¬äºŒæ­¥ï¼š.parseExpression(keyExpression)\nğŸ’¬ å¤§ç™½è¯ï¼š\nâ€œç¿»è¯‘å®˜ï¼Œè¯·æŠŠè¿™æ®µâ€˜å’’è¯­â€™ï¼ˆè¡¨è¾¾å¼ï¼‰å…ˆç†è§£ä¸€ä¸‹ï¼Œå‡†å¤‡å¥½æ€ä¹ˆç®—ã€‚â€\næ¯”å¦‚è¾“å…¥ï¼š\n\"#userId + '-' + #productId\" ç¿»è¯‘å®˜ä¼šåˆ†æå‡ºï¼š\nè¿™æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œ éœ€è¦ç”¨åˆ°ä¸¤ä¸ªå˜é‡ï¼šuserId å’Œ productId ä¸­é—´å¤¹ç€ä¸€ä¸ªå›ºå®šçš„ '-' å­—ç¬¦ä¸² âš ï¸ æ³¨æ„ï¼šè¿™æ—¶å€™è¿˜æ²¡ç®—ç»“æœï¼Œåªæ˜¯â€œç¼–è¯‘â€å¥½äº†ï¼Œå‡†å¤‡æ‰§è¡Œã€‚\nğŸ”¬ è¯­æ³•åŸç†ï¼š\nè¿”å›ä¸€ä¸ª Expression å¯¹è±¡ã€‚ å¦‚æœè¡¨è¾¾å¼è¯­æ³•é”™è¯¯ï¼ˆæ¯”å¦‚å°‘å¼•å·ã€æ‹¬å·ä¸åŒ¹é…ï¼‰ï¼Œè¿™é‡Œä¼šæŠ› ParseExceptionã€‚ âœ… ä¸¾ä¾‹åˆæ³•è¡¨è¾¾å¼ï¼š\nè¡¨è¾¾å¼ å«ä¹‰ \"#name\" å–å˜é‡ name çš„å€¼ \"#user.age \u003e 18\" åˆ¤æ–­å¹´é¾„æ˜¯å¦å¤§äº 18 \"T(java.lang.Math).random()\" è°ƒç”¨é™æ€æ–¹æ³• âœ… ç¬¬ä¸‰æ­¥ï¼š.getValue(context, String.class)\nğŸ’¬ å¤§ç™½è¯ï¼š\nâ€œç°åœ¨ï¼Œè¯·ç»“åˆæˆ‘ç»™ä½ çš„â€˜å˜é‡æœ¬å­â€™ï¼ˆcontextï¼‰ï¼ŒæŠŠè¿™ä¸ªè¡¨è¾¾å¼çœŸæ­£ç®—å‡ºæ¥ï¼Œå¹¶ä¸”ç»“æœè¦æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼â€\næ¯”å¦‚ï¼š\ncontext é‡Œæœ‰ï¼šuserId=1001, productId=2002 è¡¨è¾¾å¼æ˜¯ï¼š\"#userId + '-' + #productId\" ç®—å‡ºæ¥å°±æ˜¯ï¼š\"1001-2002\" ç„¶åæŠŠå®ƒèµ‹å€¼ç»™ realKeyã€‚\nğŸ”¬ è¯­æ³•åŸç†ï¼š\ngetValue(EvaluationContext context, Class desiredResultType) contextï¼šæä¾›å˜é‡ç¯å¢ƒï¼ˆä¹‹å‰é€šè¿‡ setVariable è®¾ç½®çš„ï¼‰ String.classï¼šå‘Šè¯‰ Springï¼šâ€œæˆ‘è¦çš„ç»“æœç±»å‹æ˜¯ Stringâ€ Spring ä¼šè‡ªåŠ¨åšç±»å‹è½¬æ¢ï¼ˆæ¯”å¦‚æ•°å­—è½¬å­—ç¬¦ä¸²ï¼‰\nâœ… å¦‚æœç»“æœä¸æ˜¯å­—ç¬¦ä¸²ï¼Œä½†èƒ½è½¬æˆå­—ç¬¦ä¸²ï¼ˆæ¯”å¦‚ Longï¼‰ï¼Œä¹Ÿä¼šæˆåŠŸã€‚ âŒ å¦‚æœå®Œå…¨æ— æ³•è½¬æ¢ï¼ˆæ¯”å¦‚è¿”å›ä¸€ä¸ªå¯¹è±¡åˆæ²¡é‡å†™ toStringï¼‰ï¼Œå¯èƒ½æŠ¥é”™ã€‚\nğŸ¯ å®Œæ•´æµç¨‹å›¾ï¼ˆå¤§ç™½è¯ç‰ˆï¼‰\nç”¨æˆ·å†™æ³¨è§£ï¼š @Idempotent(key = \"#userId + '-' + #productId\") â†“ ç¨‹åºè¯»å–ï¼š keyExpression = \"#userId + '-' + #productId\" â†“ å‡†å¤‡å˜é‡æœ¬å­ï¼ˆcontextï¼‰ï¼š userId â†’ 1001 productId â†’ 2002 â†“ è¡¨è¾¾å¼ç¿»è¯‘å®˜å¼€å·¥ï¼š æŠŠ \"#userId\" æ›¿æ¢æˆ 1001 æŠŠ \"#productId\" æ›¿æ¢æˆ 2002 æ‹¼ä¸Šä¸­é—´çš„ '-' â†“ å¾—åˆ°çœŸå® keyï¼š realKey = \"1001-2002\" â†“ ç”¨å®ƒå» Redis åŠ é”ï¼šidempotent:1001-2002 ğŸ’¡ é«˜çº§æŠ€å·§ï¼ˆå¯é€‰äº†è§£ï¼‰\nSpEL æ”¯æŒå¾ˆå¤šå¼ºå¤§åŠŸèƒ½ï¼š\n// ä¸‰å…ƒè¿ç®— \"#userId != null ? #userId : 'guest'\" // è°ƒç”¨æ–¹æ³•ï¼ˆéœ€æ³¨å†Œï¼‰ \"#content.trim().length() \u003e 0\" // è®¿é—®å¯¹è±¡å±æ€§ï¼ˆå¦‚æœå‚æ•°æ˜¯å¯¹è±¡ï¼‰ \"#order.user.id\" ä½†è¦æ³¨æ„ï¼šé»˜è®¤ä¸èƒ½è°ƒç”¨ä»»æ„æ–¹æ³•ï¼ˆå‡ºäºå®‰å…¨ï¼‰ï¼Œéœ€è¦é¢å¤–é…ç½® EvaluationContext\nâœ… æ€»ç»“ä¸€å¥è¯\nString realKey = new SpelExpressionParser() .parseExpression(keyExpression) .getValue(context, String.class); å°±åƒæ˜¯ï¼š\nâ€œè¯·æŠŠç”¨æˆ·å†™çš„è¡¨è¾¾å¼æ¨¡æ¿ï¼ˆå¦‚ #userId + '-' + #productIdï¼‰ï¼Œ ç»“åˆå½“å‰æ–¹æ³•çš„å®é™…å‚æ•°å€¼ï¼Œ åŠ¨æ€è®¡ç®—å‡ºä¸€ä¸ªå”¯ä¸€çš„å­—ç¬¦ä¸² keyã€‚â€\nè¿™ä¸ª key å°†ç”¨äº Redis é”ï¼Œå®ç°â€œé˜²é‡å¤æäº¤â€çš„æ ¸å¿ƒé€»è¾‘ã€‚\n7ã€String lockKey = â€œidempotent:â€ + realKey; // 5. æ„é€  Redis é” key String lockKey = \"idempotent:\" + realKey; // 6. å°è¯•åŠ é” Boolean isSet = redisTemplate.opsForValue() .setIfAbsent(lockKey, \"1\", idempotent.expire(), TimeUnit.SECONDS); if (Boolean.TRUE.equals(isSet)) { return joinPoint.proceed(); } else { throw new RuntimeException(\"è¯·å‹¿é‡å¤æäº¤ï¼\"); } } ğŸ§© ç¬¬5æ­¥ï¼šæ„é€  Redis é” key\nString lockKey = \"idempotent:\" + realKey; ğŸ’¬ å¤§ç™½è¯ï¼š\nâ€œæˆ‘è¦åœ¨ Redis é‡Œå­˜ä¸€ä¸ªâ€˜æ ‡è®°â€™ï¼Œè¡¨ç¤ºè¿™ä¸ªè¯·æ±‚æ­£åœ¨å¤„ç†ä¸­ã€‚ ä¸ºäº†é¿å…å’Œå…¶ä»–åŠŸèƒ½å†²çªï¼Œæˆ‘ç»™å®ƒåŠ ä¸ªå‰ç¼€ idempotent:ï¼Œè¿™æ ·ä¸€çœ‹å°±çŸ¥é“æ˜¯å¹‚ç­‰é”ã€‚â€\næ¯”å¦‚ï¼š\nrealKey = \"1001-2002\" é‚£ä¹ˆæœ€ç»ˆçš„ Redis key å°±æ˜¯ï¼š\"idempotent:1001-2002\" ğŸ¯ å°±åƒä½ åœ¨å›¾ä¹¦é¦†å€Ÿä¹¦ï¼Œä¹¦ä¸Šè´´ä¸ªæ ‡ç­¾ï¼šâ€œæ­¤ä¹¦å·²å€Ÿå‡ºï¼ˆå¹‚ç­‰é”ï¼‰â€ï¼Œåˆ«äººå°±ä¸è¦å†å€Ÿäº†ã€‚\nğŸ”¬ è¯­æ³•åŸç†ï¼š\nå­—ç¬¦ä¸²æ‹¼æ¥ï¼Œç®€å•ç›´æ¥ã€‚ å‰ç¼€è®¾è®¡æ˜¯æœ€ä½³å®è·µï¼šé¿å…ä¸åŒä¸šåŠ¡æ¨¡å—çš„ key å†²çªã€‚ å¸¸è§å‘½åè§„èŒƒï¼šä¸šåŠ¡å:æ ‡è¯†ç¬¦ï¼Œå¦‚ order:create:12345ã€user:login:abc ğŸ§© ç¬¬6æ­¥ï¼šå°è¯•åŠ é”\nBoolean isSet = redisTemplate.opsForValue() .setIfAbsent(lockKey, \"1\", idempotent.expire(), TimeUnit.SECONDS); è¿™è¡Œæ˜¯æ•´ä¸ªå¹‚ç­‰æ€§çš„çµé­‚æ‰€åœ¨ï¼æˆ‘ä»¬æ‹†å¼€çœ‹ã€‚\nğŸ’¬ å¤§ç™½è¯ï¼š\nâ€œå» Redis é—®ä¸€å¥ï¼š â€˜æœ‰æ²¡æœ‰äººå·²ç»å ç”¨äº† idempotent:1001-2002 è¿™ä¸ªä½ç½®ï¼Ÿâ€™\nå¦‚æœæ²¡äººå  â†’ æˆ‘ç°åœ¨æŠŠå®ƒå ä½ï¼Œå€¼è®¾ä¸º \"1\"ï¼Œå¹¶ä¸” 10 ç§’åè‡ªåŠ¨é‡Šæ”¾ï¼ˆè¿‡æœŸï¼‰ã€‚ å¦‚æœå·²ç»æœ‰äººå äº† â†’ è¯´æ˜è¿™æ˜¯é‡å¤è¯·æ±‚ï¼Œåˆ«æ‰§è¡Œäº†ï¼â€ è¿™å°±æ˜¯å…¸å‹çš„ åˆ†å¸ƒå¼é” å®ç°æ–¹å¼ä¹‹ä¸€ï¼ˆè½»é‡çº§ï¼‰ã€‚\nâš ï¸ æ³¨æ„ï¼šè¿™é‡Œä¸æ˜¯çœŸæ­£çš„â€œäº’æ–¥é”â€ï¼ˆä¸æ”¯æŒå¯é‡å…¥ã€æ—  watch dogï¼‰ï¼Œä½†å¯¹â€œé˜²é‡å¤æäº¤â€åœºæ™¯å®Œå…¨å¤Ÿç”¨ï¼\nğŸ”¬ è¯­æ³•åŸç†ï¼š\nredisTemplate.opsForValue()\nSpring Data Redis æä¾›çš„æ“ä½œ Redis å­—ç¬¦ä¸²ï¼ˆString ç±»å‹ï¼‰çš„ APIã€‚ ç›¸å½“äº Redis çš„ SET, GET, INCR ç­‰å‘½ä»¤å°è£…ã€‚ .setIfAbsent(key, value, timeout, unit)\nå¯¹åº” Redis å‘½ä»¤ï¼š\nSET key value NX EX expireSeconds NX = Not eXistsï¼ˆåªæœ‰ key ä¸å­˜åœ¨æ—¶æ‰è®¾ç½®ï¼‰ EX = Expireï¼ˆè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå•ä½ç§’ï¼‰ âœ… è¿”å›å€¼ï¼š\ntrueï¼šè®¾ç½®æˆåŠŸï¼ˆç¬¬ä¸€æ¬¡è¯·æ±‚ï¼‰ falseï¼škey å·²å­˜åœ¨ï¼ˆé‡å¤è¯·æ±‚ï¼‰ å‚æ•°è¯´æ˜ï¼š\nå‚æ•° å«ä¹‰ lockKey è¦è®¾ç½®çš„ keyï¼Œå¦‚ \"idempotent:1001-2002\" \"1\" value å€¼ï¼Œå…¶å®å†…å®¹ä¸é‡è¦ï¼Œåªè¦å ä½å°±è¡Œï¼ˆä¹Ÿå¯ä»¥å†™ç”¨æˆ·IDã€æ—¶é—´æˆ³ç­‰ï¼‰ idempotent.expire() è¿‡æœŸæ—¶é—´ï¼Œæ¯”å¦‚ 10ï¼ˆæ¥è‡ªæ³¨è§£é…ç½®ï¼‰ TimeUnit.SECONDS æ—¶é—´å•ä½ï¼Œè¿™é‡Œæ˜¯â€œç§’â€ âœ… è‡ªåŠ¨è¿‡æœŸéå¸¸é‡è¦ï¼é˜²æ­¢ç¨‹åºå´©æºƒå¯¼è‡´é”æ°¸è¿œä¸é‡Šæ”¾ï¼ˆæ­»é”ï¼‰ã€‚\nğŸ§© ç¬¬7æ­¥ï¼šåˆ¤æ–­æ˜¯å¦åŠ é”æˆåŠŸ\nif (Boolean.TRUE.equals(isSet)) { return joinPoint.proceed(); } else { throw new RuntimeException(\"è¯·å‹¿é‡å¤æäº¤ï¼\"); } ğŸ’¬ å¤§ç™½è¯ï¼š\nâ€œçœ‹çœ‹åˆšæ‰å ä½ç½®æˆåŠŸæ²¡ï¼š\næˆåŠŸäº† â†’ æ”¾è¡Œï¼è®©åŸæ–¹æ³•æ­£å¸¸æ‰§è¡Œï¼ˆæ¯”å¦‚ä¿å­˜è¯„è®ºï¼‰ã€‚ å¤±è´¥äº† â†’ ç›´æ¥æŠ¥é”™ï¼šâ€˜ä½ ç‚¹å¤ªå¿«äº†ï¼Œè¯·å‹¿é‡å¤æäº¤ï¼â€™ ä¸æ‰§è¡Œä»»ä½•ä¸šåŠ¡é€»è¾‘ã€‚â€ è¿™å°±å®ç°äº†â€œåŒä¸€ä¸ªè¯·æ±‚ï¼ˆç›¸åŒ keyï¼‰åœ¨çŸ­æ—¶é—´å†…åªèƒ½æˆåŠŸä¸€æ¬¡â€ã€‚\nğŸ”¬ è¯­æ³•åŸç†ï¼š\nBoolean.TRUE.equals(isSet)\nä¸ºä»€ä¹ˆä¸ç”¨ isSet == trueï¼Ÿ å› ä¸º isSet æ˜¯ Boolean å¯¹è±¡ï¼ˆå¯èƒ½ä¸º nullï¼ï¼‰ å¦‚æœ Redis æ“ä½œå¼‚å¸¸ï¼ŒæŸäº›æƒ…å†µä¸‹å¯èƒ½è¿”å› null Boolean.TRUE.equals(...) å¯ä»¥å®‰å…¨é¿å…ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼ˆNPEï¼‰ âœ… æ¨èå†™æ³•ï¼šæ°¸è¿œç”¨ Boolean.TRUE.equals(obj) åˆ¤æ–­å¸ƒå°”å¯¹è±¡ã€‚\njoinPoint.proceed()\nAOP ä¸­çš„å…³é”®æ–¹æ³•ï¼šç»§ç»­æ‰§è¡Œè¢«æ‹¦æˆªçš„åŸå§‹æ–¹æ³• è¿”å›å€¼å°±æ˜¯åŸæ–¹æ³•çš„è¿”å›ç»“æœ å¦‚æœåŸæ–¹æ³•æŠ›å¼‚å¸¸ï¼Œè¿™é‡Œä¹Ÿä¼šæŠ›å‡ºæ¥ throw new RuntimeException(...)\nä¸»åŠ¨ä¸­æ–­æµç¨‹ï¼Œä¸è®©é‡å¤è¯·æ±‚è¿›å…¥ä¸šåŠ¡å±‚ å¼‚å¸¸ä¼šè¢« Spring å…¨å±€å¼‚å¸¸å¤„ç†å™¨æ•è·ï¼ˆå¦‚æœä½ æœ‰å†™çš„è¯ï¼‰ï¼Œè¿”å›å‹å¥½æç¤º ğŸ¯ å®Œæ•´æµç¨‹å›é¡¾ï¼ˆç”Ÿæ´»åŒ–æ¯”å–»ï¼‰\næƒ³è±¡ä½ åœ¨æŠ¢æ¼”å”±ä¼šé—¨ç¥¨ï¼š\nä½ ç‚¹å‡»â€œæŠ¢ç¥¨â€æŒ‰é’® â†’ è¯·æ±‚åˆ°è¾¾ /buyTicket?userId=1001\u0026showId=2002** ç³»ç»Ÿæ£€æŸ¥ï¼šRedis é‡Œæœ‰æ²¡æœ‰ idempotent:1001-2002ï¼Ÿ âŒ æ²¡æœ‰ â†’ ç³»ç»Ÿè¯´ï¼šâ€œå¥½ï¼Œç»™ä½ å ä¸ªåº§ï¼â€ï¼ˆsetIfAbsent æˆåŠŸï¼‰ ç„¶åçœŸæ­£å»æ‰£åº“å­˜ã€ç”Ÿæˆè®¢å•ï¼ˆproceed()ï¼‰ 10 ç§’ååº§ä½è‡ªåŠ¨é‡Šæ”¾ âœ… å·²ç»æœ‰äº† â†’ ç³»ç»Ÿè¯´ï¼šâ€œä½ å·²ç»æŠ¢è¿‡äº†ï¼Œåˆ«ç‚¹äº†ï¼â€ï¼ˆæŠ›å¼‚å¸¸ï¼‰ ç¬¬ä¸‰éƒ¨åˆ†ï¼š@PostMapping(\"/comment\") @PostMapping(\"/comment\") @Idempotent(key = \"#userId + '-' + #productId\", expire = 10) public String addComment( @RequestParam Long userId, @RequestParam Long productId, @RequestBody String content) { // ä¸šåŠ¡é€»è¾‘ } **ğŸ§© ç¬¬ä¸€è¡Œï¼š@PostMapping(\"/comment\")**\nğŸ’¬ å¤§ç™½è¯ï¼š\nâ€œå½“ç”¨æˆ·ç”¨ POST æ–¹å¼è®¿é—® /comment è¿™ä¸ªç½‘å€æ—¶ï¼Œè¯·è°ƒç”¨ä¸‹é¢è¿™ä¸ªæ–¹æ³•ã€‚â€\næ¯”å¦‚ç”¨æˆ·åœ¨ç½‘é¡µä¸Šç‚¹â€œæäº¤è¯„è®ºâ€æŒ‰é’®ï¼Œæµè§ˆå™¨å°±ä¼šå‘ä¸€ä¸ª POST è¯·æ±‚åˆ°ï¼š\n1POST http://yourserver.com/comment ğŸ”¬ è¯­æ³•åŸç†ï¼š\n@PostMapping æ˜¯ Spring MVC çš„æ³¨è§£ï¼Œç”¨äºæ˜ å°„ HTTP POST è¯·æ±‚ åˆ° Java æ–¹æ³•ã€‚ ç­‰ä»·äº @RequestMapping(method = RequestMethod.POST, path = \"/comment\") å¸¸ç”¨äºåˆ›å»ºèµ„æºï¼ˆå¦‚æäº¤è¡¨å•ã€å‘è¡¨è¯„è®ºã€ä¸‹å•ç­‰ï¼‰ âœ… å®ƒå‘Šè¯‰ Springï¼šâ€œè¿™ä¸ªæ–¹æ³•ä¸“é—¨å¤„ç† POST /comment è¯·æ±‚â€ã€‚\nğŸ§© ç¬¬äºŒè¡Œï¼š@Idempotent(key = \"#userId + '-' + #productId\", expire = 10)\nğŸ’¬ å¤§ç™½è¯ï¼š\nâ€œè¿™ä¸ªæ¥å£è¦é˜²é‡å¤æäº¤ï¼ åˆ¤æ–­æ˜¯å¦é‡å¤çš„æ ‡å‡†æ˜¯ï¼šåŒä¸€ä¸ªç”¨æˆ·ï¼ˆuserIdï¼‰å¯¹åŒä¸€ä¸ªå•†å“ï¼ˆproductIdï¼‰ã€‚ å¦‚æœ 10 ç§’å†…é‡å¤æäº¤ï¼Œå°±ç›´æ¥æ‹’ç»ï¼â€\nä¸¾ä¸ªä¾‹å­ï¼š\nç”¨æˆ· Aï¼ˆuserId=1001ï¼‰ç»™å•†å“ Bï¼ˆproductId=2002ï¼‰å†™è¯„è®º â†’ âœ… æˆåŠŸ ç”¨æˆ· A å†æ¬¡ç»™å•†å“ B å†™è¯„è®ºï¼ˆ10 ç§’å†…ï¼‰â†’ âŒ â€œè¯·å‹¿é‡å¤æäº¤ï¼â€ ç”¨æˆ· A ç»™å•†å“ Cï¼ˆproductId=3003ï¼‰å†™è¯„è®º â†’ âœ… æˆåŠŸï¼ˆå› ä¸º productId ä¸åŒï¼‰ ç”¨æˆ· Bï¼ˆuserId=1002ï¼‰ç»™å•†å“ B å†™è¯„è®º â†’ âœ… æˆåŠŸï¼ˆå› ä¸º userId ä¸åŒï¼‰ ğŸ¯ æ‰€ä»¥ #userId + '-' + #productId å°±æ˜¯â€œå”¯ä¸€æŒ‡çº¹â€ã€‚\nğŸ”¬ è¯­æ³•åŸç†ï¼š\n@Idempotent\nè¿™æ˜¯ä½ è‡ªå®šä¹‰çš„æ³¨è§£ï¼ˆä¸æ˜¯ Spring è‡ªå¸¦çš„ï¼‰ï¼Œç”¨æ¥æ ‡è®°â€œéœ€è¦å¹‚ç­‰æ§åˆ¶â€çš„æ–¹æ³•ã€‚ å®ƒå¿…é¡»é…åˆå‰é¢å†™çš„ IdempotentAspect åˆ‡é¢æ‰èƒ½ç”Ÿæ•ˆã€‚ key = \"#userId + '-' + #productId\"\nè¿™æ˜¯ä¸€ä¸ª SpELï¼ˆSpring Expression Languageï¼‰è¡¨è¾¾å¼ #userId å’Œ #productId å¯¹åº”ä¸‹é¢æ–¹æ³•çš„å‚æ•°å Spring AOP ä¼šåŠ¨æ€æ›¿æ¢ä¸ºå®é™…å€¼ï¼Œæ‹¼æˆå­—ç¬¦ä¸² expire = 10\nè¡¨ç¤º Redis é”çš„è¿‡æœŸæ—¶é—´æ˜¯ 10 ç§’ å•ä½é€šå¸¸æ˜¯ç§’ï¼ˆç”±åˆ‡é¢ä»£ç å†³å®šï¼‰ âš ï¸ æ³¨æ„ï¼šè¡¨è¾¾å¼ä¸­çš„å˜é‡å å¿…é¡»å’Œæ–¹æ³•å‚æ•°åå®Œå…¨ä¸€è‡´ï¼\nğŸ§© æ–¹æ³•ç­¾åéƒ¨åˆ†\npublic String addComment( @RequestParam Long userId, @RequestParam Long productId, @RequestBody String content) { æˆ‘ä»¬é€ä¸ªå‚æ•°çœ‹ã€‚\nâœ… å‚æ•°1ï¼š@RequestParam Long userId\nğŸ’¬ å¤§ç™½è¯ï¼š\nâ€œä» URL çš„æŸ¥è¯¢å‚æ•°ï¼ˆquery paramï¼‰é‡Œæ‹¿ userId çš„å€¼ã€‚â€\næ¯”å¦‚è¯·æ±‚æ˜¯ï¼š\n1POST /comment?userId=1001\u0026productId=2002 2Content-Type: application/json 3 4\"æœåŠ¡å¾ˆå¥½ï¼\" é‚£ä¹ˆ userId å°±ä¼šè¢«èµ‹å€¼ä¸º 1001ã€‚\nğŸ”¬ è¯­æ³•åŸç†ï¼š\n@RequestParamï¼šç»‘å®š HTTP è¯·æ±‚çš„ URL å‚æ•°ï¼ˆå³ ?userId=1001 ä¸­çš„éƒ¨åˆ†ï¼‰ é»˜è®¤å‚æ•°åå°±æ˜¯å˜é‡åï¼ˆuserIdï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¾å¼æŒ‡å®šï¼š@RequestParam(\"uid\") Long userId âœ… å‚æ•°2ï¼š@RequestParam Long productId\nåŒç†ï¼š\nä» ?productId=2002 ä¸­è·å–å€¼ èµ‹ç»™ productId å˜é‡ âœ… å‚æ•°3ï¼š@RequestBody String content\nğŸ’¬ å¤§ç™½è¯ï¼š\nâ€œæŠŠ HTTP è¯·æ±‚çš„æ­£æ–‡å†…å®¹ï¼ˆbodyï¼‰ å½“æˆå­—ç¬¦ä¸²è¯»è¿›æ¥ã€‚â€\næ¯”å¦‚å‰ç«¯å‘é€çš„ JSON æˆ–çº¯æ–‡æœ¬ï¼š\n\"è¿™æ¬¡è´­ç‰©ä½“éªŒéå¸¸æ£’ï¼\" æˆ–\n{\"text\": \"å¾ˆæ£’\"} // ä½†è¿™é‡Œä½ ç”¨çš„æ˜¯ Stringï¼Œæ‰€ä»¥ä¼šæ”¶åˆ°æ•´ä¸ª JSON å­—ç¬¦ä¸² ğŸ’¡ æ³¨æ„ï¼šå¦‚æœä½ å¸Œæœ›è‡ªåŠ¨è§£æ JSON å¯¹è±¡ï¼Œåº”è¯¥ç”¨ @RequestBody CommentDTO contentï¼Œè€Œä¸æ˜¯ Stringã€‚\nğŸ”¬ è¯­æ³•åŸç†ï¼š\n@RequestBodyï¼šç»‘å®š HTTP è¯·æ±‚çš„ body å†…å®¹ Spring ä¼šç”¨ HttpMessageConverterï¼ˆå¦‚ Jacksonï¼‰æŠŠ body è½¬æˆ Java å¯¹è±¡ è¿™é‡Œè½¬æˆ Stringï¼Œæ‰€ä»¥ç›´æ¥æ‹¿åˆ°åŸå§‹å­—ç¬¦ä¸² ğŸ¯ ä¸ºä»€ä¹ˆ content æ²¡å‡ºç°åœ¨ SpEL è¡¨è¾¾å¼é‡Œï¼Ÿ\nä½ åœ¨æ³¨è§£é‡Œå†™çš„æ˜¯ï¼š\n1@Idempotent(key = \"#userId + '-' + #productId\", ...) æ²¡æœ‰ç”¨ #contentï¼Œè¿™æ˜¯æ•…æ„è®¾è®¡çš„ï¼\nğŸ’¬ å¤§ç™½è¯è§£é‡Šï¼š\nâ€œæˆ‘ä»¬åªå…³å¿ƒâ€˜è°â€™å¯¹â€˜å“ªä¸ªå•†å“â€™è¯„è®ºï¼Œä¸å…³å¿ƒâ€˜è¯„è®ºå†…å®¹æ˜¯ä»€ä¹ˆâ€™ã€‚ å³ä½¿å†…å®¹ä¸åŒï¼Œåªè¦æ˜¯åŒä¸€ä¸ªç”¨æˆ·å¯¹åŒä¸€ä¸ªå•†å“ï¼Œ10 ç§’å†…ä¹Ÿåªèƒ½æäº¤ä¸€æ¬¡ã€‚â€\nâœ… è¿™æ˜¯åˆç†çš„ä¸šåŠ¡é€»è¾‘ï¼šé˜²æ­¢æ‰‹æŠ–é‡å¤ç‚¹â€œæäº¤â€ï¼Œè€Œä¸æ˜¯é˜²æ­¢å†…å®¹ä¸åŒã€‚\nå¦‚æœä½ æƒ³â€œå†…å®¹å˜äº†å°±ç®—æ–°è¯„è®ºâ€ï¼Œé‚£å¯ä»¥æ”¹æˆï¼š\n1@Idempotent(key = \"#userId + '-' + #productId + '-' + #content\", ...) ä½†é€šå¸¸æ²¡å¿…è¦ï¼Œè€Œä¸” content å¯èƒ½å¾ˆé•¿ï¼Œå¯¼è‡´ Redis key å¤ªå¤§ã€‚\nğŸ”„ æ•´ä½“æ‰§è¡Œæµç¨‹å›é¡¾é¡¾\nç”¨æˆ·å‘é€è¯·æ±‚ï¼š\nPOST /comment?userId=1001\u0026productId=2002 Body: \"å¥½è¯„ï¼\" Spring MVC åŒ¹é…åˆ° addComment æ–¹æ³•\nAOP å‘ç°æ–¹æ³•æœ‰ @Idempotentï¼Œè§¦å‘ IdempotentAspect\nåˆ‡é¢æå–å‚æ•°ï¼š\nuserId = 1001 productId = 2002 content = \"å¥½è¯„ï¼\"ï¼ˆè™½ç„¶æ²¡ç”¨åˆ°ï¼‰ è®¡ç®— SpEL è¡¨è¾¾å¼ï¼š\n\"#userId + '-' + #productId\" â†’ \"1001-2002\" æ„é€  Redis keyï¼š\"idempotent:1001-2002\"\nå°è¯•åŠ é”ï¼š\nç¬¬ä¸€æ¬¡ï¼šæˆåŠŸ â†’ æ‰§è¡Œ addComment ä¸šåŠ¡é€»è¾‘ é‡å¤ï¼šå¤±è´¥ â†’ æŠ›å¼‚å¸¸â€œè¯·å‹¿é‡å¤æäº¤ï¼â€ â— å¸¸è§é”™è¯¯æ’æŸ¥ï¼ˆå°ç™½æ³¨æ„ï¼‰\né—®é¢˜ åŸå›  è§£å†³æ–¹æ¡ˆ #userId æ‰¾ä¸åˆ° ç¼–è¯‘æ—¶æœªä¿ç•™å‚æ•°å Maven/Gradle åŠ  -parameters è¡¨è¾¾å¼æŠ¥é”™ å‚æ•°åæ‹¼å†™é”™è¯¯ ç¡®ä¿ #xxx å’Œæ–¹æ³•å‚æ•°åå®Œå…¨ä¸€è‡´ Redis key å¤ªé•¿ ç”¨äº† #content ä¸”å†…å®¹å¾ˆé•¿ é¿å…åœ¨ key ä¸­åŒ…å«å¤§å­—æ®µ å¹‚ç­‰å¤±æ•ˆ expire æ—¶é—´å¤ªçŸ­ æ ¹æ®ä¸šåŠ¡è°ƒæ•´ï¼Œæ¯”å¦‚ 30 ç§’ âœ… æœ€ä½³å®è·µå»ºè®®\nkey è®¾è®¡è¦çŸ­è€Œå”¯ä¸€ï¼šåªåŒ…å«å¿…è¦å­—æ®µï¼ˆç”¨æˆ·IDã€å•†å“IDã€è®¢å•å·ç­‰ï¼‰ expire æ—¶é—´åˆç†ï¼šæ¯”ä¸šåŠ¡æœ€å¤§è€—æ—¶ç•¥é•¿ï¼ˆå¦‚ 10~60 ç§’ï¼‰ ä¸è¦ä¾èµ– contentï¼šé™¤éä¸šåŠ¡æ˜ç¡®è¦æ±‚â€œå†…å®¹ä¸åŒå°±ç®—æ–°è¯·æ±‚â€ è¿”å›å‹å¥½æç¤ºï¼šç”¨è‡ªå®šä¹‰å¼‚å¸¸ + å…¨å±€å¼‚å¸¸å¤„ç†å™¨è¿”å› JSON ä¾‹å¦‚ï¼š\nthrow new IdempotentException(\"è¯·å‹¿é‡å¤æäº¤\"); ç„¶åå…¨å±€æ•è·ï¼Œè¿”å›ï¼š\n{ \"code\": 400, \"msg\": \"è¯·å‹¿é‡å¤æäº¤\" } ğŸ’¡ æ€»ç»“ä¸€å¥è¯\n@PostMapping(\"/comment\") @Idempotent(key = \"#userId + '-' + #productId\", expire = 10) public String addComment(@RequestParam Long userId, @RequestParam Long productId, @RequestBody String content) å°±åƒæ˜¯åœ¨è¯´ï¼š\nâ€œå‡¡æ˜¯é€šè¿‡ POST æäº¤åˆ° /comment çš„è¯·æ±‚ï¼Œ åªè¦æ˜¯åŒä¸€ä¸ªç”¨æˆ·ï¼ˆuserIdï¼‰å¯¹åŒä¸€ä¸ªå•†å“ï¼ˆproductIdï¼‰çš„æ“ä½œï¼Œ 10 ç§’å†…åªå…è®¸æˆåŠŸä¸€æ¬¡ï¼Œå…¶ä½™å…¨éƒ¨æ‹¦æˆªï¼\n","wordCount":"3378","inLanguage":"en","datePublished":"2025-11-23T18:30:00+08:00","dateModified":"2025-11-23T18:30:00+08:00","author":{"@type":"Person","name":"æ‚¨çš„å§“å"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://ljj1992.fun/posts/aop%E5%88%87%E9%9D%A2/"},"publisher":{"@type":"Organization","name":"starå¾çš„åšå®¢","logo":{"@type":"ImageObject","url":"http://ljj1992.fun/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=http://ljj1992.fun/ accesskey=h title="starå¾çš„åšå®¢ (Alt + H)">starå¾çš„åšå®¢</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://ljj1992.fun/ title=é¦–é¡µ><span>é¦–é¡µ</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://ljj1992.fun/>Home</a>&nbsp;Â»&nbsp;<a href=http://ljj1992.fun/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">AOPåˆ‡é¢(javaæ–°æ‰‹)</h1><div class=post-meta><span title='2025-11-23 18:30:00 +0800 +0800'>November 23, 2025</span>&nbsp;Â·&nbsp;<span>æ‚¨çš„å§“å</span></div></header><div class=post-content><h1 id=aopåˆ‡é¢javaæ–°æ‰‹>AOPåˆ‡é¢(javaæ–°æ‰‹)<a hidden class=anchor aria-hidden=true href=#aopåˆ‡é¢javaæ–°æ‰‹>#</a></h1><h2 id=-ä¸€ä¸ºä»€ä¹ˆè¦ç”¨-aop>ğŸŒŸ ä¸€ã€ä¸ºä»€ä¹ˆè¦ç”¨ AOPï¼Ÿ<a hidden class=anchor aria-hidden=true href=#-ä¸€ä¸ºä»€ä¹ˆè¦ç”¨-aop>#</a></h2><p>æƒ³è±¡ä¸€ä¸‹ï¼šä½ åœ¨å¼€å‘ä¸€ä¸ªç”µå•†ç½‘ç«™ï¼Œæœ‰å‡ åä¸ªæ¥å£ï¼Œæ¯”å¦‚</p><ul><li>ç”¨æˆ·ç™»å½•</li><li>ä¸‹å•</li><li>æŸ¥çœ‹å•†å“</li><li>ä¿®æ”¹åœ°å€</li><li>æ”¯ä»˜è®¢å•</li></ul><p>è¿™äº›åŠŸèƒ½éƒ½å±äºâ€œä¸šåŠ¡é€»è¾‘â€ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰ã€‚ä½†ä½ å‘ç°ï¼Œ<strong>æ¯ä¸ªæ¥å£éƒ½éœ€è¦åšä¸¤ä»¶äº‹</strong>ï¼š</p><ol><li><strong>è®°å½•æ—¥å¿—</strong>ï¼ˆè°åœ¨ä»€ä¹ˆæ—¶å€™è°ƒç”¨äº†å“ªä¸ªæ¥å£ï¼Ÿï¼‰</li><li><strong>æ£€æŸ¥ç”¨æˆ·æœ‰æ²¡æœ‰æƒé™</strong>ï¼ˆæ¯”å¦‚æ™®é€šç”¨æˆ·ä¸èƒ½åˆ åˆ«äººè®¢å•ï¼‰</li></ol><p>å¦‚æœä¸ç”¨ AOPï¼Œä½ å¯èƒ½ä¼šåœ¨<strong>æ¯ä¸ªæ–¹æ³•é‡Œæ‰‹åŠ¨å†™æ—¥å¿—å’Œæƒé™æ£€æŸ¥ä»£ç </strong>ï¼Œåƒè¿™æ ·</p><p>é—®é¢˜æ¥äº†ï¼š</p><ul><li>ä»£ç é‡å¤ï¼æ¯ä¸ªæ–¹æ³•éƒ½è¦å†™ä¸€æ ·çš„æ—¥å¿—å’Œæƒé™ã€‚</li><li>ä¸šåŠ¡é€»è¾‘è¢«â€œæ±¡æŸ“â€äº†ï¼Œçœ‹ä¸æ¸…æ ¸å¿ƒåŠŸèƒ½ã€‚</li><li>å¦‚æœå“ªå¤©è¦æ”¹æ—¥å¿—æ ¼å¼ï¼Ÿå¾—æ”¹å‡ åä¸ªåœ°æ–¹ï¼</li></ul><p>ğŸ‘‰ <strong>AOP å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§â€œæ¨ªç€åˆ‡â€çš„å…¬å…±é—®é¢˜è€Œç”Ÿçš„ï¼</strong></p><p>ğŸ‘‰ <strong>AOP å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§â€œæ¨ªç€åˆ‡â€çš„å…¬å…±é—®é¢˜è€Œç”Ÿçš„ï¼</strong></p><blockquote><p>âœ… <strong>AOP çš„æ ¸å¿ƒæ€æƒ³</strong>ï¼š
æŠŠé‚£äº›<strong>å’Œä¸šåŠ¡æ— å…³ä½†åˆåˆ°å¤„è¦ç”¨çš„åŠŸèƒ½</strong>ï¼ˆæ¯”å¦‚æ—¥å¿—ã€æƒé™ã€äº‹åŠ¡ã€é˜²é‡æäº¤ï¼‰<strong>æŠ½å‡ºæ¥</strong>ï¼Œå†™åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œè‡ªåŠ¨â€œç»‡å…¥â€åˆ°éœ€è¦çš„åœ°æ–¹ã€‚
ä¸šåŠ¡ä»£ç åªç®¡åšè‡ªå·±çš„äº‹ï¼Œå¹²å‡€æ¸…çˆ½ï¼</p></blockquote><h2 id=-äºŒæ€ä¹ˆç†è§£-aopç”¨ä¸¤ä¸ªçœŸå®ä¾‹å­>ğŸ§© äºŒã€æ€ä¹ˆç†è§£ AOPï¼Ÿç”¨ä¸¤ä¸ªçœŸå®ä¾‹å­<a hidden class=anchor aria-hidden=true href=#-äºŒæ€ä¹ˆç†è§£-aopç”¨ä¸¤ä¸ªçœŸå®ä¾‹å­>#</a></h2><h2 id=-è‡ªåŠ¨è®°å½•æ¥å£æ—¥å¿—æœ€å¸¸è§>âœ… è‡ªåŠ¨è®°å½•æ¥å£æ—¥å¿—ï¼ˆæœ€å¸¸è§ï¼ï¼‰<a hidden class=anchor aria-hidden=true href=#-è‡ªåŠ¨è®°å½•æ¥å£æ—¥å¿—æœ€å¸¸è§>#</a></h2><h4 id=åœºæ™¯>åœºæ™¯ï¼š<a hidden class=anchor aria-hidden=true href=#åœºæ™¯>#</a></h4><p>ä½ æƒ³çŸ¥é“å“ªäº›ç”¨æˆ·è°ƒç”¨äº†å“ªäº›æ¥å£ã€èŠ±äº†å¤šé•¿æ—¶é—´ã€‚</p><h4 id=ä¸ç”¨-aopéº»çƒ¦>ä¸ç”¨ AOPï¼ˆéº»çƒ¦ï¼‰ï¼š<a hidden class=anchor aria-hidden=true href=#ä¸ç”¨-aopéº»çƒ¦>#</a></h4><p>æ¯ä¸ª Controller æ–¹æ³•é‡Œæ‰‹å†™ <code>logger.info(...)</code>ã€‚</p><h4 id=ç”¨-aopä¼˜é›…>ç”¨ AOPï¼ˆä¼˜é›…ï¼‰ï¼š<a hidden class=anchor aria-hidden=true href=#ç”¨-aopä¼˜é›…>#</a></h4><ol><li><strong>å®šä¹‰ä¸€ä¸ªâ€œåˆ‡é¢â€ç±»</strong>ï¼ˆä¸“é—¨å¤„ç†æ—¥å¿—ï¼‰ï¼š</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Aspect</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LogAspect</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Logger logger <span style=color:#f92672>=</span> LoggerFactory.<span style=color:#a6e22e>getLogger</span>(LogAspect.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å®šä¹‰â€œåˆ‡å…¥ç‚¹â€ï¼šæ‰€æœ‰ Controller åŒ…ä¸‹çš„ public æ–¹æ³•</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Pointcut</span>(<span style=color:#e6db74>&#34;execution(public * com.example.controller..*.*(..))&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>controllerMethods</span>() {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åœ¨æ–¹æ³•æ‰§è¡Œå‰è®°å½•å¼€å§‹</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Before</span>(<span style=color:#e6db74>&#34;controllerMethods()&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>logBefore</span>(JoinPoint joinPoint) {
</span></span><span style=display:flex><span>        String methodName <span style=color:#f92672>=</span> joinPoint.<span style=color:#a6e22e>getSignature</span>().<span style=color:#a6e22e>getName</span>();
</span></span><span style=display:flex><span>        Object<span style=color:#f92672>[]</span> args <span style=color:#f92672>=</span> joinPoint.<span style=color:#a6e22e>getArgs</span>();
</span></span><span style=display:flex><span>        logger.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;è°ƒç”¨æ–¹æ³•: {}, å‚æ•°: {}&#34;</span>, methodName, Arrays.<span style=color:#a6e22e>toString</span>(args));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åœ¨æ–¹æ³•æ‰§è¡Œåè®°å½•è€—æ—¶</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Around</span>(<span style=color:#e6db74>&#34;controllerMethods()&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>logTime</span>(ProceedingJoinPoint joinPoint) <span style=color:#66d9ef>throws</span> Throwable {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> start <span style=color:#f92672>=</span> System.<span style=color:#a6e22e>currentTimeMillis</span>();
</span></span><span style=display:flex><span>        Object result <span style=color:#f92672>=</span> joinPoint.<span style=color:#a6e22e>proceed</span>(); <span style=color:#75715e>// æ‰§è¡ŒåŸæ–¹æ³•</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> time <span style=color:#f92672>=</span> System.<span style=color:#a6e22e>currentTimeMillis</span>() <span style=color:#f92672>-</span> start;
</span></span><span style=display:flex><span>        logger.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;æ–¹æ³• {} è€—æ—¶ {}ms&#34;</span>, joinPoint.<span style=color:#a6e22e>getSignature</span>().<span style=color:#a6e22e>getName</span>(), time);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol><li><strong>ä½ çš„ä¸šåŠ¡ä»£ç å®Œå…¨ä¸ç”¨æ”¹ï¼</strong></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderController</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;/order&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>createOrder</span>(<span style=color:#a6e22e>@RequestBody</span> Order order) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// åªå†™ä¸šåŠ¡é€»è¾‘ï¼æ—¥å¿—è‡ªåŠ¨åŠ ä¸Šäº†</span>
</span></span><span style=display:flex><span>        orderService.<span style=color:#a6e22e>save</span>(order);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;success&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>âœ… <strong>æ•ˆæœ</strong>ï¼šåªè¦è°ƒç”¨ <code>/order</code>ï¼ŒAOP è‡ªåŠ¨å¸®ä½ æ‰“æ—¥å¿—ã€ç®—æ—¶é—´ï¼Œ<strong>ä¸šåŠ¡ä»£ç é›¶ä¾µå…¥</strong>ï¼</p><h4 id=çœ‹æ‡‚-aop-æ˜¯æ€ä¹ˆè¿è¡Œçš„>çœ‹æ‡‚ AOP æ˜¯æ€ä¹ˆè¿è¡Œçš„<a hidden class=anchor aria-hidden=true href=#çœ‹æ‡‚-aop-æ˜¯æ€ä¹ˆè¿è¡Œçš„>#</a></h4><p>ğŸŒŸ <strong>å…ˆè¯´æ¸…æ¥šï¼šAOP åˆ°åº•æ˜¯æ€ä¹ˆâ€œæ’è¿›å»â€çš„ï¼Ÿ</strong></p><blockquote><p>ğŸ”‘ <strong>æ ¸å¿ƒåŸç†ä¸€å¥è¯</strong>ï¼š
Spring åœ¨å¯åŠ¨æ—¶ï¼Œä¼šå·å·æŠŠä½ çš„ä¸šåŠ¡ç±»ï¼ˆæ¯”å¦‚ <code>OrderController</code>ï¼‰<strong>æ›¿æ¢æˆä¸€ä¸ªâ€œä»£ç†å¯¹è±¡â€</strong>ã€‚
å½“ä½ è°ƒç”¨ <code>createOrder()</code> æ—¶ï¼Œå…¶å®å…ˆæ‰§è¡Œçš„æ˜¯ AOP é‡Œçš„ä»£ç ï¼Œç„¶åå†å»è°ƒçœŸæ­£çš„ä¸šåŠ¡æ–¹æ³•ã€‚</p></blockquote><p>è¿™å°±åƒä½ ç‚¹å¤–å–ï¼š</p><ul><li>ä½ ä»¥ä¸ºç›´æ¥è”ç³»å¨å¸ˆï¼ˆä¸šåŠ¡æ–¹æ³•ï¼‰</li><li>å…¶å®ä¸­é—´æœ‰ä¸ªâ€œæ™ºèƒ½å‰å°â€ï¼ˆä»£ç†å¯¹è±¡ï¼‰ï¼šå…ˆæ£€æŸ¥ä½ æ˜¯ä¸æ˜¯ä¼šå‘˜ï¼ˆæƒé™ï¼‰ã€è®°å½•ä½ ç‚¹äº†ä»€ä¹ˆï¼ˆæ—¥å¿—ï¼‰ï¼Œå†é€šçŸ¥å¨æˆ¿åšèœ</li></ul><hr><p>ç°åœ¨æˆ‘ä»¬æ¥é€è¡Œè§£è¯»ä¸¤ä¸ªä¾‹å­ã€‚</p><hr><h4 id=-è‡ªåŠ¨è®°å½•æ¥å£æ—¥å¿—é€è¡Œè¯¦è§£>âœ… è‡ªåŠ¨è®°å½•æ¥å£æ—¥å¿—ï¼ˆé€è¡Œè¯¦è§£ï¼‰<a hidden class=anchor aria-hidden=true href=#-è‡ªåŠ¨è®°å½•æ¥å£æ—¥å¿—é€è¡Œè¯¦è§£>#</a></h4><p><strong>ç¬¬ä¸€æ­¥ï¼šå®šä¹‰åˆ‡é¢ç±»ï¼ˆLogAspect.javaï¼‰</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Aspect</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LogAspect</span> {
</span></span></code></pre></div><ul><li><code>@Aspect</code>ï¼šå‘Šè¯‰ Springï¼šâ€œæˆ‘æ˜¯ä¸€ä¸ªåˆ‡é¢ç±»ï¼Œé‡Œé¢è£…çš„æ˜¯æ¨ªåˆ‡é€»è¾‘ï¼ˆæ¯”å¦‚æ—¥å¿—ï¼‰â€</li><li><code>@Component</code>ï¼šè®© Spring èƒ½æ‰«æåˆ°è¿™ä¸ªç±»ï¼Œå¹¶æŠŠå®ƒæ”¾è¿›å®¹å™¨é‡Œï¼ˆå¦åˆ™ä¸ä¼šç”Ÿæ•ˆï¼‰</li></ul><blockquote><p>ğŸ’¡ å°±åƒä½ å‘Šè¯‰å…¬å¸ï¼šâ€œæˆ‘æ˜¯ä¸“é—¨è´Ÿè´£æ‰“å¡è€ƒå‹¤çš„äººâ€ï¼Œå…¬å¸æ‰ä¼šè®©ä½ ä¸Šå²—ã€‚</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Pointcut</span>(<span style=color:#e6db74>&#34;execution(public * com.example.controller..*.*(..))&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>controllerMethods</span>() {}
</span></span></code></pre></div><ul><li><p><code>@Pointcut</code>ï¼šå®šä¹‰â€œåœ¨å“ªäº›åœ°æ–¹æ’å…¥é€»è¾‘â€</p></li><li><p>è¡¨è¾¾å¼å«ä¹‰ï¼ˆå¤§ç™½è¯ï¼‰ï¼š</p><ul><li><p><code>execution(...)</code>ï¼šåŒ¹é…æ–¹æ³•æ‰§è¡Œ</p></li><li><p><code>public *</code>ï¼šä»»æ„è¿”å›å€¼çš„ public æ–¹æ³•</p></li><li><pre tabindex=0><code>com.example.controller..*.*(..)
</code></pre><ul><li><code>com.example.controller</code>ï¼šåŒ…å</li><li><code>..</code>ï¼šåŒ…æ‹¬æ‰€æœ‰å­åŒ…ï¼ˆæ¯”å¦‚ controller.user, controller.orderï¼‰</li><li><code>*.*(..)</code>ï¼šä»»æ„ç±»çš„ä»»æ„æ–¹æ³•ï¼Œä»»æ„å‚æ•°</li></ul><p>âœ… è¿™å¥è¯çš„æ„æ€æ˜¯ï¼š<strong>æ‰€æœ‰ Controller åŒ…ä¸‹çš„ public æ–¹æ³•ï¼Œéƒ½æ˜¯æˆ‘çš„ç›®æ ‡ï¼</strong></p><blockquote><p>ğŸ’¡ è¿™ä¸ªæ–¹æ³•æœ¬èº«æ˜¯ç©ºçš„ï¼Œåªæ˜¯ä¸ªâ€œæ ‡è®°â€ï¼Œæ–¹ä¾¿åé¢å¼•ç”¨ï¼Œå°±åƒç»™ä¸€å †é—¨è´´ä¸Šâ€œçº¢è‰²æ ‡ç­¾â€ï¼Œåé¢è¯´â€œæ‰€æœ‰çº¢æ ‡ç­¾çš„é—¨éƒ½è¦æ£€æŸ¥â€ã€‚</p></blockquote></li></ul></li></ul><hr><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Before</span>(<span style=color:#e6db74>&#34;controllerMethods()&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>logBefore</span>(JoinPoint joinPoint) {
</span></span><span style=display:flex><span>        String methodName <span style=color:#f92672>=</span> joinPoint.<span style=color:#a6e22e>getSignature</span>().<span style=color:#a6e22e>getName</span>();
</span></span><span style=display:flex><span>        Object<span style=color:#f92672>[]</span> args <span style=color:#f92672>=</span> joinPoint.<span style=color:#a6e22e>getArgs</span>();
</span></span><span style=display:flex><span>        logger.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;è°ƒç”¨æ–¹æ³•: {}, å‚æ•°: {}&#34;</span>, methodName, Arrays.<span style=color:#a6e22e>toString</span>(args));
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><ul><li><p><code>@Before("controllerMethods()")</code>ï¼šåœ¨â€œçº¢æ ‡ç­¾çš„é—¨â€è¢«æ‰“å¼€<strong>ä¹‹å‰</strong>ï¼Œæ‰§è¡Œè¿™ä¸ªæ–¹æ³•</p></li><li><p><code>JoinPoint joinPoint</code>ï¼šä»£è¡¨â€œå½“å‰æ­£åœ¨è¢«è°ƒç”¨çš„é‚£ä¸ªæ–¹æ³•â€çš„ä¸Šä¸‹æ–‡ä¿¡æ¯</p></li><li><p><code>joinPoint.getSignature().getName()</code> â†’ è·å–æ–¹æ³•åï¼Œæ¯”å¦‚ <code>"createOrder"</code></p></li><li><p><code>joinPoint.getArgs()</code> â†’ è·å–ä¼ å…¥çš„å‚æ•°ï¼Œæ¯”å¦‚ <code>[Order{id=1, userId=123}]</code></p></li></ul><p>âœ… æ•ˆæœï¼šç”¨æˆ·ä¸€è°ƒæ¥å£ï¼Œç«‹åˆ»æ‰“å°ï¼š
<code>è°ƒç”¨æ–¹æ³•: createOrder, å‚æ•°: [Order{id=1, userId=123}]</code></p><blockquote><p>ğŸ’¡ å°±åƒé—¨å«åœ¨ä½ è¿›é—¨æ—¶é—®ï¼šâ€œä½ æ˜¯è°ï¼Ÿæ¥å¹²å˜›ï¼Ÿâ€ç„¶åè®°åœ¨æœ¬å­ä¸Šã€‚</p></blockquote><hr><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Around</span>(<span style=color:#e6db74>&#34;controllerMethods()&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>logTime</span>(ProceedingJoinPoint joinPoint) <span style=color:#66d9ef>throws</span> Throwable {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> start <span style=color:#f92672>=</span> System.<span style=color:#a6e22e>currentTimeMillis</span>();
</span></span><span style=display:flex><span>        Object result <span style=color:#f92672>=</span> joinPoint.<span style=color:#a6e22e>proceed</span>(); <span style=color:#75715e>// â­ å…³é”®ï¼æ‰§è¡ŒçœŸæ­£çš„ä¸šåŠ¡æ–¹æ³•</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> time <span style=color:#f92672>=</span> System.<span style=color:#a6e22e>currentTimeMillis</span>() <span style=color:#f92672>-</span> start;
</span></span><span style=display:flex><span>        logger.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;æ–¹æ³• {} è€—æ—¶ {}ms&#34;</span>, joinPoint.<span style=color:#a6e22e>getSignature</span>().<span style=color:#a6e22e>getName</span>(), time);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><ul><li><p><code>@Around</code>ï¼š<strong>ç¯ç»•é€šçŸ¥</strong>â€”â€”æœ€å¼ºå¤§çš„é€šçŸ¥ç±»å‹ï¼Œå¯ä»¥åœ¨æ–¹æ³•å‰åéƒ½å¹²æ´»</p></li><li><p><code>ProceedingJoinPoint</code>ï¼šæ˜¯ <code>JoinPoint</code> çš„å‡çº§ç‰ˆï¼Œå¤šäº† <code>.proceed()</code> æ–¹æ³•</p></li><li><p><code>joinPoint.proceed()</code>ï¼š<strong>çœŸæ­£å»è°ƒç”¨åŸå§‹çš„ä¸šåŠ¡æ–¹æ³•</strong>ï¼ˆæ¯”å¦‚ <code>orderService.save(order)</code>ï¼‰</p></li></ul><p>â€‹ è¿™è¡Œä»£ç ä¹‹å‰ï¼šç›¸å½“äºâ€œå‰ç½®é€šçŸ¥â€</p><p>â€‹ è¿™è¡Œä»£ç ä¹‹åï¼šç›¸å½“äºâ€œåç½®é€šçŸ¥â€</p><p>âœ… æ‰§è¡Œæµç¨‹ï¼š</p><ol><li>è®°å½•å¼€å§‹æ—¶é—´</li><li><strong>æ‰§è¡ŒçœŸæ­£çš„ createOrder()</strong></li><li>è®¡ç®—è€—æ—¶</li><li>æ‰“å°æ—¥å¿—</li><li>æŠŠä¸šåŠ¡æ–¹æ³•çš„è¿”å›å€¼åŸæ ·è¿”å›ï¼ˆä¸èƒ½ä¸¢ï¼ï¼‰</li></ol><blockquote><p>ğŸ’¡ å°±åƒå¿«é€’å‘˜é€åŒ…è£¹ï¼š</p><ul><li>å…ˆæ‰«ç ç™»è®°ï¼ˆè®°å½•å¼€å§‹ï¼‰</li><li>ç„¶åçœŸçš„å»é€è´§ï¼ˆproceedï¼‰</li><li>é€åˆ°åå›ä¼ ç­¾æ”¶å•ï¼ˆreturn resultï¼‰</li><li>åŒæ—¶è®°å½•ç”¨äº†å¤šä¹…</li></ul></blockquote><h3 id=éªŒè¯æµ‹è¯•ç»“æœ>éªŒè¯æµ‹è¯•ç»“æœ<a hidden class=anchor aria-hidden=true href=#éªŒè¯æµ‹è¯•ç»“æœ>#</a></h3><h3 id=-åœºæ™¯å›é¡¾>ğŸ§ª åœºæ™¯å›é¡¾<a hidden class=anchor aria-hidden=true href=#-åœºæ™¯å›é¡¾>#</a></h3><p>ä½ æœ‰è¿™æ ·ä¸€ä¸ª Controllerï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Logger logger <span style=color:#f92672>=</span> LoggerFactory.<span style=color:#a6e22e>getLogger</span>(OrderController.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;/order&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>createOrder</span>(<span style=color:#a6e22e>@RequestBody</span> Order order) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†ï¼šæ¯”å¦‚ä¿å­˜è®¢å•</span>
</span></span><span style=display:flex><span>        logger.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;ã€ä¸šåŠ¡å±‚ã€‘æ­£åœ¨ä¿å­˜è®¢å•: {}&#34;</span>, order);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;è®¢å•åˆ›å»ºæˆåŠŸï¼&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åŒæ—¶ï¼Œä½ æœ‰ä¸€ä¸ª AOP åˆ‡é¢ç±»ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Aspect</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LogAspect</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Logger logger <span style=color:#f92672>=</span> LoggerFactory.<span style=color:#a6e22e>getLogger</span>(LogAspect.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Pointcut</span>(<span style=color:#e6db74>&#34;execution(public * com.example.controller..*.*(..))&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>controllerMethods</span>() {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Before</span>(<span style=color:#e6db74>&#34;controllerMethods()&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>logBefore</span>(JoinPoint joinPoint) {
</span></span><span style=display:flex><span>        String methodName <span style=color:#f92672>=</span> joinPoint.<span style=color:#a6e22e>getSignature</span>().<span style=color:#a6e22e>getName</span>();
</span></span><span style=display:flex><span>        Object<span style=color:#f92672>[]</span> args <span style=color:#f92672>=</span> joinPoint.<span style=color:#a6e22e>getArgs</span>();
</span></span><span style=display:flex><span>        logger.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;&gt;&gt;&gt; [AOPå‰ç½®] è°ƒç”¨æ–¹æ³•: {}, å‚æ•°: {}&#34;</span>, methodName, Arrays.<span style=color:#a6e22e>toString</span>(args));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Around</span>(<span style=color:#e6db74>&#34;controllerMethods()&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>logTime</span>(ProceedingJoinPoint joinPoint) <span style=color:#66d9ef>throws</span> Throwable {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> start <span style=color:#f92672>=</span> System.<span style=color:#a6e22e>currentTimeMillis</span>();
</span></span><span style=display:flex><span>        logger.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;&gt;&gt;&gt; [AOPç¯ç»•å¼€å§‹] å‡†å¤‡æ‰§è¡Œæ–¹æ³•: {}&#34;</span>, joinPoint.<span style=color:#a6e22e>getSignature</span>().<span style=color:#a6e22e>getName</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// â­ å…³é”®ï¼šçœŸæ­£æ‰§è¡Œ createOrder()</span>
</span></span><span style=display:flex><span>        Object result <span style=color:#f92672>=</span> joinPoint.<span style=color:#a6e22e>proceed</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> time <span style=color:#f92672>=</span> System.<span style=color:#a6e22e>currentTimeMillis</span>() <span style=color:#f92672>-</span> start;
</span></span><span style=display:flex><span>        logger.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;&gt;&gt;&gt; [AOPç¯ç»•ç»“æŸ] æ–¹æ³• {} æ‰§è¡Œå®Œæ¯•ï¼Œè€—æ—¶: {} ms&#34;</span>, 
</span></span><span style=display:flex><span>                    joinPoint.<span style=color:#a6e22e>getSignature</span>().<span style=color:#a6e22e>getName</span>(), time);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>ğŸ’¡ æ³¨æ„ï¼š<code>@Before</code> å’Œ <code>@Around</code> åŒæ—¶å­˜åœ¨æ—¶ï¼Œ<strong><code>@Around</code> ä¼šåŒ…è£¹ <code>@Before</code></strong>ï¼ˆå› ä¸º <code>@Around</code> æ˜¯æœ€å¤–å±‚çš„ä»£ç†é€»è¾‘ï¼‰ã€‚</p></blockquote><hr><h5 id=-å‡è®¾ä½ å‘é€ä¸€ä¸ªè¯·æ±‚>ğŸ–¥ï¸ å‡è®¾ä½ å‘é€ä¸€ä¸ªè¯·æ±‚ï¼š<a hidden class=anchor aria-hidden=true href=#-å‡è®¾ä½ å‘é€ä¸€ä¸ªè¯·æ±‚>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>POST http://localhost:8080/order
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>Content-Type: application/json
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  &#34;userId&#34;: 1001,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  &#34;productId&#34;: 2002,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  &#34;amount&#34;: 99.9
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span></code></pre></div><h5 id=-ç¨‹åºæ‰§è¡Œé¡ºåº--æ§åˆ¶å°è¾“å‡ºé€è¡Œ>âœ… ç¨‹åºæ‰§è¡Œé¡ºåº + æ§åˆ¶å°è¾“å‡ºï¼ˆé€è¡Œï¼‰<a hidden class=anchor aria-hidden=true href=#-ç¨‹åºæ‰§è¡Œé¡ºåº--æ§åˆ¶å°è¾“å‡ºé€è¡Œ>#</a></h5><p>å½“ Spring Boot æ”¶åˆ°è¿™ä¸ªè¯·æ±‚ï¼Œä¼šå‘ç”Ÿä»¥ä¸‹äº‹æƒ…ï¼š</p><h5 id=ç¬¬ä¸€æ­¥è¿›å…¥><strong>ç¬¬ä¸€æ­¥ï¼šè¿›å…¥ <code>@Around</code>ï¼ˆæœ€å¤–å±‚ï¼‰</strong><a hidden class=anchor aria-hidden=true href=#ç¬¬ä¸€æ­¥è¿›å…¥>#</a></h5><pre tabindex=0><code class=language-log data-lang=log>&gt;&gt;&gt; [AOPç¯ç»•å¼€å§‹] å‡†å¤‡æ‰§è¡Œæ–¹æ³•: createOrder
</code></pre><h5 id=ç¬¬äºŒæ­¥æ‰§è¡Œ-before>ç¬¬äºŒæ­¥ï¼šæ‰§è¡Œ <code>@Before</code><a hidden class=anchor aria-hidden=true href=#ç¬¬äºŒæ­¥æ‰§è¡Œ-before>#</a></h5><pre tabindex=0><code>&gt;&gt;&gt; [AOPå‰ç½®] è°ƒç”¨æ–¹æ³•: createOrder, å‚æ•°: [Order(userId=1001, productId=2002, amount=99.9)]
</code></pre><blockquote><p>ğŸ” å‚æ•°æ˜¾ç¤ºçš„æ˜¯ <code>Order</code> å¯¹è±¡çš„ <code>toString()</code> ç»“æœã€‚å¦‚æœä½ æ²¡é‡å†™ <code>toString()</code>ï¼Œå¯èƒ½æ˜¾ç¤ºç±»ä¼¼ <code>com.example.Order@1a2b3c</code>ã€‚å»ºè®®ç»™ <code>Order</code> åŠ  Lombok çš„ <code>@Data</code> æˆ–æ‰‹åŠ¨é‡å†™ <code>toString()</code>ã€‚</p></blockquote><h5 id=ç¬¬ä¸‰æ­¥æ‰§è¡ŒçœŸæ­£çš„ä¸šåŠ¡æ–¹æ³•-createorder>ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡ŒçœŸæ­£çš„ä¸šåŠ¡æ–¹æ³• <code>createOrder()</code><a hidden class=anchor aria-hidden=true href=#ç¬¬ä¸‰æ­¥æ‰§è¡ŒçœŸæ­£çš„ä¸šåŠ¡æ–¹æ³•-createorder>#</a></h5><pre tabindex=0><code>ã€ä¸šåŠ¡å±‚ã€‘æ­£åœ¨ä¿å­˜è®¢å•: Order(userId=1001, productId=2002, amount=99.9)
</code></pre><h5 id=ç¬¬å››æ­¥å›åˆ°-aroundè®°å½•è€—æ—¶å¹¶è¿”å›>ç¬¬å››æ­¥ï¼šå›åˆ° <code>@Around</code>ï¼Œè®°å½•è€—æ—¶å¹¶è¿”å›<a hidden class=anchor aria-hidden=true href=#ç¬¬å››æ­¥å›åˆ°-aroundè®°å½•è€—æ—¶å¹¶è¿”å›>#</a></h5><pre tabindex=0><code>&gt;&gt;&gt; [AOPç¯ç»•ç»“æŸ] æ–¹æ³• createOrder æ‰§è¡Œå®Œæ¯•ï¼Œè€—æ—¶: 15 ms
</code></pre><blockquote><p>ğŸ’¡ è€—æ—¶æ˜¯æ¨¡æ‹Ÿå€¼ï¼Œå®é™…å¯èƒ½æ˜¯å‡ æ¯«ç§’åˆ°å‡ åæ¯«ç§’ã€‚</p></blockquote><hr><h5 id=-æœ€ç»ˆå®Œæ•´æ§åˆ¶å°è¾“å‡ºæŒ‰é¡ºåº>ğŸ“‹ æœ€ç»ˆå®Œæ•´æ§åˆ¶å°è¾“å‡ºï¼ˆæŒ‰é¡ºåºï¼‰<a hidden class=anchor aria-hidden=true href=#-æœ€ç»ˆå®Œæ•´æ§åˆ¶å°è¾“å‡ºæŒ‰é¡ºåº>#</a></h5><pre tabindex=0><code>&gt;&gt;&gt; [AOPç¯ç»•å¼€å§‹] å‡†å¤‡æ‰§è¡Œæ–¹æ³•: createOrder
&gt;&gt;&gt; [AOPå‰ç½®] è°ƒç”¨æ–¹æ³•: createOrder, å‚æ•°: [Order(userId=1001, productId=2002, amount=99.9)]
ã€ä¸šåŠ¡å±‚ã€‘æ­£åœ¨ä¿å­˜è®¢å•: Order(userId=1001, productId=2002, amount=99.9)
&gt;&gt;&gt; [AOPç¯ç»•ç»“æŸ] æ–¹æ³• createOrder æ‰§è¡Œå®Œæ¯•ï¼Œè€—æ—¶: 15 ms
</code></pre><p>åŒæ—¶ï¼ŒHTTP æ¥å£ä¼šæ­£å¸¸è¿”å›ï¼š</p><pre tabindex=0><code>&#34;è®¢å•åˆ›å»ºæˆåŠŸï¼&#34;
</code></pre><hr><h5 id=-å…³é”®ç»“è®º>ğŸ¯ å…³é”®ç»“è®º<a hidden class=anchor aria-hidden=true href=#-å…³é”®ç»“è®º>#</a></h5><ol><li><strong>AOP çš„æ—¥å¿—å…ˆäºä¸šåŠ¡ä»£ç æ‰“å°</strong> â†’ è¯´æ˜å®ƒç¡®å®åœ¨â€œå‰é¢â€æ‹¦æˆªäº†ã€‚</li><li><strong>ä¸šåŠ¡é€»è¾‘å®Œå…¨ä¸å—å½±å“</strong> â†’ è¯¥ä¿å­˜è®¢å•è¿˜æ˜¯ä¿å­˜ï¼Œè¯¥è¿”å›ç»“æœè¿˜æ˜¯è¿”å›ã€‚</li><li><strong>ä½ ä¸ç”¨åœ¨æ¯ä¸ªæ–¹æ³•é‡Œå†™æ—¥å¿—</strong> â†’ åªè¦æ–¹æ³•åœ¨ <code>controller</code> åŒ…ä¸‹ï¼Œè‡ªåŠ¨ç”Ÿæ•ˆï¼</li><li><strong>æ€§èƒ½ç›‘æ§ä¹Ÿè‡ªåŠ¨å®Œæˆ</strong> â†’ è€—æ—¶ç›´æ¥ç®—å‡ºæ¥äº†ï¼Œå¯ç”¨äºæŠ¥è­¦æˆ–ä¼˜åŒ–ã€‚</li></ol><hr><h3 id=-å°è´´å£«é¿å…è¸©å‘>ğŸ’¡ å°è´´å£«ï¼ˆé¿å…è¸©å‘ï¼‰<a hidden class=anchor aria-hidden=true href=#-å°è´´å£«é¿å…è¸©å‘>#</a></h3><ul><li>å¦‚æœæ²¡çœ‹åˆ° AOP æ—¥å¿—ï¼Ÿæ£€æŸ¥ï¼š<ul><li>åˆ‡é¢ç±»æ˜¯å¦åŠ äº† <code>@Component</code></li><li>Spring Boot ä¸»å¯åŠ¨ç±»æ˜¯å¦æ‰«æåˆ°äº†åˆ‡é¢åŒ…ï¼ˆé€šå¸¸é»˜è®¤æ‰«æä¸»ç±»æ‰€åœ¨åŒ…åŠå­åŒ…ï¼‰</li><li>æ–¹æ³•æ˜¯ä¸æ˜¯ <code>public</code>ï¼ˆSpring AOP é»˜è®¤åªä»£ç† public æ–¹æ³•ï¼‰</li></ul></li><li>ä¸æƒ³ç”¨ <code>@Before</code> + <code>@Around</code> ä¸¤ä¸ªï¼Ÿå…¶å®åªç”¨ <code>@Around</code> å°±å¤Ÿäº†ï¼Œå®ƒèƒ½å¹²æ‰€æœ‰äº‹ï¼</li></ul><h3 id=æˆ‘çš„ç–‘é—®ä¸ºä»€ä¹ˆ-around-æ¯”-before-å…ˆæ‰§è¡Œ>æˆ‘çš„ç–‘é—®ï¼šä¸ºä»€ä¹ˆ <code>@Around</code> æ¯” <code>@Before</code> å…ˆæ‰§è¡Œï¼Ÿ<a hidden class=anchor aria-hidden=true href=#æˆ‘çš„ç–‘é—®ä¸ºä»€ä¹ˆ-around-æ¯”-before-å…ˆæ‰§è¡Œ>#</a></h3><h4 id=-ç®€çŸ­ç­”æ¡ˆ>âœ… ç®€çŸ­ç­”æ¡ˆï¼š<a hidden class=anchor aria-hidden=true href=#-ç®€çŸ­ç­”æ¡ˆ>#</a></h4><blockquote><p><strong>ä¸æ˜¯ <code>@Around</code> æ¯” <code>@Before</code> â€œå…ˆæ‰§è¡Œâ€ï¼Œè€Œæ˜¯ <code>@Around</code> åŒ…è£¹äº† <code>@Before</code> å’Œä¸šåŠ¡æ–¹æ³•ã€‚</strong>
æ§åˆ¶å°çœ‹èµ·æ¥ <code>@Around</code> çš„â€œå¼€å§‹æ—¥å¿—â€å…ˆæ‰“å°ï¼Œæ˜¯å› ä¸ºå®ƒåœ¨æœ€å¤–å±‚ã€‚</p></blockquote><hr><h4 id=-è¯¦ç»†è§£é‡Šå…³é”®>ğŸ§  è¯¦ç»†è§£é‡Šï¼ˆå…³é”®ï¼ï¼‰<a hidden class=anchor aria-hidden=true href=#-è¯¦ç»†è§£é‡Šå…³é”®>#</a></h4><p>Spring AOP çš„åº•å±‚æ˜¯é€šè¿‡ <strong>ä»£ç†æ¨¡å¼</strong> å®ç°çš„ã€‚å½“ä¸€ä¸ªæ–¹æ³•åŒæ—¶è¢« <code>@Before</code> å’Œ <code>@Around</code> åˆ‡å…¥æ—¶ï¼Œ<strong>Spring åªä¼šç”Ÿæˆä¸€ä¸ªä»£ç†å¯¹è±¡</strong>ï¼Œè€Œè¿™ä¸ªä»£ç†çš„é€»è¾‘ç»“æ„æ˜¯è¿™æ ·çš„ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// ä¼ªä»£ç ï¼šSpring ç”Ÿæˆçš„ä»£ç†é€»è¾‘</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>createOrderProxy</span>(Order order) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// â€”â€”â€”â€”â€”â€”â€”â€” @Around çš„å¼€å¤´ â€”â€”â€”â€”â€”â€”â€”â€”</span>
</span></span><span style=display:flex><span>    log(<span style=color:#e6db74>&#34;&gt;&gt;&gt; [AOPç¯ç»•å¼€å§‹] å‡†å¤‡æ‰§è¡Œæ–¹æ³•: createOrder&#34;</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// â€”â€”â€”â€”â€”â€”â€”â€” æ‰§è¡Œæ‰€æœ‰ @Before â€”â€”â€”â€”â€”â€”â€”â€”</span>
</span></span><span style=display:flex><span>        log(<span style=color:#e6db74>&#34;&gt;&gt;&gt; [AOPå‰ç½®] è°ƒç”¨æ–¹æ³•: createOrder, å‚æ•°: ...&#34;</span>);
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>// â€”â€”â€”â€”â€”â€”â€”â€” æ‰§è¡ŒçœŸæ­£çš„ä¸šåŠ¡æ–¹æ³• â€”â€”â€”â€”â€”â€”â€”â€”</span>
</span></span><span style=display:flex><span>        Object result <span style=color:#f92672>=</span> realTarget.<span style=color:#a6e22e>createOrder</span>(order);
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>// â€”â€”â€”â€”â€”â€”â€”â€” æ‰§è¡Œ @AfterReturningï¼ˆå¦‚æœæœ‰ï¼‰â€”â€”â€”â€”</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// â€”â€”â€”â€”â€”â€”â€”â€” @Around çš„ç»“å°¾ â€”â€”â€”â€”â€”â€”â€”â€”</span>
</span></span><span style=display:flex><span>        log(<span style=color:#e6db74>&#34;&gt;&gt;&gt; [AOPç¯ç»•ç»“æŸ] æ–¹æ³• createOrder è€—æ—¶: ... ms&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ‰€ä»¥å®é™…æ‰§è¡Œé¡ºåºæ˜¯ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Around</span> å¼€å§‹éƒ¨åˆ†
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>â†“</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Before</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>â†“</span>
</span></span><span style=display:flex><span>çœŸæ­£çš„ä¸šåŠ¡æ–¹æ³•<span style=color:#960050;background-color:#1e0010>ï¼ˆ</span>createOrder<span style=color:#960050;background-color:#1e0010>ï¼‰</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>â†“</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@After</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>@AfterReturning</span><span style=color:#960050;background-color:#1e0010>ï¼ˆ</span>å¦‚æœæœ‰<span style=color:#960050;background-color:#1e0010>ï¼‰</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>â†“</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Around</span> ç»“æŸéƒ¨åˆ†
</span></span></code></pre></div><p>âœ… å› æ­¤ï¼š</p><ul><li><code>@Around</code> çš„ <strong>ç¬¬ä¸€è¡Œä»£ç </strong>ï¼ˆè®°å½•å¼€å§‹æ—¶é—´ï¼‰æœ€å…ˆæ‰§è¡Œ â†’ æ‰€ä»¥ä½ çœ‹åˆ°å®ƒå…ˆæ‰“å°ã€‚</li><li>ä½† <code>@Before</code> æ˜¯åœ¨ <code>@Around</code> <strong>å†…éƒ¨</strong>ã€ä¸šåŠ¡æ–¹æ³•<strong>ä¹‹å‰</strong>æ‰§è¡Œçš„ã€‚</li></ul><blockquote><p>ğŸ”¸ ç±»æ¯”ï¼š
ä½ ç‚¹å¤–å–ï¼š</p><ul><li>éª‘æ‰‹ï¼ˆ<code>@Around</code>ï¼‰å…ˆè¯´ï¼šâ€œæˆ‘å‡ºå‘å»å–é¤äº†ï¼â€ï¼ˆæ‰“å°å¼€å§‹ï¼‰</li><li>åˆ°åº—åï¼Œåº—å‘˜ï¼ˆ<code>@Before</code>ï¼‰è¯´ï¼šâ€œå·²æ¥å•ï¼Œæ­£åœ¨æ‰“åŒ…ï¼â€</li><li>å¨å¸ˆï¼ˆä¸šåŠ¡æ–¹æ³•ï¼‰å¼€å§‹ç‚’èœ</li><li>éª‘æ‰‹æ‹¿åˆ°é¤åè¯´ï¼šâ€œé€é¤å®Œæˆï¼Œå…±ç”¨æ—¶25åˆ†é’Ÿï¼â€ï¼ˆæ‰“å°ç»“æŸï¼‰</li></ul></blockquote><p>æ‰€ä»¥<strong>ä¸æ˜¯è°â€œä¼˜å…ˆçº§é«˜â€</strong>ï¼Œè€Œæ˜¯ <code>@Around</code> æ˜¯ä¸€ä¸ªâ€œå¤§ç›’å­â€ï¼ŒæŠŠ <code>@Before</code> å’Œä¸šåŠ¡ä»£ç éƒ½è£…è¿›å»äº†ã€‚</p><h2 id=-é˜²æ­¢é‡å¤æäº¤å¹‚ç­‰æ€§æ§åˆ¶>âœ… é˜²æ­¢é‡å¤æäº¤ï¼ˆå¹‚ç­‰æ€§æ§åˆ¶ï¼‰<a hidden class=anchor aria-hidden=true href=#-é˜²æ­¢é‡å¤æäº¤å¹‚ç­‰æ€§æ§åˆ¶>#</a></h2><h4 id=åœºæ™¯-1>åœºæ™¯ï¼š<a hidden class=anchor aria-hidden=true href=#åœºæ™¯-1>#</a></h4><p>ç”¨æˆ·ç‹‚ç‚¹â€œæ”¯ä»˜â€æŒ‰é’®ï¼Œå¯èƒ½é€ æˆé‡å¤æ‰£æ¬¾ï¼ä½ éœ€è¦<strong>5ç§’å†…åŒä¸€ä¸ªç”¨æˆ·+åŒä¸€ä¸ªå•†å“åªèƒ½ä¸‹å•ä¸€æ¬¡</strong>ã€‚</p><p>ä½ éœ€è¦å€ŸåŠ© <strong>Spring çš„ SpELï¼ˆSpring Expression Languageï¼‰å¼•æ“</strong> æ¥è§£æè¡¨è¾¾å¼</p><h4 id=æ­¥éª¤-1åˆ›å»ºä¸€ä¸ªå·¥å…·ç±»æ¨è>æ­¥éª¤ 1ï¼šåˆ›å»ºä¸€ä¸ªå·¥å…·ç±»ï¼ˆæ¨èï¼‰<a hidden class=anchor aria-hidden=true href=#æ­¥éª¤-1åˆ›å»ºä¸€ä¸ªå·¥å…·ç±»æ¨è>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.core.LocalVariableTableParameterNameDiscoverer;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.expression.ExpressionParser;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.expression.spel.standard.SpelExpressionParser;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.expression.spel.support.StandardEvaluationContext;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SpelUtil</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> ExpressionParser PARSER <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SpelExpressionParser();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> LocalVariableTableParameterNameDiscoverer NAME_DISCOVERER 
</span></span><span style=display:flex><span>        <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LocalVariableTableParameterNameDiscoverer();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>parse</span>(String spel, Object<span style=color:#f92672>[]</span> args, Class<span style=color:#f92672>&lt;?&gt;</span> targetClass) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (spel <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> spel.<span style=color:#a6e22e>isEmpty</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è·å–æ–¹æ³•å‚æ•°åï¼ˆæ¯”å¦‚ order, userIdï¼‰</span>
</span></span><span style=display:flex><span>        String<span style=color:#f92672>[]</span> paramNames <span style=color:#f92672>=</span> NAME_DISCOVERER.<span style=color:#a6e22e>getParameterNames</span>(targetClass.<span style=color:#a6e22e>getDeclaredMethods</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>); <span style=color:#75715e>// ç®€åŒ–ç‰ˆï¼Œå®é™…éœ€åŒ¹é…æ–¹æ³•</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// åˆ›å»ºä¸Šä¸‹æ–‡</span>
</span></span><span style=display:flex><span>        StandardEvaluationContext context <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StandardEvaluationContext();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> args.<span style=color:#a6e22e>length</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            context.<span style=color:#a6e22e>setVariable</span>(paramNames<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span>, args<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è§£æè¡¨è¾¾å¼</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> PARSER.<span style=color:#a6e22e>parseExpression</span>(spel).<span style=color:#a6e22e>getValue</span>(context, String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>ğŸ’¡ ä½†ä¸Šé¢ä»£ç æœ‰ç¼ºé™·ï¼ˆæ–¹æ³•åŒ¹é…ä¸å‡†ç¡®ï¼‰ï¼Œæ›´ç¨³å¦¥çš„åšæ³•æ˜¯ç»“åˆ AOP çš„ <code>MethodSignature</code>ã€‚</p></blockquote><hr><h4 id=æ­¥éª¤-2åœ¨åˆ‡é¢ä¸­æ­£ç¡®ä½¿ç”¨å®Œæ•´å¯è¿è¡Œç‰ˆ>æ­¥éª¤ 2ï¼šåœ¨åˆ‡é¢ä¸­æ­£ç¡®ä½¿ç”¨ï¼ˆå®Œæ•´å¯è¿è¡Œç‰ˆï¼‰<a hidden class=anchor aria-hidden=true href=#æ­¥éª¤-2åœ¨åˆ‡é¢ä¸­æ­£ç¡®ä½¿ç”¨å®Œæ•´å¯è¿è¡Œç‰ˆ>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Aspect</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>IdempotentAspect</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> RedisTemplate<span style=color:#f92672>&lt;</span>String, String<span style=color:#f92672>&gt;</span> redisTemplate;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Around</span>(<span style=color:#e6db74>&#34;@annotation(idempotent)&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>checkIdempotent</span>(ProceedingJoinPoint joinPoint, Idempotent idempotent) <span style=color:#66d9ef>throws</span> Throwable {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 1. è·å–æ–¹æ³•ç­¾å</span>
</span></span><span style=display:flex><span>        MethodSignature signature <span style=color:#f92672>=</span> (MethodSignature) joinPoint.<span style=color:#a6e22e>getSignature</span>();
</span></span><span style=display:flex><span>        Method method <span style=color:#f92672>=</span> signature.<span style=color:#a6e22e>getMethod</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 2. è·å–å‚æ•°åï¼ˆéœ€è¦ç¼–è¯‘æ—¶ä¿ç•™å‚æ•°åï¼šJava 8+ é»˜è®¤å¼€å¯ï¼Œæˆ–åŠ  -parametersï¼‰</span>
</span></span><span style=display:flex><span>        String<span style=color:#f92672>[]</span> paramNames <span style=color:#f92672>=</span> signature.<span style=color:#a6e22e>getParameterNames</span>();
</span></span><span style=display:flex><span>        Object<span style=color:#f92672>[]</span> args <span style=color:#f92672>=</span> joinPoint.<span style=color:#a6e22e>getArgs</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 3. æ„å»º SpEL ä¸Šä¸‹æ–‡</span>
</span></span><span style=display:flex><span>        StandardEvaluationContext context <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StandardEvaluationContext();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> paramNames.<span style=color:#a6e22e>length</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            context.<span style=color:#a6e22e>setVariable</span>(paramNames<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span>, args<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 4. è§£æè¡¨è¾¾å¼ï¼Œå¾—åˆ°çœŸå® key</span>
</span></span><span style=display:flex><span>        String keyExpression <span style=color:#f92672>=</span> idempotent.<span style=color:#a6e22e>key</span>(); <span style=color:#75715e>// å¦‚ &#34;#order.userId + &#39;-&#39; + #order.productId&#34;</span>
</span></span><span style=display:flex><span>        String realKey <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SpelExpressionParser()
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>parseExpression</span>(keyExpression)
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>getValue</span>(context, String.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 5. æ„é€  Redis é” key</span>
</span></span><span style=display:flex><span>        String lockKey <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;idempotent:&#34;</span> <span style=color:#f92672>+</span> realKey;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 6. å°è¯•åŠ é”</span>
</span></span><span style=display:flex><span>        Boolean isSet <span style=color:#f92672>=</span> redisTemplate.<span style=color:#a6e22e>opsForValue</span>()
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>setIfAbsent</span>(lockKey, <span style=color:#e6db74>&#34;1&#34;</span>, idempotent.<span style=color:#a6e22e>expire</span>(), TimeUnit.<span style=color:#a6e22e>SECONDS</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (Boolean.<span style=color:#a6e22e>TRUE</span>.<span style=color:#a6e22e>equals</span>(isSet)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> joinPoint.<span style=color:#a6e22e>proceed</span>();
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(<span style=color:#e6db74>&#34;è¯·å‹¿é‡å¤æäº¤ï¼&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><h3 id=-ä¸¾ä¸ªå®é™…è¿è¡Œä¾‹å­>ğŸ§ª ä¸¾ä¸ªå®é™…è¿è¡Œä¾‹å­<a hidden class=anchor aria-hidden=true href=#-ä¸¾ä¸ªå®é™…è¿è¡Œä¾‹å­>#</a></h3><p><strong>ä½ çš„ Controllerï¼š</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;/comment&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Idempotent</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#userId + &#39;-&#39; + #productId&#34;</span>, expire <span style=color:#f92672>=</span> 10)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>addComment</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestParam</span> Long userId,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestParam</span> Long productId,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestBody</span> String content) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä¸šåŠ¡é€»è¾‘</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>ç”¨æˆ·è¯·æ±‚ï¼š</strong></p><pre tabindex=0><code>POST /comment?userId=1001&amp;productId=2002
Body: &#34;å¾ˆå¥½ï¼&#34;
</code></pre><p><strong>åˆ‡é¢æ‰§è¡Œæ—¶ï¼š</strong></p><ul><li><code>keyExpression = "#userId + '-' + #productId"</code></li><li><code>paramNames = ["userId", "productId", "content"]</code></li><li><code>args = [1001L, 2002L, "å¾ˆå¥½ï¼"]</code></li><li>SpEL è§£æåï¼š<code>realKey = "1001-2002"</code></li><li><code>lockKey = "idempotent:1001-2002"</code></li></ul><p>âœ… å®Œç¾å®ç°â€œåŒä¸€ç”¨æˆ·å¯¹åŒä¸€å•†å“10ç§’å†…åªèƒ½è¯„è®ºä¸€æ¬¡â€</p><h3 id=é€è¡Œè§£é‡Š>é€è¡Œè§£é‡Š<a hidden class=anchor aria-hidden=true href=#é€è¡Œè§£é‡Š>#</a></h3><h4 id=-æ•´ä½“ç›®æ ‡>ğŸ§© æ•´ä½“ç›®æ ‡<a hidden class=anchor aria-hidden=true href=#-æ•´ä½“ç›®æ ‡>#</a></h4><p>æˆ‘ä»¬è¦å®ç°ä¸€ä¸ªåŠŸèƒ½ï¼š</p><blockquote><p>å½“ç”¨æˆ·è°ƒç”¨ <code>/comment</code> æ¥å£æ—¶ï¼Œå¦‚æœçŸ­æ—¶é—´å†…é‡å¤æäº¤ï¼ˆæ¯”å¦‚è¿ç»­ç‚¹ä¸¤æ¬¡æŒ‰é’®ï¼‰ï¼Œç³»ç»Ÿåªå¤„ç†ä¸€æ¬¡ï¼Œç¬¬äºŒæ¬¡å°±æç¤ºâ€œè¯·å‹¿é‡å¤æäº¤â€ã€‚</p></blockquote><p>ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ï¼š</p><ul><li><strong>AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰</strong>ï¼šåœ¨æ–¹æ³•æ‰§è¡Œå‰åæ’å…¥é€»è¾‘ã€‚</li><li><strong>SpELï¼ˆSpring Expression Languageï¼‰</strong>ï¼šåŠ¨æ€ä»æ–¹æ³•å‚æ•°ä¸­æå–æ•°æ®æ‹¼æˆå”¯ä¸€ keyã€‚</li><li><strong>Redis</strong>ï¼šç”¨å®ƒåšåˆ†å¸ƒå¼é”ï¼Œç¡®ä¿åŒä¸€ä¸ªè¯·æ±‚ä¸ä¼šè¢«é‡å¤å¤„ç†ã€‚</li></ul><hr><h4 id=ç¬¬ä¸€éƒ¨åˆ†spelutiljavaå·¥å…·ç±»>ç¬¬ä¸€éƒ¨åˆ†ï¼š<code>SpelUtil.java</code>ï¼ˆå·¥å…·ç±»ï¼‰<a hidden class=anchor aria-hidden=true href=#ç¬¬ä¸€éƒ¨åˆ†spelutiljavaå·¥å…·ç±»>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.core.LocalVariableTableParameterNameDiscoverer;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.expression.ExpressionParser;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.expression.spel.standard.SpelExpressionParser;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.expression.spel.support.StandardEvaluationContext;
</span></span></code></pre></div><p>âœ… <strong>å¤§ç™½è¯ï¼š</strong></p><p>è¿™äº›æ˜¯ Spring æä¾›çš„â€œå·¥å…·åŒ…â€ï¼Œç”¨æ¥ï¼š</p><ul><li>è·å–æ–¹æ³•çš„å‚æ•°åå­—ï¼ˆæ¯”å¦‚ <code>userId</code>ã€<code>productId</code>ï¼‰</li><li>è§£æåƒ <code>"#userId + '-' + #productId"</code> è¿™æ ·çš„è¡¨è¾¾å¼</li><li>åˆ›å»ºä¸€ä¸ªâ€œå˜é‡å®¹å™¨â€ï¼ŒæŠŠå‚æ•°å€¼æ”¾è¿›å»ï¼Œè®©è¡¨è¾¾å¼èƒ½è¯»åˆ°</li></ul><p>âœ… <strong>è¯­æ³•åŸç†ï¼š</strong></p><ul><li><code>LocalVariableTableParameterNameDiscoverer</code>ï¼šé€šè¿‡ Java å­—èŠ‚ç è·å–æ–¹æ³•å‚æ•°åï¼ˆéœ€è¦ç¼–è¯‘æ—¶ä¿ç•™å‚æ•°åï¼ŒJava 8+ é»˜è®¤æ”¯æŒï¼‰ã€‚</li><li><code>SpelExpressionParser</code>ï¼šSpring çš„è¡¨è¾¾å¼è§£æå™¨ï¼Œèƒ½ç†è§£ <code>#xxx</code> è¿™ç§å†™æ³•ã€‚</li><li><code>StandardEvaluationContext</code>ï¼šè¡¨è¾¾å¼è¿è¡Œæ—¶çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œç›¸å½“äºä¸€ä¸ªâ€œå˜é‡è¡¨â€ã€‚</li></ul><h5 id=1public-class-spelutil>1ã€public class SpelUtil<a hidden class=anchor aria-hidden=true href=#1public-class-spelutil>#</a></h5><hr><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SpelUtil</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> ExpressionParser PARSER <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SpelExpressionParser();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> LocalVariableTableParameterNameDiscoverer NAME_DISCOVERER 
</span></span><span style=display:flex><span>        <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LocalVariableTableParameterNameDiscoverer();
</span></span></code></pre></div><p>âœ… <strong>å¤§ç™½è¯ï¼š</strong></p><p>åˆ›å»ºä¸¤ä¸ªâ€œä¸‡èƒ½å·¥å…·â€ï¼š</p><ul><li>ä¸€ä¸ªå« <code>PARSER</code>ï¼Œä¸“é—¨è´Ÿè´£â€œè¯»æ‡‚â€åƒ <code>#userId + '-' + #productId</code> è¿™æ ·çš„å­—ç¬¦ä¸²ã€‚</li><li>ä¸€ä¸ªå« <code>NAME_DISCOVERER</code>ï¼Œä¸“é—¨è´Ÿè´£â€œçŒœå‡ºâ€æ–¹æ³•çš„å‚æ•°å«ä»€ä¹ˆåå­—ï¼ˆæ¯”å¦‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸æ˜¯å« <code>userId</code>ï¼‰ã€‚</li></ul><p>å®ƒä»¬éƒ½æ˜¯ <code>static final</code>ï¼Œæ„æ€æ˜¯æ•´ä¸ªç¨‹åºåªç”¨ä¸€ä»½ï¼Œçœèµ„æºã€‚</p><p><strong>ğŸ§© ç¬¬ä¸€è¡Œï¼š<code>public class SpelUtil</code></strong></p><p><strong>ğŸ’¬ å¤§ç™½è¯ï¼š</strong></p><p>è¿™æ˜¯ä¸€ä¸ªå« <code>SpelUtil</code> çš„â€œå·¥å…·ç®±â€ï¼Œä¸“é—¨ç”¨æ¥å¤„ç† Spring è¡¨è¾¾å¼ï¼ˆSpELï¼‰ç›¸å…³çš„äº‹æƒ…ã€‚
æ¯”å¦‚ï¼šæŠŠ <code>"#userId + '-' + #productId"</code> è¿™ç§å­—ç¬¦ä¸²å˜æˆçœŸæ­£çš„å€¼ã€‚</p><blockquote><p>å°±åƒä½ æœ‰ä¸€ä¸ªâ€œè®¡ç®—å™¨å·¥å…·ç±»â€ï¼Œåˆ«äººå¯ä»¥ç›´æ¥æ‹¿æ¥ç®—è¡¨è¾¾å¼ï¼Œä¸ç”¨è‡ªå·±ä»å¤´å†™ã€‚</p></blockquote><p><strong>ğŸ”¬ è¯­æ³•åŸç†ï¼š</strong></p><ul><li><code>public</code>ï¼šå…¬å¼€ç±»ï¼Œå…¶ä»–åŒ…ä¹Ÿèƒ½ç”¨ã€‚</li><li><code>class SpelUtil</code>ï¼šå®šä¹‰ä¸€ä¸ªæ™®é€š Java ç±»ã€‚</li><li>å‘½åä¹ æƒ¯ï¼šä»¥ <code>Util</code> ç»“å°¾ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸ª<strong>å·¥å…·ç±»</strong>ï¼ˆé€šå¸¸åªåŒ…å«é™æ€æ–¹æ³•ï¼Œä¸å®ä¾‹åŒ–ï¼‰ã€‚</li></ul><hr><p><strong>ğŸ§© ç¬¬äºŒè¡Œï¼š<code>private static final ExpressionParser PARSER = new SpelExpressionParser();</code></strong></p><p>æˆ‘ä»¬æ‹†æˆå‡ ä¸ªå…³é”®è¯æ¥çœ‹ï¼š</p><p>âœ… <code>private</code></p><ul><li>åªæœ‰è¿™ä¸ªç±»å†…éƒ¨èƒ½è®¿é—®ï¼Œå¤–é¢ä¸èƒ½ç›´æ¥è°ƒç”¨ <code>PARSER</code>ã€‚</li><li>ç¬¦åˆå°è£…åŸåˆ™ï¼šå·¥å…·çš„â€œé›¶ä»¶â€ä¸æš´éœ²ç»™ç”¨æˆ·ã€‚</li></ul><p>âœ… <code>static</code></p><ul><li><strong>å±äºç±»æœ¬èº«ï¼Œä¸å±äºæŸä¸ªå¯¹è±¡</strong>ã€‚</li><li>æ•´ä¸ªç¨‹åºè¿è¡ŒæœŸé—´ï¼Œåªåˆ›å»º<strong>ä¸€ä»½</strong> <code>PARSER</code>ã€‚</li><li>è°ƒç”¨æ—¶ä¸ç”¨ <code>new SpelUtil()</code>ï¼Œç›´æ¥é€šè¿‡ç±»åéšå¼ä½¿ç”¨ï¼ˆå› ä¸ºæ˜¯ç§æœ‰çš„ï¼Œå…¶å®å¤–éƒ¨ä¹Ÿçœ‹ä¸åˆ°ï¼‰ã€‚</li></ul><blockquote><p>ğŸŒ° æ¯”å¦‚ï¼šå…¨å…¬å¸å…±ç”¨ä¸€å°æ‰“å°æœºï¼Œä¸æ˜¯æ¯äººä¹°ä¸€å°ã€‚</p></blockquote><p>âœ… <code>final</code></p><ul><li>è¿™ä¸ªå˜é‡ä¸€æ—¦èµ‹å€¼ï¼Œå°±ä¸èƒ½å†æ”¹äº†ã€‚</li><li>é˜²æ­¢ä¸å°å¿ƒè¢«è¦†ç›–ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨ï¼ˆå› ä¸ºå®ƒæ˜¯æ— çŠ¶æ€çš„ï¼Œå¯ä»¥å®‰å…¨å…±äº«ï¼‰ã€‚</li></ul><p>âœ… <code>ExpressionParser PARSER</code></p><ul><li><code>ExpressionParser</code> æ˜¯ Spring æä¾›çš„æ¥å£ï¼Œä»£è¡¨â€œè¡¨è¾¾å¼è§£æå™¨â€ã€‚</li><li><code>PARSER</code> æ˜¯å˜é‡åï¼Œå…¨å¤§å†™æ˜¯å¸¸é‡å‘½åä¹ æƒ¯ï¼ˆè™½ç„¶ Java æ²¡å¼ºåˆ¶ï¼Œä½†å¤§å®¶éƒ½è¿™ä¹ˆå†™ï¼‰ã€‚</li></ul><p>âœ… <code>new SpelExpressionParser()</code></p><ul><li>åˆ›å»ºä¸€ä¸ªå…·ä½“çš„è§£æå™¨å®ä¾‹ã€‚</li><li><code>SpelExpressionParser</code> æ˜¯ Spring å®ç° <code>ExpressionParser</code> æ¥å£çš„ç±»ï¼Œä¸“é—¨è§£æ <strong>SpELï¼ˆSpring Expression Languageï¼‰</strong> è¡¨è¾¾å¼ã€‚</li></ul><p>ğŸ¯ å®ƒèƒ½ç†è§£ï¼š</p><ul><li><p><code>#name</code></p></li><li><p><code>#order.price > 100</code></p></li><li><p><code>'Hello ' + #user.name</code></p></li><li><p><code>T(java.lang.Math).random()</code>ï¼ˆè°ƒç”¨é™æ€æ–¹æ³•ï¼‰</p></li><li><p>ï¼‰</p></li></ul><hr><p>ğŸ’¬ <strong>æ•´ä½“å¤§ç™½è¯æ€»ç»“è¿™è¡Œï¼š</strong></p><blockquote><p>â€œæˆ‘å‡†å¤‡äº†ä¸€ä¸ªä¸‡èƒ½çš„â€˜è¡¨è¾¾å¼ç¿»è¯‘å®˜â€™ï¼Œå« <code>PARSER</code>ï¼Œå®ƒä¸€è¾ˆå­å°±å¹²ä¸€ä»¶äº‹ï¼šæŠŠåƒ <code>#userId + '-' + #productId</code> è¿™æ ·çš„å­—ç¬¦ä¸²ï¼Œç¿»è¯‘æˆçœŸæ­£çš„å€¼ã€‚â€</p></blockquote><p>è€Œä¸”è¿™ä¸ªç¿»è¯‘å®˜æ˜¯ï¼š</p><ul><li>å…¨å±€å”¯ä¸€çš„ï¼ˆ<code>static</code>ï¼‰</li><li>ä¸ä¼šè¢«æ¢æ‰ï¼ˆ<code>final</code>ï¼‰</li><li>åˆ«äººçœ‹ä¸è§ï¼ˆ<code>private</code>ï¼‰ï¼Œåªèƒ½é€šè¿‡æˆ‘æä¾›çš„æ–¹æ³•é—´æ¥ä½¿ç”¨</li></ul><p><strong>ğŸ§© ç¬¬ä¸‰è¡Œï¼š<code>private static final LocalVariableTableParameterNameDiscoverer NAME_DISCOVERER = ...</code></strong></p><p>åŒæ ·æ‹†è§£ï¼š</p><p><strong>âœ… <code>LocalVariableTableParameterNameDiscoverer</code></strong></p><p>è¿™æ˜¯ Spring æä¾›çš„ä¸€ä¸ª<strong>å‚æ•°åå‘ç°å™¨</strong>ã€‚</p><p>ğŸ’¬ <strong>å¤§ç™½è¯ï¼š</strong></p><blockquote><p>â€œæˆ‘æƒ³çŸ¥é“æŸä¸ªæ–¹æ³•çš„å‚æ•°åˆ°åº•å«ä»€ä¹ˆåå­—ï¼Œæ¯”å¦‚æ˜¯å« <code>userId</code> è¿˜æ˜¯ <code>uid</code>ï¼Ÿ
ä½† Java ç¼–è¯‘åï¼Œé»˜è®¤ä¼šæŠŠå‚æ•°åå˜æˆ <code>arg0</code>, <code>arg1</code>â€¦â€¦
è¿™ä¸ªå·¥å…·èƒ½ä»å­—èŠ‚ç é‡Œâ€˜æŒ–å‡ºâ€™åŸå§‹çš„å‚æ•°åï¼â€</p></blockquote><p>ğŸ”¬ <strong>æŠ€æœ¯ç»†èŠ‚ï¼š</strong></p><ul><li>å®ƒé€šè¿‡è¯»å– <code>.class</code> æ–‡ä»¶ä¸­çš„ <strong>LocalVariableTable</strong>ï¼ˆæœ¬åœ°å˜é‡è¡¨ï¼‰æ¥è·å–çœŸå®å‚æ•°åã€‚</li><li><strong>å‰æ</strong>ï¼šç¼–è¯‘æ—¶å¿…é¡»ä¿ç•™è°ƒè¯•ä¿¡æ¯ï¼ˆJava 8+ é»˜è®¤å¼€å¯ï¼Œæˆ–æ˜¾å¼åŠ  <code>-g</code> æˆ– <code>-parameters</code>ï¼‰ã€‚</li><li>å¦‚æœæ²¡ä¿ç•™ï¼Œå®ƒä¼šè¿”å› <code>null</code>ï¼</li></ul><blockquote><p>âš ï¸ æ‰€ä»¥è¿™ä¸ªå·¥å…·<strong>ä¸å¯é </strong>â€”â€”è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä½ åœ¨ AOP ä¸­åº”è¯¥ç”¨ <code>MethodSignature.getParameterNames()</code>ï¼Œè€Œä¸æ˜¯å®ƒï¼</p></blockquote><hr><p><strong>âœ… <code>NAME_DISCOVERER</code></strong></p><ul><li>å˜é‡åï¼Œæ„æ€æ˜¯â€œå‚æ•°åå‘ç°è€…â€ã€‚</li><li>åŒæ ·æ˜¯ <code>private static final</code>ï¼šå…¨å±€å”¯ä¸€ã€ä¸å¯å˜ã€å†…éƒ¨ä½¿ç”¨ã€‚</li></ul><hr><p>ğŸ’¬ æ•´ä½“å¤§ç™½è¯æ€»ç»“è¿™è¡Œï¼š</p><blockquote><p>â€œæˆ‘è¿˜å‡†å¤‡äº†ä¸€ä¸ªâ€˜è€ƒå¤å­¦å®¶â€™ï¼Œå« <code>NAME_DISCOVERER</code>ï¼Œå®ƒçš„ä»»åŠ¡æ˜¯ä»ç¼–è¯‘åçš„ä»£ç é‡Œï¼ŒæŠŠæ–¹æ³•å‚æ•°çš„åŸå§‹åå­—â€˜æŒ–â€™å‡ºæ¥ï¼Œæ¯”å¦‚ <code>userId</code>ã€<code>productId</code>ã€‚â€</p></blockquote><p>ä½†è¦æ³¨æ„ï¼š</p><blockquote><p>è¿™ä¸ªâ€œè€ƒå¤å­¦å®¶â€æœ‰æ—¶å€™ä¼šç©ºæ‰‹è€Œå½’ï¼ˆå¦‚æœç¼–è¯‘æ—¶æ²¡ç•™çº¿ç´¢ï¼‰ï¼</p></blockquote><hr><h5 id=2public-static-string-parse>2ã€public static String parse()<a hidden class=anchor aria-hidden=true href=#2public-static-string-parse>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>parse</span>(String spel, Object<span style=color:#f92672>[]</span> args, Class<span style=color:#f92672>&lt;?&gt;</span> targetClass) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (spel <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> spel.<span style=color:#a6e22e>isEmpty</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p><strong>âœ… å¤§ç™½è¯ï¼š</strong></p><p>è¿™æ˜¯ä¸€ä¸ªå·¥å…·æ–¹æ³•ï¼Œè¾“å…¥ï¼š</p><ul><li>ä¸€æ®µè¡¨è¾¾å¼ï¼ˆæ¯”å¦‚ <code>"#userId + '-' + #productId"</code>ï¼‰</li><li>æ–¹æ³•çš„å®é™…å‚æ•°å€¼ï¼ˆæ¯”å¦‚ <code>[1001, 2002]</code>ï¼‰</li><li>æ–¹æ³•æ‰€åœ¨çš„ç±»ï¼ˆæ¯”å¦‚ <code>CommentController.class</code>ï¼‰</li></ul><p>å¦‚æœè¡¨è¾¾å¼æ˜¯ç©ºçš„ï¼Œå°±ç›´æ¥è¿”å›ç©ºå­—ç¬¦ä¸²ã€‚</p><hr><h5 id=3name_discoverergetparameternames>3ã€NAME_DISCOVERER.getParameterNames<a hidden class=anchor aria-hidden=true href=#3name_discoverergetparameternames>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>        <span style=color:#75715e>// è·å–æ–¹æ³•å‚æ•°åï¼ˆæ¯”å¦‚ order, userIdï¼‰</span>
</span></span><span style=display:flex><span>        String<span style=color:#f92672>[]</span> paramNames <span style=color:#f92672>=</span> NAME_DISCOVERER.<span style=color:#a6e22e>getParameterNames</span>(targetClass.<span style=color:#a6e22e>getDeclaredMethods</span>()<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>); <span style=color:#75715e>// ç®€åŒ–ç‰ˆï¼Œå®é™…éœ€åŒ¹é…æ–¹æ³•</span>
</span></span></code></pre></div><p><strong>âœ… å¤§ç™½è¯ï¼ˆâš ï¸æ³¨æ„è¿™é‡Œæœ‰é—®é¢˜ï¼‰ï¼š</strong></p><p>è¿™è¡Œä»£ç æƒ³æ‹¿åˆ°æ–¹æ³•çš„å‚æ•°åå­—ï¼Œæ¯”å¦‚ <code>userId</code>, <code>productId</code>ã€‚</p><p>ä½†å®ƒæœ‰ä¸ª <strong>ä¸¥é‡é—®é¢˜</strong>ï¼š<code>targetClass.getDeclaredMethods()[0]</code> æ˜¯éšä¾¿æ‹¿ç±»é‡Œçš„ç¬¬ä¸€ä¸ªæ–¹æ³•ï¼
å¦‚æœè¿™ä¸ªç±»æœ‰å¤šä¸ªæ–¹æ³•ï¼Œå¾ˆå¯èƒ½æ‹¿é”™ï¼</p><blockquote><p>ğŸš¨ æ‰€ä»¥è¿™ä¸ª <code>SpelUtil</code> å…¶å®æ˜¯ä¸ªâ€œç®€åŒ–ç‰ˆç¤ºä¾‹â€ï¼Œ<strong>ä¸èƒ½ç›´æ¥ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒ</strong>ã€‚åé¢æˆ‘ä»¬ä¼šçœ‹åˆ°æ­£ç¡®çš„åšæ³•åœ¨ <code>IdempotentAspect</code> é‡Œã€‚</p></blockquote><p><strong>âœ… è¯­æ³•åŸç†ï¼š</strong></p><ul><li><code>getDeclaredMethods()</code> è¿”å›ç±»ä¸­æ‰€æœ‰æ–¹æ³•ï¼ˆåŒ…æ‹¬ privateï¼‰ã€‚</li><li><code>[0]</code> è¡¨ç¤ºå–ç¬¬ä¸€ä¸ªï¼Œä½†ä¸ä¸€å®šæ˜¯ä½ è¦çš„é‚£ä¸ªæ–¹æ³•ã€‚</li></ul><hr><h5 id=4standardevaluationcontext-context>4ã€StandardEvaluationContext context<a hidden class=anchor aria-hidden=true href=#4standardevaluationcontext-context>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// åˆ›å»ºä¸Šä¸‹æ–‡</span>
</span></span><span style=display:flex><span>StandardEvaluationContext context <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StandardEvaluationContext();
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> args.<span style=color:#a6e22e>length</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    context.<span style=color:#a6e22e>setVariable</span>(paramNames<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span>, args<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ğŸ§© ç¬¬ä¸€è¡Œï¼š<code>StandardEvaluationContext context = new StandardEvaluationContext();</code></p><p><strong>ğŸ’¬ å¤§ç™½è¯</strong>ï¼š</p><blockquote><p>â€œæˆ‘è¦å¼€å§‹ç®—ä¸€ä¸ªè¡¨è¾¾å¼äº†ï¼Œå…ˆå‡†å¤‡ä¸€ä¸ªâ€˜å°æœ¬å­â€™ï¼Œç”¨æ¥è®°å˜é‡ã€‚â€</p></blockquote><p>å°±åƒä½ åšæ•°å­¦é¢˜å‰ï¼Œè€å¸ˆè¯´ï¼šâ€œå·²çŸ¥ï¼šx = 5ï¼Œy = 3â€ï¼Œè¿™ä¸ªâ€œå·²çŸ¥æ¡ä»¶â€çš„åœ°æ–¹ï¼Œå°±æ˜¯ <strong>ä¸Šä¸‹æ–‡ï¼ˆcontextï¼‰</strong>ã€‚</p><p>åœ¨è¿™é‡Œï¼Œè¿™ä¸ªâ€œå°æœ¬å­â€å« <code>context</code>ï¼Œå®ƒæ˜¯ Spring ä¸“é—¨ç”¨æ¥è®© <strong>SpEL è¡¨è¾¾å¼</strong> èƒ½è¯»åˆ°å˜é‡çš„åœ°æ–¹ã€‚</p><p>ğŸ¯ ä¸¾ä¸ªç”Ÿæ´»ä¾‹å­ï¼š</p><p>ä½ æƒ³ç®—ï¼š<code>#userId + '-' + #productId</code>
ä½† Spring ä¸çŸ¥é“ <code>#userId</code> æ˜¯å¤šå°‘å•Šï¼
æ‰€ä»¥ä½ è¦å…ˆå‘Šè¯‰å®ƒï¼šâ€œå¬ç€ï¼Œæˆ‘ç°åœ¨å‘Šè¯‰ä½ ï¼š<code>userId=1001</code>ï¼Œ<code>productId=2002</code>â€
è¿™ä¸ªâ€œå‘Šè¯‰â€çš„è¿‡ç¨‹ï¼Œå°±éœ€è¦ä¸€ä¸ªâ€œè®°äº‹æœ¬â€â€”â€”å°±æ˜¯è¿™ä¸ª <code>context</code>ã€‚</p><hr><p><strong>ğŸ”¬ è¯­æ³•åŸç†ï¼š</strong></p><ul><li><code>StandardEvaluationContext</code> æ˜¯ Spring æä¾›çš„ä¸€ä¸ªç±»ï¼Œè¡¨ç¤º <strong>SpEL è¡¨è¾¾å¼çš„è¿è¡Œç¯å¢ƒ</strong>ã€‚</li><li>å®ƒå¯ä»¥å­˜å‚¨ï¼š<ul><li>å˜é‡ï¼ˆvariablesï¼‰</li><li>å‡½æ•°ï¼ˆfunctionsï¼‰</li><li>ç±»å‹æŸ¥æ‰¾å™¨ï¼ˆtype locatorsï¼‰ç­‰</li></ul></li><li>åœ¨æ±‚å€¼æ—¶ï¼Œè¡¨è¾¾å¼ä¼šä»è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­æŸ¥æ‰¾ <code>#xxx</code> è¿™æ ·çš„å˜é‡ã€‚</li></ul><p>âœ… ç®€å•è¯´ï¼šæ²¡æœ‰å®ƒï¼Œ<code>#userId</code> å°±æ˜¯â€œæ— åä¹‹è¾ˆâ€ï¼Œæœ‰äº†å®ƒï¼Œ<code>#userId</code> æ‰æœ‰å€¼ã€‚</p><hr><p><strong>ğŸ§© ç¬¬äºŒéƒ¨åˆ†ï¼š<code>for</code> å¾ªç¯</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> args.<span style=color:#a6e22e>length</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    context.<span style=color:#a6e22e>setVariable</span>(paramNames<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span>, args<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬æ‹†å¼€æ¥çœ‹ã€‚</p><hr><p><strong>ğŸ’¬ å¤§ç™½è¯ï¼š</strong></p><blockquote><p>â€œæˆ‘ç°åœ¨æœ‰ä¸€å †å‚æ•°ï¼š</p><ul><li>å‚æ•°åå­—æ˜¯ï¼š<code>["userId", "productId", "content"]</code></li><li>å®é™…å€¼æ˜¯ï¼š<code>[1001, 2002, "å¥½è¯„ï¼"]</code></li></ul><p>æˆ‘è¦æŠŠå®ƒä»¬ä¸€ä¸ªä¸ªæ”¾è¿›â€˜å°æœ¬å­â€™é‡Œï¼Œå˜æˆï¼š</p><ul><li><code>userId = 1001</code></li><li><code>productId = 2002</code></li><li><code>content = "å¥½è¯„ï¼"</code></li></ul><p>è¿™æ ·åé¢ç®—è¡¨è¾¾å¼çš„æ—¶å€™ï¼Œå°±èƒ½ç”¨ <code>#userId</code> æ‹¿åˆ° 1001 äº†ã€‚â€</p></blockquote><hr><p><strong>ğŸ”¬ è¯­æ³•åŸç†ï¼š</strong></p><p><strong><code>paramNames[i]</code>ï¼šå‚æ•°å</strong></p><ul><li><p>æ¥è‡ª <code>signature.getParameterNames()</code></p></li><li><p>æ¯”å¦‚æ–¹æ³•æ˜¯ï¼š</p><pre tabindex=0><code>public String addComment(Long userId, Long productId, String content)
</code></pre></li><li><p>é‚£ä¹ˆ <code>paramNames = ["userId", "productId", "content"]</code></p></li></ul><blockquote><p>âš ï¸ æ³¨æ„ï¼šå¿…é¡»ç¼–è¯‘æ—¶åŠ  <code>-parameters</code> å‚æ•°ï¼Œå¦åˆ™å¯èƒ½å¾—åˆ° <code>arg0, arg1, arg2</code></p></blockquote><p><strong><code>args[i]</code>ï¼šå‚æ•°å€¼</strong></p><ul><li><p>æ¥è‡ª <code>joinPoint.getArgs()</code></p></li><li><p>æ˜¯å®é™…ä¼ è¿›æ¥çš„æ•°æ®ï¼Œæ¯”å¦‚ï¼š</p><pre tabindex=0><code>[1001L, 2002L, &#34;æœåŠ¡å¾ˆå¥½ï¼&#34;]
</code></pre></li></ul><p><strong><code>context.setVariable(name, value)</code></strong></p><ul><li>æŠŠä¸€ä¸ªå˜é‡æ³¨å†Œåˆ° SpEL ä¸Šä¸‹æ–‡ä¸­</li><li>ä¹‹ååœ¨è¡¨è¾¾å¼ä¸­å°±å¯ä»¥ç”¨ <code>#name</code> æ¥å¼•ç”¨å®ƒ</li></ul><p>âœ… ä¸¾ä¾‹ï¼š</p><table><thead><tr><th>ä»£ç </th><th>æ•ˆæœ</th></tr></thead><tbody><tr><td><code>context.setVariable("userId", 1001)</code></td><td>ä¹‹å <code>#userId</code> å°±ç­‰äº <code>1001</code></td></tr><tr><td><code>context.setVariable("content", "å¥½è¯„")</code></td><td>ä¹‹å <code>#content</code> å°±ç­‰äº <code>"å¥½è¯„"</code></td></tr></tbody></table><hr><p><strong>ğŸ¯ ä¸¾ä¸ªå®Œæ•´ä¾‹å­</strong></p><p>å‡è®¾ä½ è°ƒç”¨äº†è¿™ä¸ªæ¥å£ï¼š</p><h5 id=5return-parserparseexpressionspel>5ã€return PARSER.parseExpression(spel)<a hidden class=anchor aria-hidden=true href=#5return-parserparseexpressionspel>#</a></h5><p>âœ… ä»£ç è¡Œï¼š</p><pre tabindex=0><code>return PARSER.parseExpression(spel).getValue(context, String.class);
</code></pre><p>è¿™è¡Œä»£ç æ˜¯æ•´ä¸ª <code>SpelUtil.parse()</code> æ–¹æ³•çš„â€œæœ€åä¸€å‡»â€â€”â€”çœŸæ­£å»æ‰§è¡Œ SpEL è¡¨è¾¾å¼ï¼Œå¾—åˆ°ç»“æœã€‚</p><hr><p><strong>ğŸ§  å¤§ç™½è¯è§£é‡Šï¼ˆåƒèŠå¤©ä¸€æ ·ï¼‰</strong></p><p>æƒ³è±¡ä½ å†™äº†ä¸€ä¸ªâ€œæ•°å­¦é¢˜â€ä¸€æ ·çš„å­—ç¬¦ä¸²ï¼š</p><blockquote><pre tabindex=0><code>&#34;#userId + &#39;-&#39; + #productId&#34;
</code></pre></blockquote><p>è¿™å…¶å®ä¸æ˜¯ä¸€ä¸ªæ™®é€šå­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä¸€ä¸ªâ€œå¾…è®¡ç®—çš„å…¬å¼â€ã€‚
ç°åœ¨ä½ è¦è®© Spring å¸®ä½ â€œç®—å‡ºç­”æ¡ˆâ€ã€‚</p><p>è¿™ä¸ªè¿‡ç¨‹åˆ†ä¸‰æ­¥ï¼š</p><ol><li><strong>æŠŠå…¬å¼è¯»ä¸€é</strong> â†’ <code>parseExpression(spel)</code></li></ol><p>Spring è¯´ï¼šâ€œå“¦ï¼Œè¿™æ˜¯ä¸ªæ‹¼æ¥å­—ç¬¦ä¸²çš„è¡¨è¾¾å¼ï¼Œè¦ç”¨åˆ° <code>#userId</code> å’Œ <code>#productId</code>ã€‚â€</p><p><strong>çœ‹çœ‹å˜é‡æœ‰æ²¡æœ‰</strong> â†’ éœ€è¦ä¸€ä¸ªâ€œä¸Šä¸‹æ–‡â€ï¼ˆcontextï¼‰â€</p><ol><li><strong>çœ‹çœ‹å˜é‡æœ‰æ²¡æœ‰</strong> â†’ éœ€è¦ä¸€ä¸ªâ€œä¸Šä¸‹æ–‡â€ï¼ˆcontextï¼‰
å°±åƒä½ åšæ•°å­¦é¢˜æ—¶ï¼Œè€å¸ˆè¯´ï¼šâ€œå·²çŸ¥ x=1001, y=2002â€ï¼Œè¿™é‡Œçš„ context å°±æ˜¯â€œå·²çŸ¥æ¡ä»¶â€ã€‚</li><li><strong>å¼€å§‹è®¡ç®—ç»“æœ</strong> â†’ <code>.getValue(context, String.class)</code>
Spring æ‹¿ç€ä¸Šä¸‹æ–‡é‡Œçš„å€¼ï¼Œä»£å…¥å…¬å¼ï¼š<ul><li><code>#userId</code> â†’ 1001</li><li><code>#productId</code> â†’ 2002</li><li>æ‹¼èµ·æ¥å°±æ˜¯ <code>"1001-2002"</code></li></ul></li></ol><p>æœ€åæŠŠè¿™ä¸ªç»“æœè¿”å›å‡ºå»ã€‚</p><p>ğŸ”š æ‰€ä»¥è¿™è¡Œä»£ç çš„æ„æ€å°±æ˜¯ï¼š</p><blockquote><p>â€œè¯·æŠŠ <code>spel</code> è¿™ä¸ªè¡¨è¾¾å¼ï¼Œç»“åˆæˆ‘ç»™çš„å‚æ•°å€¼ï¼ˆcontextï¼‰ï¼Œç®—å‡ºä¸€ä¸ªå­—ç¬¦ä¸²ç»“æœã€‚â€</p></blockquote><hr><p><strong>ğŸ”¬ è¯­æ³•åŸç†æ‹†è§£</strong></p><p>æˆ‘ä»¬æŠŠå®ƒæ‹†æˆä¸‰éƒ¨åˆ†æ¥çœ‹ï¼š</p><p>1ï¸âƒ£ <code>PARSER</code></p><pre tabindex=0><code>private static final ExpressionParser PARSER = new SpelExpressionParser();
</code></pre><ul><li><code>ExpressionParser</code> æ˜¯ Spring æä¾›çš„æ¥å£ï¼Œä¸“é—¨ç”¨æ¥è§£æè¡¨è¾¾å¼ã€‚</li><li><code>SpelExpressionParser</code> æ˜¯å®ƒçš„å®ç°ç±»ã€‚</li><li><code>PARSER</code> æ˜¯ä¸€ä¸ªé™æ€å¯¹è±¡ï¼Œæ•´ä¸ªç¨‹åºåªåˆ›å»ºä¸€æ¬¡ï¼Œæ•ˆç‡é«˜ã€‚</li></ul><p>ğŸ‘‰ å®ƒçš„ä½œç”¨ï¼šæŠŠå­—ç¬¦ä¸²å˜æˆå¯æ‰§è¡Œçš„â€œè¡¨è¾¾å¼å¯¹è±¡â€ã€‚</p><hr><p>2ï¸âƒ£ <code>.parseExpression(spel)</code></p><pre tabindex=0><code>PARSER.parseExpression(spel)
</code></pre><ul><li>æŠŠä¼ è¿›æ¥çš„å­—ç¬¦ä¸²ï¼ˆæ¯”å¦‚ <code>"#userId + '-' + #productId"</code>ï¼‰è§£ææˆä¸€ä¸ªå†…éƒ¨ç»“æ„ï¼ˆASTï¼ŒæŠ½è±¡è¯­æ³•æ ‘ï¼‰ã€‚</li><li>è¿™ä¸€æ­¥åªæ˜¯â€œç¼–è¯‘â€ï¼Œè¿˜æ²¡æ‰§è¡Œã€‚</li><li>å¦‚æœè¡¨è¾¾å¼å†™é”™äº†ï¼Œæ¯”å¦‚ <code>#user.idd</code>ï¼ˆæ‹¼é”™å­—æ®µï¼‰ï¼Œè¿™é‡Œä¼šæŠ›å¼‚å¸¸ã€‚</li></ul><p>âœ… ä¸¾ä¸ªä¾‹å­ï¼š</p><table><thead><tr><th>è¾“å…¥</th><th>ç»“æœ</th></tr></thead><tbody><tr><td><code>"#name"</code></td><td>å–å˜é‡ name çš„å€¼</td></tr><tr><td><code>"#order.price * 0.9"</code></td><td>å– price çš„ 90%</td></tr><tr><td><code>"T(java.lang.Math).random()"</code></td><td>è°ƒç”¨ Java é™æ€æ–¹æ³•</td></tr></tbody></table><p>SpEL åŠŸèƒ½å¾ˆå¼ºï¼Œç”šè‡³èƒ½è°ƒæ–¹æ³•ã€è®¿é—®å±æ€§ã€åšåˆ¤æ–­ï¼</p><p>3ï¸âƒ£ <code>.getValue(context, String.class)</code></p><pre tabindex=0><code>.getValue(context, String.class)
</code></pre><p>è¿™æ‰æ˜¯çœŸæ­£çš„â€œè¿è¡Œâ€ï¼</p><ul><li><code>context</code>ï¼šå°±æ˜¯ä¹‹å‰è®¾ç½®å¥½çš„â€œå˜é‡ç¯å¢ƒâ€ï¼Œé‡Œé¢æœ‰ <code>userId=1001</code>, <code>productId=2002</code></li><li><code>String.class</code>ï¼šè¡¨ç¤ºä½ å¸Œæœ›è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„ç»“æœ</li></ul><p>Spring ä¼šï¼š</p><ol><li>æ‰¾åˆ° <code>#userId</code> â†’ ä» context ä¸­å–å‡º <code>1001</code></li><li>æ‰¾åˆ° <code>#productId</code> â†’ å–å‡º <code>2002</code></li><li>ä¸­é—´çš„ <code>'-'</code> æ˜¯å­—ç¬¦ä¸²å¸¸é‡ï¼ˆæ³¨æ„å•å¼•å·ï¼‰</li><li>æ‹¼æ¥æˆ <code>"1001-2002"</code></li><li>è½¬æˆ <code>String</code> ç±»å‹è¿”å›</li></ol><hr><p><strong>ğŸ§ª ä¸¾ä¸ªå®é™…ä¾‹å­</strong></p><p>å‡è®¾ï¼š</p><pre tabindex=0><code>spel = &#34;#userId + &#39;-&#39; + #productId&#34;
args = [1001, 2002]
paramNames = [&#34;userId&#34;, &#34;productId&#34;]
</code></pre><p>é‚£ä¹ˆï¼š</p><pre tabindex=0><code>context.setVariable(&#34;userId&#34;, 1001);
context.setVariable(&#34;productId&#34;, 2002);
</code></pre><p>æ‰§è¡Œï¼š</p><pre tabindex=0><code>PARSER.parseExpression(&#34;#userId + &#39;-&#39; + #productId&#34;).getValue(context, String.class)
</code></pre><p>ğŸ‘‰ è¿”å›ç»“æœæ˜¯å­—ç¬¦ä¸²ï¼š<code>"1001-2002"</code></p><h4 id=ç¬¬äºŒéƒ¨åˆ†idempotentaspectjavaçœŸæ­£çš„æ ¸å¿ƒ>ç¬¬äºŒéƒ¨åˆ†ï¼š<code>IdempotentAspect.java</code>ï¼ˆçœŸæ­£çš„æ ¸å¿ƒï¼‰<a hidden class=anchor aria-hidden=true href=#ç¬¬äºŒéƒ¨åˆ†idempotentaspectjavaçœŸæ­£çš„æ ¸å¿ƒ>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Aspect</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>IdempotentAspect</span> {
</span></span></code></pre></div><p>âœ… å¤§ç™½è¯ï¼š</p><p>è¿™æ˜¯ä¸€ä¸ªâ€œåˆ‡é¢ç±»â€ï¼ŒSpring ä¼šè‡ªåŠ¨æ‰«æå®ƒï¼ˆå› ä¸ºåŠ äº† <code>@Component</code>ï¼‰ï¼Œå¹¶åœ¨æœ‰ <code>@Idempotent</code> æ³¨è§£çš„æ–¹æ³•ä¸Šâ€œæ’å…¥é¢å¤–é€»è¾‘â€ã€‚</p><ul><li><code>@Aspect</code>ï¼šå‘Šè¯‰ Springï¼šâ€œæˆ‘æ˜¯ä¸€ä¸ªåˆ‡é¢â€</li><li><code>@Component</code>ï¼šå‘Šè¯‰ Springï¼šâ€œæŠŠæˆ‘å½“æ™®é€š Bean ç®¡ç†èµ·æ¥â€</li></ul><hr><h5 id=1autowired>1ã€@Autowired<a hidden class=anchor aria-hidden=true href=#1autowired>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> RedisTemplate<span style=color:#f92672>&lt;</span>String, String<span style=color:#f92672>&gt;</span> redisTemplate;
</span></span></code></pre></div><p>âœ… å¤§ç™½è¯ï¼š</p><p>æ³¨å…¥ Redis æ“ä½œå·¥å…·ï¼Œç”¨æ¥å­˜â€œé”â€ã€‚æ¯”å¦‚å­˜ä¸€ä¸ª keyï¼š<code>idempotent:1001-2002</code>ï¼Œè¡¨ç¤ºè¿™ä¸ªç»„åˆæ­£åœ¨å¤„ç†ä¸­ã€‚</p><hr><h5 id=2around>2ã€@Around<a hidden class=anchor aria-hidden=true href=#2around>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Around</span>(<span style=color:#e6db74>&#34;@annotation(idempotent)&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>checkIdempotent</span>(ProceedingJoinPoint joinPoint, Idempotent idempotent) <span style=color:#66d9ef>throws</span> Throwable {
</span></span></code></pre></div><p>ğŸ§© ç¬¬ä¸€éƒ¨åˆ†ï¼š<code>@Around("@annotation(idempotent)")</code></p><p><strong>ğŸ’¬ å¤§ç™½è¯è§£é‡Šï¼š</strong></p><blockquote><p>â€œå½“æŸä¸ªæ–¹æ³•ä¸ŠåŠ äº† <code>@Idempotent</code> æ³¨è§£çš„æ—¶å€™ï¼Œè¯·å…ˆåˆ«æ€¥ç€æ‰§è¡Œå®ƒï¼Œè®©æˆ‘å…ˆæ’ä¸€è„šï¼â€</p></blockquote><p>è¿™å¥è¯çš„æ„æ€æ˜¯ï¼š</p><ul><li>æˆ‘è¦ç›‘å¬æ‰€æœ‰è¢« <code>@Idempotent</code> æ ‡è®°çš„æ–¹æ³•ã€‚</li><li>åœ¨è¿™äº›æ–¹æ³•<strong>çœŸæ­£æ‰§è¡Œä¹‹å‰</strong>ï¼Œå…ˆè¿è¡Œæˆ‘è¿™ä¸ª <code>checkIdempotent</code> æ–¹æ³•ã€‚</li><li>æˆ‘å¯ä»¥å†³å®šï¼šæ˜¯æ”¾è¡Œè®©å®ƒæ‰§è¡Œï¼Ÿè¿˜æ˜¯ç›´æ¥æ‹¦ä¸‹æ¥ï¼Ÿ</li></ul><p>ğŸ¯ å°±åƒä½ åœ¨é—¨å£è£…äº†ä¸ªâ€œé—¨ç¦ç³»ç»Ÿâ€ï¼Œæ¯ä¸ªäººè¿›é—¨å‰éƒ½è¦åˆ·ä¸€ä¸‹å¡ã€‚</p><hr><p><strong>ğŸ”¬ è¯­æ³•åŸç†ï¼š</strong></p><ul><li><code>@Around</code> æ˜¯ <strong>AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰</strong> çš„ä¸€ç§é€šçŸ¥ç±»å‹ï¼Œå«â€œç¯ç»•é€šçŸ¥â€ã€‚<ul><li>å®ƒæ˜¯æœ€å¼ºå¤§çš„ä¸€ç§é€šçŸ¥ï¼Œå¯ä»¥ï¼š<ul><li>åœ¨æ–¹æ³•å‰åšäº‹æƒ… âœ…</li><li>å†³å®šæ˜¯å¦æ‰§è¡ŒåŸæ–¹æ³• âœ…</li><li>åœ¨æ–¹æ³•ååšäº‹æƒ… âœ…</li><li>ä¿®æ”¹è¿”å›å€¼ âœ…</li><li>æ•è·å¼‚å¸¸ âœ…</li></ul></li></ul></li><li><code>"@annotation(idempotent)"</code> æ˜¯ä¸€ä¸ª <strong>åˆ‡ç‚¹è¡¨è¾¾å¼ï¼ˆPointcut Expressionï¼‰</strong><ul><li>æ„æ€æ˜¯ï¼šâ€œåŒ¹é…æ‰€æœ‰æ ‡æ³¨äº† <code>@Idempotent</code> æ³¨è§£çš„æ–¹æ³•â€</li><li>å…¶ä¸­ <code>idempotent</code> æ˜¯å‚æ•°åï¼Œå¯¹åº”åé¢æ–¹æ³•é‡Œçš„ <code>Idempotent idempotent</code></li></ul></li></ul><p>ğŸ“Œ ä¸¾ä¸ªç±»æ¯”ï¼š</p><table><thead><tr><th>ç±»æ¯”</th><th>å¯¹åº”</th></tr></thead><tbody><tr><td>å­¦æ ¡å¤§é—¨</td><td>è¢«æ‹¦æˆªçš„æ–¹æ³•ï¼ˆå¦‚ addCommentï¼‰</td></tr><tr><td>å­¦ç”Ÿåˆ·è„¸è¿›é—¨</td><td>æ–¹æ³•è¢«è°ƒç”¨</td></tr><tr><td>ä¿å®‰æ‹¦äººæ£€æŸ¥</td><td><code>@Around</code> åˆ‡é¢é€»è¾‘</td></tr><tr><td>åªæœ‰æˆ´æ ¡å¾½çš„äººæ‰èƒ½è¿›</td><td><code>@annotation(idempotent)</code> æ¡ä»¶</td></tr></tbody></table><hr><p>ğŸ§© ç¬¬äºŒéƒ¨åˆ†ï¼šæ–¹æ³•ç­¾å</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>checkIdempotent</span>(ProceedingJoinPoint joinPoint, Idempotent idempotent)
</span></span></code></pre></div><p>æˆ‘ä»¬æ‹†å¼€çœ‹æ¯ä¸ªéƒ¨åˆ†ã€‚</p><hr><p>1ï¸âƒ£ <code>public Object</code></p><ul><li>è¿”å›ç±»å‹æ˜¯ <code>Object</code>ï¼Œå› ä¸ºæˆ‘ä»¬è¦è¿”å›<strong>åŸæ–¹æ³•çš„æ‰§è¡Œç»“æœ</strong>ã€‚</li><li>åŸæ–¹æ³•å¯èƒ½æ˜¯ <code>String</code>ã€<code>Map</code>ã€<code>void</code> ç­‰ï¼Œæ‰€ä»¥ç”¨æœ€é€šç”¨çš„ <code>Object</code> æ¥ä½ã€‚</li></ul><p>ğŸ¯ å¤§ç™½è¯ï¼š
â€œæˆ‘ä¸ç®¡ä½ æ˜¯è¿”å›å­—ç¬¦ä¸²è¿˜æ˜¯æ•°å­—ï¼Œæˆ‘éƒ½åŸæ ·äº¤å›å»ã€‚â€</p><hr><p>2ï¸âƒ£ <code>ProceedingJoinPoint joinPoint</code></p><p>è¿™æ˜¯ AOP çš„æ ¸å¿ƒå¯¹è±¡ä¹‹ä¸€ã€‚</p><p><strong>ğŸ’¬ å¤§ç™½è¯ï¼š</strong></p><blockquote><p>â€œä½ æ‹¦ä½çš„é‚£ä¸ªæ­£åœ¨è¢«è°ƒç”¨çš„æ–¹æ³•ï¼Œæˆ‘ç°åœ¨æŠŠå®ƒâ€˜æ‰“åŒ…â€™æˆä¸€ä¸ªå¯¹è±¡ï¼Œå« <code>joinPoint</code>ï¼Œä½ å¯ä»¥é€šè¿‡å®ƒçŸ¥é“ï¼š</p><ul><li>å®ƒæ˜¯è°ï¼Ÿï¼ˆå“ªä¸ªç±»çš„å“ªä¸ªæ–¹æ³•ï¼‰</li><li>å®ƒæœ‰å“ªäº›å‚æ•°ï¼Ÿ</li><li>å®ƒçš„å‚æ•°å«ä»€ä¹ˆåå­—ï¼Ÿ</li><li>æˆ‘ç°åœ¨è¦ä¸è¦è®©å®ƒç»§ç»­æ‰§è¡Œï¼Ÿâ€</li></ul></blockquote><p><strong>ğŸ”¬ è¯­æ³•åŸç†ï¼š</strong></p><ul><li><code>JoinPoint</code>ï¼šä»£è¡¨â€œè¿æ¥ç‚¹â€ï¼Œå³ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­çš„æŸä¸ªç‚¹ï¼ˆæ¯”å¦‚æ–¹æ³•è°ƒç”¨ï¼‰ã€‚</li><li><code>ProceedingJoinPoint</code> æ˜¯å®ƒçš„å­æ¥å£ï¼Œå¤šäº† <code>.proceed()</code> æ–¹æ³•ï¼Œè¡¨ç¤ºâ€œç»§ç»­æ‰§è¡ŒåŸæ–¹æ³•â€ã€‚</li><li>å¸¸è§æ–¹æ³•ï¼š<ul><li><code>getArgs()</code> â†’ è·å–å‚æ•°å€¼</li><li><code>getSignature()</code> â†’ è·å–æ–¹æ³•ç­¾å</li><li><code>proceed()</code> â†’ æ”¾è¡Œï¼Œè®©åŸæ–¹æ³•æ‰§è¡Œ</li></ul></li></ul><p>ğŸ¯ å…³é”®ä½œç”¨ï¼š<strong>æ§åˆ¶æµç¨‹æ˜¯å¦ç»§ç»­å‘ä¸‹èµ°</strong></p><hr><p>3ï¸âƒ£ <code>Idempotent idempotent</code></p><p>ğŸ’¬ å¤§ç™½è¯ï¼š</p><blockquote><p>â€œä½ ä¸æ˜¯åœ¨æ–¹æ³•ä¸Šå†™äº† <code>@Idempotent(key = '...', expire = 10)</code> å—ï¼Ÿ
æˆ‘ç°åœ¨æŠŠé‚£ä¸ªæ³¨è§£æœ¬èº«æ‹¿è¿‡æ¥ï¼Œè¯»é‡Œé¢çš„é…ç½®ã€‚â€</p></blockquote><p>æ¯”å¦‚ä½ å¯ä»¥æ‹¿åˆ°ï¼š</p><ul><li><code>idempotent.key()</code> â†’ <code>"#userId + '-' + #productId"</code></li><li><code>idempotent.expire()</code> â†’ <code>10</code></li></ul><p>è¿™å°±å®ç°äº†â€œé…ç½®é©±åŠ¨â€ï¼šä¸åŒæ–¹æ³•å¯ä»¥ç”¨ä¸åŒçš„ key å’Œè¿‡æœŸæ—¶é—´ã€‚</p><p><strong>ğŸ”¬ è¯­æ³•åŸç†ï¼š</strong></p><ul><li><p>Spring AOP æ”¯æŒè‡ªåŠ¨æ³¨å…¥æ³¨è§£å¯¹è±¡åˆ°é€šçŸ¥æ–¹æ³•ä¸­ã€‚</p></li><li><p>æ¡ä»¶ï¼šå‚æ•°åå¿…é¡»å’Œ<code>@Around</code> è¡¨è¾¾å¼ä¸­çš„å˜é‡ä¸€è‡´ã€‚</p><ul><li><code>@Around("@annotation(idempotent)")</code></li><li>æ–¹æ³•å‚æ•°ï¼š<code>Idempotent idempotent</code></li><li>åå­—è¦å¯¹å¾—ä¸Šï¼</li></ul><p>âœ… æ­£ç¡®ï¼š</p><pre tabindex=0><code>@Around(&#34;@annotation(myAnno)&#34;)
public void advice(MyAnnotation myAnno) { ... }
</code></pre><p>âŒ é”™è¯¯ï¼š</p><pre tabindex=0><code>@Around(&#34;@annotation(myAnno)&#34;)
public void advice(MyAnnotation wrongName) { ... } // æ‰¾ä¸åˆ°
</code></pre><hr><p>ğŸ§© ç¬¬ä¸‰éƒ¨åˆ†ï¼š<code>throws Throwable</code></p><p>ğŸ’¬ å¤§ç™½è¯ï¼š</p><blockquote><p>â€œæˆ‘åœ¨æ£€æŸ¥çš„æ—¶å€™å¯èƒ½ä¼šå‡ºé”™ï¼Œæ¯”å¦‚ Redis è¿ä¸ä¸Šã€è¡¨è¾¾å¼å†™é”™äº†â€¦â€¦
å¦‚æœçœŸå‡ºäº†é—®é¢˜ï¼Œæˆ‘å°±æŠŠé”™è¯¯å¾€ä¸ŠæŠ›ï¼Œè®©åˆ«äººå¤„ç†ã€‚â€</p></blockquote><p>å› ä¸ºæˆ‘ä»¬è¦è°ƒç”¨ <code>joinPoint.proceed()</code>ï¼Œå®ƒæœ¬èº«å°±ä¼šæŠ›å¼‚å¸¸ï¼ˆæ¯”å¦‚ä¸šåŠ¡é€»è¾‘å¼‚å¸¸ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿè¦å£°æ˜ <code>throws Throwable</code>ã€‚</p><blockquote><p><code>Throwable</code> æ˜¯æ‰€æœ‰é”™è¯¯å’Œå¼‚å¸¸çš„â€œè€ç¥–å®—â€ï¼ŒåŒ…æ‹¬ <code>Exception</code> å’Œ <code>Error</code>ã€‚</p></blockquote><hr><p>ğŸ¯ æ•´ä½“ç†è§£ï¼ˆå†ä¸²ä¸€éï¼‰</p><pre tabindex=0><code>@Around(&#34;@annotation(idempotent)&#34;)
public Object checkIdempotent(ProceedingJoinPoint joinPoint, Idempotent idempotent) throws Throwable {
</code></pre><p>ğŸ” ç›¸å½“äºä½ è¯´ï¼š</p><blockquote><p>â€œSpring å•Šï¼Œè¯·ä½ ç›‘å¬æ‰€æœ‰åŠ äº† <code>@Idempotent</code> æ³¨è§£çš„æ–¹æ³•ã€‚
å½“å®ƒä»¬è¢«è°ƒç”¨æ—¶ï¼Œå…ˆåˆ«æ‰§è¡Œï¼ŒæŠŠæˆ‘è¿™ä¸ªæ–¹æ³•å«èµ·æ¥ï¼š
æŠŠâ€˜è¢«æ‹¦æˆªçš„æ–¹æ³•â€™åŒ…è£…æˆ <code>joinPoint</code>ï¼ŒæŠŠæ³¨è§£æœ¬èº«å½“ä½œ <code>idempotent</code> å‚æ•°ä¼ ç»™æˆ‘ã€‚
æˆ‘ä¼šæ ¹æ®æ³¨è§£é‡Œçš„é…ç½®ï¼Œåˆ¤æ–­è¦ä¸è¦æ”¾è¡Œã€‚
å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œæˆ‘å°±è®©å®ƒç»§ç»­æ‰§è¡Œï¼›å¦åˆ™å°±ç›´æ¥æŠ›å¼‚å¸¸æ‹¦ä½ã€‚
å‡ºäº†é—®é¢˜æˆ‘ä¹Ÿæ‹¦ä¸ä½ï¼Œé‚£å°±å¾€ä¸Šæ‰”é”™è¯¯ã€‚â€</p></blockquote><hr><p><strong>ğŸ§ª ä¸¾ä¸ªç”Ÿæ´»åŒ–çš„ä¾‹å­</strong></p><p>æƒ³è±¡ä½ åœ¨ç”µå½±é™¢ä¹°ç¥¨ï¼š</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;/buyTicket&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Idempotent</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#userId + &#39;-&#39; + #movieId&#34;</span>, expire <span style=color:#f92672>=</span> 60)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>buyTicket</span>(<span style=color:#a6e22e>@RequestParam</span> Long userId, <span style=color:#a6e22e>@RequestParam</span> Long movieId) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ‰£é’±ã€å‡ºç¥¨</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å½“ä½ ç‚¹å‡»â€œä¹°ç¥¨â€æŒ‰é’®ä¸¤æ¬¡ï¼š</p><ol><li>ç¬¬ä¸€æ¬¡ï¼š<ul><li>AOP æ‹¦æˆª â†’ <code>checkIdempotent</code> æ‰§è¡Œ</li><li>ç®— keyï¼š<code>"1001-2002"</code></li><li>Redis æ²¡æœ‰è¿™ä¸ª key â†’ è®¾ç½®æˆåŠŸ â†’ æ”¾è¡Œ â†’ ä¹°ç¥¨æˆåŠŸ âœ…</li></ul></li><li>ç¬¬äºŒæ¬¡ï¼ˆ1 ç§’åï¼‰ï¼š<ul><li>AOP åˆæ‹¦æˆª</li><li>ç®—åŒæ ·çš„ keyï¼š<code>"1001-2002"</code></li><li>Redis å·²å­˜åœ¨ â†’ ä¸æ”¾è¡Œ â†’ æŠ›å¼‚å¸¸ âŒ â€œè¯·å‹¿é‡å¤æäº¤â€</li></ul></li></ol><p>ğŸ‘‰ å°±åƒå”®ç¥¨å‘˜è¯´ï¼šâ€œä½ åˆšä¹°è¿‡è¿™å¼ ç¥¨äº†ï¼Œä¸èƒ½å†ä¹°ï¼â€</p><p><strong>âœ… æ€»ç»“ä¸€å¥è¯</strong></p><blockquote><pre tabindex=0><code>@Around(&#34;@annotation(idempotent)&#34;)
public Object checkIdempotent(ProceedingJoinPoint joinPoint, Idempotent idempotent) throws Throwable
</code></pre><p>å°±åƒæ˜¯ä¸€ä¸ªâ€œæ™ºèƒ½é—¨å«â€ï¼š</p><ul><li><strong>è°æ¥éƒ½è¦æŸ¥</strong>ï¼šæ‰€æœ‰å¸¦ <code>@Idempotent</code> çš„æ–¹æ³•</li><li><strong>æ‰‹é‡Œæœ‰åå•</strong>ï¼š<code>idempotent</code> æ³¨è§£é‡Œçš„é…ç½®ï¼ˆkeyã€è¿‡æœŸæ—¶é—´ï¼‰</li><li><strong>èƒ½æ‹¦ä¹Ÿèƒ½æ”¾</strong>ï¼šé€šè¿‡ <code>joinPoint.proceed()</code> æ§åˆ¶æ˜¯å¦æ‰§è¡ŒåŸæ–¹æ³•</li><li><strong>å‡ºäº‹è¦ä¸ŠæŠ¥</strong>ï¼šå¯èƒ½æŠ›å¼‚å¸¸ï¼Œæ‰€ä»¥å£°æ˜ <code>throws Throwable</code></li></ul></blockquote><hr><h5 id=3methodsignature-signature-->3ã€MethodSignature signature = &mldr;&mldr;<a hidden class=anchor aria-hidden=true href=#3methodsignature-signature-->#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>        <span style=color:#75715e>// 1. è·å–æ–¹æ³•ç­¾å</span>
</span></span><span style=display:flex><span>        MethodSignature signature <span style=color:#f92672>=</span> (MethodSignature) joinPoint.<span style=color:#a6e22e>getSignature</span>();
</span></span><span style=display:flex><span>        Method method <span style=color:#f92672>=</span> signature.<span style=color:#a6e22e>getMethod</span>();
</span></span></code></pre></div><p><strong>âœ… å¤§ç™½è¯ï¼š</strong></p><p>æ‹¿åˆ°â€œè¢«è°ƒç”¨çš„æ–¹æ³•â€æœ¬èº«ï¼Œæ¯”å¦‚ <code>addComment(...)</code> è¿™ä¸ªæ–¹æ³•å¯¹è±¡ã€‚</p><ul><li><code>getSignature()</code>ï¼šæ‹¿åˆ°æ–¹æ³•çš„â€œèº«ä»½è¯â€ï¼ˆç­¾åï¼‰</li><li>å¼ºè½¬æˆ <code>MethodSignature</code> æ˜¯ä¸ºäº†èƒ½è¿›ä¸€æ­¥è·å–å‚æ•°å</li></ul><h5 id=4signaturegetparameternames>4ã€signature.getParameterNames()<a hidden class=anchor aria-hidden=true href=#4signaturegetparameternames>#</a></h5><p>âœ… å¤§ç™½è¯ï¼š</p><p>è¿™æ‰æ˜¯<strong>æ­£ç¡®çš„æ–¹å¼</strong>è·å–å‚æ•°åï¼</p><ul><li><code>signature.getParameterNames()</code>ï¼šç›´æ¥ä»æ–¹æ³•ç­¾åé‡Œæ‹¿å‚æ•°åæ•°ç»„ï¼Œæ¯”å¦‚ <code>["userId", "productId", "content"]</code></li><li><code>joinPoint.getArgs()</code>ï¼šæ‹¿åˆ°å®é™…ä¼ å…¥çš„å‚æ•°å€¼ï¼Œæ¯”å¦‚ <code>[1001, 2002, "å¥½è¯„ï¼"]</code></li></ul><blockquote><p>âœ… å¯¹æ¯”å‰é¢ <code>SpelUtil</code> çš„é”™è¯¯åšæ³•ï¼Œè¿™é‡Œæ‰æ˜¯å¯¹çš„ï¼</p></blockquote><hr><h5 id=5standardevaluationcontext-context>5ã€StandardEvaluationContext context<a hidden class=anchor aria-hidden=true href=#5standardevaluationcontext-context>#</a></h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>        <span style=color:#75715e>// 3. æ„å»º SpEL ä¸Šä¸‹æ–‡</span>
</span></span><span style=display:flex><span>        StandardEvaluationContext context <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> StandardEvaluationContext();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> paramNames.<span style=color:#a6e22e>length</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            context.<span style=color:#a6e22e>setVariable</span>(paramNames<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span>, args<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span>);
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>ğŸ§© ç¬¬ä¸€è¡Œï¼š<code>StandardEvaluationContext context = new StandardEvaluationContext();</code></p><p><strong>ğŸ’¬ å¤§ç™½è¯ï¼š</strong></p><blockquote><p>â€œæˆ‘è¦å¼€å§‹ç®—ä¸€ä¸ªè¡¨è¾¾å¼äº†ï¼Œå…ˆå‡†å¤‡ä¸€ä¸ªâ€˜å°æœ¬å­â€™ï¼Œç”¨æ¥è®°å˜é‡ã€‚â€</p></blockquote><p>å°±åƒä½ åšæ•°å­¦é¢˜å‰ï¼Œè€å¸ˆè¯´ï¼šâ€œå·²çŸ¥ï¼šx = 5ï¼Œy = 3â€ï¼Œè¿™ä¸ªâ€œå·²çŸ¥æ¡ä»¶â€çš„åœ°æ–¹ï¼Œå°±æ˜¯ <strong>ä¸Šä¸‹æ–‡ï¼ˆcontextï¼‰</strong>ã€‚</p><p>åœ¨è¿™é‡Œï¼Œè¿™ä¸ªâ€œå°æœ¬å­â€å« <code>context</code>ï¼Œå®ƒæ˜¯ Spring ä¸“é—¨ç”¨æ¥è®© <strong>SpEL è¡¨è¾¾å¼</strong> èƒ½è¯»åˆ°å˜é‡çš„åœ°æ–¹ã€‚</p><p>ğŸ¯ ä¸¾ä¸ªç”Ÿæ´»ä¾‹å­ï¼š</p><p>ä½ æƒ³ç®—ï¼š<code>#userId + '-' + #productId</code></p><p>ä½† Spring ä¸çŸ¥é“ <code>#userId</code> æ˜¯å¤šå°‘å•Šï¼</p><p>æ‰€ä»¥ä½ è¦å…ˆå‘Šè¯‰å®ƒï¼šâ€œå¬ç€ï¼Œæˆ‘ç°åœ¨å‘Šè¯‰ä½ ï¼š<code>userId=1001</code>ï¼Œ<code>productId=2002</code>â€</p><p>è¿™ä¸ªâ€œå‘Šè¯‰â€çš„è¿‡ç¨‹ï¼Œå°±éœ€è¦ä¸€ä¸ªâ€œè®°äº‹æœ¬â€â€”â€”å°±æ˜¯è¿™ä¸ª <code>context</code>ã€‚</p><hr><p><strong>ğŸ”¬ è¯­æ³•åŸç†ï¼š</strong></p><ul><li><code>StandardEvaluationContext</code> æ˜¯ Spring æä¾›çš„ä¸€ä¸ªç±»ï¼Œè¡¨ç¤º <strong>SpEL è¡¨è¾¾å¼çš„è¿è¡Œç¯å¢ƒ</strong>ã€‚</li><li>å®ƒå¯ä»¥å­˜å‚¨ï¼š<ul><li>å˜é‡ï¼ˆvariablesï¼‰</li><li>å‡½æ•°ï¼ˆfunctionsï¼‰</li><li>ç±»å‹æŸ¥æ‰¾å™¨ï¼ˆtype locatorsï¼‰ç­‰</li></ul></li><li>åœ¨æ±‚å€¼æ—¶ï¼Œè¡¨è¾¾å¼ä¼šä»è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­æŸ¥æ‰¾ <code>#xxx</code> è¿™æ ·çš„å˜é‡ã€‚</li></ul><p>âœ… ç®€å•è¯´ï¼šæ²¡æœ‰å®ƒï¼Œ<code>#userId</code> å°±æ˜¯â€œæ— åä¹‹è¾ˆâ€ï¼Œæœ‰äº†å®ƒï¼Œ<code>#userId</code> æ‰æœ‰å€¼</p><hr><p><strong>ğŸ§© ç¬¬äºŒéƒ¨åˆ†ï¼š<code>for</code> å¾ªç¯</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> args.<span style=color:#a6e22e>length</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    context.<span style=color:#a6e22e>setVariable</span>(paramNames<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span>, args<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬æ‹†å¼€æ¥çœ‹ã€‚</p><hr><p><strong>ğŸ’¬ å¤§ç™½è¯ï¼š</strong></p><blockquote><p>â€œæˆ‘ç°åœ¨æœ‰ä¸€å †å‚æ•°ï¼š</p><ul><li>å‚æ•°åå­—æ˜¯ï¼š<code>["userId", "productId", "content"]</code></li><li>å®é™…å€¼æ˜¯ï¼š<code>[1001, 2002, "å¥½è¯„ï¼"]</code></li></ul><p>æˆ‘è¦æŠŠå®ƒä»¬ä¸€ä¸ªä¸ªæ”¾è¿›â€˜å°æœ¬å­â€™é‡Œï¼Œå˜æˆï¼š</p><ul><li><code>userId = 1001</code></li><li><code>productId = 2002</code></li><li><code>content = "å¥½è¯„ï¼"</code></li></ul><p>è¿™æ ·åé¢ç®—è¡¨è¾¾å¼çš„æ—¶å€™ï¼Œå°±èƒ½ç”¨ <code>#userId</code> æ‹¿åˆ° 1001 äº†ã€‚â€</p></blockquote><hr><p><strong>ğŸ”¬ è¯­æ³•åŸç†ï¼š</strong></p><p><strong><code>paramNames[i]</code>ï¼šå‚æ•°å</strong></p><ul><li><p>æ¥è‡ª <code>signature.getParameterNames()</code></p></li><li><p>æ¯”å¦‚æ–¹æ³•æ˜¯ï¼š</p><pre tabindex=0><code>public String addComment(Long userId, Long productId, String content)
</code></pre></li><li><p>é‚£ä¹ˆ <code>paramNames = ["userId", "productId", "content"]</code></p></li></ul><blockquote><p>âš ï¸ æ³¨æ„ï¼šå¿…é¡»ç¼–è¯‘æ—¶åŠ  <code>-parameters</code> å‚æ•°ï¼Œå¦åˆ™å¯èƒ½å¾—åˆ° <code>arg0, arg1, arg2</code></p></blockquote><p><strong><code>args[i]</code>ï¼šå‚æ•°å€¼</strong></p><ul><li><p>æ¥è‡ª <code>joinPoint.getArgs()</code></p></li><li><p>æ˜¯å®é™…ä¼ è¿›æ¥çš„æ•°æ®ï¼Œæ¯”å¦‚ï¼š</p><pre tabindex=0><code>[1001L, 2002L, &#34;æœåŠ¡å¾ˆå¥½ï¼&#34;]
</code></pre></li></ul><p><strong><code>context.setVariable(name, value)</code></strong></p><ul><li>æŠŠä¸€ä¸ªå˜é‡æ³¨å†Œåˆ° SpEL ä¸Šä¸‹æ–‡ä¸­</li><li>ä¹‹ååœ¨è¡¨è¾¾å¼ä¸­å°±å¯ä»¥ç”¨ <code>#name</code> æ¥å¼•ç”¨å®ƒ</li></ul><p>âœ… ä¸¾ä¾‹ï¼š</p><table><thead><tr><th>ä»£ç </th><th>æ•ˆæœ</th></tr></thead><tbody><tr><td><code>context.setVariable("userId", 1001)</code></td><td>ä¹‹å <code>#userId</code> å°±ç­‰äº <code>1001</code></td></tr><tr><td><code>context.setVariable("content", "å¥½è¯„")</code></td><td>ä¹‹å <code>#content</code> å°±ç­‰äº <code>"å¥½è¯„"</code></td></tr></tbody></table><hr><p><strong>ğŸ¯ ä¸¾ä¸ªå®Œæ•´ä¾‹å­</strong></p><p>å‡è®¾ä½ è°ƒç”¨äº†è¿™ä¸ªæ¥å£ï¼š</p><pre tabindex=0><code>@PostMapping(&#34;/comment&#34;)
@Idempotent(key = &#34;#userId + &#39;-&#39; + #productId&#34;)
public String addComment(
    @RequestParam Long userId,      // å®é™…å€¼ï¼š1001
    @RequestParam Long productId,   // å®é™…å€¼ï¼š2002
    @RequestBody String content) {  // å®é™…å€¼ï¼š&#34;æœåŠ¡å¾ˆæ£’&#34;
    // ...
}
</code></pre><p>é‚£ä¹ˆï¼š</p><table><thead><tr><th>å˜é‡</th><th>å€¼</th></tr></thead><tbody><tr><td><code>paramNames</code></td><td><code>["userId", "productId", "content"]</code></td></tr><tr><td><code>args</code></td><td><code>[1001, 2002, "æœåŠ¡å¾ˆæ£’"]</code></td></tr></tbody></table><p>å¾ªç¯æ‰§è¡Œåï¼Œ<code>context</code> é‡Œå°±å­˜äº†ï¼š</p><table><thead><tr><th>å˜é‡å</th><th>å€¼</th></tr></thead><tbody><tr><td><code>userId</code></td><td><code>1001</code></td></tr><tr><td><code>productId</code></td><td><code>2002</code></td></tr><tr><td><code>content</code></td><td><code>"æœåŠ¡å¾ˆæ£’"</code></td></tr></tbody></table><p>ç„¶åä½ å†™è¡¨è¾¾å¼ï¼š</p><pre tabindex=0><code>&#34;#userId + &#39;-&#39; + #productId&#34;
</code></pre><p>Spring å°±èƒ½ä» <code>context</code> ä¸­æ‰¾åˆ°ï¼š</p><ul><li><code>#userId</code> â†’ <code>1001</code></li><li><code>#productId</code> â†’ <code>2002</code></li><li>æ‹¼æˆ <code>"1001-2002"</code></li></ul><p>ğŸ¯ æˆåŠŸç”Ÿæˆ Redis çš„ keyï¼</p><hr><h5 id=6string-keyexpression--idempotentkey>6ã€String keyExpression = idempotent.key()<a hidden class=anchor aria-hidden=true href=#6string-keyexpression--idempotentkey>#</a></h5><p>ğŸ§© ç¬¬ä¸€è¡Œï¼š<code>String keyExpression = idempotent.key();</code></p><p><strong>ğŸ’¬ å¤§ç™½è¯ï¼š</strong></p><blockquote><p>â€œå…ˆçœ‹çœ‹ç”¨æˆ·åœ¨æ³¨è§£é‡Œå†™äº†ä»€ä¹ˆè¡¨è¾¾å¼ã€‚â€</p></blockquote><p>æ¯”å¦‚ä½ åœ¨ Controller æ–¹æ³•ä¸Šè¿™ä¹ˆå†™ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Idempotent</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#userId + &#39;-&#39; + #productId&#34;</span>, expire <span style=color:#f92672>=</span> 10)
</span></span><span style=display:flex><span>2public String <span style=color:#a6e22e>addComment</span>(Long userId, Long productId, ...) { ... }
</span></span></code></pre></div><p>é‚£ä¹ˆ <code>idempotent.key()</code> å°±ä¼šè¿”å›å­—ç¬¦ä¸²ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#e6db74>&#34;#userId + &#39;-&#39; + #productId&#34;</span>
</span></span></code></pre></div><p>è¿™ä¸ªå­—ç¬¦ä¸²ä¸æ˜¯æ™®é€šæ–‡æœ¬ï¼Œè€Œæ˜¯ä¸€ä¸ªâ€œæ¨¡æ¿â€æˆ–â€œå…¬å¼â€ï¼Œç­‰ç€æˆ‘ä»¬å»â€œå¡«ç©ºâ€ã€‚</p><p>ğŸ¯ å°±åƒä½ å†™äº†ä¸€ä¸ª Excel å…¬å¼ï¼š<code>=A1 & "-" & B1</code>ï¼Œä½†è¿˜æ²¡ä»£å…¥çœŸå®å•å…ƒæ ¼çš„å€¼ã€‚</p><hr><p>ğŸ”¬ è¯­æ³•åŸç†ï¼š</p><p><code>idempotent</code> æ˜¯æ–¹æ³•ä¸Šçš„ <code>@Idempotent</code> æ³¨è§£å¯¹è±¡ï¼ˆç”± Spring AOP è‡ªåŠ¨æ³¨å…¥ï¼‰ã€‚</p><p><code>key()</code> æ˜¯æ³¨è§£ä¸­çš„ä¸€ä¸ªå±æ€§ï¼ˆæ–¹æ³•ï¼‰ï¼Œè¿”å› <code>String</code> ç±»å‹ã€‚</p><p>æ³¨è§£å®šä¹‰å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Target</span>(ElementType.<span style=color:#a6e22e>METHOD</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Retention</span>(RetentionPolicy.<span style=color:#a6e22e>RUNTIME</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>@interface</span> Idempotent {
</span></span><span style=display:flex><span>    String <span style=color:#a6e22e>key</span>();     <span style=color:#75715e>// â† è¿™å°±æ˜¯ .key() çš„æ¥æº</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>expire</span>() <span style=color:#66d9ef>default</span> 5;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>âœ… æ‰€ä»¥è¿™è¡Œä»£ç åªæ˜¯<strong>è¯»å–é…ç½®</strong>ï¼Œæ²¡æœ‰è®¡ç®—ã€‚</p><hr><p><strong>ğŸ§© ç¬¬äºŒè¡Œï¼ˆæ ¸å¿ƒï¼‰ï¼šè§£æå¹¶æ±‚å€¼</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>String realKey <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SpelExpressionParser()
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>parseExpression</span>(keyExpression)
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>getValue</span>(context, String.<span style=color:#a6e22e>class</span>);
</span></span></code></pre></div><p>æˆ‘ä»¬æ‹†æˆä¸‰æ­¥æ¥çœ‹ï¼š</p><hr><p>âœ… ç¬¬ä¸€æ­¥ï¼š<code>new SpelExpressionParser()</code></p><p><strong>ğŸ’¬ å¤§ç™½è¯ï¼š</strong></p><blockquote><p>â€œè¯·å¬å”¤ä¸€ä½â€˜è¡¨è¾¾å¼ç¿»è¯‘å®˜â€™ï¼â€</p></blockquote><p>è¿™ä½ç¿»è¯‘å®˜ä¸“é—¨è´Ÿè´£è¯»æ‡‚åƒ <code>"#userId + '-' + #productId"</code> è¿™æ ·çš„â€œSpring è¡¨è¾¾å¼è¯­è¨€ï¼ˆSpELï¼‰â€ã€‚</p><p><strong>ğŸ”¬ è¯­æ³•åŸç†ï¼š</strong></p><ul><li><code>SpelExpressionParser</code> æ˜¯ Spring æä¾›çš„æ ‡å‡† SpEL è§£æå™¨ã€‚</li><li>æ¯æ¬¡ <code>new</code> ä¸€ä¸ªä¹Ÿå¯ä»¥ï¼Œä½†é€šå¸¸å»ºè®®å¤ç”¨ï¼ˆä¸è¿‡è¿™é‡Œåªç”¨ä¸€æ¬¡ï¼Œé—®é¢˜ä¸å¤§ï¼‰ã€‚</li><li>å®ƒå®ç°äº† <code>ExpressionParser</code> æ¥å£ã€‚</li></ul><hr><p>âœ… ç¬¬äºŒæ­¥ï¼š<code>.parseExpression(keyExpression)</code></p><p><strong>ğŸ’¬ å¤§ç™½è¯ï¼š</strong></p><blockquote><p>â€œç¿»è¯‘å®˜ï¼Œè¯·æŠŠè¿™æ®µâ€˜å’’è¯­â€™ï¼ˆè¡¨è¾¾å¼ï¼‰å…ˆç†è§£ä¸€ä¸‹ï¼Œå‡†å¤‡å¥½æ€ä¹ˆç®—ã€‚â€</p></blockquote><p>æ¯”å¦‚è¾“å…¥ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#e6db74>&#34;#userId + &#39;-&#39; + #productId&#34;</span>
</span></span></code></pre></div><p>ç¿»è¯‘å®˜ä¼šåˆ†æå‡ºï¼š</p><ul><li>è¿™æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ‹¼æ¥æ“ä½œ</li><li>éœ€è¦ç”¨åˆ°ä¸¤ä¸ªå˜é‡ï¼š<code>userId</code> å’Œ <code>productId</code></li><li>ä¸­é—´å¤¹ç€ä¸€ä¸ªå›ºå®šçš„ <code>'-'</code> å­—ç¬¦ä¸²</li></ul><p>âš ï¸ æ³¨æ„ï¼šè¿™æ—¶å€™<strong>è¿˜æ²¡ç®—ç»“æœ</strong>ï¼Œåªæ˜¯â€œç¼–è¯‘â€å¥½äº†ï¼Œå‡†å¤‡æ‰§è¡Œã€‚</p><p>ğŸ”¬ è¯­æ³•åŸç†ï¼š</p><ul><li>è¿”å›ä¸€ä¸ª <code>Expression</code> å¯¹è±¡ã€‚</li><li>å¦‚æœè¡¨è¾¾å¼è¯­æ³•é”™è¯¯ï¼ˆæ¯”å¦‚å°‘å¼•å·ã€æ‹¬å·ä¸åŒ¹é…ï¼‰ï¼Œè¿™é‡Œä¼šæŠ› <code>ParseException</code>ã€‚</li></ul><p>âœ… ä¸¾ä¾‹åˆæ³•è¡¨è¾¾å¼ï¼š</p><table><thead><tr><th>è¡¨è¾¾å¼</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td><code>"#name"</code></td><td>å–å˜é‡ name çš„å€¼</td></tr><tr><td><code>"#user.age > 18"</code></td><td>åˆ¤æ–­å¹´é¾„æ˜¯å¦å¤§äº 18</td></tr><tr><td><code>"T(java.lang.Math).random()"</code></td><td>è°ƒç”¨é™æ€æ–¹æ³•</td></tr></tbody></table><p>âœ… ç¬¬ä¸‰æ­¥ï¼š<code>.getValue(context, String.class)</code></p><p><strong>ğŸ’¬ å¤§ç™½è¯ï¼š</strong></p><blockquote><p>â€œç°åœ¨ï¼Œè¯·ç»“åˆæˆ‘ç»™ä½ çš„â€˜å˜é‡æœ¬å­â€™ï¼ˆcontextï¼‰ï¼ŒæŠŠè¿™ä¸ªè¡¨è¾¾å¼çœŸæ­£ç®—å‡ºæ¥ï¼Œå¹¶ä¸”ç»“æœè¦æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼â€</p></blockquote><p>æ¯”å¦‚ï¼š</p><ul><li><code>context</code> é‡Œæœ‰ï¼š<code>userId=1001</code>, <code>productId=2002</code></li><li>è¡¨è¾¾å¼æ˜¯ï¼š<code>"#userId + '-' + #productId"</code></li><li>ç®—å‡ºæ¥å°±æ˜¯ï¼š<code>"1001-2002"</code></li></ul><p>ç„¶åæŠŠå®ƒèµ‹å€¼ç»™ <code>realKey</code>ã€‚</p><p><strong>ğŸ”¬ è¯­æ³•åŸç†ï¼š</strong></p><ul><li><pre tabindex=0><code>getValue(EvaluationContext context, Class&lt;T&gt; desiredResultType)
</code></pre><ul><li><code>context</code>ï¼šæä¾›å˜é‡ç¯å¢ƒï¼ˆä¹‹å‰é€šè¿‡ <code>setVariable</code> è®¾ç½®çš„ï¼‰</li><li><code>String.class</code>ï¼šå‘Šè¯‰ Springï¼šâ€œæˆ‘è¦çš„ç»“æœç±»å‹æ˜¯ Stringâ€</li></ul></li><li><p>Spring ä¼šè‡ªåŠ¨åšç±»å‹è½¬æ¢ï¼ˆæ¯”å¦‚æ•°å­—è½¬å­—ç¬¦ä¸²ï¼‰</p></li></ul><p>âœ… å¦‚æœç»“æœä¸æ˜¯å­—ç¬¦ä¸²ï¼Œä½†èƒ½è½¬æˆå­—ç¬¦ä¸²ï¼ˆæ¯”å¦‚ <code>Long</code>ï¼‰ï¼Œä¹Ÿä¼šæˆåŠŸã€‚
âŒ å¦‚æœå®Œå…¨æ— æ³•è½¬æ¢ï¼ˆæ¯”å¦‚è¿”å›ä¸€ä¸ªå¯¹è±¡åˆæ²¡é‡å†™ <code>toString</code>ï¼‰ï¼Œå¯èƒ½æŠ¥é”™ã€‚</p><hr><p><strong>ğŸ¯ å®Œæ•´æµç¨‹å›¾ï¼ˆå¤§ç™½è¯ç‰ˆï¼‰</strong></p><pre tabindex=0><code>ç”¨æˆ·å†™æ³¨è§£ï¼š
  @Idempotent(key = &#34;#userId + &#39;-&#39; + #productId&#34;)

â†“

ç¨‹åºè¯»å–ï¼š
  keyExpression = &#34;#userId + &#39;-&#39; + #productId&#34;

â†“

å‡†å¤‡å˜é‡æœ¬å­ï¼ˆcontextï¼‰ï¼š
  userId â†’ 1001
  productId â†’ 2002

â†“

è¡¨è¾¾å¼ç¿»è¯‘å®˜å¼€å·¥ï¼š
  æŠŠ &#34;#userId&#34; æ›¿æ¢æˆ 1001
  æŠŠ &#34;#productId&#34; æ›¿æ¢æˆ 2002
  æ‹¼ä¸Šä¸­é—´çš„ &#39;-&#39;

â†“

å¾—åˆ°çœŸå® keyï¼š
  realKey = &#34;1001-2002&#34;

â†“

ç”¨å®ƒå» Redis åŠ é”ï¼šidempotent:1001-2002
</code></pre><p><strong>ğŸ’¡ é«˜çº§æŠ€å·§ï¼ˆå¯é€‰äº†è§£ï¼‰</strong></p><p>SpEL æ”¯æŒå¾ˆå¤šå¼ºå¤§åŠŸèƒ½ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// ä¸‰å…ƒè¿ç®—</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;#userId != null ? #userId : &#39;guest&#39;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// è°ƒç”¨æ–¹æ³•ï¼ˆéœ€æ³¨å†Œï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;#content.trim().length() &gt; 0&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// è®¿é—®å¯¹è±¡å±æ€§ï¼ˆå¦‚æœå‚æ•°æ˜¯å¯¹è±¡ï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>&#34;#order.user.id&#34;</span>
</span></span></code></pre></div><p>ä½†è¦æ³¨æ„ï¼š<strong>é»˜è®¤ä¸èƒ½è°ƒç”¨ä»»æ„æ–¹æ³•</strong>ï¼ˆå‡ºäºå®‰å…¨ï¼‰ï¼Œéœ€è¦é¢å¤–é…ç½® <code>EvaluationContext</code></p><p>âœ… æ€»ç»“ä¸€å¥è¯</p><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>String realKey <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SpelExpressionParser()
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>parseExpression</span>(keyExpression)
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>getValue</span>(context, String.<span style=color:#a6e22e>class</span>);
</span></span></code></pre></div><p>å°±åƒæ˜¯ï¼š</p><p>â€œè¯·æŠŠç”¨æˆ·å†™çš„è¡¨è¾¾å¼æ¨¡æ¿ï¼ˆå¦‚ <code>#userId + '-' + #productId</code>ï¼‰ï¼Œ
ç»“åˆå½“å‰æ–¹æ³•çš„å®é™…å‚æ•°å€¼ï¼Œ
åŠ¨æ€è®¡ç®—å‡ºä¸€ä¸ªå”¯ä¸€çš„å­—ç¬¦ä¸² keyã€‚â€</p></blockquote><p>è¿™ä¸ª key å°†ç”¨äº Redis é”ï¼Œå®ç°â€œé˜²é‡å¤æäº¤â€çš„æ ¸å¿ƒé€»è¾‘ã€‚</p><hr><h5 id=7string-lockkey--idempotent--realkey>7ã€String lockKey = &ldquo;idempotent:&rdquo; + realKey;<a hidden class=anchor aria-hidden=true href=#7string-lockkey--idempotent--realkey>#</a></h5><pre tabindex=0><code> // 5. æ„é€  Redis é” key
        String lockKey = &#34;idempotent:&#34; + realKey;

        // 6. å°è¯•åŠ é”
        Boolean isSet = redisTemplate.opsForValue()
                .setIfAbsent(lockKey, &#34;1&#34;, idempotent.expire(), TimeUnit.SECONDS);

        if (Boolean.TRUE.equals(isSet)) {
            return joinPoint.proceed();
        } else {
            throw new RuntimeException(&#34;è¯·å‹¿é‡å¤æäº¤ï¼&#34;);
        }
    }
</code></pre><p><strong>ğŸ§© ç¬¬5æ­¥ï¼šæ„é€  Redis é” key</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>String lockKey <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;idempotent:&#34;</span> <span style=color:#f92672>+</span> realKey;
</span></span></code></pre></div><p><strong>ğŸ’¬ å¤§ç™½è¯ï¼š</strong></p><blockquote><p>â€œæˆ‘è¦åœ¨ Redis é‡Œå­˜ä¸€ä¸ªâ€˜æ ‡è®°â€™ï¼Œè¡¨ç¤ºè¿™ä¸ªè¯·æ±‚æ­£åœ¨å¤„ç†ä¸­ã€‚
ä¸ºäº†é¿å…å’Œå…¶ä»–åŠŸèƒ½å†²çªï¼Œæˆ‘ç»™å®ƒåŠ ä¸ªå‰ç¼€ <code>idempotent:</code>ï¼Œè¿™æ ·ä¸€çœ‹å°±çŸ¥é“æ˜¯å¹‚ç­‰é”ã€‚â€</p></blockquote><p>æ¯”å¦‚ï¼š</p><ul><li><code>realKey = "1001-2002"</code></li><li>é‚£ä¹ˆæœ€ç»ˆçš„ Redis key å°±æ˜¯ï¼š<code>"idempotent:1001-2002"</code></li></ul><p>ğŸ¯ å°±åƒä½ åœ¨å›¾ä¹¦é¦†å€Ÿä¹¦ï¼Œä¹¦ä¸Šè´´ä¸ªæ ‡ç­¾ï¼šâ€œæ­¤ä¹¦å·²å€Ÿå‡ºï¼ˆå¹‚ç­‰é”ï¼‰â€ï¼Œåˆ«äººå°±ä¸è¦å†å€Ÿäº†ã€‚</p><hr><p><strong>ğŸ”¬ è¯­æ³•åŸç†ï¼š</strong></p><ul><li>å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œç®€å•ç›´æ¥ã€‚</li><li><strong>å‰ç¼€è®¾è®¡æ˜¯æœ€ä½³å®è·µ</strong>ï¼šé¿å…ä¸åŒä¸šåŠ¡æ¨¡å—çš„ key å†²çªã€‚</li><li>å¸¸è§å‘½åè§„èŒƒï¼š<code>ä¸šåŠ¡å:æ ‡è¯†ç¬¦</code>ï¼Œå¦‚ <code>order:create:12345</code>ã€<code>user:login:abc</code></li></ul><hr><p><strong>ğŸ§© ç¬¬6æ­¥ï¼šå°è¯•åŠ é”</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Boolean isSet <span style=color:#f92672>=</span> redisTemplate.<span style=color:#a6e22e>opsForValue</span>()
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>setIfAbsent</span>(lockKey, <span style=color:#e6db74>&#34;1&#34;</span>, idempotent.<span style=color:#a6e22e>expire</span>(), TimeUnit.<span style=color:#a6e22e>SECONDS</span>);
</span></span></code></pre></div><p>è¿™è¡Œæ˜¯æ•´ä¸ªå¹‚ç­‰æ€§çš„<strong>çµé­‚æ‰€åœ¨</strong>ï¼æˆ‘ä»¬æ‹†å¼€çœ‹ã€‚</p><hr><p><strong>ğŸ’¬ å¤§ç™½è¯ï¼š</strong></p><blockquote><p>â€œå» Redis é—®ä¸€å¥ï¼š
â€˜æœ‰æ²¡æœ‰äººå·²ç»å ç”¨äº† <code>idempotent:1001-2002</code> è¿™ä¸ªä½ç½®ï¼Ÿâ€™</p><ul><li>å¦‚æœ<strong>æ²¡äººå </strong> â†’ æˆ‘ç°åœ¨æŠŠå®ƒå ä½ï¼Œå€¼è®¾ä¸º <code>"1"</code>ï¼Œå¹¶ä¸” <strong>10 ç§’åè‡ªåŠ¨é‡Šæ”¾</strong>ï¼ˆè¿‡æœŸï¼‰ã€‚</li><li>å¦‚æœ<strong>å·²ç»æœ‰äººå äº†</strong> â†’ è¯´æ˜è¿™æ˜¯é‡å¤è¯·æ±‚ï¼Œåˆ«æ‰§è¡Œäº†ï¼â€</li></ul></blockquote><p>è¿™å°±æ˜¯å…¸å‹çš„ <strong>åˆ†å¸ƒå¼é”</strong> å®ç°æ–¹å¼ä¹‹ä¸€ï¼ˆè½»é‡çº§ï¼‰ã€‚</p><blockquote><p>âš ï¸ æ³¨æ„ï¼šè¿™é‡Œä¸æ˜¯çœŸæ­£çš„â€œäº’æ–¥é”â€ï¼ˆä¸æ”¯æŒå¯é‡å…¥ã€æ—  watch dogï¼‰ï¼Œä½†å¯¹â€œé˜²é‡å¤æäº¤â€åœºæ™¯å®Œå…¨å¤Ÿç”¨ï¼</p></blockquote><hr><p><strong>ğŸ”¬ è¯­æ³•åŸç†ï¼š</strong></p><p><strong><code>redisTemplate.opsForValue()</code></strong></p><ul><li>Spring Data Redis æä¾›çš„æ“ä½œ Redis å­—ç¬¦ä¸²ï¼ˆString ç±»å‹ï¼‰çš„ APIã€‚</li><li>ç›¸å½“äº Redis çš„ <code>SET</code>, <code>GET</code>, <code>INCR</code> ç­‰å‘½ä»¤å°è£…ã€‚</li></ul><p><strong><code>.setIfAbsent(key, value, timeout, unit)</code></strong></p><ul><li><p>å¯¹åº” Redis å‘½ä»¤ï¼š</p><pre tabindex=0><code>SET key value NX EX expireSeconds
</code></pre><ul><li><code>NX</code> = Not eXistsï¼ˆåªæœ‰ key ä¸å­˜åœ¨æ—¶æ‰è®¾ç½®ï¼‰</li><li><code>EX</code> = Expireï¼ˆè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå•ä½ç§’ï¼‰</li></ul></li></ul><p>âœ… è¿”å›å€¼ï¼š</p><ul><li><code>true</code>ï¼šè®¾ç½®æˆåŠŸï¼ˆç¬¬ä¸€æ¬¡è¯·æ±‚ï¼‰</li><li><code>false</code>ï¼škey å·²å­˜åœ¨ï¼ˆé‡å¤è¯·æ±‚ï¼‰</li></ul><p><strong>å‚æ•°è¯´æ˜ï¼š</strong></p><table><thead><tr><th>å‚æ•°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td><code>lockKey</code></td><td>è¦è®¾ç½®çš„ keyï¼Œå¦‚ <code>"idempotent:1001-2002"</code></td></tr><tr><td><code>"1"</code></td><td>value å€¼ï¼Œå…¶å®å†…å®¹ä¸é‡è¦ï¼Œåªè¦å ä½å°±è¡Œï¼ˆä¹Ÿå¯ä»¥å†™ç”¨æˆ·IDã€æ—¶é—´æˆ³ç­‰ï¼‰</td></tr><tr><td><code>idempotent.expire()</code></td><td>è¿‡æœŸæ—¶é—´ï¼Œæ¯”å¦‚ <code>10</code>ï¼ˆæ¥è‡ªæ³¨è§£é…ç½®ï¼‰</td></tr><tr><td><code>TimeUnit.SECONDS</code></td><td>æ—¶é—´å•ä½ï¼Œè¿™é‡Œæ˜¯â€œç§’â€</td></tr></tbody></table><blockquote><p>âœ… è‡ªåŠ¨è¿‡æœŸéå¸¸é‡è¦ï¼é˜²æ­¢ç¨‹åºå´©æºƒå¯¼è‡´é”æ°¸è¿œä¸é‡Šæ”¾ï¼ˆæ­»é”ï¼‰ã€‚</p></blockquote><hr><p><strong>ğŸ§© ç¬¬7æ­¥ï¼šåˆ¤æ–­æ˜¯å¦åŠ é”æˆåŠŸ</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>if</span> (Boolean.<span style=color:#a6e22e>TRUE</span>.<span style=color:#a6e22e>equals</span>(isSet)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> joinPoint.<span style=color:#a6e22e>proceed</span>();
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(<span style=color:#e6db74>&#34;è¯·å‹¿é‡å¤æäº¤ï¼&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><hr><p><strong>ğŸ’¬ å¤§ç™½è¯ï¼š</strong></p><blockquote><p>â€œçœ‹çœ‹åˆšæ‰å ä½ç½®æˆåŠŸæ²¡ï¼š</p><ul><li><strong>æˆåŠŸäº†</strong> â†’ æ”¾è¡Œï¼è®©åŸæ–¹æ³•æ­£å¸¸æ‰§è¡Œï¼ˆæ¯”å¦‚ä¿å­˜è¯„è®ºï¼‰ã€‚</li><li><strong>å¤±è´¥äº†</strong> â†’ ç›´æ¥æŠ¥é”™ï¼šâ€˜ä½ ç‚¹å¤ªå¿«äº†ï¼Œè¯·å‹¿é‡å¤æäº¤ï¼â€™ ä¸æ‰§è¡Œä»»ä½•ä¸šåŠ¡é€»è¾‘ã€‚â€</li></ul></blockquote><p>è¿™å°±å®ç°äº†â€œåŒä¸€ä¸ªè¯·æ±‚ï¼ˆç›¸åŒ keyï¼‰åœ¨çŸ­æ—¶é—´å†…åªèƒ½æˆåŠŸä¸€æ¬¡â€ã€‚</p><hr><p><strong>ğŸ”¬ è¯­æ³•åŸç†ï¼š</strong></p><p><code>Boolean.TRUE.equals(isSet)</code></p><ul><li>ä¸ºä»€ä¹ˆä¸ç”¨ <code>isSet == true</code>ï¼Ÿ<ul><li>å› ä¸º <code>isSet</code> æ˜¯ <code>Boolean</code> å¯¹è±¡ï¼ˆå¯èƒ½ä¸º <code>null</code>ï¼ï¼‰</li><li>å¦‚æœ Redis æ“ä½œå¼‚å¸¸ï¼ŒæŸäº›æƒ…å†µä¸‹å¯èƒ½è¿”å› <code>null</code></li><li><code>Boolean.TRUE.equals(...)</code> å¯ä»¥å®‰å…¨é¿å…ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼ˆNPEï¼‰</li></ul></li></ul><p>âœ… æ¨èå†™æ³•ï¼šæ°¸è¿œç”¨ <code>Boolean.TRUE.equals(obj)</code> åˆ¤æ–­å¸ƒå°”å¯¹è±¡ã€‚</p><p><strong><code>joinPoint.proceed()</code></strong></p><ul><li>AOP ä¸­çš„å…³é”®æ–¹æ³•ï¼š<strong>ç»§ç»­æ‰§è¡Œè¢«æ‹¦æˆªçš„åŸå§‹æ–¹æ³•</strong></li><li>è¿”å›å€¼å°±æ˜¯åŸæ–¹æ³•çš„è¿”å›ç»“æœ</li><li>å¦‚æœåŸæ–¹æ³•æŠ›å¼‚å¸¸ï¼Œè¿™é‡Œä¹Ÿä¼šæŠ›å‡ºæ¥</li></ul><p><strong><code>throw new RuntimeException(...)</code></strong></p><ul><li>ä¸»åŠ¨ä¸­æ–­æµç¨‹ï¼Œä¸è®©é‡å¤è¯·æ±‚è¿›å…¥ä¸šåŠ¡å±‚</li><li>å¼‚å¸¸ä¼šè¢« Spring å…¨å±€å¼‚å¸¸å¤„ç†å™¨æ•è·ï¼ˆå¦‚æœä½ æœ‰å†™çš„è¯ï¼‰ï¼Œè¿”å›å‹å¥½æç¤º</li></ul><hr><p><strong>ğŸ¯ å®Œæ•´æµç¨‹å›é¡¾ï¼ˆç”Ÿæ´»åŒ–æ¯”å–»ï¼‰</strong></p><p>æƒ³è±¡ä½ åœ¨æŠ¢æ¼”å”±ä¼šé—¨ç¥¨ï¼š</p><ul><li><strong>ä½ ç‚¹å‡»â€œæŠ¢ç¥¨â€æŒ‰é’®</strong> â†’ è¯·æ±‚åˆ°è¾¾ <code>/buyTicket?userId=1001&amp;showId=2002</code>**</li><li><strong>ç³»ç»Ÿæ£€æŸ¥</strong>ï¼šRedis é‡Œæœ‰æ²¡æœ‰ <code>idempotent:1001-2002</code>ï¼Ÿ<ul><li>âŒ <strong>æ²¡æœ‰</strong> â†’ ç³»ç»Ÿè¯´ï¼šâ€œå¥½ï¼Œç»™ä½ å ä¸ªåº§ï¼â€ï¼ˆ<code>setIfAbsent</code> æˆåŠŸï¼‰<ul><li>ç„¶åçœŸæ­£å»æ‰£åº“å­˜ã€ç”Ÿæˆè®¢å•ï¼ˆ<code>proceed()</code>ï¼‰</li><li>10 ç§’ååº§ä½è‡ªåŠ¨é‡Šæ”¾</li></ul></li><li>âœ… <strong>å·²ç»æœ‰äº†</strong> â†’ ç³»ç»Ÿè¯´ï¼šâ€œä½ å·²ç»æŠ¢è¿‡äº†ï¼Œåˆ«ç‚¹äº†ï¼â€ï¼ˆæŠ›å¼‚å¸¸ï¼‰</li></ul></li></ul><hr><h4 id=ç¬¬ä¸‰éƒ¨åˆ†postmappingcomment>ç¬¬ä¸‰éƒ¨åˆ†ï¼š@PostMapping("/comment")<a hidden class=anchor aria-hidden=true href=#ç¬¬ä¸‰éƒ¨åˆ†postmappingcomment>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;/comment&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Idempotent</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#userId + &#39;-&#39; + #productId&#34;</span>, expire <span style=color:#f92672>=</span> 10)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>addComment</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestParam</span> Long userId,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestParam</span> Long productId,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestBody</span> String content) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä¸šåŠ¡é€»è¾‘</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>**ğŸ§© ç¬¬ä¸€è¡Œï¼š<code>@PostMapping("/comment")**</code></p><p><strong>ğŸ’¬ å¤§ç™½è¯ï¼š</strong></p><blockquote><p>â€œå½“ç”¨æˆ·ç”¨ POST æ–¹å¼è®¿é—® <code>/comment</code> è¿™ä¸ªç½‘å€æ—¶ï¼Œè¯·è°ƒç”¨ä¸‹é¢è¿™ä¸ªæ–¹æ³•ã€‚â€</p></blockquote><p>æ¯”å¦‚ç”¨æˆ·åœ¨ç½‘é¡µä¸Šç‚¹â€œæäº¤è¯„è®ºâ€æŒ‰é’®ï¼Œæµè§ˆå™¨å°±ä¼šå‘ä¸€ä¸ª POST è¯·æ±‚åˆ°ï¼š</p><pre tabindex=0><code>1POST http://yourserver.com/comment
</code></pre><p><strong>ğŸ”¬ è¯­æ³•åŸç†ï¼š</strong></p><ul><li><code>@PostMapping</code> æ˜¯ Spring MVC çš„æ³¨è§£ï¼Œç”¨äºæ˜ å°„ <strong>HTTP POST è¯·æ±‚</strong> åˆ° Java æ–¹æ³•ã€‚</li><li>ç­‰ä»·äº <code>@RequestMapping(method = RequestMethod.POST, path = "/comment")</code></li><li>å¸¸ç”¨äº<strong>åˆ›å»ºèµ„æº</strong>ï¼ˆå¦‚æäº¤è¡¨å•ã€å‘è¡¨è¯„è®ºã€ä¸‹å•ç­‰ï¼‰</li></ul><p>âœ… å®ƒå‘Šè¯‰ Springï¼šâ€œè¿™ä¸ªæ–¹æ³•ä¸“é—¨å¤„ç† POST /comment è¯·æ±‚â€ã€‚</p><hr><p><strong>ğŸ§© ç¬¬äºŒè¡Œï¼š<code>@Idempotent(key = "#userId + '-' + #productId", expire = 10)</code></strong></p><p><strong>ğŸ’¬ å¤§ç™½è¯ï¼š</strong></p><blockquote><p>â€œè¿™ä¸ªæ¥å£è¦é˜²é‡å¤æäº¤ï¼
åˆ¤æ–­æ˜¯å¦é‡å¤çš„æ ‡å‡†æ˜¯ï¼š<strong>åŒä¸€ä¸ªç”¨æˆ·ï¼ˆuserIdï¼‰å¯¹åŒä¸€ä¸ªå•†å“ï¼ˆproductIdï¼‰</strong>ã€‚
å¦‚æœ 10 ç§’å†…é‡å¤æäº¤ï¼Œå°±ç›´æ¥æ‹’ç»ï¼â€</p></blockquote><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><ul><li>ç”¨æˆ· Aï¼ˆuserId=1001ï¼‰ç»™å•†å“ Bï¼ˆproductId=2002ï¼‰å†™è¯„è®º â†’ âœ… æˆåŠŸ</li><li>ç”¨æˆ· A å†æ¬¡ç»™å•†å“ B å†™è¯„è®ºï¼ˆ10 ç§’å†…ï¼‰â†’ âŒ â€œè¯·å‹¿é‡å¤æäº¤ï¼â€</li><li>ç”¨æˆ· A ç»™å•†å“ Cï¼ˆproductId=3003ï¼‰å†™è¯„è®º â†’ âœ… æˆåŠŸï¼ˆå› ä¸º productId ä¸åŒï¼‰</li><li>ç”¨æˆ· Bï¼ˆuserId=1002ï¼‰ç»™å•†å“ B å†™è¯„è®º â†’ âœ… æˆåŠŸï¼ˆå› ä¸º userId ä¸åŒï¼‰</li></ul><p>ğŸ¯ æ‰€ä»¥ <code>#userId + '-' + #productId</code> å°±æ˜¯â€œå”¯ä¸€æŒ‡çº¹â€ã€‚</p><hr><p><strong>ğŸ”¬ è¯­æ³•åŸç†ï¼š</strong></p><p><code>@Idempotent</code></p><ul><li>è¿™æ˜¯ä½ <strong>è‡ªå®šä¹‰çš„æ³¨è§£</strong>ï¼ˆä¸æ˜¯ Spring è‡ªå¸¦çš„ï¼‰ï¼Œç”¨æ¥æ ‡è®°â€œéœ€è¦å¹‚ç­‰æ§åˆ¶â€çš„æ–¹æ³•ã€‚</li><li>å®ƒå¿…é¡»é…åˆå‰é¢å†™çš„ <code>IdempotentAspect</code> åˆ‡é¢æ‰èƒ½ç”Ÿæ•ˆã€‚</li></ul><p><code>key = "#userId + '-' + #productId"</code></p><ul><li>è¿™æ˜¯ä¸€ä¸ª <strong>SpELï¼ˆSpring Expression Languageï¼‰è¡¨è¾¾å¼</strong></li><li><code>#userId</code> å’Œ <code>#productId</code> å¯¹åº”ä¸‹é¢æ–¹æ³•çš„<strong>å‚æ•°å</strong></li><li>Spring AOP ä¼šåŠ¨æ€æ›¿æ¢ä¸ºå®é™…å€¼ï¼Œæ‹¼æˆå­—ç¬¦ä¸²</li></ul><p><code>expire = 10</code></p><ul><li>è¡¨ç¤º Redis é”çš„<strong>è¿‡æœŸæ—¶é—´æ˜¯ 10 ç§’</strong></li><li>å•ä½é€šå¸¸æ˜¯ç§’ï¼ˆç”±åˆ‡é¢ä»£ç å†³å®šï¼‰</li></ul><blockquote><p>âš ï¸ æ³¨æ„ï¼šè¡¨è¾¾å¼ä¸­çš„å˜é‡å <strong>å¿…é¡»å’Œæ–¹æ³•å‚æ•°åå®Œå…¨ä¸€è‡´</strong>ï¼</p></blockquote><hr><p>ğŸ§© æ–¹æ³•ç­¾åéƒ¨åˆ†</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>addComment</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestParam</span> Long userId,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestParam</span> Long productId,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestBody</span> String content) {
</span></span></code></pre></div><p>æˆ‘ä»¬é€ä¸ªå‚æ•°çœ‹ã€‚</p><hr><p>âœ… å‚æ•°1ï¼š<code>@RequestParam Long userId</code></p><p>ğŸ’¬ å¤§ç™½è¯ï¼š</p><blockquote><p>â€œä» URL çš„æŸ¥è¯¢å‚æ•°ï¼ˆquery paramï¼‰é‡Œæ‹¿ <code>userId</code> çš„å€¼ã€‚â€</p></blockquote><p>æ¯”å¦‚è¯·æ±‚æ˜¯ï¼š</p><pre tabindex=0><code>1POST /comment?userId=1001&amp;productId=2002
2Content-Type: application/json
3
4&#34;æœåŠ¡å¾ˆå¥½ï¼&#34;
</code></pre><p>é‚£ä¹ˆ <code>userId</code> å°±ä¼šè¢«èµ‹å€¼ä¸º <code>1001</code>ã€‚</p><p><strong>ğŸ”¬ è¯­æ³•åŸç†ï¼š</strong></p><ul><li><code>@RequestParam</code>ï¼šç»‘å®š HTTP è¯·æ±‚çš„ <strong>URL å‚æ•°</strong>ï¼ˆå³ <code>?userId=1001</code> ä¸­çš„éƒ¨åˆ†ï¼‰</li><li>é»˜è®¤å‚æ•°åå°±æ˜¯å˜é‡åï¼ˆ<code>userId</code>ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¾å¼æŒ‡å®šï¼š<code>@RequestParam("uid") Long userId</code></li></ul><hr><p><strong>âœ… å‚æ•°2ï¼š<code>@RequestParam Long productId</code></strong></p><p>åŒç†ï¼š</p><ul><li>ä» <code>?productId=2002</code> ä¸­è·å–å€¼</li><li>èµ‹ç»™ <code>productId</code> å˜é‡</li></ul><hr><p><strong>âœ… å‚æ•°3ï¼š<code>@RequestBody String content</code></strong></p><p><strong>ğŸ’¬ å¤§ç™½è¯ï¼š</strong></p><blockquote><p>â€œæŠŠ HTTP è¯·æ±‚çš„<strong>æ­£æ–‡å†…å®¹ï¼ˆbodyï¼‰</strong> å½“æˆå­—ç¬¦ä¸²è¯»è¿›æ¥ã€‚â€</p></blockquote><p>æ¯”å¦‚å‰ç«¯å‘é€çš„ JSON æˆ–çº¯æ–‡æœ¬ï¼š</p><pre tabindex=0><code>&#34;è¿™æ¬¡è´­ç‰©ä½“éªŒéå¸¸æ£’ï¼&#34;
</code></pre><p>æˆ–</p><pre tabindex=0><code>{&#34;text&#34;: &#34;å¾ˆæ£’&#34;}   // ä½†è¿™é‡Œä½ ç”¨çš„æ˜¯ Stringï¼Œæ‰€ä»¥ä¼šæ”¶åˆ°æ•´ä¸ª JSON å­—ç¬¦ä¸²
</code></pre><blockquote><p>ğŸ’¡ æ³¨æ„ï¼šå¦‚æœä½ å¸Œæœ›è‡ªåŠ¨è§£æ JSON å¯¹è±¡ï¼Œåº”è¯¥ç”¨ <code>@RequestBody CommentDTO content</code>ï¼Œè€Œä¸æ˜¯ <code>String</code>ã€‚</p></blockquote><p><strong>ğŸ”¬ è¯­æ³•åŸç†ï¼š</strong></p><ul><li><code>@RequestBody</code>ï¼šç»‘å®š HTTP è¯·æ±‚çš„ <strong>body å†…å®¹</strong></li><li>Spring ä¼šç”¨ <code>HttpMessageConverter</code>ï¼ˆå¦‚ Jacksonï¼‰æŠŠ body è½¬æˆ Java å¯¹è±¡</li><li>è¿™é‡Œè½¬æˆ <code>String</code>ï¼Œæ‰€ä»¥ç›´æ¥æ‹¿åˆ°åŸå§‹å­—ç¬¦ä¸²</li></ul><hr><p>ğŸ¯ ä¸ºä»€ä¹ˆ <code>content</code> æ²¡å‡ºç°åœ¨ SpEL è¡¨è¾¾å¼é‡Œï¼Ÿ</p><p>ä½ åœ¨æ³¨è§£é‡Œå†™çš„æ˜¯ï¼š</p><pre tabindex=0><code>1@Idempotent(key = &#34;#userId + &#39;-&#39; + #productId&#34;, ...)
</code></pre><p>æ²¡æœ‰ç”¨ <code>#content</code>ï¼Œè¿™æ˜¯<strong>æ•…æ„è®¾è®¡</strong>çš„ï¼</p><p><strong>ğŸ’¬ å¤§ç™½è¯è§£é‡Šï¼š</strong></p><blockquote><p>â€œæˆ‘ä»¬åªå…³å¿ƒâ€˜è°â€™å¯¹â€˜å“ªä¸ªå•†å“â€™è¯„è®ºï¼Œä¸å…³å¿ƒâ€˜è¯„è®ºå†…å®¹æ˜¯ä»€ä¹ˆâ€™ã€‚
å³ä½¿å†…å®¹ä¸åŒï¼Œåªè¦æ˜¯åŒä¸€ä¸ªç”¨æˆ·å¯¹åŒä¸€ä¸ªå•†å“ï¼Œ10 ç§’å†…ä¹Ÿåªèƒ½æäº¤ä¸€æ¬¡ã€‚â€</p></blockquote><p>âœ… è¿™æ˜¯åˆç†çš„ä¸šåŠ¡é€»è¾‘ï¼šé˜²æ­¢æ‰‹æŠ–é‡å¤ç‚¹â€œæäº¤â€ï¼Œè€Œä¸æ˜¯é˜²æ­¢å†…å®¹ä¸åŒã€‚</p><p>å¦‚æœä½ æƒ³â€œå†…å®¹å˜äº†å°±ç®—æ–°è¯„è®ºâ€ï¼Œé‚£å¯ä»¥æ”¹æˆï¼š</p><pre tabindex=0><code>1@Idempotent(key = &#34;#userId + &#39;-&#39; + #productId + &#39;-&#39; + #content&#34;, ...)
</code></pre><p>ä½†é€šå¸¸æ²¡å¿…è¦ï¼Œè€Œä¸” <code>content</code> å¯èƒ½å¾ˆé•¿ï¼Œå¯¼è‡´ Redis key å¤ªå¤§ã€‚</p><hr><p><strong>ğŸ”„ æ•´ä½“æ‰§è¡Œæµç¨‹å›é¡¾</strong>é¡¾</p><ol><li><p>ç”¨æˆ·å‘é€è¯·æ±‚ï¼š</p><pre tabindex=0><code>POST /comment?userId=1001&amp;productId=2002
Body: &#34;å¥½è¯„ï¼&#34;
</code></pre></li><li><p>Spring MVC åŒ¹é…åˆ° <code>addComment</code> æ–¹æ³•</p></li><li><p>AOP å‘ç°æ–¹æ³•æœ‰ <code>@Idempotent</code>ï¼Œè§¦å‘ <code>IdempotentAspect</code></p></li><li><p>åˆ‡é¢æå–å‚æ•°ï¼š</p><ul><li><code>userId = 1001</code></li><li><code>productId = 2002</code></li><li><code>content = "å¥½è¯„ï¼"</code>ï¼ˆè™½ç„¶æ²¡ç”¨åˆ°ï¼‰</li></ul></li><li><p>è®¡ç®— SpEL è¡¨è¾¾å¼ï¼š</p><ul><li><code>"#userId + '-' + #productId"</code> â†’ <code>"1001-2002"</code></li></ul></li><li><p>æ„é€  Redis keyï¼š<code>"idempotent:1001-2002"</code></p></li><li><p>å°è¯•åŠ é”ï¼š</p><ul><li>ç¬¬ä¸€æ¬¡ï¼šæˆåŠŸ â†’ æ‰§è¡Œ <code>addComment</code> ä¸šåŠ¡é€»è¾‘</li><li>é‡å¤ï¼šå¤±è´¥ â†’ æŠ›å¼‚å¸¸â€œè¯·å‹¿é‡å¤æäº¤ï¼â€</li></ul></li></ol><hr><p><strong>â— å¸¸è§é”™è¯¯æ’æŸ¥ï¼ˆå°ç™½æ³¨æ„ï¼‰</strong></p><table><thead><tr><th>é—®é¢˜</th><th>åŸå› </th><th>è§£å†³æ–¹æ¡ˆ</th></tr></thead><tbody><tr><td><code>#userId</code> æ‰¾ä¸åˆ°</td><td>ç¼–è¯‘æ—¶æœªä¿ç•™å‚æ•°å</td><td>Maven/Gradle åŠ  <code>-parameters</code></td></tr><tr><td>è¡¨è¾¾å¼æŠ¥é”™</td><td>å‚æ•°åæ‹¼å†™é”™è¯¯</td><td>ç¡®ä¿ <code>#xxx</code> å’Œæ–¹æ³•å‚æ•°åå®Œå…¨ä¸€è‡´</td></tr><tr><td>Redis key å¤ªé•¿</td><td>ç”¨äº† <code>#content</code> ä¸”å†…å®¹å¾ˆé•¿</td><td>é¿å…åœ¨ key ä¸­åŒ…å«å¤§å­—æ®µ</td></tr><tr><td>å¹‚ç­‰å¤±æ•ˆ</td><td><code>expire</code> æ—¶é—´å¤ªçŸ­</td><td>æ ¹æ®ä¸šåŠ¡è°ƒæ•´ï¼Œæ¯”å¦‚ 30 ç§’</td></tr></tbody></table><hr><p><strong>âœ… æœ€ä½³å®è·µå»ºè®®</strong></p><ol><li><strong>key è®¾è®¡è¦çŸ­è€Œå”¯ä¸€</strong>ï¼šåªåŒ…å«å¿…è¦å­—æ®µï¼ˆç”¨æˆ·IDã€å•†å“IDã€è®¢å•å·ç­‰ï¼‰</li><li><strong>expire æ—¶é—´åˆç†</strong>ï¼šæ¯”ä¸šåŠ¡æœ€å¤§è€—æ—¶ç•¥é•¿ï¼ˆå¦‚ 10~60 ç§’ï¼‰</li><li><strong>ä¸è¦ä¾èµ– content</strong>ï¼šé™¤éä¸šåŠ¡æ˜ç¡®è¦æ±‚â€œå†…å®¹ä¸åŒå°±ç®—æ–°è¯·æ±‚â€</li><li><strong>è¿”å›å‹å¥½æç¤º</strong>ï¼šç”¨è‡ªå®šä¹‰å¼‚å¸¸ + å…¨å±€å¼‚å¸¸å¤„ç†å™¨è¿”å› JSON</li></ol><p>ä¾‹å¦‚ï¼š</p><pre tabindex=0><code>throw new IdempotentException(&#34;è¯·å‹¿é‡å¤æäº¤&#34;);
</code></pre><p>ç„¶åå…¨å±€æ•è·ï¼Œè¿”å›ï¼š</p><pre tabindex=0><code>{ &#34;code&#34;: 400, &#34;msg&#34;: &#34;è¯·å‹¿é‡å¤æäº¤&#34; }
</code></pre><hr><p>ğŸ’¡ æ€»ç»“ä¸€å¥è¯</p><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;/comment&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Idempotent</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#userId + &#39;-&#39; + #productId&#34;</span>, expire <span style=color:#f92672>=</span> 10)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>addComment</span>(<span style=color:#a6e22e>@RequestParam</span> Long userId, <span style=color:#a6e22e>@RequestParam</span> Long productId, <span style=color:#a6e22e>@RequestBody</span> String content)
</span></span></code></pre></div><p>å°±åƒæ˜¯åœ¨è¯´ï¼š</p><p>â€œå‡¡æ˜¯é€šè¿‡ POST æäº¤åˆ° /comment çš„è¯·æ±‚ï¼Œ
åªè¦æ˜¯åŒä¸€ä¸ªç”¨æˆ·ï¼ˆuserIdï¼‰å¯¹åŒä¸€ä¸ªå•†å“ï¼ˆproductIdï¼‰çš„æ“ä½œï¼Œ
10 ç§’å†…åªå…è®¸æˆåŠŸä¸€æ¬¡ï¼Œå…¶ä½™å…¨éƒ¨æ‹¦æˆªï¼</p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=http://ljj1992.fun/tags/java/>Java</a></li><li><a href=http://ljj1992.fun/tags/aop%E5%88%87%E9%9D%A2/>AOPåˆ‡é¢</a></li><li><a href=http://ljj1992.fun/tags/web%E5%BC%80%E5%8F%91/>Webå¼€å‘</a></li><li><a href=http://ljj1992.fun/tags/%E5%9F%BA%E7%A1%80%E7%BC%96%E7%A8%8B/>åŸºç¡€ç¼–ç¨‹</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=http://ljj1992.fun/>starå¾çš„åšå®¢</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script></body></html>